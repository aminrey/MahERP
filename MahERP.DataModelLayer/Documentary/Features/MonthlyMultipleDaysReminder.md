# 🔔 یادآوری ماهانه با انتخاب چند روز

## 📋 معرفی

این قابلیت جدید امکان تنظیم یادآوری‌هایی را فراهم می‌کند که در **روزهای خاص هر ماه** ارسال شوند.

---

## 🎯 مثال‌های کاربردی

### مثال 1: یادآوری پرداخت حقوق
```
روزهای انتخاب شده: 25
ساعت: 10:00

→ هر ماه روز 25 راس ساعت 10:00 صبح یادآوری ارسال می‌شود
```

### مثال 2: یادآوری چند مرحله‌ای
```
روزهای انتخاب شده: 10, 20, 25
ساعت: 09:00

→ هر ماه در روزهای 10، 20، 25 راس ساعت 09:00 یادآوری ارسال می‌شود
```

### مثال 3: یادآوری پیگیری پروژه
```
روزهای انتخاب شده: 5, 15, 25
ساعت: 14:00
حداکثر تعداد ارسال: 12

→ طی 4 ماه، در روزهای 5، 15، 25 هر ماه راس ساعت 14:00 یادآوری ارسال می‌شود
→ جمعاً 12 یادآوری (3 بار در هر ماه × 4 ماه)
```

---

## 🛠️ نحوه استفاده

### مرحله 1: انتخاب نوع یادآوری
در مودال "افزودن یادآوری"، گزینه **"ماهانه - چند روز"** را انتخاب کنید.

### مرحله 2: انتخاب روزهای ماه
از گرید 31 روزه، روزهای مورد نظر را انتخاب کنید:
- می‌توانید یک روز انتخاب کنید
- می‌توانید چند روز انتخاب کنید
- می‌توانید حتی تمام روزهای ماه را انتخاب کنید!

### مرحله 3: تنظیم ساعت
ساعت ارسال یادآوری را مشخص کنید (مثلاً 09:00).

### مرحله 4: (اختیاری) حداکثر تعداد ارسال
اگر می‌خواهید یادآوری محدود باشد، حداکثر تعداد را وارد کنید.  
**نکته:** هر روز یک بار محسوب می‌شود!

---

## 🔍 منطق محاسبه زمان بعدی

```
الگوریتم:
1️⃣ بررسی ماه جاری:
   - آیا امروز در لیست است و ساعت نگذشته؟ → همین امروز
   - آیا روزی بعد از امروز در لیست وجود دارد؟ → اولین روز بعد

2️⃣ بررسی ماه بعد:
   - اولین روز موجود در لیست که در ماه بعد معتبر است

3️⃣ بررسی ماه‌های بعدی:
   - اگر روزی مثل 31 در ماه کوتاه‌تر (مثل فوریه) وجود ندارد
   - برو به ماه بعدی که این روز معتبر است
```

### مثال عملی:
```
تنظیمات:
- روزهای انتخاب شده: 10, 20, 29
- ساعت: 09:00
- امروز: 15 دی 1403 (ساعت 11:00)

محاسبه:
→ امروز: 15 دی → گذشته (در لیست نیست)
→ روز بعدی در لیست: 20 دی
→ زمان بعدی: 20 دی 1403 ساعت 09:00 ✅
```

---

## 💾 ساختار دیتابیس

### فیلد جدید در `TaskReminderSchedule_Tbl`:

```sql
ScheduledDaysOfMonth NVARCHAR(100) NULL
```

**مثال‌های معتبر:**
- `"10"` → فقط روز 10
- `"10,20"` → روزهای 10 و 20
- `"5,15,25"` → روزهای 5، 15، 25
- `"1,10,15,20,25,30"` → 6 روز در هر ماه

---

## 🎨 UI/UX

### نمایش در Modal:
```
┌─────────────────────────────────────┐
│ ماهانه - چند روز                    │
├─────────────────────────────────────┤
│  1   2   3   4   5   6   7          │
│  8   9  [10] 11  12  13  14         │
│ 15  16  17  18  19 [20] 21          │
│ 22  23  24 [25] 26  27  28          │
│ 29  30  31                          │
└─────────────────────────────────────┘

روزهای انتخاب شده: 10، 20، 25
```

### پیش‌نمایش:
```
یادآوری در روزهای 10، 20، 25 هر ماه، ساعت 09:00 ارسال خواهد شد (نامحدود)
```

---

## ⚙️ Background Service

### زمان اجرا:
- هر **1 دقیقه** یک بار چک می‌شود
- TimeZone: **Iran Standard Time (UTC+3:30)**

### فرآیند:
1. دریافت تمام یادآوری‌های فعال با `ReminderType = 4`
2. Parse کردن `ScheduledDaysOfMonth`
3. محاسبه زمان بعدی
4. اگر زمان رسیده → ارسال اعلان
5. افزایش `SentCount`
6. بررسی `MaxSendCount` (اگر رسید → غیرفعال)

---

## 📊 آمار و گزارش

### Query برای مشاهده یادآوری‌های ماهانه:

```sql
SELECT 
    Id,
    Title,
    ScheduledDaysOfMonth,
    NotificationTime,
    SentCount,
    MaxSendCount,
    LastExecuted,
    IsActive
FROM TaskReminderSchedule_Tbl
WHERE ReminderType = 4
  AND IsActive = 1
ORDER BY LastExecuted DESC;
```

---

## 🐛 Troubleshooting

### مشکل: یادآوری ارسال نمی‌شود

✅ **بررسی‌ها:**
1. آیا `ReminderType = 4`؟
2. آیا `ScheduledDaysOfMonth` خالی نیست؟
3. آیا `IsActive = true`؟
4. آیا `MaxSendCount` رسیده؟
5. آیا Background Service در حال اجراست؟

```sql
-- Query تشخیصی
SELECT 
    Id,
    Title,
    ScheduledDaysOfMonth,
    SentCount,
    MaxSendCount,
    CASE 
        WHEN ScheduledDaysOfMonth IS NULL THEN '❌ خالی است'
        WHEN MaxSendCount IS NOT NULL AND SentCount >= MaxSendCount THEN '❌ به حداکثر رسیده'
        WHEN IsActive = 0 THEN '❌ غیرفعال'
        ELSE '✅ فعال'
    END AS Status
FROM TaskReminderSchedule_Tbl
WHERE ReminderType = 4;
```

---

## 📝 نمونه کد

### ایجاد یادآوری ماهانه:

```csharp
var reminder = new TaskReminderViewModel
{
    TaskId = taskId,
    Title = "یادآوری پیگیری پروژه",
    Description = "پیگیری وضعیت پروژه در مراحل مختلف",
    ReminderType = 4, // ماهانه - چند روز
    ScheduledDaysOfMonth = "10,20,25", // روزهای 10، 20، 25
    NotificationTime = new TimeSpan(9, 0, 0), // 09:00
    MaxSendCount = 12, // 12 بار (4 ماه × 3 روز)
    IsActive = true
};

await _taskRepository.CreateReminderAsync(reminder, userId);
```

---

## 📌 نکات مهم

1. ⚠️ **روز 31:** در ماه‌های 30 روزه (یا فوریه) ارسال نمی‌شود، به ماه بعدی موکول می‌شود
2. ⚠️ **SentCount:** هر روز یک بار محسوب می‌شود (نه هر ماه)
3. ⚠️ **MaxSendCount:** اگر 10 تنظیم کنید و 3 روز در ماه دارید → فقط 3 ماه کار می‌کند
4. ✅ **نامحدود:** `MaxSendCount = null` → تا ابد ادامه می‌یابد

---

## 🎉 خلاصه

این قابلیت امکان تنظیم یادآوری‌های **ماهانه با چند روز** را فراهم می‌کند:

✅ انتخاب چند روز در هر ماه  
✅ تنظیم ساعت دقیق ارسال  
✅ محدودیت تعداد ارسال  
✅ مدیریت خودکار با Background Service  
✅ پشتیبانی از ماه‌های مختلف (28، 29، 30، 31 روزه)  

**نسخه:** 1.0.0  
**تاریخ:** دی 1403
