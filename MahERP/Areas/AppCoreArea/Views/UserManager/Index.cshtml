@model List<AppUsers>
@{
    ViewData["Title"] = "Index";
    int Counter = 1;
    bool isCurrentUserAdmin = ViewBag.IsCurrentUserAdmin ?? false;
    bool showArchived = ViewBag.ShowArchived ?? false;
    int archivedUsersCount = ViewBag.ArchivedUsersCount ?? 0;
}

<!-- Main Container -->
<main id="main-container">
    <!-- Hero -->
    <div class="bg-body-light">
        <div class="content content-full">
            <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
                <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                    @if (showArchived)
                    {
                        <text>کاربران بایگانی شده</text>
                    }
                    else
                    {
                        <text>لیست کاربران</text>
                    }
                </h1>
                <nav aria-label="breadcrumb" class="flex-shrink-0 my-2 my-sm-0 ms-sm-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            کاربران
                        </li>
                        <li aria-current="page" class="breadcrumb-item active">
                            @if (showArchived)
                            {
                                <text>کاربران بایگانی</text>
                            }
                            else
                            {
                                <text>لیست کاربران</text>
                            }
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- END Hero -->
    
    <!-- Page Content -->
    <div class="content">
        <!-- Dynamic Table Responsive -->
        <div class="block block-rounded">
            <div class="block-header block-header-default">
                <div class="add-button d-flex justify-content-between w-100">
                    <div>
                        @if (!showArchived)
                        {
                            <a asp-controller="UserManager" asp-action="AddUser" class="btn btn-success me-1 mb-3">
                                <i class="fa fa-fw fa-plus me-1"></i>افزودن کاربر جدید
                            </a>
                        }
                        
                        @if (isCurrentUserAdmin)
                        {
                            @if (showArchived)
                            {
                                <a asp-controller="UserManager" asp-action="Index" asp-route-showArchived="false" class="btn btn-primary me-1 mb-3">
                                    <i class="fa fa-fw fa-users me-1"></i>کاربران فعال
                                </a>
                            }
                            else if (archivedUsersCount > 0)
                            {
                                <a asp-controller="UserManager" asp-action="Index" asp-route-showArchived="true" class="btn btn-warning me-1 mb-3">
                                    <i class="fa fa-fw fa-archive me-1"></i>کاربران بایگانی (@archivedUsersCount)
                                </a>
                            }
                        }
                    </div>
                    
                    @if (showArchived)
                    {
                        <div class="alert alert-info mb-3">
                            <i class="fa fa-info-circle me-1"></i>
                            این کاربران بایگانی شده‌اند و در سیستم فعال نیستند. می‌توانید آنها را بازیابی یا حذف کامل کنید.
                        </div>
                    }
                </div>
            </div>
            <div class="block-content block-content-full">
                <!-- DataTables init on table by adding .js-dataTable-responsive class, functionality is initialized in js/pages/be_tables_datatables.min.js which was auto compiled from _js/pages/be_tables_datatables.js -->
                <table class="table table-bordered table-striped table-vcenter js-dataTable-no-pagination">
                    <thead>
                        <tr>
                            <th class="d-none d-sm-table-cell text-center" style="width: 80px;">#</th>
                            <th class="text-center">نام</th>
                            <th class="d-none d-sm-table-cell text-center" style="width: 30%;">نام کاربری</th>
                            <th class="d-none d-sm-table-cell text-center" style="width: 15%;">تلفن</th>
                            <th class="text-center" style="width: 15%;">وضعیت</th>
                            <th class="text-center" style="width: 15%;">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td class="text-center d-none d-sm-table-cell">@Counter</td>
                                <td class="text-center fw-semibold">
                                    <a asp-controller="Customer" asp-action="CustomerDetails" asp-route-CustomerId="@item.Id">@item.FirstName @item.LastName</a>
                                </td>
                               <td class="text-center d-none d-sm-table-cell">@item.UserName</td>
                                <td class="text-center d-none d-sm-table-cell">@item.PhoneNumber</td>

                                @if (showArchived)
                                {
                                    <td class="text-center">
                                        <span class="badge bg-secondary">بایگانی شده</span>
                                    </td>
                                }
                                else if (item.IsActive == true)
                                {
                                    <td class="text-center">
                                        <button asp-controller="UserManager" asp-action="ActiveOrDeactiveUser" asp-route-UserId="@item.Id"
                                                class="btn btn-sm rounded-pill btn-alt-success" data-bs-target="#modal-action" data-toggle="modal-ajax">
                                            فعال
                                        </button>
                                    </td>
                                }
                                else
                                {
                                    <td class="text-center">
                                        <button asp-controller="UserManager" asp-action="ActiveOrDeactiveUser" asp-route-UserId="@item.Id"
                                                class="btn btn-sm rounded-pill btn-alt-danger" data-bs-target="#modal-action" data-toggle="modal-ajax">
                                            غیر فعال
                                        </button>
                                    </td>
                                }

                                <td class="text-center">
                                    @if (showArchived)
                                    {
                                        <!-- دکمه‌های مخصوص کاربران بایگانی -->
                                        <div class="btn-group" role="group" aria-label="عملیات کاربر بایگانی">
                                            <!-- دکمه بازیابی -->
                                            <button onclick="RestoreUser('@item.Id')" class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="بازیابی کاربر" type="button">
                                                <i class="fa fa-undo"></i>
                                            </button>

                                            <!-- دکمه حذف کامل -->
                                            <button asp-controller="UserManager" asp-action="CompletelyDeleteUser" asp-route-UserId="@item.Id"
                                                    class="btn btn-sm btn-danger" data-bs-target="#modal-action" data-toggle="modal-ajax" data-bs-toggle="tooltip" title="حذف کامل کاربر" type="button">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <!-- دکمه‌های عادی برای کاربران فعال -->
                                        <div class="btn-group" role="group" aria-label="عملیات کاربر">
                                            
                                            <!-- دکمه ارسال پیام -->
                                            <button asp-controller="UserManager" asp-action="SendMessageToUser" asp-route-UserId="@item.Id"
                                                    class="btn btn-sm btn-alt-info" data-bs-target="#modal-action" data-toggle="modal-ajax" data-bs-toggle="tooltip" title="ارسال پیام" type="button">
                                                <i class="fa fa-paper-plane"></i>
                                            </button>

                                            <!-- دکمه تغییر رمز عبور -->
                                            <button asp-controller="UserManager" asp-action="ChangePasswordByAdmin" asp-route-UserId="@item.Id"
                                                    class="btn btn-sm btn-alt-secondary" data-bs-target="#modal-action" data-toggle="modal-ajax" data-bs-toggle="tooltip" title="تغییر رمز عبور" type="button">
                                                <i class="fa fa-key"></i>
                                            </button>

                                            <!-- دکمه ویرایش کاربر -->
                                            <a asp-controller="UserManager" asp-action="EditUser" asp-route-UserId="@item.Id" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="ویرایش" type="button">
                                                <i class="fa fa-pencil-alt"></i>
                                            </a>

                                            <!-- دکمه بایگانی کاربر -->
                                            <button asp-controller="UserManager" asp-action="RemoveUser" asp-route-UserId="@item.Id"
                                                    class="btn btn-sm btn-warning" data-bs-target="#modal-action" data-toggle="modal-ajax" data-bs-toggle="tooltip" title="بایگانی کاربر" type="button">
                                                <i class="fa fa-archive"></i>
                                            </button>

                                            @if (isCurrentUserAdmin)
                                            {
                                                <!-- دکمه حذف کامل کاربر - فقط برای ادمین -->
                                                <button asp-controller="UserManager" asp-action="CompletelyDeleteUser" asp-route-UserId="@item.Id"
                                                        class="btn btn-sm btn-danger" data-bs-target="#modal-action" data-toggle="modal-ajax" data-bs-toggle="tooltip" title="حذف کامل کاربر" type="button">
                                                    <i class="fa fa-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    }
                                </td>

                            </tr>
                            Counter++;
                        }

                    </tbody>
                </table>
            </div>
        </div>
        <!-- END Dynamic Table Responsive -->
    </div>
    <!-- END Page Content -->
</main>
<!-- END Main Container -->

<!-- Modal Container برای استفاده توسط main.js -->
<div class="modal fade" id="modal-action" tabindex="-1" role="dialog" aria-labelledby="modal-action" aria-hidden="true">
    <!-- محتوای دینامیک در اینجا بارگذاری می‌شود -->
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.js-dataTable-no-pagination').DataTable({
                paging: false,
                info: false,
                language: {
                    search: "جستجو:",
                    searchPlaceholder: "جستجو در جدول...",
                    lengthMenu: "نمایش _MENU_ رکورد",
                    info: "نمایش _START_ تا _END_ از _TOTAL_ رکورد",
                    infoEmpty: "نمایش 0 تا 0 از 0 رکورد",
                    infoFiltered: "(فیلتر شده از _MAX_ رکورد)",
                    emptyTable: "هیچ داده‌ای در جدول وجود ندارد",
                    zeroRecords: "هیچ رکوردی یافت نشد"
                }
            });
        });
    </script>
}

<!-- فرم مخفی برای توکن CSRF -->
<form style="display: none;">
    @Html.AntiForgeryToken()
</form>








