@model SendMessageToUserViewModel
@{
    bool hasTelegram = Model.TelegramChatId.HasValue;
    bool hasEmail = !string.IsNullOrEmpty(Model.Email);
    bool hasPhone = !string.IsNullOrEmpty(Model.PhoneNumber);
}

<!-- Modal Dialog -->
<div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
        <!-- Modal Header -->
        <div class="block block-rounded block-themed block-transparent mb-0">
            <div class="block-header bg-primary-dark">
                <h3 class="block-title">
                    <i class="fa fa-paper-plane me-2"></i>
                    ارسال پیام به @Model.UserFullName
                </h3>
                <div class="block-options">
                    <button type="button" class="btn-block-option" data-bs-dismiss="modal" aria-label="Close">
                        <i class="fa fa-fw fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="block-content block-content-full">
                <form asp-action="SendMessageToUserPost" asp-controller="UserManager" method="post" id="sendMessageForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="UserId" />
                    <input type="hidden" asp-for="UserFullName" />
                    <input type="hidden" asp-for="UserName" />
                    <input type="hidden" asp-for="Email" />
                    <input type="hidden" asp-for="PhoneNumber" />
                    <input type="hidden" asp-for="TelegramChatId" />
                    <input type="hidden" value="@ViewBag.page" name="page"/>
                    <input type="hidden" id="selectedTemplateId" name="TemplateId" value="" />
                    
                    <!-- User Info -->
                    <div class="alert alert-info mb-4">
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1">
                                    <i class="fa fa-user me-2"></i>
                                    <strong>نام کاربر:</strong> @Model.UserFullName
                                </p>
                                <p class="mb-1">
                                    <i class="fa fa-at me-2"></i>
                                    <strong>نام کاربری:</strong> @Model.UserName
                                </p>
                            </div>
                            <div class="col-md-6">
                                @if (hasEmail)
                                {
                                    <p class="mb-1">
                                        <i class="fa fa-envelope me-2"></i>
                                        <strong>ایمیل:</strong> @Model.Email
                                    </p>
                                }
                                @if (hasPhone)
                                {
                                    <p class="mb-1">
                                        <i class="fa fa-phone me-2"></i>
                                        <strong>تلفن:</strong> @Model.PhoneNumber
                                    </p>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Right Column: Templates -->
                        <div class="col-lg-4">
                            <div class="block block-rounded">
                                <div class="block-header block-header-default">
                                    <h3 class="block-title">
                                        <i class="fa fa-file-alt me-2"></i>
                                        قالب‌های آماده
                                    </h3>
                                </div>
                                <div class="block-content p-0">
                                    <!-- Search Template -->
                                    <div class="p-3 bg-body-light">
                                        <input type="text" class="form-control form-control-sm" id="searchTemplate" placeholder="جستجو در قالب‌ها...">
                                    </div>
                                    
                                    <!-- Templates List -->
                                    <div id="templatesList" style="max-height: 500px; overflow-y: auto;">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">در حال بارگذاری...</span>
                                            </div>
                                            <p class="text-muted mt-2">در حال دریافت قالب‌ها...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Left Column: Message Form -->
                        <div class="col-lg-8">
                            <!-- Send Methods -->
                            <div class="mb-3">
                                <label class="form-label">روش ارسال <span class="text-danger">*</span></label>
                                <div class="space-y-2">
                                    @if (hasTelegram)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" asp-for="SendViaTelegram" id="sendViaTelegram" checked />
                                            <label class="form-check-label" for="sendViaTelegram">
                                                <i class="fab fa-telegram text-info me-1"></i>
                                                <strong>ارسال از طریق تلگرام</strong>
                                                <span class="text-muted fs-sm">(Chat ID: @Model.TelegramChatId)</span>
                                            </label>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                                            <i class="fa fa-exclamation-triangle me-1"></i>
                                            <strong>توجه:</strong> چت آی دی تلگرام برای این کاربر ثبت نشده است
                                        </div>
                                    }

                                    @if (hasEmail)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" asp-for="SendViaEmail" id="sendViaEmail" />
                                            <label class="form-check-label" for="sendViaEmail">
                                                <i class="fa fa-envelope text-primary me-1"></i>
                                                <strong>ارسال از طریق ایمیل</strong>
                                                <span class="text-muted fs-sm">(@Model.Email)</span>
                                            </label>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning alert-dismissible fade show mb-2" role="alert">
                                            <i class="fa fa-exclamation-triangle me-1"></i>
                                            <strong>توجه:</strong> ایمیل برای این کاربر ثبت نشده است
                                        </div>
                                    }

                                    @if (hasPhone)
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" asp-for="SendViaSms" id="sendViaSms" disabled />
                                            <label class="form-check-label" for="sendViaSms">
                                                <i class="fa fa-sms text-success me-1"></i>
                                                <strong>ارسال از طریق پیامک</strong>
                                                <span class="badge bg-warning text-dark">به زودی</span>
                                            </label>
                                        </div>
                                    }
                                </div>
                                <span asp-validation-for="SendViaTelegram" class="text-danger"></span>
                                <span asp-validation-for="SendViaEmail" class="text-danger"></span>
                            </div>

                            <!-- Subject -->
                            <div class="mb-3">
                                <label class="form-label" for="subject">
                                    عنوان پیام <span class="text-danger">*</span>
                                </label>
                                <input asp-for="Subject" class="form-control" id="subject" placeholder="عنوان پیام خود را وارد کنید" />
                                <span asp-validation-for="Subject" class="text-danger"></span>
                            </div>

                            <!-- Message -->
                            <div class="mb-3">
                                <label class="form-label" for="message">
                                    متن پیام <span class="text-danger">*</span>
                                </label>
                                <textarea asp-for="Message" class="form-control" id="message" rows="10" placeholder="متن پیام خود را وارد کنید"></textarea>
                                <span asp-validation-for="Message" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fa fa-info-circle me-1"></i>
                                    حداکثر 2000 کاراکتر | از متغیرها مانند {{RecipientFullName}}، {{Date}}، {{Time}} استفاده کنید
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer -->
            <div class="block-content block-content-full text-end bg-body-light">
                <button type="button" class="btn btn-sm btn-alt-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-sm btn-primary" data-save="modal-ajax-save">
                    <i class="fa fa-paper-plane me-1"></i>
                    ارسال پیام
                </button>
            </div>
        </div>
    </div>
</div>

    <partial name="_ValidationScriptsPartial" />
<script>
    $(document).ready(function() {
        // ⭐⭐⭐ بارگذاری فوری قالب‌ها (بدون تاخیر)
        loadScheduledTemplates();

        // ⭐ جستجو در قالب‌ها
        $('#searchTemplate').on('keyup', function() {
            const searchValue = $(this).val().toLowerCase();
            $('.template-item').each(function() {
                const templateName = $(this).data('name').toLowerCase();
                if (templateName.includes(searchValue)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        // حداقل یکی از روش‌های ارسال باید انتخاب شود
        $('#sendMessageForm').on('submit', function(e) {
            const sendViaTelegram = $('#sendViaTelegram').is(':checked');
            const sendViaEmail = $('#sendViaEmail').is(':checked');
            const sendViaSms = $('#sendViaSms').is(':checked');

            if (!sendViaTelegram && !sendViaEmail && !sendViaSms) {
                e.preventDefault();
                alert('لطفاً حداقل یک روش ارسال را انتخاب کنید');
                return false;
            }
        });
    });

    // ⭐⭐⭐ بروزرسانی انتخاب کانال
    function updateChannelSelection(channel) {
        // پاک کردن همه
        $('#sendViaTelegram').prop('checked', false);
        $('#sendViaEmail').prop('checked', false);
        $('#sendViaSms').prop('checked', false);

        // انتخاب کانال مناسب
        switch(channel) {
            case 1: // Email
                $('#sendViaEmail').prop('checked', true);
                break;
            case 2: // SMS
                $('#sendViaSms').prop('checked', true);
                break;
            case 3: // Telegram
                $('#sendViaTelegram').prop('checked', true);
                break;
        }
    }

    // ⭐ دریافت آیکون کانال
    function getChannelIcon(channel) {
        switch(channel) {
            case 1: return '<i class="fa fa-envelope fa-2x text-primary"></i>';
            case 2: return '<i class="fa fa-sms fa-2x text-success"></i>';
            case 3: return '<i class="fab fa-telegram fa-2x text-info"></i>';
            default: return '<i class="fa fa-bell fa-2x text-secondary"></i>';
        }
    }

    // ⭐ دریافت Badge کانال
    function getChannelBadge(channel, channelName) {
        const colors = {
            1: 'primary',
            2: 'success',
            3: 'info'
        };
        return `<span class="badge bg-${colors[channel] || 'secondary'}">${channelName}</span>`;
    }

    // ⭐ نمایش پیام
    function showNotification(type, message) {
        const icon = type === 'success' ? 'check' : (type === 'warning' ? 'exclamation-triangle' : 'times');
        const bgColor = type === 'success' ? 'success' : (type === 'warning' ? 'warning' : 'danger');

        const notification = `
            <div class="alert alert-${bgColor} alert-dismissible fade show" role="alert">
                <i class="fa fa-${icon} me-1"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        // نمایش در بالای فرم
        $('#sendMessageForm').prepend(notification);

        // حذف خودکار بعد از 3 ثانیه
        setTimeout(() => {
            $('.alert').fadeOut(function() {
                $(this).remove();
            });
        }, 3000);
    }

    // ⭐⭐⭐ بارگذاری قالب‌های زمان‌بندی شده
    function loadScheduledTemplates() {
        // ⭐ بررسی flag قبل از شروع
        if (window.isLoadingTemplates) {
            console.warn('⚠️ Templates are already loading');
            return;
        }

        // ⭐ تنظیم flag
        window.isLoadingTemplates = true;

        $.ajax({
            url: '/AppCoreArea/NotificationTemplates/GetScheduledTemplatesForManualSend',
            type: 'GET',
            success: function (response) {
                // ⭐ Reset flag
                window.isLoadingTemplates = false;

                if (response.success && response.templates && response.templates.length > 0) {
                    renderTemplates(response.templates);
                } else {
                    $('#templatesList').html(`
                        <div class="text-center py-4">
                            <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">هیچ قالب زمان‌بندی شده‌ای یافت نشد</p>
                        </div>
                    `);
                }
            },
            error: function (xhr, status, error) {
                // ⭐ Reset flag on error
                window.isLoadingTemplates = false;

                console.error('Error loading templates:', error);
                $('#templatesList').html(`
                    <div class="text-center py-4">
                        <i class="fa fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">خطا در بارگذاری قالب‌ها</p>
                        <button class="btn btn-sm btn-primary mt-2" onclick="loadScheduledTemplates()">
                            <i class="fa fa-refresh me-1"></i>
                            تلاش مجدد
                        </button>
                    </div>
                `);
            }
        });
    }

    // ⭐⭐⭐ رندر کردن لیست قالب‌ها
    function renderTemplates(templates) {
        let html = '';

        templates.forEach(template => {
            const channelIcon = getChannelIcon(template.channel);
            const channelBadge = getChannelBadge(template.channel, template.channelName);

            html += `
                <div class="template-item" data-name="${template.templateName}" data-id="${template.id}">
                    <a href="javascript:void(0)" class="block block-link-shadow text-center" onclick="selectTemplate(${template.id})">
                        <div class="block-content block-content-full">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1 text-start">
                                    <div class="fw-semibold">${template.templateName}</div>
                                    ${template.description ? `<div class="fs-sm text-muted mt-1">${template.description}</div>` : ''}
                                </div>
                                <div class="ms-2">
                                    ${channelIcon}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                ${channelBadge}
                                <small class="text-muted">
                                    <i class="fa fa-calendar me-1"></i>
                                    ${template.scheduleTypeName}
                                </small>
                            </div>
                        </div>
                    </a>
                </div>
            `;
        });

        $('#templatesList').html(html);
    }

    // ⭐⭐⭐ انتخاب قالب
    function selectTemplate(templateId) {
        // ⭐ بررسی flag قبل از شروع
        if (window.isLoadingTemplates) {
            console.warn('⚠️ Templates are loading, please wait...');
            showNotification('warning', 'لطفاً صبر کنید...');
            return;
        }

        // ⭐ تنظیم flag
        window.isLoadingTemplates = true;

        $.ajax({
            url: `/AppCoreArea/NotificationTemplates/GetTemplateById/${templateId}`,
            type: 'GET',
            success: function(response) {
                // ⭐ Reset flag
                window.isLoadingTemplates = false;

                if (response.success && response.template) {
                    const template = response.template;

                    // ⭐ پر کردن فیلدها
                    $('#subject').val(template.subject || '');
                    $('#message').val(template.messageTemplate || '');
                    $('#selectedTemplateId').val(templateId);

                    // ⭐ انتخاب کانال ارسال بر اساس قالب
                    updateChannelSelection(template.channel);

                    // ⭐ هایلایت قالب انتخاب شده
                    $('.template-item').removeClass('bg-body-light');
                    $(`.template-item[data-id="${templateId}"]`).addClass('bg-body-light');

                    // نمایش پیام موفقیت
                    showNotification('success', 'قالب با موفقیت انتخاب شد');
                } else {
                    showNotification('error', 'قالب یافت نشد');
                }
            },
            error: function(xhr, status, error) {
                // ⭐ Reset flag on error
                window.isLoadingTemplates = false;

                console.error('Error loading template:', error);
                showNotification('error', 'خطا در دریافت اطلاعات قالب');
            }
        });
    }
</script>

<style>
    .template-item {
        border-bottom: 1px solid #e9ecef;
        transition: all 0.2s;
    }

        .template-item:hover {
            background-color: #f8f9fa !important;
        }

        .template-item.bg-body-light {
            background-color: #e3f2fd !important;
            border-left: 4px solid #2196F3;
        }

        .template-item .block {
            margin-bottom: 0;
        }
</style>
    <style>
        .template-item {
            border-bottom: 1px solid #e9ecef;
            transition: all 0.2s;
        }
        
        .template-item:hover {
            background-color: #f8f9fa !important;
        }
        
        .template-item.bg-body-light {
            background-color: #e3f2fd !important;
            border-left: 4px solid #2196F3;
        }
        
        .template-item .block {
            margin-bottom: 0;
        }
    </style>
