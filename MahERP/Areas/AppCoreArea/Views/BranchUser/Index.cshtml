@model List<BranchUser>
@{
    ViewData["Title"] = $"مدیریت کاربران شعبه - {ViewBag.BranchName}";
}

<!-- Hero -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo12.jpg');">
    <div class="bg-primary-dark-op">
        <div class="content content-full text-center py-6">
            <h1 class="h2 text-white mb-2">مدیریت کاربران شعبه</h1>
            <h2 class="h4 fw-normal text-white-75 mb-0">@ViewBag.BranchName</h2>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- Quick Actions -->
    <div class="row items-push">
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("Create", new { branchId = ViewBag.BranchId })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-user-plus text-success"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        افزودن کاربر
                    </p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("Details", "Branch", new { id = ViewBag.BranchId })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-building text-primary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        جزئیات شعبه
                    </p>
                </div>
            </a>
        </div>
    </div>
    <!-- END Quick Actions -->
    <!-- Search and Filter -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-search text-muted me-1"></i> جستجو و فیلتر
            </h3>
        </div>
        <div class="block-content">
            <form method="get" action="@Url.Action("Search")">
                <input type="hidden" name="branchId" value="@ViewBag.BranchId" />
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">جستجو</label>
                            <input type="text" class="form-control" name="searchTerm" value="@ViewBag.SearchTerm" placeholder="نام، ایمیل یا نام کاربری">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">نقش</label>
                            @{
                                var roleItems = new List<SelectListItem>
                                                        {
                                                        new SelectListItem { Text = "همه", Value = "" },
                                                        new SelectListItem { Text = "مشاهده‌گر", Value = "0" },
                                                        new SelectListItem { Text = "کارمند", Value = "1" },
                                                        new SelectListItem { Text = "مدیر", Value = "2" }
                                                        };
                                var selectedRoleValue = ViewBag.SelectedRole?.ToString() ?? "";
                            }
                            @Html.DropDownList("role", new SelectList(roleItems, "Value", "Text", selectedRoleValue), new { @class = "form-select" })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">وضعیت</label>
                            @{
                                var statusItems = new List<SelectListItem>
                                                        {
                                                        new SelectListItem { Text = "همه", Value = "" },
                                                        new SelectListItem { Text = "فعال", Value = "true" },
                                                        new SelectListItem { Text = "غیرفعال", Value = "false" }
                                                        };
                                var selectedStatusValue = ViewBag.SelectedStatus?.ToString() ?? "";
                            }
                            @Html.DropDownList("isActive", new SelectList(statusItems, "Value", "Text", selectedStatusValue), new { @class = "form-select" })
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-search me-1"></i> جستجو
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Users List -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-users text-muted me-1"></i> لیست کاربران (@Model.Count نفر)
            </h3>
            <div class="block-options">
                <a href="@Url.Action("Create", new { branchId = ViewBag.BranchId })" class="btn btn-sm btn-alt-primary">
                    <i class="fa fa-plus me-1"></i> افزودن کاربر
                </a>
            </div>
        </div>
        <div class="block-content">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-vcenter">
                        <thead>
                            <tr>
                                <th class="text-center">ردیف</th>
                                <th class="text-center">نام کاربر</th>
                                <th class="text-center">ایمیل</th>
                                <th class="text-center">نقش</th>
                                <th class="text-center">تاریخ تخصیص</th>
                                <th class="text-center">تخصیص توسط</th>
                                <th class="text-center">وضعیت</th>
                                <th class="text-center" style="width: 150px;">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int counter = 1;
                            }
                            @foreach (var user in Model)
                            {
                                <tr>
                                    <td class="text-center">@counter</td>
                                    <td class="text-center fw-semibold">
                                        <a href="@Url.Action("Details", new { id = user.Id })">
                                            @user.User.FirstName @user.User.LastName
                                        </a>
                                    </td>
                                    <td class="text-center">@user.User.Email</td>
                                    <td class="text-center">
                                        @switch (user.Role)
                                        {
                                            case 0:
                                                <span class="badge bg-info">مشاهده‌گر</span>
                                                break;
                                            case 1:
                                                <span class="badge bg-warning">کارمند</span>
                                                break;
                                            case 2:
                                                <span class="badge bg-success">مدیر</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center">@ConvertDateTime.ConvertMiladiToShamsi(user.AssignDate, "yyyy/MM/dd")</td>
                                    <td class="text-center">
                                        @if (user.AssignedByUser != null)
                                        {
                                            <span>@user.AssignedByUser.FirstName @user.AssignedByUser.LastName</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (user.IsActive)
                                        {
                                            <span class="badge bg-success">فعال</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-danger">غیرفعال</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group">
                                            <a href="@Url.Action("Details", new { id = user.Id })" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="جزئیات">
                                                <i class="fa fa-fw fa-eye"></i>
                                            </a>
                                            <a href="@Url.Action("Edit", new { id = user.Id })" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="ویرایش">
                                                <i class="fa fa-fw fa-pencil-alt"></i>
                                            </a>
                                            <form method="post" action="@Url.Action("ToggleStatus")" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@user.Id" />
                                                <button type="submit" class="btn btn-sm @(user.IsActive ? "btn-alt-warning" : "btn-alt-success")" data-bs-toggle="tooltip" title="@(user.IsActive ? "غیرفعال کردن" : "فعال کردن")">
                                                    <i class="fa fa-fw @(user.IsActive ? "fa-ban" : "fa-check")"></i>
                                                </button>
                                            </form>
                                            <a href="@Url.Action("Delete", new { id = user.Id })" class="btn btn-sm btn-alt-danger" data-bs-toggle="tooltip" title="حذف">
                                                <i class="fa fa-fw fa-trash-alt"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                counter++;
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fa fa-users fa-3x text-muted mb-3"></i>
                    <p class="mb-3">هیچ کاربری برای این شعبه یافت نشد.</p>
                    <a href="@Url.Action("Create", new { branchId = ViewBag.BranchId })" class="btn btn-primary">
                        <i class="fa fa-plus me-1"></i> افزودن کاربر
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Initialize tooltips
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}