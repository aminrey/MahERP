@model int
@{
    var branchId = Model;
}

<div class="block block-rounded">
    <div class="block-header block-header-default">
        <h3 class="block-title">
            <i class="fa fa-eye-slash text-purple me-2"></i>
            تنظیمات نمایش تسک برای مدیران بالاسری
        </h3>
        <div class="block-options">
            <button type="button" 
                    class="btn btn-sm btn-primary" 
                    data-toggle="modal-ajax"
                    data-url="@Url.Action("TaskVisibilitySettingsModal", "Branch", new { area = "AppCoreArea", branchId = branchId })">
                <i class="fa fa-plus me-1"></i>
                تنظیم پیش‌فرض شعبه
            </button>
        </div>
    </div>

    <div class="block-content">
        <!-- توضیحات -->
        <div class="alert alert-info d-flex align-items-center mb-4">
            <div class="flex-shrink-0">
                <i class="fa fa-info-circle fa-2x"></i>
            </div>
            <div class="flex-grow-1 ms-3">
                <h5 class="alert-heading mb-2">
                    <i class="fa fa-lightbulb me-1"></i>
                    این تنظیمات برای چیست؟
                </h5>
                <p class="mb-2">
                    <strong>مشکل:</strong> اگر شما مدیر بالاسری باشید (مثلاً مدیر کل)، ممکن است میلیون‌ها تسک از زیرتیم‌ها در لیست نظارتی شما ظاهر شود که شلوغی زیادی ایجاد می‌کند.
                </p>
                <p class="mb-0">
                    <strong>راه‌حل:</strong> با این تنظیمات می‌توانید مشخص کنید که <strong>به صورت پیش‌فرض</strong> تسک‌های کدام تیم‌ها در لیست نظارتی شما نمایش داده شوند.
                </p>
            </div>
        </div>

        <!-- کارت‌های راهنما -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="block block-rounded block-link-shadow border-start border-primary border-4">
                    <div class="block-content block-content-full">
                        <div class="text-center py-2">
                            <div class="mb-2">
                                <i class="fa fa-building fa-3x text-primary"></i>
                            </div>
                            <h5 class="fw-bold mb-1">تنظیمات پیش‌فرض شعبه</h5>
                            <p class="fs-sm text-muted mb-0">
                                برای همه مدیران این شعبه
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="block block-rounded block-link-shadow border-start border-success border-4">
                    <div class="block-content block-content-full">
                        <div class="text-center py-2">
                            <div class="mb-2">
                                <i class="fa fa-user-tie fa-3x text-success"></i>
                            </div>
                            <h5 class="fw-bold mb-1">تنظیمات شخصی مدیر</h5>
                            <p class="fs-sm text-muted mb-0">
                                برای یک مدیر خاص
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="block block-rounded block-link-shadow border-start border-warning border-4">
                    <div class="block-content block-content-full">
                        <div class="text-center py-2">
                            <div class="mb-2">
                                <i class="fa fa-toggle-on fa-3x text-warning"></i>
                            </div>
                            <h5 class="fw-bold mb-1">کنترل دستی</h5>
                            <p class="fs-sm text-muted mb-0">
                                با چک‌باکس در لیست تسک‌ها
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- لیست تنظیمات -->
        <div id="settings-list-container">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <p class="text-muted mt-3">در حال بارگذاری تنظیمات...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            loadSettings();

            // بارگذاری لیست تنظیمات
            function loadSettings() {
                $.ajax({
                    url: '@Url.Action("GetBranchTaskVisibilitySettings", "Branch", new { area = "AppCoreArea" })',
                    type: 'GET',
                    data: { branchId: @branchId },
                    success: function(response) {
                        if (response.status === 'success') {
                            renderSettings(response.data);
                        } else {
                            showError('خطا در بارگذاری تنظیمات');
                        }
                    },
                    error: function() {
                        showError('خطا در ارتباط با سرور');
                    }
                });
            }

            // نمایش تنظیمات
            function renderSettings(settings) {
                if (settings.length === 0) {
                    $('#settings-list-container').html(`
                        <div class="text-center py-5">
                            <i class="fa fa-inbox fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">هیچ تنظیماتی وجود ندارد</h5>
                            <p class="text-muted mb-3">
                                برای شروع، یک تنظیمات پیش‌فرض برای شعبه ایجاد کنید
                            </p>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    data-toggle="modal-ajax"
                                    data-url="@Url.Action("TaskVisibilitySettingsModal", "Branch", new { area = "AppCoreArea" })/?branchId=@branchId">
                                <i class="fa fa-plus me-1"></i>
                                ایجاد تنظیمات پیش‌فرض
                            </button>
                        </div>
                    `);
                    return;
                }

                let html = '<div class="table-responsive">';
                html += '<table class="table table-hover table-vcenter">';
                html += '<thead class="table-light">';
                html += '<tr>';
                html += '<th style="width: 5%">#</th>';
                html += '<th style="width: 30%">مدیر / تنظیمات</th>';
                html += '<th style="width: 20%">نمایش همه زیرتیم‌ها</th>';
                html += '<th style="width: 15%">تیم‌های انتخابی</th>';
                html += '<th style="width: 15%">حداکثر تسک</th>';
                html += '<th style="width: 10%">وضعیت</th>';
                html += '<th style="width: 10%" class="text-center">عملیات</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                settings.forEach((setting, index) => {
                    html += '<tr>';
                    html += `<td class="fw-bold text-center">${index + 1}</td>`;
                    
                    // نام مدیر
                    if (setting.managerUserId) {
                        html += `<td>
                            <i class="fa fa-user-tie text-success me-2"></i>
                            <strong>${setting.managerName}</strong>
                            <br>
                            <small class="text-muted">تنظیمات شخصی</small>
                        </td>`;
                    } else {
                        html += `<td>
                            <i class="fa fa-building text-primary me-2"></i>
                            <strong>${setting.managerName}</strong>
                            <br>
                            <small class="text-muted">برای همه مدیران</small>
                        </td>`;
                    }

                    // نمایش همه
                    html += `<td>
                        ${setting.showAllSubTeams 
                            ? '<span class="badge bg-success"><i class="fa fa-check me-1"></i>بله</span>' 
                            : '<span class="badge bg-secondary"><i class="fa fa-times me-1"></i>خیر</span>'}
                    </td>`;

                    // تیم‌ها
                    html += `<td>
                        ${setting.teamsCount > 0 
                            ? `<span class="badge bg-info">${setting.teamsCount} تیم</span>` 
                            : '<span class="text-muted">-</span>'}
                    </td>`;

                    // حداکثر
                    html += `<td>
                        ${setting.maxTasks > 0 
                            ? `<span class="badge bg-warning">${setting.maxTasks}</span>` 
                            : '<span class="badge bg-secondary">نامحدود</span>'}
                    </td>`;

                    // وضعیت
                    html += `<td>
                        ${setting.isActive 
                            ? '<span class="badge bg-success">فعال</span>' 
                            : '<span class="badge bg-danger">غیرفعال</span>'}
                    </td>`;

                    // عملیات
                    html += '<td class="text-center">';
                    html += '<div class="btn-group btn-group-sm" role="group">';
                    
                    // ویرایش
                    const editUrl = setting.managerUserId
                        ? '@Url.Action("TaskVisibilitySettingsPersonalModal", "Branch", new { area = "AppCoreArea" })/?branchId=@branchId&managerId=' + setting.managerUserId
                        : '@Url.Action("TaskVisibilitySettingsModal", "Branch", new { area = "AppCoreArea" })/?branchId=@branchId';
                    
                    html += `<button type="button" 
                                     class="btn btn-primary" 
                                     data-toggle="modal-ajax"
                                     data-url="${editUrl}"
                                     title="ویرایش">
                        <i class="fa fa-edit"></i>
                    </button>`;

                    // حذف
                    html += `<button type="button" 
                                     class="btn btn-danger" 
                                     onclick="deleteSettings(${setting.id})"
                                     title="حذف">
                        <i class="fa fa-trash"></i>
                    </button>`;

                    html += '</div>';
                    html += '</td>';
                    html += '</tr>';
                });

                html += '</tbody>';
                html += '</table>';
                html += '</div>';

                $('#settings-list-container').html(html);
            }

            // حذف تنظیمات
            window.deleteSettings = function(settingsId) {
                Swal.fire({
                    title: 'حذف تنظیمات',
                    text: 'آیا از حذف این تنظیمات اطمینان دارید؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'بله، حذف کن',
                    cancelButtonText: 'انصراف'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '@Url.Action("DeleteTaskVisibilitySettings", "Branch", new { area = "AppCoreArea" })',
                            type: 'POST',
                            data: { 
                                settingsId: settingsId,
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function(response) {
                                if (response.status === 'success') {
                                    Swal.fire('موفق', response.message, 'success');
                                    loadSettings();
                                } else {
                                    Swal.fire('خطا', response.message, 'error');
                                }
                            }
                        });
                    }
                });
            };

            function showError(message) {
                $('#settings-list-container').html(`
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                `);
            }

            // بارگذاری مجدد پس از ذخیره
            $(document).on('settingsSaved', function() {
                loadSettings();
            });
        });
    </script>
}
