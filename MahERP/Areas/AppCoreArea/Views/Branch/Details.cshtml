@model BranchDetailsViewModel
@{
    ViewData["Title"] = $"جزئیات شعبه - {Model.Name}";
}

<!-- Hero -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo12.jpg');">
    <div class="bg-primary-dark-op">
        <div class="content content-full text-center py-6">
            <h1 class="h2 text-white mb-2">@Model.Name</h1>
            <h2 class="h4 fw-normal text-white-75 mb-0">
                @(Model.IsMainBranch ? "شعبه اصلی" : "شعبه فرعی")
                @if (Model.ParentBranch != null)
                {
                    <span class="mx-2">|</span>
                    <span>زیرمجموعه: @Model.ParentBranchName</span>
                }
            </h2>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- دکمه‌های عملیاتی - ردیف اول -->
    <div class="row items-push">
        <!-- ویرایش -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("EditBranch", "Branch", new { id = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-pencil-alt text-primary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">ویرایش</p>
                </div>
            </a>
        </div>

        <!-- فعال/غیرفعال کردن -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               data-toggle="modal-ajax" href="@Url.Action("ToggleActivation", "Branch", new { id = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-@(Model.IsActive ? "ban text-danger" : "check text-success")"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        @(Model.IsActive ? "غیرفعال کردن" : "فعال کردن")
                    </p>
                </div>
            </a>
        </div>

        <!-- ⭐⭐⭐ افزودن فرد (Contact) - جدید -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               data-toggle="modal-ajax"
               href="@Url.Action("AddContactToBranch", "Branch", new { branchId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-user-plus text-success"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن فرد</p>
                </div>
            </a>
        </div>

        <!-- ⭐⭐⭐ افزودن سازمان (Organization) - جدید -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               data-toggle="modal-ajax"
               href="@Url.Action("AddOrganizationToBranch", "Branch", new { branchId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-building text-info"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن سازمان</p>
                </div>
            </a>
        </div>

        <!-- افزودن دسته‌بندی -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               data-toggle="modal-ajax"
               href="@Url.Action("AssignTaskCategoryToBranch", "BranchTaskCategory", new { area = "TaskingArea", branchId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-plus-circle text-warning"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن دسته‌بندی</p>
                </div>
            </a>
        </div>

        <!-- بازگشت -->
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("Index", "Branch")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-arrow-left text-secondary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">بازگشت</p>
                </div>
            </a>
        </div>
    </div>
    <!-- END Quick Actions -->
    <!-- دکمه‌های بخش‌های جزئیات - ردیف دوم (Tab Navigation) -->
    <div class="block block-rounded">
        <ul class="nav nav-tabs nav-tabs-block justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-info" data-bs-toggle="tab"
                        data-bs-target="#info-panel" type="button" role="tab">
                    <i class="fa fa-info-circle me-1"></i> اطلاعات پایه
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-users" data-bs-toggle="tab"
                        data-bs-target="#users-panel" type="button" role="tab">
                    <i class="fa fa-users me-1"></i> کاربران شعبه
                </button>
            </li>

            <!-- ⭐⭐⭐ تب افراد (اولویت اول) -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-contacts" data-bs-toggle="tab"
                        data-bs-target="#contacts-panel" type="button" role="tab">
                    <i class="fa fa-user text-success me-1"></i>
                    افراد
                    <span class="badge bg-success ms-1">@Model.BranchContacts.Count</span>
                </button>
            </li>

            <!-- ⭐⭐⭐ تب سازمان‌ها (اولویت دوم) -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-organizations" data-bs-toggle="tab"
                        data-bs-target="#organizations-panel" type="button" role="tab">
                    <i class="fa fa-building text-info me-1"></i>
                    سازمان‌ها
                    <span class="badge bg-info ms-1">@Model.BranchOrganizations.Count</span>
                </button>
            </li>


            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-categories" data-bs-toggle="tab"
                        data-bs-target="#categories-panel" type="button" role="tab">
                    <i class="fa fa-list-alt me-1"></i> دسته‌بندی تسک‌ها
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-stats" data-bs-toggle="tab"
                        data-bs-target="#stats-panel" type="button" role="tab">
                    <i class="fa fa-chart-bar me-1"></i> آمار و گزارشات
                </button>
            </li>

            <!-- ⭐⭐⭐ تب تنظیمات نمایش تسک -->
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-task-visibility" data-bs-toggle="tab"
                        data-bs-target="#task-visibility-panel" type="button" role="tab">
                    <i class="fa fa-eye-slash text-purple me-1"></i>
                    تنظیمات نمایش تسک
                    <span class="badge bg-purple ms-1">جدید</span>
                </button>
            </li>

        </ul>

        <div class="block-content tab-content">
            <!-- بخش اطلاعات پایه -->
            <div class="tab-pane active" id="info-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchBasicInfo", Model)
            </div>

            <!-- بخش کاربران -->
            <div class="tab-pane" id="users-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchUsers", Model)
            </div>

            <!-- ⭐⭐⭐ بخش افراد (سیستم جدید) -->
            <div class="tab-pane" id="contacts-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchContacts", Model.BranchContacts)
            </div>

            <!-- ⭐⭐⭐ بخش سازمان‌ها (سیستم جدید) -->
            <div class="tab-pane" id="organizations-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchOrganizations", Model.BranchOrganizations)
            </div>

            <!-- بخش شعبه‌های زیرمجموعه -->
            @if (Model.ChildBranches != null && Model.ChildBranches.Count > 0)
            {
                <div class="tab-pane" id="children-panel" role="tabpanel">
                    @await Html.PartialAsync("_BranchChildren", Model.ChildBranches)
                </div>
            }

            <!-- بخش دسته‌بندی تسک‌ها -->
            <div class="tab-pane" id="categories-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchTaskCategories", Model.Id)
            </div>

            <!-- بخش آمار -->
            <div class="tab-pane" id="stats-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchStats", Model)
            </div>

            <!-- ⭐⭐⭐ بخش تنظیمات نمایش تسک -->
            <div class="tab-pane" id="task-visibility-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchTaskVisibilitySettings", Model.Id)
            </div>

          
        </div>
    </div>
</div>
<!-- END Page Content -->
<!-- Modal Container -->
<div class="modal fade" id="modal-branch" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <h5 class="mt-3">در حال بارگذاری...</h5>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        $(document).ready(function() {
            // Tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

    
            // Reset modal content
            $('#modal-branch').on('hidden.bs.modal', function () {
                $(this).find('.modal-content').html(`
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <h5 class="mt-3">در حال بارگذاری...</h5>
                    </div>
                `);
            });

            // ⭐ نمایش آمار در کنسول (اختیاری)
            console.log('📊 آمار شعبه:');
            console.log('👤 تعداد افراد:', @Model.BranchContacts.Count);
            console.log('🏢 تعداد سازمان‌ها:', @Model.BranchOrganizations.Count);
        });
    </script>
}

@section Styles {
    <style>
        /* استایل برای تب منسوخ شده */
        #tab-stakeholders-old {
            opacity: 0.7;
            font-style: italic;
        }

            #tab-stakeholders-old:hover {
                opacity: 1;
            }

            #tab-stakeholders-old .badge {
                font-size: 0.65rem;
                vertical-align: middle;
            }

        /* تأکید بر تب‌های جدید */
        #tab-contacts .badge,
        #tab-organizations .badge {
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        /* استایل برای Alert منسوخ شده */
        #stakeholders-old-panel .alert-warning {
            border-left: 4px solid #ff9f43;
            background: linear-gradient(135deg, #fff7e6 0%, #ffe5cc 100%);
        }

        /* هایلایت دکمه‌های جدید */
        .nav-link[id^="tab-contacts"],
        .nav-link[id^="tab-organizations"] {
            position: relative;
        }

            .nav-link[id^="tab-contacts"].active,
            .nav-link[id^="tab-organizations"].active {
                background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            }

        /* افکت hover برای دکمه‌های Quick Action */
        .block-link-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
    </style>
}