@model MahERP.DataModelLayer.ViewModels.Core.NotificationViewModels.CoreNotificationStatsViewModel
@{
    ViewData["Title"] = "آمار نوتیفیکیشن‌ها";
    Layout = "~/Areas/AdminArea/Views/Shared/_Layout.cshtml";
}

<div class="content">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="content-heading">
                <i class="fa fa-chart-bar text-primary me-2"></i>
                آمار نوتیفیکیشن‌ها
            </h2>
            <p class="text-muted mb-0">نمایش آمار و گزارشات نوتیفیکیشن‌های دریافتی</p>
        </div>
        <div>
            <a href="@Url.Action("Index")" class="btn btn-alt-secondary">
                <i class="fa fa-arrow-right me-1"></i>
                بازگشت به نوتیفیکیشن‌ها
            </a>
        </div>
    </div>

    <!-- Filter Form -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-filter text-primary me-1"></i>
                فیلتر بازه زمانی
            </h3>
            <div class="block-options">
                <a href="@Url.Action("Index")" class="btn btn-sm btn-alt-secondary">
                    <i class="fa fa-arrow-right opacity-50 me-1"></i>
                    بازگشت به نوتیفیکیشن‌ها
                </a>
                <button type="button" class="btn btn-sm btn-alt-primary" onclick="window.print()">
                    <i class="fa fa-print opacity-50 me-1"></i>
                    چاپ گزارش
                </button>
            </div>
        </div>
        <div class="block-content">
            <!-- Filter Form -->
            <div class="row mb-4">
                <div class="col-12">
                    <form method="get" action="@Url.Action("Statistics")" class="row align-items-end">
                        <div class="col-md-4">
                            <label class="form-label" for="fromDate">از تاریخ:</label>
                            <input type="text" class="form-control persian-datepicker" id="fromDate" name="fromDate" value="@ViewBag.FromDate" placeholder="انتخاب تاریخ">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label" for="toDate">تا تاریخ:</label>
                            <input type="text" class="form-control persian-datepicker" id="toDate" name="toDate" value="@ViewBag.ToDate" placeholder="انتخاب تاریخ">
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-search me-1"></i>
                                اعمال فیلتر
                            </button>
                            <a href="@Url.Action("Statistics")" class="btn btn-alt-secondary">
                                <i class="fa fa-times me-1"></i>
                                حذف فیلتر
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Statistics Overview -->
            <div class="row mb-4">
                <!-- Total Notifications -->
                <div class="col-xl-3 col-md-6">
                    <div class="block block-rounded bg-primary-light">
                        <div class="block-content py-3">
                            <div class="fs-3 fw-bold text-primary text-center">@Model.TotalNotifications.ToString("N0")</div>
                            <div class="text-center">کل نوتیفیکیشن‌ها</div>
                        </div>
                    </div>
                </div>
                
                <!-- Unread Notifications -->
                <div class="col-xl-3 col-md-6">
                    <div class="block block-rounded bg-warning-light">
                        <div class="block-content py-3">
                            <div class="fs-3 fw-bold text-warning text-center">@Model.UnreadNotifications.ToString("N0")</div>
                            <div class="text-center">خوانده نشده</div>
                        </div>
                    </div>
                </div>
                
                <!-- Read Notifications -->
                <div class="col-xl-3 col-md-6">
                    <div class="block block-rounded bg-success-light">
                        <div class="block-content py-3">
                            <div class="fs-3 fw-bold text-success text-center">@Model.ReadNotifications.ToString("N0")</div>
                            <div class="text-center">خوانده شده</div>
                        </div>
                    </div>
                </div>
                
                <!-- Read Percentage -->
                <div class="col-xl-3 col-md-6">
                    <div class="block block-rounded bg-info-light">
                        <div class="block-content py-3">
                            <div class="fs-3 fw-bold text-info text-center">@Model.ReadPercentage.ToString("F1")%</div>
                            <div class="text-center">درصد خوانده شده</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Notifications by System -->
                @if (Model.NotificationsBySystem.Any())
                {
                    <div class="col-lg-6">
                        <div class="block block-rounded">
                            <div class="block-header block-header-default">
                                <h3 class="block-title">
                                    <i class="fa fa-cubes text-primary me-1"></i>
                                    نوتیفیکیشن‌ها بر اساس سیستم
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-vcenter">
                                        <thead>
                                            <tr>
                                                <th>سیستم</th>
                                                <th class="text-center">تعداد</th>
                                                <th class="text-center">درصد</th>
                                                <th class="text-center">خوانده نشده</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var system in Model.NotificationsBySystem.OrderByDescending(s => s.Count))
                                            {
                                                var percentage = Model.TotalNotifications > 0 ? (system.Count * 100.0 / Model.TotalNotifications) : 0;
                                                <tr>
                                                    <td>
                                                        <span class="fw-semibold">@system.SystemName</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary">@system.Count.ToString("N0")</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar" role="progressbar" style="width: @percentage%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                                                @percentage.ToString("F1")%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        @if (system.UnreadCount > 0)
                                                        {
                                                            <span class="badge bg-warning">@system.UnreadCount.ToString("N0")</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Notifications by Priority -->
                @if (Model.NotificationsByPriority.Any())
                {
                    <div class="col-lg-6">
                        <div class="block block-rounded">
                            <div class="block-header block-header-default">
                                <h3 class="block-title">
                                    <i class="fa fa-exclamation-triangle text-primary me-1"></i>
                                    نوتیفیکیشن‌ها بر اساس اولویت
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-vcenter">
                                        <thead>
                                            <tr>
                                                <th>اولویت</th>
                                                <th class="text-center">تعداد</th>
                                                <th class="text-center">درصد</th>
                                                <th class="text-center">خوانده نشده</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var priority in Model.NotificationsByPriority.OrderByDescending(p => p.Priority))
                                            {
                                                var percentage = Model.TotalNotifications > 0 ? (priority.Count * 100.0 / Model.TotalNotifications) : 0;
                                                var badgeClass = priority.Priority switch
                                                {
                                                    3 => "bg-danger",
                                                    2 => "bg-warning",
                                                    1 => "bg-info",
                                                    _ => "bg-secondary"
                                                };
                                                
                                                <tr>
                                                    <td>
                                                        <span class="badge @badgeClass">@priority.PriorityName</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="fw-semibold">@priority.Count.ToString("N0")</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar @badgeClass.Replace("bg-", "bg-")" role="progressbar" style="width: @percentage%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100">
                                                                @percentage.ToString("F1")%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        @if (priority.UnreadCount > 0)
                                                        {
                                                            <span class="badge bg-warning">@priority.UnreadCount.ToString("N0")</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Notifications by Type -->
            @if (Model.NotificationsByType.Any())
            {
                <div class="row">
                    <div class="col-lg-12">
                        <div class="block block-rounded">
                            <div class="block-header block-header-default">
                                <h3 class="block-title">
                                    <i class="fa fa-tags text-primary me-1"></i>
                                    نوتیفیکیشن‌ها بر اساس نوع
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped table-vcenter">
                                        <thead>
                                            <tr>
                                                <th>نوع نوتیفیکیشن</th>
                                                <th class="text-center">تعداد کل</th>
                                                <th class="text-center">خوانده شده</th>
                                                <th class="text-center">خوانده نشده</th>
                                                <th class="text-center">درصد خوانده شده</th>
                                                <th class="text-center">آخرین نوتیفیکیشن</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var type in Model.NotificationsByType.OrderByDescending(t => t.Count))
                                            {
                                                var readPercentage = type.Count > 0 ? (type.ReadCount * 100.0 / type.Count) : 0;
                                                <tr>
                                                    <td>
                                                        <span class="fw-semibold">@type.TypeName</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary">@type.Count.ToString("N0")</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-success">@type.ReadCount.ToString("N0")</span>
                                                    </td>
                                                    <td class="text-center">
                                                        @if (type.UnreadCount > 0)
                                                        {
                                                            <span class="badge bg-warning">@type.UnreadCount.ToString("N0")</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="progress" style="height: 20px;">
                                                            <div class="progress-bar bg-success" role="progressbar" style="width: @readPercentage%" aria-valuenow="@readPercentage" aria-valuemin="0" aria-valuemax="100">
                                                                @readPercentage.ToString("F1")%
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="text-center">
                                                        @if (type.LastNotificationDate.HasValue)
                                                        {
                                                            <small class="text-muted">
                                                                @ConvertDateTime.ConvertMiladiToShamsi(type.LastNotificationDate.Value, "yyyy/MM/dd HH:mm")
                                                            </small>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Daily Activity Chart -->
            @if (Model.DailyActivity.Any())
            {
                <div class="row">
                    <div class="col-lg-12">
                        <div class="block block-rounded">
                            <div class="block-header block-header-default">
                                <h3 class="block-title">
                                    <i class="fa fa-chart-line text-primary me-1"></i>
                                    فعالیت روزانه نوتیفیکیشن‌ها
                                </h3>
                            </div>
                            <div class="block-content">
                                <canvas id="dailyActivityChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Export Options -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-download text-primary me-1"></i>
                                گزارش‌گیری
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="text-muted">دانلود گزارش آمار نوتیفیکیشن‌ها در فرمت‌های مختلف:</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-alt-success" onclick="exportToPdf()">
                                            <i class="fa fa-file-pdf me-1"></i>
                                            PDF
                                        </button>
                                        <button type="button" class="btn btn-alt-primary" onclick="exportToExcel()">
                                            <i class="fa fa-file-excel me-1"></i>
                                            Excel
                                        </button>
                                        <button type="button" class="btn btn-alt-secondary" onclick="window.print()">
                                            <i class="fa fa-print me-1"></i>
                                            چاپ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (!Model.NotificationsBySystem.Any() && !Model.NotificationsByPriority.Any() && !Model.NotificationsByType.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fa fa-chart-bar fa-3x text-muted"></i>
                    </div>
                    <h4 class="h5 text-muted">هیچ داده‌ای برای نمایش وجود ندارد</h4>
                    <p class="text-muted">در بازه زمانی انتخاب شده نوتیفیکیشنی یافت نشد.</p>
                    <a href="@Url.Action("Statistics")" class="btn btn-alt-primary">
                        <i class="fa fa-refresh me-1"></i>
                        نمایش کل آمار
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js for daily activity chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Daily Activity Chart
        @if (Model.DailyActivity.Any())
        {
            <text>
            const dailyActivityData = @Html.Raw(Json.Serialize(Model.DailyActivity.Select(d => new { 
                date = ConvertDateTime.ConvertMiladiToShamsi(d.Date, "MM/dd"),
                count = d.Count
            })));

            const ctx = document.getElementById('dailyActivityChart').getContext('2d');
            const dailyActivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyActivityData.map(d => d.date),
                    datasets: [{
                        label: 'تعداد نوتیفیکشن‌ها',
                        data: dailyActivityData.map(d => d.count),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            </text>
        }

        // Export functions
        function exportToPdf() {
            window.print(); // Simple implementation, can be enhanced with jsPDF
        }

        function exportToExcel() {
            // Simple CSV export (can be enhanced with actual Excel export)
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "سیستم,تعداد,خوانده نشده\n";
            
            @foreach (var system in Model.NotificationsBySystem)
            {
                <text>csvContent += "@system.SystemName,@system.Count,@system.UnreadCount\n";</text>
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "notification_stats.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize Persian Date Picker
        $(document).ready(function() {
            if (typeof $.fn.persianDatepicker !== 'undefined') {
                $('.persian-datepicker').persianDatepicker({
                    format: 'YYYY/MM/DD',
                    calendarType: 'persian',
                    autoClose: true,
                    navigator: {
                        enabled: true
                    }
                });
            }
        });
    </script>

    <style>
        .block-link-shadow {
            transition: all 0.3s ease;
        }

        .block-link-shadow:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .progress {
            border-radius: 0.375rem;
            overflow: hidden;
        }

        .progress-bar {
            transition: width 0.6s ease;
        }

        @@media print {
            .btn, .block-options, .no-print {
                display: none !important;
            }
            
            .block {
                break-inside: avoid;
            }
        }

        .bg-primary-light {
            background-color: rgba(13, 110, 253, 0.1) !important;
        }

        .bg-warning-light {
            background-color: rgba(255, 193, 7, 0.1) !important;
        }

        .bg-success-light {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }

        .bg-info-light {
            background-color: rgba(13, 202, 240, 0.1) !important;
        }
    </style>
}