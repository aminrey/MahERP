@model MahERP.DataModelLayer.ViewModels.Notifications.NotificationTemplateFormViewModel
@{
    ViewData["Title"] = "ویرایش الگو";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-edit text-warning me-2"></i>ویرایش الگوی پیام
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-area="AppCoreArea" asp-controller="Dashboard" asp-action="Index">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-action="Index" asp-controller="NotificationTemplates">الگوها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">ویرایش</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <form id="templateForm" asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />

        <!-- یادداشت تغییرات -->
        <div class="block block-rounded">
            <div class="block-content">
                <div class="alert alert-warning d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <p class="mb-2">
                            <strong>توجه:</strong> با ویرایش این الگو، نسخه جدیدی ایجاد می‌شود.
                        </p>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fa fa-sticky-note"></i>
                            </span>
                            <input type="text" class="form-control" name="changeNote" 
                                   placeholder="یادداشت تغییرات (اختیاری) - مثال: بروزرسانی متن پیام">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- فرم اصلی -->
            <div class="col-lg-8">
                <!-- اطلاعات پایه -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-info-circle text-primary me-2"></i>اطلاعات پایه
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="row">
                            <!-- ⭐⭐⭐ نوع اعلان -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="NotificationEventType">
                                    نوع اعلان <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" asp-for="NotificationEventType" id="notificationTypeSelect">
                                    <option value="">انتخاب کنید...</option>
                                    @foreach (var item in Model.AvailableNotificationTypes)
                                    {
                                        <option value="@item.Id" 
                                                data-schedulable="@item.IsSchedulable.ToString().ToLower()"
                                                selected="@(Model.NotificationEventType == item.Id)">
                                            @item.Name
                                            @if (item.IsSchedulable)
                                            {
                                                <text> ⏰</text>
                                            }
                                        </option>
                                    }
                                </select>
                                <span asp-validation-for="NotificationEventType" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    اعلان‌های با نماد ⏰ قابل زمان‌بندی هستند
                                </small>
                            </div>

                            <!-- ⭐⭐⭐ کانال ارسال -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="Channel">
                                    کانال ارسال <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" asp-for="Channel" id="ChannelSelect">
                                    <option value="">انتخاب کنید...</option>
                                    <option value="0">📱 سیستمی (درون برنامه)</option>
                                    <option value="1">📧 ایمیل</option>
                                    <option value="2">💬 پیامک</option>
                                    <option value="3">✈️ تلگرام</option>
                                </select>
                                <span asp-validation-for="Channel" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="TemplateCode">
                                    کد الگو <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="TemplateCode" 
                                       placeholder="مثال: TASK_ASSIGNED_EMAIL">
                                <span asp-validation-for="TemplateCode" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="TemplateName">
                                    نام الگو <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="TemplateName" 
                                       placeholder="مثال: اعلان تخصیص تسک (ایمیل)">
                                <span asp-validation-for="TemplateName" class="text-danger"></span>
                            </div>

                            <div class="col-12 mb-3">
                                <label class="form-label" asp-for="Description">توضیحات</label>
                                <textarea class="form-control" asp-for="Description" rows="2" 
                                          placeholder="توضیحات کوتاه درباره کاربرد این الگو..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <!-- موضوع (فقط برای ایمیل) -->
                            <div class="col-12 mb-3" id="subjectField" style="display: none;">
                                <label class="form-label" asp-for="Subject">
                                    موضوع (Subject) <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="Subject" 
                                       placeholder="می‌توانید از متغیرها استفاده کنید: {{UserName}}">
                                <span asp-validation-for="Subject" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- محتوای الگو -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-file-code text-info me-2"></i>محتوای الگو
                        </h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-alt-secondary" id="insertVariableBtn">
                                <i class="fa fa-plus-circle me-1"></i>درج متغیر
                            </button>
                        </div>
                    </div>
                    <div class="block-content">
                        <!-- ⭐⭐⭐ محتوای متنی (تغییر از Body به MessageTemplate) -->
                        <div class="mb-3">
                            <label class="form-label" asp-for="MessageTemplate">
                                محتوای متنی <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" asp-for="MessageTemplate" rows="6" 
                                      id="bodyTextarea"
                                      placeholder="محتوای متنی الگو... می‌توانید از متغیرها استفاده کنید: {{VariableName}}"></textarea>
                            <span asp-validation-for="MessageTemplate" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای درج متغیر از فرمت {{نام_متغیر}} استفاده کنید
                            </small>
                        </div>

                        <!-- محتوای HTML (فقط برای ایمیل) -->
                        <div class="mb-3" id="htmlEditorField" style="display: none;">
                            <label class="form-label" asp-for="BodyHtml">
                                محتوای HTML (اختیاری)
                            </label>
                            <textarea asp-for="BodyHtml" id="htmlBodyEditor"></textarea>
                            <span asp-validation-for="BodyHtml" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای ایمیل HTML از ویرایشگر بالا استفاده کنید
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ⭐⭐⭐ دریافت‌کنندگان -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-users text-success me-2"></i>دریافت‌کنندگان
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="mb-3">
                            <label class="form-label">حالت دریافت‌کنندگان</label>
                            <select class="form-select" asp-for="RecipientMode" id="recipientModeSelect">
                                <option value="0">همه کاربران</option>
                                <option value="1">فقط کاربران مشخص</option>
                                <option value="2">همه به جز کاربران مشخص</option>
                            </select>
                        </div>

                        <div id="recipientUsersField" style="display: none;">
                            <label class="form-label">انتخاب کاربران</label>
                            <select class="form-select" multiple asp-for="SelectedUserIds" size="8">
                                @foreach (var user in Model.AvailableUsers)
                                {
                                    var isSelected = Model.SelectedUserIds?.Contains(user.Id) == true;

    if (isSelected)
    {
                                                             <option value="@user.Id" selected>
                                        @user.FullName (@user.Email)
                                    </option>
                                            }
                                            else
                                            {
                                        <option value="@user.Id" >
                                            @user.FullName (@user.Email)
                                        </option>
                                            }


                                }
                            </select>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای انتخاب چند کاربر، Ctrl را فشرده نگه دارید
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ⭐⭐⭐ تنظیمات زمان‌بندی -->
                <div class="block block-rounded" id="schedulingBlock" style="display: none;">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-clock text-warning me-2"></i>تنظیمات زمان‌بندی (اختیاری)
                        </h3>
                    </div>
                    <div class="block-content">
                        <!-- فعال/غیرفعال زمان‌بندی -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="IsScheduled" id="isScheduledSwitch">
                                <label class="form-check-label" for="isScheduledSwitch">
                                    <strong>فعال‌سازی زمان‌بندی خودکار</strong>
                                    <div class="fs-xs text-muted">برای اعلان‌های دوره‌ای مثل گزارش روزانه</div>
                                </label>
                            </div>
                        </div>

                        <div id="scheduleSettingsFields" style="display: none;">
                            <!-- نوع زمان‌بندی -->
                            <div class="mb-3">
                                <label class="form-label">نوع زمان‌بندی <span class="text-danger">*</span></label>
                                <select class="form-select" asp-for="ScheduleType" id="scheduleTypeSelect">
                                    <option value="0">دستی (بدون زمان‌بندی)</option>
                                    <option value="1">روزانه</option>
                                    <option value="2">هفتگی</option>
                                    <option value="3">ماهانه</option>
                                </select>
                            </div>

                            <!-- ساعت اجرا -->
                            <div class="mb-3">
                                <label class="form-label">ساعت اجرا <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" asp-for="ScheduledTime" placeholder="مثال: 08:00">
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    ساعت اجرای روزانه (24 ساعته)
                                </small>
                            </div>

                            <!-- روزهای هفته (فقط برای هفتگی) -->
                            <div class="mb-3" id="daysOfWeekField" style="display: none;">
                                <label class="form-label">روزهای اجرا</label>
                                @{
                                    var selectedDays = Model.ScheduledDaysOfWeek?.Split(',', StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
                                }
                                <div class="btn-group-vertical w-100" role="group">
                                    <input type="checkbox" class="btn-check" id="day0" name="ScheduledDays" value="0" @(selectedDays.Contains("0") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day0">یکشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day1" name="ScheduledDays" value="1" @(selectedDays.Contains("1") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day1">دوشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day2" name="ScheduledDays" value="2" @(selectedDays.Contains("2") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day2">سه‌شنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day3" name="ScheduledDays" value="3" @(selectedDays.Contains("3") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day3">چهارشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day4" name="ScheduledDays" value="4" @(selectedDays.Contains("4") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day4">پنج‌شنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day5" name="ScheduledDays" value="5" @(selectedDays.Contains("5") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day5">جمعه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day6" name="ScheduledDays" value="6" @(selectedDays.Contains("6") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day6">شنبه</label>
                                </div>
                                <input type="hidden" asp-for="ScheduledDaysOfWeek" id="scheduledDaysOfWeekHidden">
                            </div>

                            <!-- روز ماه (فقط برای ماهانه) -->
                            <div class="mb-3" id="dayOfMonthField" style="display: none;">
                                <label class="form-label">روز ماه</label>
                                <input type="number" class="form-control" asp-for="ScheduledDayOfMonth" 
                                       min="1" max="31" placeholder="مثال: 1 یا 15">
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    روز ماه برای اجرا (1 تا 31)
                                </small>
                            </div>

                            @if (Model.LastExecutionDate.HasValue)
                            {
                                <div class="alert alert-success">
                                    <i class="fa fa-check-circle me-1"></i>
                                    <strong>آخرین اجرا:</strong> @Model.LastExecutionDate.Value.ToString("yyyy/MM/dd HH:mm")
                                </div>
                            }

                            @if (Model.NextExecutionDate.HasValue)
                            {
                                <div class="alert alert-info">
                                    <i class="fa fa-calendar me-1"></i>
                                    <strong>اجرای بعدی:</strong> @Model.NextExecutionDate.Value.ToString("yyyy/MM/dd HH:mm")
                                </div>
                            }

                            <!-- پیش‌نمایش -->
                            <div class="alert alert-warning">
                                <i class="fa fa-calendar me-1"></i>
                                <strong>پیش‌نمایش:</strong>
                                <div id="schedulePreview">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - متغیرها -->
            <div class="col-lg-4">
                <!-- وضعیت -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">وضعیت</h3>
                    </div>
                    <div class="block-content">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" asp-for="IsActive" id="isActiveSwitch">
                            <label class="form-check-label" for="isActiveSwitch">
                                الگو فعال است
                            </label>
                        </div>
                    </div>
                </div>

                <!-- متغیرهای سیستمی -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-code text-success me-2"></i>متغیرهای قابل استفاده
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="alert alert-info">
                            <i class="fa fa-lightbulb me-1"></i>
                            <strong>راهنما:</strong> ابتدا نوع اعلان را انتخاب کنید تا متغیرهای مرتبط نمایش داده شوند
                        </div>

                        <!-- ⭐⭐⭐ متغیرها با دسته‌بندی -->
                        <div id="variablesContainer">
                            <!-- پیام اولیه -->
                            <div id="noEventTypeSelected" class="text-center text-muted py-4">
                                <i class="fa fa-info-circle fa-2x mb-2"></i>
                                <p>لطفاً ابتدا نوع اعلان را انتخاب کنید</p>
                            </div>

                            <!-- لیست متغیرها (پویا بر اساس EventType) -->
                            <div id="variablesList" style="display: none;">
                                <!-- ⭐ دسته‌بندی‌ها به صورت Accordion -->
                                <div class="accordion" id="variablesAccordion">
                                    <!-- متغیرهای عمومی -->
                                    <div class="accordion-item category-General" style="display: none;">
                                        <h2 class="accordion-header" id="headingGeneral">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseGeneral">
                                                <i class="fa fa-calendar-alt me-2 text-primary"></i>
                                                متغیرهای عمومی
                                            </button>
                                        </h2>
                                        <div id="collapseGeneral" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="General"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای کاربر دریافت‌کننده -->
                                    <div class="accordion-item category-Recipient" style="display: none;">
                                        <h2 class="accordion-header" id="headingRecipient">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseRecipient">
                                                <i class="fa fa-user me-2 text-info"></i>
                                                اطلاعات گیرنده
                                            </button>
                                        </h2>
                                        <div id="collapseRecipient" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Recipient"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای تسک -->
                                    <div class="accordion-item category-Task" style="display: none;">
                                        <h2 class="accordion-header" id="headingTask">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseTask">
                                                <i class="fa fa-tasks me-2 text-success"></i>
                                                اطلاعات تسک
                                            </button>
                                        </h2>
                                        <div id="collapseTask" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Task"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای ارسال‌کننده -->
                                    <div class="accordion-item category-Sender" style="display: none;">
                                        <h2 class="accordion-header" id="headingSender">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseSender">
                                                <i class="fa fa-paper-plane me-2 text-warning"></i>
                                                اطلاعات ارسال‌کننده
                                            </button>
                                        </h2>
                                        <div id="collapseSender" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Sender"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- لیست تسک‌ها -->
                                    <div class="accordion-item category-TaskList" style="display: none;">
                                        <h2 class="accordion-header" id="headingTaskList">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseTaskList">
                                                <i class="fa fa-list me-2 text-purple"></i>
                                                لیست تسک‌ها
                                            </button>
                                        </h2>
                                        <div id="collapseTaskList" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="TaskList"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای کامنت -->
                                    <div class="accordion-item category-Comment" style="display: none;">
                                        <h2 class="accordion-header" id="headingComment">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseComment">
                                                <i class="fa fa-comment me-2 text-primary"></i>
                                                متغیرهای کامنت
                                            </button>
                                        </h2>
                                        <div id="collapseComment" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Comment"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای گزارش کار -->
                                    <div class="accordion-item category-WorkLog" style="display: none;">
                                        <h2 class="accordion-header" id="headingWorkLog">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseWorkLog">
                                                <i class="fa fa-clock me-2 text-info"></i>
                                                متغیرهای گزارش کار
                                            </button>
                                        </h2>
                                        <div id="collapseWorkLog" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="WorkLog"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای تکمیل -->
                                    <div class="accordion-item category-Completion" style="display: none;">
                                        <h2 class="accordion-header" id="headingCompletion">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseCompletion">
                                                <i class="fa fa-check-circle me-2 text-success"></i>
                                                متغیرهای تکمیل
                                            </button>
                                        </h2>
                                        <div id="collapseCompletion" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Completion"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای اولویت -->
                                    <div class="accordion-item category-Priority" style="display: none;">
                                        <h2 class="accordion-header" id="headingPriority">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapsePriority">
                                                <i class="fa fa-exclamation-triangle me-2 text-warning"></i>
                                                متغیرهای اولویت
                                            </button>
                                        </h2>
                                        <div id="collapsePriority" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Priority"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای وضعیت -->
                                    <div class="accordion-item category-Status" style="display: none;">
                                        <h2 class="accordion-header" id="headingStatus">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseStatus">
                                                <i class="fa fa-flag me-2 text-danger"></i>
                                                متغیرهای وضعیت
                                            </button>
                                        </h2>
                                        <div id="collapseStatus" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="Status"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- متغیرهای یادآوری -->
                                    <div class="accordion-item category-ReminderSchedule" style="display: none;">
                                        <h2 class="accordion-header" id="headingReminder">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" data-bs-target="#collapseReminder">
                                                <i class="fa fa-bell me-2 text-warning"></i>
                                                متغیرهای یادآوری
                                            </button>
                                        </h2>
                                        <div id="collapseReminder" class="accordion-collapse collapse" 
                                             data-bs-parent="#variablesAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush" data-category="ReminderSchedule"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                               
                            </div>
                        </div>

                        <!-- ⭐⭐⭐ داده‌های JSON متغیرها برای جاوا اسکریپت -->
                        <script id="allVariablesData" type="application/json">
                            @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SystemVariables))
                        </script>
                    </div>
                </div>

                <!-- دکمه‌های عملیات -->
                <div class="block block-rounded">
                    <div class="block-content">
                        <button type="submit" class="btn btn-warning w-100 mb-2" id="saveTemplateBtn">
                            <i class="fa fa-save me-1"></i>بروزرسانی الگو
                        </button>
                        <a asp-action="Preview" asp-route-id="@Model.Id" target="_blank" class="btn btn-alt-info w-100 mb-2">
                            <i class="fa fa-eye me-1"></i>پیش‌نمایش
                        </a>
                        <a asp-action="History" asp-route-id="@Model.Id" class="btn btn-alt-secondary w-100 mb-2">
                            <i class="fa fa-history me-1"></i>تاریخچه تغییرات
                        </a>
                        <a asp-action="Index" class="btn btn-alt-secondary w-100">
                            <i class="fa fa-times me-1"></i>انصراف
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<!-- END Page Content -->

@section Styles {
    <link rel="stylesheet" href="~/css/notification-templates.css" />
}

@section Scripts {
    <script src="~/assets/js/tinymceConfig.js"></script>
    <script src="~/js/notification-templates.js"></script>
    <script>
        $(document).ready(function() {
            initializeTemplateForm(true);

            let allVariablesData = [];

            const categoryNames = {
                0: 'General',
                1: 'Recipient',
                2: 'Task',
                3: 'TaskList',
                4: 'Sender',
                5: 'ReminderSchedule',
                6: 'Comment',
                7: 'WorkLog',
                8: 'Completion',
                9: 'Priority',
                10: 'Status'
            };

            window.filterAndDisplayVariables = async function(eventType) {
                console.log('🔍 Filtering variables for EventType:', eventType);

                if (!eventType) {
                    $('#noEventTypeSelected').show();
                    $('#variablesList').hide();
                    return;
                }

                // ⭐ همیشه متغیرها را از API دوباره بگیر
                try {
                    const response = await $.ajax({
                        url: `/AppCoreArea/NotificationTemplates/GetVariablesForEventType?eventType=${eventType}`,
                        type: 'GET'
                    });

                    if (response.success) {
                        allVariablesData = response.variables;
                        console.log('📡 Variables loaded from API for EventType', eventType, ':', allVariablesData);

                        if (allVariablesData.length > 0) {
                            console.log('🔍 First Variable:', allVariablesData[0]);
                        }
                    } else {
                        console.error('❌ Failed to load variables:', response.message);
                        return;
                    }
                } catch (error) {
                    console.error('❌ Error loading variables:', error);
                    return;
                }

                $('#noEventTypeSelected').hide();
                $('#variablesList').show();

                $('.list-group[data-category]').empty();
                $('.accordion-item').hide();

                const categorizedVariables = {};

                allVariablesData.forEach(variable => {
                    if (variable.categories || variable.Categories) {
                        const categories = variable.categories || variable.Categories || [];
                        categories.forEach(catId => {
                            const catName = categoryNames[catId];
                            if (catName) {
                                if (!categorizedVariables[catName]) {
                                    categorizedVariables[catName] = [];
                                }
                                categorizedVariables[catName].push(variable);
                            }
                        });
                    } else {
                        console.warn('⚠️ Variable missing Categories:', variable);
                    }
                });

                console.log('📂 Categorized Variables:', categorizedVariables);

                Object.keys(categorizedVariables).forEach(category => {
                    const variables = categorizedVariables[category];
                    const $container = $(`.list-group[data-category="${category}"]`);

                    if (variables.length > 0) {
                        $(`.category-${category}`).show();

                        variables.forEach(variable => {
                            const varName = variable.variableName || variable.VariableName;
                            const displayName = variable.displayName || variable.DisplayName;
                            const description = variable.description || variable.Description || '';
                            const exampleValue = variable.exampleValue || variable.ExampleValue;

                            const $item = $(`
                                <button type="button"
                                        class="list-group-item list-group-item-action variable-item"
                                        data-variable-name="${varName}"
                                        title="${description}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <strong class="text-primary">{{${varName}}}</strong>
                                            <div class="fs-xs text-muted">${displayName}</div>
                                            ${exampleValue ? `<div class="fs-xs text-secondary"><em>مثال: ${exampleValue}</em></div>` : ''}
                                        </div>
                                        <i class="fa fa-copy text-primary ms-2"></i>
                                    </div>
                                </button>
                            `);

                            $container.append($item);
                        });
                    }
                });

                $('.variable-item').off('click').on('click', function() {
                    const varName = $(this).data('variable-name');
                    insertVariableToTextarea(varName);
                });
            };

            function insertVariableToTextarea(variableName) {
                const $textarea = $('#bodyTextarea');
                const cursorPos = $textarea[0].selectionStart;
                const textBefore = $textarea.val().substring(0, cursorPos);
                const textAfter = $textarea.val().substring(cursorPos);

                const variableText = `{{${variableName}}}`;
                $textarea.val(textBefore + variableText + textAfter);

                const newPos = cursorPos + variableText.length;
                $textarea[0].setSelectionRange(newPos, newPos);
                $textarea.focus();

                if (typeof NotificationHelper !== 'undefined') {
                    NotificationHelper.success(`متغیر {{${variableName}}} درج شد`);
                } else {
                    console.log(`✅ Variable {{${variableName}}} inserted`);
                }
            }

            $('#insertVariableBtn').on('click', function() {
                $('#variablesAccordion .accordion-collapse:first').collapse('show');
            });

            function updateConditionalFields() {
                const Channel = parseInt($('#ChannelSelect').val());

                if (Channel === 1) {
                    $('#subjectField').slideDown();
                    $('#htmlEditorField').slideDown();
                } else {
                    $('#subjectField').slideUp();
                    $('#htmlEditorField').slideUp();
                }
            }

            function updateRecipientFields() {
                const mode = parseInt($('#recipientModeSelect').val());

                if (mode === 1 || mode === 2) {
                    $('#recipientUsersField').slideDown();
                } else {
                    $('#recipientUsersField').slideUp();
                }
            }

            $('#ChannelSelect').on('change', updateConditionalFields);
            $('#recipientModeSelect').on('change', updateRecipientFields);

            updateConditionalFields();
            updateRecipientFields();

            // ⭐ Trigger اولیه برای نمایش متغیرها
            const initialEventType = parseInt($('#notificationTypeSelect').val());
            if (initialEventType) {
                console.log('🔄 Initial trigger for notificationTypeSelect:', initialEventType);
                filterAndDisplayVariables(initialEventType);
            }

            $('#isScheduledSwitch').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#scheduleSettingsFields').slideDown();
                } else {
                    $('#scheduleSettingsFields').slideUp();
                }
            });

            $('#scheduleTypeSelect').on('change', function() {
                const scheduleType = parseInt($(this).val());

                $('#daysOfWeekField').hide();
                $('#dayOfMonthField').hide();

                if (scheduleType === 2) {
                    $('#daysOfWeekField').slideDown();
                } else if (scheduleType === 3) {
                    $('#dayOfMonthField').slideDown();
                }

                updateSchedulePreview();
            });

            function updateSchedulePreview() {
                const scheduleType = parseInt($('#scheduleTypeSelect').val());
                const time = $('#ScheduledTime').val() || '08:00';

                let preview = '';

                switch(scheduleType) {
                    case 1:
                        preview = `هر روز ساعت ${time}`;
                        break;
                    case 2:
                        const selectedDays = [];
                        $('input[name="ScheduledDays"]:checked').each(function() {
                            const dayNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
                            selectedDays.push(dayNames[parseInt($(this).val())]);
                        });
                        preview = selectedDays.length > 0
                            ? `هر ${selectedDays.join('، ')} ساعت ${time}`
                            : 'لطفاً روزهای هفته را انتخاب کنید';
                        break;
                    case 3:
                        const dayOfMonth = $('#ScheduledDayOfMonth').val();
                        preview = dayOfMonth
                            ? `هر ماه روز ${dayOfMonth} ساعت ${time}`
                            : 'لطفاً روز ماه را وارد کنید';
                        break;
                    default:
                        preview = 'دستی (بدون زمان‌بندی)';
                }

                $('#schedulePreview').text(preview);
            }

            $('input[name="ScheduledDays"]').on('change', function() {
                const selectedDays = [];
                $('input[name="ScheduledDays"]:checked').each(function() {
                    selectedDays.push($(this).val());
                });
                $('#scheduledDaysOfWeekHidden').val(selectedDays.join(','));
                updateSchedulePreview();
            });

            $('#ScheduledTime, #ScheduledDayOfMonth').on('change', updateSchedulePreview);

            if ($('#isScheduledSwitch').is(':checked')) {
                $('#scheduleSettingsFields').show();
            }
            $('#scheduleTypeSelect').trigger('change');
            updateSchedulePreview();
        });
    </script>
}