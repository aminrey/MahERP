@model MahERP.DataModelLayer.ViewModels.Notifications.NotificationTemplateFormViewModel
@{
    ViewData["Title"] = "ویرایش الگو";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-edit text-warning me-2"></i>ویرایش الگوی پیام
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-area="AppCoreArea" asp-controller="Dashboard" asp-action="Index">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-action="Index" asp-controller="NotificationTemplates">الگوها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">ویرایش</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <form id="templateForm" asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />

        <!-- یادداشت تغییرات -->
        <div class="block block-rounded">
            <div class="block-content">
                <div class="alert alert-warning d-flex align-items-center">
                    <div class="flex-shrink-0">
                        <i class="fa fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <p class="mb-2">
                            <strong>توجه:</strong> با ویرایش این الگو، نسخه جدیدی ایجاد می‌شود.
                        </p>
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fa fa-sticky-note"></i>
                            </span>
                            <input type="text" class="form-control" name="changeNote" 
                                   placeholder="یادداشت تغییرات (اختیاری) - مثال: بروزرسانی متن پیام">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- فرم اصلی -->
            <div class="col-lg-8">
                <!-- اطلاعات پایه -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-info-circle text-primary me-2"></i>اطلاعات پایه
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="row">
                            <!-- ⭐⭐⭐ نوع اعلان -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="NotificationEventType">
                                    نوع اعلان <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" asp-for="NotificationEventType" id="notificationTypeSelect">
                                    <option value="">انتخاب کنید...</option>
                                    @foreach (var item in Model.AvailableNotificationTypes)
                                    {
                                        var isSelected = Model.NotificationEventType == item.Id;
                                        
                                        if (isSelected)
                                        {
                                            <option selected value="@item.Id" data-schedulable="@item.IsSchedulable.ToString().ToLower()">
                                                @item.DisplayName
                                                @if (item.IsSchedulable)
                                                {
                                                    <text> ⏰</text>
                                                }
                                            </option>
                                        }
                                        else
                                        {
                                            <option value="@item.Id" data-schedulable="@item.IsSchedulable.ToString().ToLower()">
                                                @item.DisplayName
                                                @if (item.IsSchedulable)
                                                {
                                                    <text> ⏰</text>
                                                }
                                            </option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="NotificationEventType" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    اعلان‌های با نماد ⏰ قابل زمان‌بندی هستند
                                </small>
                            </div>

                            <!-- ⭐⭐⭐ کانال ارسال -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="Channel">
                                    کانال ارسال <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" asp-for="Channel" id="ChannelSelect">
                                    <option value="">انتخاب کنید...</option>
                                    <option value="0">سیستمی (درون برنامه)</option>
                                    <option value="1">ایمیل</option>
                                    <option value="2">پیامک</option>
                                    <option value="3">تلگرام</option>
                                </select>
                                <span asp-validation-for="Channel" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="TemplateCode">
                                    کد الگو <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="TemplateCode" 
                                       placeholder="مثال: TASK_ASSIGNED_EMAIL">
                                <span asp-validation-for="TemplateCode" class="text-danger"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label" asp-for="TemplateName">
                                    نام الگو <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="TemplateName" 
                                       placeholder="مثال: اعلان تخصیص تسک (ایمیل)">
                                <span asp-validation-for="TemplateName" class="text-danger"></span>
                            </div>

                            <div class="col-12 mb-3">
                                <label class="form-label" asp-for="Description">توضیحات</label>
                                <textarea class="form-control" asp-for="Description" rows="2" 
                                          placeholder="توضیحات کوتاه درباره کاربرد این الگو..."></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <!-- موضوع (فقط برای ایمیل) -->
                            <div class="col-12 mb-3" id="subjectField" style="display: none;">
                                <label class="form-label" asp-for="Subject">
                                    موضوع (Subject) <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" asp-for="Subject" 
                                       placeholder="می‌توانید از متغیرها استفاده کنید: {{UserName}}">
                                <span asp-validation-for="Subject" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- محتوای الگو -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-file-code text-info me-2"></i>محتوای الگو
                        </h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-alt-secondary" id="insertVariableBtn">
                                <i class="fa fa-plus-circle me-1"></i>درج متغیر
                            </button>
                        </div>
                    </div>
                    <div class="block-content">
                        <!-- محتوای متنی (برای همه) -->
                        <div class="mb-3">
                            <label class="form-label" asp-for="Body">
                                محتوای متنی <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" asp-for="Body" rows="6" 
                                      id="bodyTextarea"
                                      placeholder="محتوای متنی الگو... می‌توانید از متغیرها استفاده کنید: {{VariableName}}"></textarea>
                            <span asp-validation-for="Body" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای درج متغیر از فرمت {{نام_متغیر}} استفاده کنید
                            </small>
                        </div>

                        <!-- محتوای HTML (فقط برای ایمیل) -->
                        <div class="mb-3" id="htmlEditorField" style="display: none;">
                            <label class="form-label" asp-for="BodyHtml">
                                محتوای HTML (اختیاری)
                            </label>
                            <textarea asp-for="BodyHtml" id="htmlBodyEditor"></textarea>
                            <span asp-validation-for="BodyHtml" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای ایمیل HTML از ویرایشگر بالا استفاده کنید
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ⭐⭐⭐ دریافت‌کنندگان -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-users text-success me-2"></i>دریافت‌کنندگان
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="mb-3">
                            <label class="form-label">حالت دریافت‌کنندگان</label>
                            <select class="form-select" asp-for="RecipientMode" id="recipientModeSelect">
                                <option value="0">همه کاربران</option>
                                <option value="1">فقط کاربران مشخص</option>
                                <option value="2">همه به جز کاربران مشخص</option>
                            </select>
                        </div>

                        <div id="recipientUsersField" style="display: none;">
                            <label class="form-label">انتخاب کاربران</label>
                            <select class="form-select" multiple asp-for="SelectedUserIds" size="8">
                                @foreach (var user in Model.AvailableUsers)
                                {
                                    var isSelected = Model.SelectedUserIds?.Contains(user.Id) == true;

    if (isSelected)
    {
                                                             <option value="@user.Id" selected>
                                        @user.FullName (@user.Email)
                                    </option>
                                            }
                                            else
                                            {
                                        <option value="@user.Id" >
                                            @user.FullName (@user.Email)
                                        </option>
                                            }


                                }
                            </select>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                برای انتخاب چند کاربر، Ctrl را فشرده نگه دارید
                            </small>
                        </div>
                    </div>
                </div>

                <!-- ⭐⭐⭐ تنظیمات زمان‌بندی -->
                <div class="block block-rounded" id="schedulingBlock" style="display: none;">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-clock text-warning me-2"></i>تنظیمات زمان‌بندی (اختیاری)
                        </h3>
                    </div>
                    <div class="block-content">
                        <!-- فعال/غیرفعال زمان‌بندی -->
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" asp-for="IsScheduled" id="isScheduledSwitch">
                                <label class="form-check-label" for="isScheduledSwitch">
                                    <strong>فعال‌سازی زمان‌بندی خودکار</strong>
                                    <div class="fs-xs text-muted">برای اعلان‌های دوره‌ای مثل گزارش روزانه</div>
                                </label>
                            </div>
                        </div>

                        <div id="scheduleSettingsFields" style="display: none;">
                            <!-- نوع زمان‌بندی -->
                            <div class="mb-3">
                                <label class="form-label">نوع زمان‌بندی <span class="text-danger">*</span></label>
                                <select class="form-select" asp-for="ScheduleType" id="scheduleTypeSelect">
                                    <option value="0">دستی (بدون زمان‌بندی)</option>
                                    <option value="1">روزانه</option>
                                    <option value="2">هفتگی</option>
                                    <option value="3">ماهانه</option>
                                </select>
                            </div>

                            <!-- ساعت اجرا -->
                            <div class="mb-3">
                                <label class="form-label">ساعت اجرا <span class="text-danger">*</span></label>
                                <input type="time" class="form-control" asp-for="ScheduledTime" placeholder="مثال: 08:00">
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    ساعت اجرای روزانه (24 ساعته)
                                </small>
                            </div>

                            <!-- روزهای هفته (فقط برای هفتگی) -->
                            <div class="mb-3" id="daysOfWeekField" style="display: none;">
                                <label class="form-label">روزهای اجرا</label>
                                @{
                                    var selectedDays = Model.ScheduledDaysOfWeek?.Split(',', StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
                                }
                                <div class="btn-group-vertical w-100" role="group">
                                    <input type="checkbox" class="btn-check" id="day0" name="ScheduledDays" value="0" @(selectedDays.Contains("0") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day0">یکشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day1" name="ScheduledDays" value="1" @(selectedDays.Contains("1") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day1">دوشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day2" name="ScheduledDays" value="2" @(selectedDays.Contains("2") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day2">سه‌شنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day3" name="ScheduledDays" value="3" @(selectedDays.Contains("3") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day3">چهارشنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day4" name="ScheduledDays" value="4" @(selectedDays.Contains("4") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day4">پنج‌شنبه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day5" name="ScheduledDays" value="5" @(selectedDays.Contains("5") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day5">جمعه</label>
                                    
                                    <input type="checkbox" class="btn-check" id="day6" name="ScheduledDays" value="6" @(selectedDays.Contains("6") ? "checked" : "")>
                                    <label class="btn btn-outline-primary text-start" for="day6">شنبه</label>
                                </div>
                                <input type="hidden" asp-for="ScheduledDaysOfWeek" id="scheduledDaysOfWeekHidden">
                            </div>

                            <!-- روز ماه (فقط برای ماهانه) -->
                            <div class="mb-3" id="dayOfMonthField" style="display: none;">
                                <label class="form-label">روز ماه</label>
                                <input type="number" class="form-control" asp-for="ScheduledDayOfMonth" 
                                       min="1" max="31" placeholder="مثال: 1 یا 15">
                                <small class="form-text text-muted">
                                    <i class="fa fa-info-circle me-1"></i>
                                    روز ماه برای اجرا (1 تا 31)
                                </small>
                            </div>

                            @if (Model.LastExecutionDate.HasValue)
                            {
                                <div class="alert alert-success">
                                    <i class="fa fa-check-circle me-1"></i>
                                    <strong>آخرین اجرا:</strong> @Model.LastExecutionDate.Value.ToString("yyyy/MM/dd HH:mm")
                                </div>
                            }

                            @if (Model.NextExecutionDate.HasValue)
                            {
                                <div class="alert alert-info">
                                    <i class="fa fa-calendar me-1"></i>
                                    <strong>اجرای بعدی:</strong> @Model.NextExecutionDate.Value.ToString("yyyy/MM/dd HH:mm")
                                </div>
                            }

                            <!-- پیش‌نمایش -->
                            <div class="alert alert-warning">
                                <i class="fa fa-calendar me-1"></i>
                                <strong>پیش‌نمایش:</strong>
                                <div id="schedulePreview">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar - متغیرها -->
            <div class="col-lg-4">
                <!-- وضعیت -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">وضعیت</h3>
                    </div>
                    <div class="block-content">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" asp-for="IsActive" id="isActiveSwitch">
                            <label class="form-check-label" for="isActiveSwitch">
                                الگو فعال است
                            </label>
                        </div>
                    </div>
                </div>

                <!-- متغیرهای سیستمی -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-code text-success me-2"></i>متغیرهای قابل استفاده
                        </h3>
                    </div>
                    <div class="block-content">
                        <div class="alert alert-info">
                            <i class="fa fa-lightbulb me-1"></i>
                            برای استفاده از متغیر، روی آن کلیک کنید
                        </div>

                        <div class="list-group list-group-flush" id="variablesList">
                            @foreach (var variable in Model.SystemVariables.OrderBy(v => v.DisplayName))
                            {
                                <button type="button" 
                                        class="list-group-item list-group-item-action variable-item"
                                        data-variable-name="@variable.VariableName"
                                        title="@variable.Description">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{@variable.VariableName}}</strong>
                                            <div class="fs-xs text-muted">@variable.DisplayName</div>
                                        </div>
                                        <i class="fa fa-copy text-primary"></i>
                                    </div>
                                </button>
                            }
                        </div>
                    </div>
                </div>

                <!-- دکمه‌های عملیات -->
                <div class="block block-rounded">
                    <div class="block-content">
                        <button type="submit" class="btn btn-warning w-100 mb-2" id="saveTemplateBtn">
                            <i class="fa fa-save me-1"></i>بروزرسانی الگو
                        </button>
                        <a asp-action="Preview" asp-route-id="@Model.Id" target="_blank" class="btn btn-alt-info w-100 mb-2">
                            <i class="fa fa-eye me-1"></i>پیش‌نمایش
                        </a>
                        <a asp-action="History" asp-route-id="@Model.Id" class="btn btn-alt-secondary w-100 mb-2">
                            <i class="fa fa-history me-1"></i>تاریخچه تغییرات
                        </a>
                        <a asp-action="Index" class="btn btn-alt-secondary w-100">
                            <i class="fa fa-times me-1"></i>انصراف
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<!-- END Page Content -->

@section Styles {
    <link rel="stylesheet" href="~/css/notification-templates.css" />
}

@section Scripts {
    <script src="~/assets/js/tinymceConfig.js"></script>
    <script src="~/js/notification-templates.js"></script>
    <script>
        $(document).ready(function() {
            initializeTemplateForm(true);
            // ⭐ نمایش فیلدهای شرطی بر اساس Channel
            function updateConditionalFields() {
                const Channel = parseInt($('#ChannelSelect').val());
                
                // Subject و HTML Editor فقط برای ایمیل (Channel = 1)
                if (Channel === 1) {
                    $('#subjectField').slideDown();
                    $('#htmlEditorField').slideDown();
                } else {
                    $('#subjectField').slideUp();
                    $('#htmlEditorField').slideUp();
                }
            }

            // ⭐ نمایش لیست کاربران بر اساس RecipientMode
            function updateRecipientFields() {
                const mode = parseInt($('#recipientModeSelect').val());
                
                if (mode === 1 || mode === 2) {
                    $('#recipientUsersField').slideDown();
                } else {
                    $('#recipientUsersField').slideUp();
                }
            }

            // ⭐⭐⭐ نمایش بخش زمان‌بندی فقط برای اعلان‌های زمان‌بندی شده
            function updateSchedulingVisibility() {
                const selectedOption = $('#notificationTypeSelect').find('option:selected');
                const isSchedulable = selectedOption.data('schedulable') === true;

                if (isSchedulable) {
                    // نمایش بخش زمان‌بندی
                    $('#schedulingBlock').slideDown();
                } else {
                    // مخفی کردن بخش زمان‌بندی
                    $('#schedulingBlock').slideUp();
                    $('#isScheduledSwitch').prop('checked', false);
                    $('#scheduleSettingsFields').hide();
                }
            }

            // Event handlers
            $('#ChannelSelect').on('change', updateConditionalFields);
            $('#recipientModeSelect').on('change', updateRecipientFields);
            $('#notificationTypeSelect').on('change', updateSchedulingVisibility);

            // Trigger initial state
            updateConditionalFields();
            updateRecipientFields();
            updateSchedulingVisibility(); // ⭐ چک اولیه

            // ⭐⭐⭐ مدیریت زمان‌بندی
            $('#isScheduledSwitch').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#scheduleSettingsFields').slideDown();
                } else {
                    $('#scheduleSettingsFields').slideUp();
                }
            });

            $('#scheduleTypeSelect').on('change', function() {
                const scheduleType = parseInt($(this).val());
                
                $('#daysOfWeekField').hide();
                $('#dayOfMonthField').hide();

                if (scheduleType === 2) { // هفتگی
                    $('#daysOfWeekField').slideDown();
                } else if (scheduleType === 3) { // ماهانه
                    $('#dayOfMonthField').slideDown();
                }

                updateSchedulePreview();
            });

            // ⭐ بروزرسانی پیش‌نمایش
            function updateSchedulePreview() {
                const scheduleType = parseInt($('#scheduleTypeSelect').val());
                const time = $('#ScheduledTime').val() || '08:00';
                
                let preview = '';
                
                switch(scheduleType) {
                    case 1: // روزانه
                        preview = `هر روز ساعت ${time}`;
                        break;
                    case 2: // هفتگی
                        const selectedDays = [];
                        $('input[name="ScheduledDays"]:checked').each(function() {
                            const dayNames = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
                            selectedDays.push(dayNames[parseInt($(this).val())]);
                        });
                        preview = selectedDays.length > 0 
                            ? `هر ${selectedDays.join('، ')} ساعت ${time}`
                            : 'لطفاً روزهای هفته را انتخاب کنید';
                        break;
                    case 3: // ماهانه
                        const dayOfMonth = $('#ScheduledDayOfMonth').val();
                        preview = dayOfMonth 
                            ? `هر ماه روز ${dayOfMonth} ساعت ${time}`
                            : 'لطفاً روز ماه را وارد کنید';
                        break;
                    default:
                        preview = 'دستی (بدون زمان‌بندی)';
                }
                
                $('#schedulePreview').text(preview);
            }

            // ⭐ به‌روزرسانی مقدار hidden field برای روزهای هفته
            $('input[name="ScheduledDays"]').on('change', function() {
                const selectedDays = [];
                $('input[name="ScheduledDays"]:checked').each(function() {
                    selectedDays.push($(this).val());
                });
                $('#scheduledDaysOfWeekHidden').val(selectedDays.join(','));
                updateSchedulePreview();
            });

            $('#ScheduledTime, #ScheduledDayOfMonth').on('change', updateSchedulePreview);

            // Trigger initial state for schedule
            if ($('#isScheduledSwitch').is(':checked')) {
                $('#scheduleSettingsFields').show();
            }
            $('#scheduleTypeSelect').trigger('change');
            updateSchedulePreview();
        });
    </script>
}