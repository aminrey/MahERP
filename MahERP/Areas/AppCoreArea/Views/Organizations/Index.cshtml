@model List<OrganizationViewModel>
@{
    ViewData["Title"] = "لیست سازمان‌ها";
    var groups = ViewBag.OrganizationGroups as List<OrganizationGroup>;
    var selectedGroupId = ViewBag.SelectedGroupId as int?;
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center py-2">
            <div class="flex-grow-1">
                <h1 class="h3 fw-bold mb-1">
                    <i class="fa fa-building text-primary me-2"></i>
                    مدیریت سازمان‌ها
                </h1>
                <h2 class="fs-base lh-base fw-medium text-muted mb-0">
                    مدیریت و گروه‌بندی اشخاص حقوقی
                </h2>
            </div>
            <nav class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-alt">
                    <li class="breadcrumb-item">
                        <a class="link-fx" href="@Url.Action("Index", "Home")">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item" aria-current="page">سازمان‌ها</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content">
    <!-- دکمه‌های عملیاتی -->
    <div class="block block-rounded mb-4">
        <div class="block-content block-content-full">
            <div class="row g-3">
                <div class="col-md-8">
                    <!-- ⭐⭐⭐ فرم جستجو و فیلتر ⭐⭐⭐ -->
                    <form method="get" asp-action="Index" id="searchForm">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fa fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           name="searchTerm" 
                                           class="form-control form-control-lg" 
                                           placeholder="نام، شماره ثبت، کد اقتصادی، ایمیل یا شماره تماس..."
                                           value="@ViewBag.SearchTerm">
                                    @if (!string.IsNullOrEmpty(ViewBag.SearchTerm as string))
                                    {
                                        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                            <i class="fa fa-times"></i>
                                        </a>
                                    }
                                </div>
                            </div>
                            <div class="col-md-4">
                                <select name="organizationType" class="form-select form-select-lg" onchange="document.getElementById('searchForm').submit()">
                                    <option value="">همه انواع</option>
                                    @{
                                        var orgType = ViewBag.OrganizationType?.ToString();
                                    }
                                    
                                    @if (orgType == "0")
                                    {
                                        <option value="0" selected>شرکت</option>
                                    }
                                    else
                                    {
                                        <option value="0">شرکت</option>
                                    }
                                    
                                    @if (orgType == "1")
                                    {
                                        <option value="1" selected>سازمان</option>
                                    }
                                    else
                                    {
                                        <option value="1">سازمان</option>
                                    }
                                    
                                    @if (orgType == "2")
                                    {
                                        <option value="2" selected>موسسه</option>
                                    }
                                    else
                                    {
                                        <option value="2">موسسه</option>
                                    }
                                    
                                    @if (orgType == "3")
                                    {
                                        <option value="3" selected>نهاد</option>
                                    }
                                    else
                                    {
                                        <option value="3">نهاد</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fa fa-search"></i> جستجو
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="col-md-4">
                    <div class="row g-2">
                        <div class="col-6">
                            <a class="btn btn-lg btn-success w-100" href="@Url.Action("Create", "Organizations")">
                                <i class="fa fa-plus me-1"></i>
                                افزودن
                            </a>
                        </div>
                        <div class="col-6">
                            <a class="btn btn-lg btn-info w-100" href="@Url.Action("Index", "OrganizationGroups")">
                                <i class="fa fa-layer-group me-1"></i>
                                گروه‌ها
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ⭐ نمایش فیلترهای فعال -->
            @if (!string.IsNullOrEmpty(ViewBag.SearchTerm as string) || ViewBag.OrganizationType != null || ViewBag.SelectedGroupId != null)
            {
                <div class="mt-3">
                    <div class="d-flex flex-wrap gap-2 align-items-center">
                        <span class="text-muted small">فیلترهای فعال:</span>
                        
                        @if (!string.IsNullOrEmpty(ViewBag.SearchTerm as string))
                        {
                            <span class="badge bg-primary">
                                <i class="fa fa-search me-1"></i>
                                جستجو: @ViewBag.SearchTerm
                                <a href="@Url.Action("Index", new { organizationType = ViewBag.OrganizationType, groupId = ViewBag.SelectedGroupId })" 
                                   class="text-white ms-1">
                                    <i class="fa fa-times"></i>
                                </a>
                            </span>
                        }

                        @if (ViewBag.OrganizationType != null)
                        {
                            var typeText = ViewBag.OrganizationType switch
                            {
                                (byte)0 => "شرکت",
                                (byte)1 => "سازمان",
                                (byte)2 => "موسسه",
                                (byte)3 => "نهاد",
                                _ => ""
                            };
                            <span class="badge bg-info">
                                <i class="fa fa-filter me-1"></i>
                                نوع: @typeText
                                <a href="@Url.Action("Index", new { searchTerm = ViewBag.SearchTerm, groupId = ViewBag.SelectedGroupId })" 
                                   class="text-white ms-1">
                                    <i class="fa fa-times"></i>
                                </a>
                            </span>
                        }

                        @if (ViewBag.SelectedGroupId != null && groups != null)
                        {
                            var selectedGroup = groups.FirstOrDefault(g => g.Id == ViewBag.SelectedGroupId);
                            if (selectedGroup != null)
                            {
                                <span class="badge" style="background-color: @selectedGroup.DisplayColorHex;">
                                    <i class="fa @selectedGroup.DisplayIconClass me-1"></i>
                                    گروه: @selectedGroup.Title
                                    <a href="@Url.Action("Index", new { searchTerm = ViewBag.SearchTerm, organizationType = ViewBag.OrganizationType })" 
                                       class="text-white ms-1">
                                        <i class="fa fa-times"></i>
                                    </a>
                                </span>
                            }
                        }

                        <a href="@Url.Action("Index")" class="btn btn-sm btn-outline-danger">
                            <i class="fa fa-times me-1"></i> پاک کردن همه فیلترها
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- ⭐⭐⭐ فیلتر گروه‌ها (دکمه‌های داینامیک) ⭐⭐⭐ -->
    @if (groups != null && groups.Any())
    {
        <div class="block block-rounded mb-4">
            <div class="block-header block-header-default">
                <h3 class="block-title">
                    <i class="fa fa-filter me-2 text-primary"></i>
                    فیلتر بر اساس گروه
                </h3>
            </div>
            <div class="block-content">
                <div class="btn-group-container d-flex flex-wrap gap-2">
                    <!-- دکمه همه سازمان‌ها -->
                    <a href="@Url.Action("Index", "Organizations")"
                       class="btn btn-group-filter @(selectedGroupId == null ? "btn-primary" : "btn-outline-secondary")">
                        <i class="fa fa-building me-1"></i>
                        همه سازمان‌ها
                        <span class="badge bg-white text-dark ms-1">@Model.Count</span>
                    </a>

                    <!-- دکمه‌های گروه‌ها (داینامیک) -->
                    @foreach (var group in groups)
                    {
                        <a href="@Url.Action("Index", "Organizations", new { groupId = group.Id })"
                           class="btn btn-group-filter @(selectedGroupId == group.Id ? "btn-primary" : "btn-outline-secondary")"
                           style="border-color: @group.DisplayColorHex; @(selectedGroupId == group.Id ? $"background-color: {group.DisplayColorHex}; border-color: {group.DisplayColorHex};" : "")">
                            <i class="fa @group.DisplayIconClass me-1"></i>
                            @group.Title
                            <span class="badge bg-white text-dark ms-1">@group.ActiveMembersCount</span>
                        </a>
                    }
                </div>
            </div>
        </div>
    }

    <!-- جدول سازمان‌ها -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                لیست سازمان‌ها
                <span class="badge bg-primary ms-2">@Model.Count سازمان</span>
            </h3>
        </div>
        <div class="block-content">
            @if (Model != null && Model.Any())
            {
                var groupedOrganizations = ViewBag.GroupedOrganizations as Dictionary<string, List<OrganizationViewModel>>;
                var alphabeticalIndex = ViewBag.AlphabeticalIndex as List<string>;

                <div class="row">
                    <!-- ⭐⭐⭐ Alphabetical Quick Index (Sidebar) -->
                    <div class="col-lg-2 d-none d-lg-block">
                        <div class="sticky-top" style="top: 80px;">
                            <div class="text-center mb-3">
                                <small class="text-muted fw-bold">دسترسی سریع</small>
                            </div>
                            <div class="d-flex flex-column gap-1 alphabet-index">
                                @if (alphabeticalIndex != null)
                                {
                                    @foreach (var letter in alphabeticalIndex)
                                    {
                                        <a href="#letter-@letter" 
                                           class="btn btn-sm btn-outline-primary alphabet-btn"
                                           data-letter="@letter">
                                            @letter
                                        </a>
                                    }
                                }
                            </div>
                        </div>
                    </div>

                    <!-- ⭐⭐⭐ Main Content Area -->
                    <div class="col-lg-10">
                        @if (groupedOrganizations != null && groupedOrganizations.Any())
                        {
                            @foreach (var group in groupedOrganizations)
                            {
                                <div class="mb-4" id="letter-@group.Key">
                                    <!-- Letter Header -->
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="letter-header bg-success text-white">
                                            @group.Key
                                        </div>
                                        <div class="flex-grow-1 border-bottom ms-3"></div>
                                        <span class="badge bg-secondary">@group.Value.Count سازمان</span>
                                    </div>

                                    <!-- Organizations Cards -->
                                    <div class="row g-3">
                                        @foreach (var org in group.Value)
                                        {
                                            <div class="col-md-6 col-xl-4">
                                                <div class="organization-card">
                                                    <div class="d-flex align-items-center">
                                                        <div class="organization-avatar bg-success text-white">
                                                            <i class="fa fa-building"></i>
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <a href="@Url.Action("Details", "Organizations", new { id = org.Id })" 
                                                               class="organization-name">
                                                                @org.DisplayName
                                                            </a>
                                                            <div class="text-muted small">
                                                                <span class="badge bg-info">@org.OrganizationTypeText</span>
                                                            </div>
                                                        </div>
                                                        <div class="btn-group-vertical btn-group-sm">
                                                            <a href="@Url.Action("Details", "Organizations", new { id = org.Id })" 
                                                               class="btn btn-sm btn-info" title="جزئیات">
                                                                <i class="fa fa-eye"></i>
                                                            </a>
                                                            <a href="@Url.Action("Edit", "Organizations", new { id = org.Id })" 
                                                               class="btn btn-sm btn-warning" title="ویرایش">
                                                                <i class="fa fa-pencil-alt"></i>
                                                            </a>
                                                        </div>
                                                    </div>

                                                    <!-- Organization Details -->
                                                    <div class="organization-details mt-2">
                                                        @* ⭐⭐⭐ نمایش شماره پیش‌فرض از Phones *@
                                                        @if (org.Phones != null && org.Phones.Any())
                                                        {
                                                            var defaultPhone = org.Phones.FirstOrDefault(p => p.IsDefault);
                                                            if (defaultPhone != null)
                                                            {
                                                                <div class="small text-muted mb-1">
                                                                    <i class="fa fa-phone fa-fw"></i>
                                                                    <span dir="ltr" class="d-inline-block">@defaultPhone.FormattedNumber</span>
                                                                    @if (!string.IsNullOrEmpty(defaultPhone.Extension))
                                                                    {
                                                                        <span class="text-muted" dir="ltr">(داخلی: @defaultPhone.Extension)</span>
                                                                    }
                                                                </div>
                                                            }
                                                        }
                                                        else if (!string.IsNullOrEmpty(org.PrimaryPhone))
                                                        {
                                                            @* ⭐ fallback به فیلد قدیمی اگر شماره‌ای در Phones نیست *@
                                                            <div class="small text-muted mb-1">
                                                                <i class="fa fa-phone fa-fw"></i>
                                                                <span dir="ltr" class="d-inline-block">@org.PrimaryPhone</span>
                                                            </div>
                                                        }
                                
                                                        @if (!string.IsNullOrEmpty(org.Email))
                                                        {
                                                            <div class="small text-muted mb-1">
                                                                <i class="fa fa-envelope fa-fw"></i>
                                                                <span dir="ltr" class="d-inline-block">@org.Email</span>
                                                            </div>
                                                        }

                                                        @* ⭐ توضیحات (فقط یک خط) *@
                                                        @if (!string.IsNullOrEmpty(org.Description))
                                                        {
                                                            <div class="small text-muted mb-1 text-truncate" title="@org.Description">
                                                                <i class="fa fa-sticky-note fa-fw"></i>
                                                                @org.Description
                                                            </div>
                                                        }

                                                        <!-- Groups -->
                                                        @if (ViewBag.OrganizationGroupsDict != null)
                                                        {
                                                            var orgGroups = (ViewBag.OrganizationGroupsDict as Dictionary<int, List<OrganizationGroup>>)?[org.Id];
                                                            if (orgGroups != null && orgGroups.Any())
                                                            {
                                                                <div class="mt-2">
                                                                    @foreach (var ogroup in orgGroups.Take(2))
                                                                    {
                                                                        <span class="badge me-1" 
                                                                              style="background-color: @ogroup.DisplayColorHex; font-size: 0.7rem;">
                                                                            <i class="fa @ogroup.DisplayIconClass me-1"></i>
                                                                            @ogroup.Title
                                                                        </span>
                                                                    }
                                                                    @if (orgGroups.Count > 2)
                                                                    {
                                                                        <span class="badge bg-secondary" style="font-size: 0.7rem;">
                                                                            +@(orgGroups.Count - 2)
                                                                        </span>
                                                                    }
                                                                </div>
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fa fa-building fa-3x text-muted mb-3"></i>
                    <p class="text-muted">هیچ سازمانی یافت نشد</p>
                </div>
            }
        </div>
    </div>
</div>
<!-- END Page Content -->
@section Styles {
    <style>
        .btn-group-filter {
            transition: all 0.3s ease;
        }

            .btn-group-filter:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

        .btn-group-container {
            max-width: 100%;
            overflow-x: auto;
            padding: 0.5rem 0;
        }

        .btn-group-filter .badge {
            font-size: 0.75rem;
        }

        /* ⭐⭐⭐ Alphabetical Index Styles */
        .alphabet-index {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
        }

        .alphabet-btn {
            font-weight: bold;
            font-size: 0.9rem;
            padding: 0.4rem 0.6rem;
            transition: all 0.2s ease;
        }

        .alphabet-btn:hover,
        .alphabet-btn.active {
            transform: scale(1.1);
            background-color: var(--bs-success);
            color: white !important;
            border-color: var(--bs-success);
        }

        /* Letter Header */
        .letter-header {
            font-size: 2rem;
            font-weight: bold;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
        }

        /* Organization Card Styles */
        .organization-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            height: 100%;
        }

        .organization-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-3px);
            border-color: var(--bs-success);
        }

        .organization-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .organization-name {
            font-weight: 600;
            color: #333;
            text-decoration: none;
            display: block;
            margin-bottom: 0.25rem;
        }

        .organization-name:hover {
            color: var(--bs-success);
        }

        .organization-details {
            border-top: 1px solid #f0f0f0;
            padding-top: 0.75rem;
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* ⭐ LTR Content (Phone, Email) */
        [dir="ltr"] {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 0.5px;
        }

        /* Sticky Index */
        @@media (max-width: 991px) {
            .alphabet-index {
                display: none;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // ⭐ Highlight active letter on scroll
            $(window).on('scroll', function() {
                let scrollPos = $(window).scrollTop() + 100;
                
                $('.alphabet-btn').removeClass('active');
                
                $('[id^="letter-"]').each(function() {
                    let top = $(this).offset().top;
                    let bottom = top + $(this).outerHeight();
                    
                    if (scrollPos >= top && scrollPos <= bottom) {
                        let letter = $(this).attr('id').replace('letter-', '');
                        $(`.alphabet-btn[data-letter="${letter}"]`).addClass('active');
                        return false;
                    }
                });
            });

            // ⭐ Smooth scroll to letter
            $('.alphabet-btn').on('click', function(e) {
                e.preventDefault();
                let target = $(this).attr('href');
                $('html, body').animate({
                    scrollTop: $(target).offset().top - 80
                }, 500);
            });
        });
    </script>
}