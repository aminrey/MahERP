@model OrganizationContactViewModel
@{
    ViewData["Title"] = "افزودن اعضا به سازمان";
}

<div class="block block-rounded">
    <div class="block-header block-header-default">
        <h3 class="block-title">
            <i class="fa fa-user-plus me-2"></i>
            افزودن اعضا به سازمان: @ViewBag.OrganizationName
        </h3>
        <div class="block-options">
            <a asp-action="Details" asp-route-id="@ViewBag.OrganizationId" 
               class="btn btn-sm btn-alt-secondary">
                <i class="fa fa-arrow-right me-1"></i> بازگشت
            </a>
        </div>
    </div>

    <div class="block-content block-content-full">
        <form asp-action="AddOrganizationContact" method="post" id="addMembersForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="OrganizationId" />

            <!-- ⭐⭐⭐ جستجو و انتخاب افراد (Multi-Select) ⭐⭐⭐ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="fa fa-info-circle fa-2x me-3"></i>
                        <div>
                            <strong>راهنما:</strong>
                            شما می‌توانید چندین نفر را همزمان انتخاب کنید. برای جستجو، نام، نام خانوادگی، یا کد ملی را تایپ کنید.
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <label class="form-label fw-bold">
                        <i class="fa fa-search text-primary me-1"></i>
                        جستجو و انتخاب افراد
                        <span class="text-danger">*</span>
                    </label>
                    <select id="contactSearchSelect" 
                            class="form-select" 
                            multiple="multiple"
                            style="width: 100%;">
                    </select>
                  
                </div>
            </div>

            <!-- ⭐⭐⭐ لیست افراد انتخاب شده ⭐⭐⭐ -->
            <div class="row mb-4" id="selectedMembersSection" style="display: none;">
                <div class="col-12">
                    <div class="block block-rounded border-success">
                        <div class="block-header block-header-default bg-success-light">
                            <h3 class="block-title">
                                <i class="fa fa-users me-2"></i>
                                افراد انتخاب شده
                                <span class="badge bg-success ms-2" id="selectedCount">0</span>
                            </h3>
                        </div>
                        <div class="block-content p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-vcenter mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">#</th>
                                            <th>نام و نام خانوادگی</th>
                                            <th>کد ملی</th>
                                            <th>شماره تماس</th>
                                            <th style="width: 250px;">نوع رابطه</th>
                                            <th style="width: 80px;" class="text-center">عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="selectedMembersList">
                                        <!-- افراد انتخاب شده اینجا اضافه می‌شوند -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ⭐⭐⭐ تنظیمات عمومی ⭐⭐⭐ -->
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">
                        <i class="fa fa-link text-info me-1"></i>
                        نوع رابطه پیش‌فرض
                    </label>
                    <select id="defaultRelationType" class="form-select">
                        <option value="0">مدیرعامل</option>
                        <option value="1" selected>مدیر</option>
                        <option value="2">حسابدار</option>
                        <option value="3">کارمند</option>
                        <option value="5">سایر</option>
                    </select>
                    <small class="form-text text-muted">
                        این نوع رابطه به صورت پیش‌فرض برای همه افراد انتخاب می‌شود
                    </small>
                </div>

                <div class="col-md-6">
                    <label class="form-label">
                        <i class="fa fa-sticky-note text-secondary me-1"></i>
                        یادداشت عمومی
                    </label>
                    <textarea id="defaultNotes" class="form-control" rows="2" 
                              placeholder="این یادداشت برای همه افراد اعمال می‌شود..."></textarea>
                </div>
            </div>

            <!-- دکمه‌ها -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between">
                        <a asp-action="Details" asp-route-id="@ViewBag.OrganizationId" 
                           class="btn btn-lg btn-secondary">
                            <i class="fa fa-times me-1"></i> انصراف
                        </a>
                        <button type="submit" class="btn btn-lg btn-success" id="submitBtn" disabled>
                            <i class="fa fa-check me-1"></i>
                            ذخیره <span id="submitCount"></span> عضو
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <style>
        /* ⭐ Select2 Custom Styles */
        .select2-container--default .select2-selection--multiple {
            min-height: 80px;
            border: 2px solid #d4dae3;
            border-radius: 0.375rem;
            padding: 0.5rem;
        }

        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
        }

        .select2-results__option {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .select2-results__option--highlighted {
            background-color: #e7f3ff !important;
            color: #000 !important;
        }

        /* ⭐ Custom Option Template */
        .contact-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .contact-details {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.2rem;
        }

        .contact-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: #e9ecef;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }

        /* ⭐ Selected Members Table */
        #selectedMembersList tr {
            transition: all 0.3s ease;
        }

        #selectedMembersList tr:hover {
            background-color: #f8f9fa;
        }

        .relation-select {
            border: 1px solid #dee2e6;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }

        .relation-select:focus {
            border-color: #0d6efd;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
        }
    </style>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        let selectedMembers = [];
        let availableContacts = [];

        $(document).ready(function() {
            // ⭐⭐⭐ دریافت لیست افراد از سرور
            loadAvailableContacts();

            // ⭐⭐⭐ راه‌اندازی Select2 با قابلیت‌های پیشرفته
            initializeSelect2();

            // ⭐⭐⭐ مدیریت انتخاب افراد
            $('#contactSearchSelect').on('change', function() {
                const selectedIds = $(this).val() || [];
                updateSelectedMembers(selectedIds);
            });

            // ⭐⭐⭐ مدیریت نوع رابطه پیش‌فرض
            $('#defaultRelationType').on('change', function() {
                const newType = $(this).val();
                selectedMembers.forEach(member => {
                    if (!member.relationTypeChanged) {
                        member.relationType = newType;
                    }
                });
                renderSelectedMembers();
            });

            // ⭐⭐⭐ مدیریت ارسال فرم
            $('#addMembersForm').on('submit', function(e) {
                e.preventDefault();
                submitMembers();
            });
        });

        // ⭐ دریافت لیست افراد
        function loadAvailableContacts() {
            $.ajax({
                url: '@Url.Action("GetAvailableContactsJson", "Organizations")',
                type: 'GET',
                data: { organizationId: @ViewBag.OrganizationId },
                success: function(data) {
                    availableContacts = data;
                    console.log('✅ تعداد افراد:', data.length);
                },
                error: function(xhr) {
                    console.error('❌ خطا در دریافت افراد:', xhr);
                    Dashmix.helpers('notify', {
                        type: 'danger',
                        icon: 'fa fa-times',
                        message: 'خطا در دریافت لیست افراد'
                    });
                }
            });
        }

        // ⭐ راه‌اندازی Select2 با Template سفارشی
        function initializeSelect2() {
            $('#contactSearchSelect').select2({
                placeholder: 'نام، نام خانوادگی یا کد ملی را تایپ کنید...',
                allowClear: true,
                width: '100%',
                dir: 'rtl',
                multiple: true,
                closeOnSelect: false,
                templateResult: formatContact,
                templateSelection: formatContactSelection,
                matcher: customMatcher,
                ajax: {
                    delay: 250,
                    transport: function (params, success, failure) {
                        // جستجوی local
                        const term = (params.data.term || '').toLowerCase();
                        const filtered = availableContacts.filter(contact => {
                            // ⭐ اصلاح شده: بررسی null/undefined
                            const firstName = (contact.firstName || '').toLowerCase();
                            const lastName = (contact.lastName || '').toLowerCase();
                            const fullName = `${lastName} ${firstName}`.toLowerCase();
                            const nationalCode = (contact.nationalCode || '').toLowerCase();
                            const notes = (contact.notes || '').toLowerCase();
                            
                            return fullName.includes(term) || 
                                   nationalCode.includes(term) || 
                                   notes.includes(term) ||
                                   firstName.includes(term) ||
                                   lastName.includes(term);
                        });
                        
                        success({ results: filtered.slice(0, 20) });
                    },
                    processResults: function (data) {
                        return {
                            results: data.results.map(contact => ({
                                id: contact.id,
                                text: `${contact.lastName || ''} ${contact.firstName || ''}`.trim(),
                                contact: contact
                            }))
                        };
                    }
                }
            });
        }

        // ⭐ قالب نمایش در Dropdown
        function formatContact(contact) {
            if (!contact.id || !contact.contact) return contact.text;

            const c = contact.contact;
            // ⭐ اصلاح شده: بررسی null/undefined برای initials
            const firstInitial = c.firstName?.[0] || c.lastName?.[0] || '?';
            const lastInitial = c.lastName?.[0] || '';
            const initials = `${firstInitial}${lastInitial}`.toUpperCase();
            
            const phone = c.primaryPhone || '-';
            const nationalCode = c.nationalCode || '-';
            const notes = c.notes ? (c.notes.length > 40 ? c.notes.substring(0, 40) + '...' : c.notes) : '';
            
            // ⭐ اصلاح شده: نمایش بهتر نام
            const displayName = `${c.lastName || ''} ${c.firstName || ''}`.trim() || 'نام نامشخص';

            return $(`
                <div class="contact-option">
                    <div class="contact-avatar">${initials}</div>
                    <div class="contact-info">
                        <div class="contact-name">${displayName}</div>
                        <div class="contact-details">
                            <span class="contact-badge"><i class="fa fa-id-card"></i> ${nationalCode}</span>
                            <span class="contact-badge"><i class="fa fa-phone"></i> ${phone}</span>
                            ${notes ? `<span class="contact-badge"><i class="fa fa-sticky-note"></i> ${notes}</span>` : ''}
                        </div>
                    </div>
                </div>
            `);
        }

        // ⭐ قالب نمایش انتخاب شده
        function formatContactSelection(contact) {
            if (!contact.contact) return contact.text;
            const c = contact.contact;
            // ⭐ اصلاح شده: بررسی null/undefined
            return `${c.lastName || ''} ${c.firstName || ''}`.trim() || 'نام نامشخص';
        }

        // ⭐ جستجوی سفارشی
        function customMatcher(params, data) {
            if ($.trim(params.term) === '') return data;
            
            if (typeof data.text === 'undefined') return null;
            
            const term = params.term.toLowerCase();
            const contact = data.contact;
            
            if (!contact) return null;
            
            // ⭐ اصلاح شده: بررسی null/undefined
            const firstName = (contact.firstName || '').toLowerCase();
            const lastName = (contact.lastName || '').toLowerCase();
            const fullName = `${lastName} ${firstName}`.toLowerCase();
            const nationalCode = (contact.nationalCode || '').toLowerCase();
            const notes = (contact.notes || '').toLowerCase();
            
            if (fullName.includes(term) || 
                nationalCode.includes(term) || 
                notes.includes(term) ||
                firstName.includes(term) ||
                lastName.includes(term)) {
                return data;
            }
            
            return null;
        }

        // ⭐ بروزرسانی لیست انتخاب شده
        function updateSelectedMembers(selectedIds) {
            // افزودن افراد جدید
            selectedIds.forEach(id => {
                if (!selectedMembers.find(m => m.id == id)) {
                    const contact = availableContacts.find(c => c.id == id);
                    if (contact) {
                        selectedMembers.push({
                            id: contact.id,
                            firstName: contact.firstName || '', // ⭐ اصلاح شده
                            lastName: contact.lastName || '',   // ⭐ اصلاح شده
                            nationalCode: contact.nationalCode || '',
                            primaryPhone: contact.primaryPhone || '',
                            relationType: $('#defaultRelationType').val(),
                            relationTypeChanged: false,
                            notes: $('#defaultNotes').val()
                        });
                    }
                }
            });

            // حذف افرادی که از انتخاب خارج شده‌اند
            selectedMembers = selectedMembers.filter(m => selectedIds.includes(m.id.toString()));

            renderSelectedMembers();
        }

        // ⭐ نمایش لیست انتخاب شده
        function renderSelectedMembers() {
            const $list = $('#selectedMembersList');
            $list.empty();

            if (selectedMembers.length === 0) {
                $('#selectedMembersSection').hide();
                $('#submitBtn').prop('disabled', true);
                return;
            }

            $('#selectedMembersSection').show();
            $('#submitBtn').prop('disabled', false);
            $('#selectedCount').text(selectedMembers.length);
            $('#submitCount').text(selectedMembers.length);

            selectedMembers.forEach((member, index) => {
                // ⭐ اصلاح شده: نمایش بهتر نام
                const displayName = `${member.lastName || ''} ${member.firstName || ''}`.trim() || 'نام نامشخص';
                
                const row = `
                    <tr>
                        <td class="text-center fw-bold">${index + 1}</td>
                        <td>
                            <strong>${displayName}</strong>
                        </td>
                        <td><span dir="ltr">${member.nationalCode || '-'}</span></td>
                        <td><span dir="ltr">${member.primaryPhone || '-'}</span></td>
                        <td>
                            <select class="relation-select" data-member-id="${member.id}">
                                <option value="0" ${member.relationType == 0 ? 'selected' : ''}>مدیرعامل</option>
                                <option value="1" ${member.relationType == 1 ? 'selected' : ''}>مدیر</option>
                                <option value="2" ${member.relationType == 2 ? 'selected' : ''}>حسابدار</option>
                                <option value="3" ${member.relationType == 3 ? 'selected' : ''}>کارمند</option>
                                <option value="5" ${member.relationType == 5 ? 'selected' : ''}>سایر</option>
                            </select>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeMember(${member.id})">
                                <i class="fa fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
                $list.append(row);
            });

            // مدیریت تغییر نوع رابطه
            $('.relation-select').on('change', function() {
                const memberId = $(this).data('member-id');
                const newType = $(this).val();
                const member = selectedMembers.find(m => m.id == memberId);
                if (member) {
                    member.relationType = newType;
                    member.relationTypeChanged = true;
                }
            });
        }

        // ⭐ حذف عضو از لیست
        function removeMember(memberId) {
            selectedMembers = selectedMembers.filter(m => m.id != memberId);
            
            // حذف از Select2
            const currentValues = $('#contactSearchSelect').val() || [];
            const newValues = currentValues.filter(id => id != memberId.toString());
            $('#contactSearchSelect').val(newValues).trigger('change');
            
            renderSelectedMembers();
        }

        // ⭐ ارسال فرم
        function submitMembers() {
            if (selectedMembers.length === 0) {
                Dashmix.helpers('notify', {
                    type: 'warning',
                    icon: 'fa fa-exclamation',
                    message: 'لطفاً حداقل یک نفر انتخاب کنید'
                });
                return;
            }

            const $submitBtn = $('#submitBtn');
            $submitBtn.prop('disabled', true);
            $submitBtn.html('<i class="fa fa-spinner fa-spin me-1"></i> در حال ذخیره...');

            $.ajax({
                url: '@Url.Action("AddMultipleOrganizationContacts", "Organizations")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    organizationId: @ViewBag.OrganizationId,
                    members: selectedMembers,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }),
                success: function(response) {
                    if (response.success || response.status === 'redirect') {
                        Dashmix.helpers('notify', {
                            type: 'success',
                            icon: 'fa fa-check',
                            message: `${selectedMembers.length} عضو با موفقیت اضافه شد`
                        });
                        
                        setTimeout(() => {
                            window.location.href = '@Url.Action("Details", "Organizations", new { id = ViewBag.OrganizationId })';
                        }, 1000);
                    } else {
                        Dashmix.helpers('notify', {
                            type: 'danger',
                            icon: 'fa fa-times',
                            message: response.message || 'خطا در ذخیره'
                        });
                        $submitBtn.prop('disabled', false);
                        $submitBtn.html('<i class="fa fa-check me-1"></i> ذخیره <span>' + selectedMembers.length + '</span> عضو');
                    }
                },
                error: function(xhr) {
                    console.error('خطا:', xhr);
                    Dashmix.helpers('notify', {
                        type: 'danger',
                        icon: 'fa fa-times',
                        message: 'خطا در ارتباط با سرور'
                    });
                    $submitBtn.prop('disabled', false);
                    $submitBtn.html('<i class="fa fa-check me-1"></i> ذخیره <span>' + selectedMembers.length + '</span> عضو');
                }
            });
        }
    </script>
}