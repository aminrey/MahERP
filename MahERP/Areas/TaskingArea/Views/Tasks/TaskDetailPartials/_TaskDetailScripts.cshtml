@model TaskViewModel

<script>
    window.TaskDetailConfig = {
        taskId: @Model.Id,
        isTaskCompleted: @(Model.CompletionDate.HasValue ? "true" : "false"),
        urls: {
            getTaskComments: '@Url.Action("GetTaskComments", "Tasks")',
            addTaskComment: '@Url.Action("AddTaskComment", "Tasks")',
            deleteTaskComment: '@Url.Action("DeleteTaskComment", "Tasks")',
            getTaskHeroStats: '@Url.Action("GetTaskHeroStats", "Tasks")',
            getTaskProgress: '@Url.Action("GetTaskProgress", "Tasks")',
            getTaskSidebarStats: '@Url.Action("GetTaskSidebarStats", "Tasks")',
            getTaskReminders: '@Url.Action("GetTaskReminders", "Tasks", new { taskId = Model.Id })',
            getTaskHistory: '@Url.Action("GetTaskHistory", "Tasks", new { area = "TaskingArea" })',
            getOperationsGroup: '@Url.Action("GetOperationsGroup", "TaskOperations", new { area = "TaskingArea" })',
            toggleOperationComplete: '@Url.Action("ToggleOperationComplete", "TaskOperations", new { area = "TaskingArea" })',
            toggleOperationStar: '@Url.Action("ToggleOperationStar", "TaskOperations", new { area = "TaskingArea" })',
            deleteOperation: '@Url.Action("DeleteOperation", "TaskOperations", new { area = "TaskingArea" })',
            addOperation: '@Url.Action("AddOperation", "TaskOperations", new { area = "TaskingArea" })',
            getAllOperations: '@Url.Action("GetAllOperations", "TaskOperations", new { area = "TaskingArea" })',
            refreshAllTaskStats: '@Url.Action("RefreshAllTaskStats", "Tasks", new { area = "TaskingArea" })',
            getTaskViewers: '@Url.Action("GetTaskViewers", "TaskViewers", new { area = "TaskingArea" })',
            removeCarbonCopy: '@Url.Action("RemoveCarbonCopy", "TaskViewers", new { area = "TaskingArea" })',
            getTaskSettings: '@Url.Action("GetTaskSettingsModal", "Tasks", new { area = "TaskingArea" })'
        }
    };

    $(document).ready(function() {
        // بارگذاری تنظیمات هنگام کلیک روی تب
        $('#settings-tab').on('shown.bs.tab', function() {
            loadTaskSettings();
        });
    });

    // بارگذاری مودال تنظیمات
    function loadTaskSettings() {
        const $container = $('#task-settings-container');

        $container.html(`
            <div class="block block-rounded block-fx-shadow">
                <div class="block-content text-center py-5">
                    <i class="fa fa-spinner fa-spin fa-3x text-muted mb-3"></i>
                    <p class="text-muted">در حال بارگذاری تنظیمات...</p>
                </div>
            </div>
        `);

        $.ajax({
            url: TaskDetailConfig.urls.getTaskSettings,
            type: 'GET',
            data: { 
                taskId: @Model.Id,
                __RequestVerificationToken: getAntiForgeryToken()
            },
            dataType: 'json',
            success: function(response) {
                console.log('✅ Task Settings Response:', response);

                if (response.status === "update-view" && response.viewList) {
                    updateMultipleViews(response.viewList);
                    initializeTaskSettingsComponents();
                    console.log('✅ Task settings loaded successfully');
                } 
                else if (response.success === false || response.status === "error") {
                    const errorMessage = response.message?.[0]?.text || 'خطا در بارگذاری تنظیمات';
                    
                    $container.html(`
                        <div class="block block-rounded block-fx-shadow">
                            <div class="block-content">
                                <div class="alert alert-danger">
                                    <i class="fa fa-exclamation-circle me-2"></i>
                                    <strong>خطا</strong>
                                    <p class="mb-0 mt-2">${errorMessage}</p>
                                </div>
                            </div>
                        </div>
                    `);
                    
                    if (response.message) {
                        SendResposeMessage(response.message);
                    }
                }
                else {
                    console.error('❌ Unexpected response format:', response);
                    $container.html(`
                        <div class="block block-rounded block-fx-shadow">
                            <div class="block-content text-center py-5">
                                <i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                <p class="text-muted">فرمت پاسخ نامعتبر است</p>
                                <button type="button" class="btn btn-primary mt-3" onclick="loadTaskSettings()">
                                    <i class="fa fa-sync me-1"></i>تلاش مجدد
                                </button>
                            </div>
                        </div>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ Error loading task settings:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    error: error,
                    responseText: xhr.responseText
                });
                
                let errorMessage = 'خطای ناشناخته';
                
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message[0]?.text || errorMessage;
                } else if (xhr.responseText) {
                    try {
                        const errorJson = JSON.parse(xhr.responseText);
                        if (errorJson.message) {
                            errorMessage = errorJson.message[0]?.text || errorMessage;
                        }
                    } catch (e) {
                        errorMessage = xhr.responseText.substring(0, 200);
                    }
                }

                $container.html(`
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-content">
                            <div class="alert alert-danger">
                                <i class="fa fa-exclamation-circle me-2"></i>
                                <strong>خطا در بارگذاری تنظیمات</strong>
                                <p class="mb-0 mt-2">${errorMessage}</p>
                                <button type="button" class="btn btn-sm btn-danger mt-3" onclick="loadTaskSettings()">
                                    <i class="fa fa-sync me-1"></i>تلاش مجدد
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            }
        });
    }

    // راه‌اندازی کامپوننت‌ها
    function initializeTaskSettingsComponents() {
        const $container = $('#task-settings-container');

        $container.find('[data-bs-toggle="tooltip"]').tooltip();

        if (typeof DynamicSelect2Manager !== 'undefined') {
            DynamicSelect2Manager.reinitializeSelect2InDiv($container);
        }

        if (typeof ModalUtils !== 'undefined') {
            ModalUtils.processUrlsInContainer($container);
        }

        console.log('✅ Task Settings Components initialized');
    }

    // ⭐⭐⭐ تابع بروزرسانی badge count تب‌ها
    function updateTabBadge(tabId, count) {
        const $tab = $(`#${tabId}`);
        if ($tab.length === 0) {
            console.warn(`Tab ${tabId} not found`);
            return;
        }

        let $badge = $tab.find('.badge');
        
        if (count > 0) {
            if ($badge.length === 0) {
                // اگر badge وجود ندارد، ایجاد کن
                $badge = $('<span class="badge bg-info rounded-pill ms-1"></span>');
                $tab.find('.tab-title').after($badge);
            }
            $badge.text(count).show();
        } else {
            // اگر count صفر است، badge را مخفی کن
            $badge.hide();
        }

        console.log(`✅ Badge updated for ${tabId}: ${count}`);
    }
</script>

<script src="~/assets/js/taskdetail.js"></script>
