@model TaskViewModel

<!-- بخش 5: طرف حساب -->
<div class="task-section">
    <div class="task-section-title">
        <i class="fa fa-handshake"></i>
        <h5>طرف حساب</h5>
        <span class="badge bg-secondary ms-2">اختیاری</span>
    </div>

    <!-- Tab Navigation برای انتخاب نوع -->
    <ul class="nav nav-pills mb-3" id="stakeholderTypeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="organization-tab"
                    data-bs-toggle="pill" data-bs-target="#organization-panel"
                    type="button" role="tab">
                <i class="fa fa-building me-1"></i>
                شرکت/سازمان
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="contact-tab"
                    data-bs-toggle="pill" data-bs-target="#contact-panel"
                    type="button" role="tab">
                <i class="fa fa-user me-1"></i>
                فرد
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Panel 1: انتخاب Organization -->
        <div class="tab-pane fade show active" id="organization-panel" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0 fw-semibold">انتخاب شرکت/سازمان</label>
                <!-- ⭐⭐⭐ دکمه افزودن سریع سازمان -->
                <button type="button" 
                        class="btn btn-sm btn-alt-info" 
                        onclick="openQuickAddModalForTask('organization')"
                        title="افزودن سریع سازمان جدید">
                    <i class="fa fa-building me-1"></i>
                    افزودن سریع
                </button>
            </div>

            <div id="OrganizationSelectionDiv">
                <select asp-for="SelectedOrganizationId"
                        class="js-select2 form-select"
                        id="SelectedOrganizationId"
                        name="SelectedOrganizationId"
                        data-placeholder="انتخاب شرکت/سازمان"
                        style="width: 100%;">
                    <option value="">انتخاب شرکت/سازمان</option>
                    @if (Model.OrganizationsInitial != null && Model.OrganizationsInitial.Any())
                    {
                        @foreach (var org in Model.OrganizationsInitial)
                        {
                            <option value="@org.Id">
                                @org.Name
                                @if (!string.IsNullOrEmpty(org.RegistrationNumber))
                                {
                                    <text> (ثبت: @org.RegistrationNumber)</text>
                                }
                            </option>
                        }
                    }
                </select>
            </div>

            <small class="form-text text-muted mt-1">
                <i class="fa fa-building me-1"></i>
                شرکت‌ها و سازمان‌هایی که در شعبه انتخاب شده تعریف شده‌اند
            </small>

            <!-- ⭐⭐⭐ بخش نمایش افراد مرتبط با Organization (با سمت) -->
            <div id="OrganizationContactsDiv" class="mt-3" style="display: none;">
                <div class="border rounded p-3 bg-light">
                    <h6 class="mb-3">
                        <i class="fa fa-users text-primary me-1"></i>
                        اعضای این سازمان
                    </h6>
                    <div id="organizationMembersList">
                        <!-- محتوا از AJAX بارگذاری می‌شود -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel 2: انتخاب Contact -->
        <div class="tab-pane fade" id="contact-panel" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="form-label mb-0 fw-semibold">انتخاب فرد</label>
                <!-- ⭐⭐⭐ دکمه افزودن سریع فرد -->
                <button type="button" 
                        class="btn btn-sm btn-alt-primary" 
                        onclick="openQuickAddModalForTask('contact')"
                        title="افزودن سریع فرد جدید">
                    <i class="fa fa-user-plus me-1"></i>
                    افزودن سریع
                </button>
            </div>

            <div id="ContactSelectionDiv">
                <select asp-for="SelectedContactId"
                        class="js-select2 form-select"
                        id="SelectedContactId"
                        name="SelectedContactId"
                        data-placeholder="انتخاب فرد"
                        style="width: 100%;">
                    <option value="">انتخاب فرد</option>
                    @if (Model.ContactsInitial != null && Model.ContactsInitial.Any())
                    {
                        @foreach (var contact in Model.ContactsInitial)
                        {
                            <option value="@contact.Id">@contact.FullName (@contact.NationalCode)</option>
                        }
                    }
                </select>
            </div>

            <small class="form-text text-muted mt-1">
                <i class="fa fa-user me-1"></i>
                افرادی که در شعبه انتخاب شده تعریف شده‌اند
            </small>

            <!-- ⭐⭐⭐ نمایش سازمان‌های مرتبط با فرد (اختیاری) -->
            <div id="contactOrganizationsSection" class="mt-3" style="display: none;">
                <div class="border rounded p-3 bg-light">
                    <h6 class="mb-3">
                        <i class="fa fa-sitemap text-info me-1"></i>
                        سازمان‌های مرتبط با این فرد
                    </h6>
                    <div id="contactOrganizationsList">
                        <!-- محتوا با Ajax بارگذاری می‌شود -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ⭐⭐⭐ Modal برای افزودن سریع -->
<div class="modal fade" id="quickAddModalTask" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" id="quickAddModalTaskContent">
            <!-- محتوا به صورت داینامیک بارگذاری می‌شود -->
        </div>
    </div>
</div>
