@model MahERP.DataModelLayer.ViewModels.taskingModualsViewModels.OperationWorkLogViewModel

<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <form id="addWorkLogForm" method="post" asp-action="AddWorkLog" asp-controller="TaskOperations">
            <input type="hidden" asp-for="TaskOperationId" />

            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fa fa-clipboard-check me-2"></i>
                    ثبت گزارش کار انجام شده
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="بستن"></button>
            </div>

            <div class="modal-body">
                <!-- اطلاعات تسک و عملیات -->
                <div class="alert alert-info mb-3">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>تسک:</strong> @Model.TaskTitle
                        </div>
                        <div class="col-md-6">
                            <strong>عملیات:</strong> @Model.OperationTitle
                        </div>
                    </div>
                </div>

                <!-- فرم ثبت WorkLog -->
                <div class="mb-3">
                    <label asp-for="WorkDescription" class="form-label">توضیحات کار انجام شده <span class="text-danger">*</span></label>
                    <textarea asp-for="WorkDescription" class="form-control" rows="4"
                              placeholder="توضیحات کامل کار انجام شده را وارد کنید..."></textarea>
                    <span asp-validation-for="WorkDescription" class="text-danger"></span>
                </div>

                <!-- لیست WorkLog های اخیر -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fa fa-history me-2"></i>
                            آخرین گزارشات ثبت شده
                            @if (Model.TotalWorkLogsCount > 0)
                            {
                                <span class="badge bg-primary">@Model.TotalWorkLogsCount</span>
                            }
                        </h6>
                        @if (Model.TotalWorkLogsCount > 0)
                        {
                            <button type="button" class="btn btn-sm btn-outline-primary"
                                    data-toggle="modal-ajax"
                                    href="@Url.Action("ViewWorkLogsModal", "TaskOperations", new { operationId = Model.TaskOperationId })">
                                <i class="fa fa-list me-1"></i>
                                مشاهده همه
                            </button>
                        }
                    </div>

                    <div id="workLogsListContainer">
                        @await Html.PartialAsync("_WorkLogsList", Model.RecentWorkLogs ?? new List<OperationWorkLogViewModel>())
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-success" data-save="modal-ajax-save">
                    <i class="fa fa-save me-1"></i>
                    ثبت گزارش کار
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // مدیریت ثبت موفق WorkLog
            $('[data-save="modal-ajax-save"]').on('ajaxSuccess', function(event, response) {
                if (response.status === 'update-view') {
                    // پاک کردن فرم
                    $('#addWorkLogForm')[0].reset();

                    // نمایش پیام موفقیت
                    console.log('WorkLog ثبت شد، لیست بروزرسانی شد');
                }
            });
        });
    </script>
}