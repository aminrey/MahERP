@model TaskCardViewModel

@* ⭐⭐⭐ کارت نواری تمام عرض با نمایش موبایلی بهبود یافته *@
<div class="col-12" id="task-row-@Model.Id">
    <div class="block block-rounded mb-3 @(Model.IsCompleted ? "bg-success-light" : "") position-relative task-row-card"
         style="@(GetBorderAndBackgroundStyle(Model)); 
                box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                transition: all 0.2s ease;">

        @* ⭐ Ribbons کوچک برای ویژگی‌ها *@
        @if (Model.IsFocused || Model.IsInMyDay)
        {
            <div class="position-absolute top-0 start-0 d-flex" style="z-index: 3;">
                @if (Model.IsFocused)
                {
                    <span class="badge bg-warning text-dark me-1 mt-2 ms-2" style="font-size: 0.65rem;">
                        <i class="fa fa-star"></i> فوکوس
                    </span>
                }
                @if (Model.IsInMyDay)
                {
                    <span class="badge bg-success me-1 mt-2" style="font-size: 0.65rem;">
                        <i class="fa fa-calendar-check"></i> روز من
                    </span>
                }
            </div>
        }

        <div class="block-content p-3">
            <div class="row align-items-center g-2">
                
                @* ⭐ ستون 1: شماره و کد تسک (همیشه نمایش) *@
                <div class="col-auto">
                    <div class="text-center" style="min-width: 70px;">
                        <div class="fw-bold text-primary" style="font-size: 1rem;">#@Model.CardNumber</div>
                        <div class="fs-xs text-muted">@Model.TaskCode</div>
                    </div>
                </div>

                @* ⭐ ستون 2: عنوان و اطلاعات اصلی (responsive) *@
                <div class="col">
                    <div class="d-flex flex-column">
                        <a target="_blank" 
                           href="@Url.Action("Details", "Tasks", new { id = Model.Id })"
                           class="fw-bold text-dark text-decoration-none mb-1 task-title"
                           style="font-size: 0.95rem;">
                            @Model.Title
                        </a>
                        
                        @* توضیحات کوتاه (فقط دسکتاپ) *@
                        @if (!string.IsNullOrEmpty(Model.ShortDescription))
                        {
                            <small class="text-muted d-none d-lg-block mb-2">@Model.ShortDescription</small>
                        }

                        @* Badge های اطلاعاتی (همیشه نمایش) *@
                        <div class="mt-1 d-flex flex-wrap gap-1">
                            @* دسته‌بندی *@
                            @if (!string.IsNullOrEmpty(Model.CategoryTitle))
                            {
                                <span class="badge @Model.CategoryBadgeClass" style="font-size: 0.65rem;">
                                    <i class="fa fa-folder me-1"></i>@Model.CategoryTitle
                                </span>
                            }
                            
                            @* طرف حساب *@
                            @if (!string.IsNullOrEmpty(Model.StakeholderName))
                            {
                                <span class="badge bg-secondary" style="font-size: 0.65rem;">
                                    <i class="fa fa-user me-1"></i>@Model.StakeholderName
                                </span>
                            }

                            @* اولویت (موبایل) *@
                            <span class="badge @Model.PriorityBadgeClass d-md-none" style="font-size: 0.65rem;">
                                @Model.PriorityText
                            </span>

                            @* وضعیت (موبایل) *@
                            <span class="badge @Model.StatusBadgeClass d-md-none" style="font-size: 0.65rem;">
                                @Model.StatusText
                            </span>

                            @* عقب افتاده *@
                            @if (Model.IsOverdue)
                            {
                                <span class="badge bg-danger" style="font-size: 0.65rem;">
                                    <i class="fa fa-exclamation-triangle"></i> عقب‌افتاده
                                </span>
                            }

                            @* نوع نظارت *@
                            @if (!string.IsNullOrEmpty(Model.SupervisionType))
                            {
                                <span class="badge @Model.SupervisionBadgeClass" style="font-size: 0.65rem;">
                                    <i class="fa @Model.SupervisionIcon me-1"></i>@Model.SupervisionTypeText
                                </span>
                            }
                        </div>

                        @* تاریخ‌ها (موبایل) *@
                        <div class="mt-2 d-lg-none">
                            <div class="fs-xs text-muted">
                                <i class="fa fa-calendar-plus me-1"></i>@Model.CreateDatePersian
                                @if (Model.DueDate.HasValue)
                                {
                                    <span class="ms-2">
                                        <i class="fa fa-clock me-1"></i>@Model.DueDatePersian
                                    </span>
                                }
                            </div>
                        </div>

                        @* پیشرفت (موبایل) *@
                        @if (Model.TotalOperations > 0)
                        {
                            <div class="mt-2 d-xxl-none">
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 6px; min-width: 80px;">
                                        <div class="progress-bar @(Model.ProgressPercentage == 100 ? "bg-success" : "bg-primary")"
                                             style="width: @Model.ProgressPercentage%"></div>
                                    </div>
                                    <span class="badge @(Model.ProgressPercentage == 100 ? "bg-success" : "bg-primary")" style="font-size: 0.6rem;">
                                        @Model.ProgressPercentage%
                                    </span>
                                </div>
                            </div>
                        }

                        @* اعضا (موبایل) *@
                        <div class="mt-2 d-xl-none">
                            @if (Model.Members != null && Model.Members.Any())
                            {
                                <div class="d-flex align-items-center">
                                    @foreach (var member in Model.Members.Take(3))
                                    {
                                        @if (!string.IsNullOrEmpty(member.ProfileImagePath))
                                        {
                                            <img src="@member.ProfileImagePath"
                                                 class="rounded-circle task-member-avatar"
                                                 style="width: 24px; height: 24px; margin-left: -4px; border: 2px solid white; cursor: pointer;"
                                                 data-tooltip="@member.TooltipText"
                                                 data-tooltip-position="top"
                                                 data-tooltip-theme="primary"
                                                 alt="@member.FullName">
                                        }
                                        else
                                        {
                                            <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white fw-bold task-member-avatar"
                                                 style="width: 24px; height: 24px; margin-left: -4px; border: 2px solid white; font-size: 10px; cursor: pointer;"
                                                 data-tooltip="@member.TooltipText"
                                                 data-tooltip-position="top"
                                                 data-tooltip-theme="primary">
                                                @member.Initials
                                            </div>
                                        }
                                    }
                                    @if (Model.RemainingMembers > 0)
                                    {
                                        <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary text-white fw-bold"
                                             style="width: 24px; height: 24px; margin-left: -4px; border: 2px solid white; font-size: 9px; cursor: pointer;"
                                             data-tooltip="@Model.RemainingMembers نفر دیگر"
                                             data-tooltip-position="top"
                                             data-tooltip-theme="dark">
                                            +@Model.RemainingMembers
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @* ⭐ ستون 3: اولویت و وضعیت (فقط دسکتاپ) *@
                <div class="col-auto d-none d-md-flex flex-column align-items-center" style="min-width: 100px;">
                    <span class="badge @Model.PriorityBadgeClass mb-1" style="font-size: 0.7rem; width: 90px;">
                        @Model.PriorityText
                    </span>
                    <span class="badge @Model.StatusBadgeClass" style="font-size: 0.7rem; width: 90px;">
                        @Model.StatusText
                    </span>
                </div>

                @* ⭐ ستون 4: تاریخ شروع و مهلت (فقط دسکتاپ) *@
                <div class="col-auto d-none d-lg-block text-center" style="min-width: 130px;">
                    @* تاریخ شروع - اگر وجود داشته باشد *@
                    @if (Model.StartDate.HasValue)
                    {
                        <div class="fs-xs text-muted mb-1">
                            <i class="fa fa-play-circle me-1 text-primary"></i>
                            <strong>شروع:</strong> @(ConvertDateTime.ConvertMiladiToShamsi(Model.StartDate, "yyyy/MM/dd"))
                        </div>
                    }
                    else
                    {
                        <div class="fs-xs text-muted mb-1">
                            <i class="fa fa-calendar-plus me-1"></i>
                            <strong>ایجاد:</strong> @Model.CreateDatePersian
                        </div>
                    }
                    
                    @* تاریخ پایان *@
                    @if (Model.DueDate.HasValue)
                    {
                        <div class="fs-xs @(Model.IsOverdue ? "text-danger fw-bold" : "text-muted")">
                            <i class="fa fa-flag-checkered me-1 @(Model.IsOverdue ? "text-danger" : "text-success")"></i>
                            <strong>مهلت:</strong> @Model.DueDatePersian
                        </div>
                        @if (Model.DaysRemaining.HasValue)
                        {
                            <span class="badge @(Model.DaysRemaining < 0 ? "bg-danger" : Model.DaysRemaining <= 2 ? "bg-warning" : "bg-info") mt-1"
                                  style="font-size: 0.6rem;">
                                @(Model.DaysRemaining > 0 ? $"{Model.DaysRemaining} روز" : Model.DaysRemaining == 0 ? "امروز" : $"{Math.Abs(Model.DaysRemaining.Value)} روز تاخیر")
                            </span>
                        }
                    }
                </div>

                @* ⭐ ستون 5: اعضا (فقط دسکتاپ بزرگ) *@
                <div class="col-auto d-none d-xl-flex align-items-center" style="min-width: 120px;">
                    @if (Model.Members != null && Model.Members.Any())
                    {
                        <div class="d-flex align-items-center">
                            @foreach (var member in Model.Members.Take(3))
                            {
                                @if (!string.IsNullOrEmpty(member.ProfileImagePath))
                                {
                                    <img src="@member.ProfileImagePath"
                                         class="rounded-circle task-member-avatar"
                                         style="width: 28px; height: 28px; margin-left: -6px; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer;"
                                         data-tooltip="@member.TooltipText"
                                         data-tooltip-position="top"
                                         data-tooltip-theme="primary"
                                         alt="@member.FullName">
                                }
                                else
                                {
                                    <div class="d-flex align-items-center justify-content-center rounded-circle bg-primary text-white fw-bold task-member-avatar"
                                         style="width: 28px; height: 28px; margin-left: -6px; border: 2px solid white; font-size: 11px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer;"
                                         data-tooltip="@member.TooltipText"
                                         data-tooltip-position="top"
                                         data-tooltip-theme="primary">
                                        @member.Initials
                                    </div>
                                }
                            }
                            @if (Model.RemainingMembers > 0)
                            {
                                <div class="d-flex align-items-center justify-content-center rounded-circle bg-secondary text-white fw-bold"
                                     style="width: 28px; height: 28px; margin-left: -6px; border: 2px solid white; font-size: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer;"
                                     data-tooltip="@Model.RemainingMembers نفر دیگر"
                                     data-tooltip-position="top"
                                     data-tooltip-theme="dark">
                                    +@Model.RemainingMembers
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <span class="text-muted small">
                            <i class="fa fa-users me-1"></i>بدون عضو
                        </span>
                    }
                </div>

                @* ⭐ ستون 6: پیشرفت (فقط دسکتاپ بزرگ) *@
                @if (Model.TotalOperations > 0)
                {
                    <div class="col-auto d-none d-xxl-block" style="min-width: 140px;">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-2" style="height: 8px; min-width: 80px;">
                                <div class="progress-bar @(Model.ProgressPercentage == 100 ? "bg-success" : "bg-primary")"
                                     role="progressbar"
                                     style="width: @Model.ProgressPercentage%"
                                     aria-valuenow="@Model.ProgressPercentage"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <span class="badge @(Model.ProgressPercentage == 100 ? "bg-success" : "bg-primary")" style="font-size: 0.65rem;">
                                @Model.ProgressPercentage%
                            </span>
                        </div>
                        <div class="fs-xs text-muted text-center mt-1">
                            @Model.CompletedOperations/@Model.TotalOperations عملیات
                        </div>
                    </div>
                }

                @* ⭐ ستون 7: دکمه‌های عملیات (همیشه نمایش) *@
                <div class="col-auto">
                    <div class="btn-group btn-group-sm" role="group">
                        <a target="_blank" 
                           href="@Url.Action("Details", "Tasks", new { id = Model.Id })"
                           class="btn btn-sm btn-alt-secondary"
                           data-tooltip="جزئیات"
                           data-tooltip-position="top"
                           data-tooltip-theme="dark">
                            <i class="fa fa-eye"></i>
                        </a>

                        @if (!Model.IsCompleted && Model.CanComplete)
                        {
                            <button class="btn btn-sm btn-success complete-task-from-list-btn"
                                    data-toggle="modal-ajax"
                                    data-tooltip="تکمیل تسک"
                                    data-tooltip-position="top"
                                    data-tooltip-theme="success"
                                    asp-controller="Tasks" asp-action="CompleteTask" asp-route-id="@Model.Id" asp-route-fromList="true" asp-route-rowNum="@Model.CardNumber">
                                <i class="fa fa-check"></i>
                            </button>
                        }

                        @if (Model.CanEdit)
                        {
                            <button class="btn btn-sm btn-alt-secondary d-none d-sm-inline-block"
                                    onclick="editTask(@Model.Id)"
                                    data-tooltip="ویرایش تسک"
                                    data-tooltip-position="top"
                                    data-tooltip-theme="dark">
                                <i class="fa fa-pencil-alt"></i>
                            </button>
                        }

                        @* منوی بیشتر *@
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" 
                                    class="btn btn-sm btn-alt-secondary dropdown-toggle" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    title="عملیات بیشتر">
                                <i class="fa fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                @if (!Model.IsCompleted)
                                {
                                    @if (!Model.IsInMyDay)
                                    {
                                        <li>
                                            <a class="dropdown-item add-to-myday-from-row" 
                                               href="@Url.Action("AddToMyDayModal", "MyDayTask", new { 
                                                   taskId = Model.Id, 
                                                   fromList = true,
                                                   returnUrl = Context.Request.Path + Context.Request.QueryString,
                                                   sourcePage = "TaskRow"
                                               })"
                                               data-toggle="modal-ajax"
                                               data-task-id="@Model.Id">
                                                <i class="fa fa-calendar-plus me-2"></i>افزودن به روز من
                                            </a>
                                        </li>
                                    }
                                    @if (!Model.IsFocused)
                                    {
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="setTaskFocus(@Model.Id, true); return false;">
                                                <i class="fa fa-bullseye me-2"></i>تنظیم فوکوس
                                            </a>
                                        </li>
                                    }
                                    else
                                    {
                                        <li>
                                            <a class="dropdown-item" href="#" onclick="removeTaskFocus(@Model.Id, true); return false;">
                                                <i class="fa fa-times-circle me-2"></i>حذف فوکوس
                                            </a>
                                        </li>
                                    }
                                }
                                @if (Model.CanDelete)
                                {
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="#" onclick="deleteTask(@Model.Id); return false;">
                                            <i class="fa fa-trash me-2"></i>حذف
                                        </a>
                                    </li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    /// <summary>
    /// تعیین رنگ و پس‌زمینه نوار سمت راست بر اساس اولویت‌ها
    /// </summary>
    string GetBorderAndBackgroundStyle(TaskCardViewModel model)
    {
        // ⭐⭐⭐ اولویت: فوکوس > روز من > تکمیل شده > پیش‌فرض
        if (model.IsFocused)
        {
            // زرد برای فوکوس - استایل bg-gd-sun
            return "border-right: 5px solid #f59f00; " +
                   "background: linear-gradient(90deg, rgba(245,159,0,0.08) 0%, rgba(255,255,255,0) 100%); " +
                   "border-block: 1px solid #ffe8cc;";
        }
        else if (model.IsInMyDay)
        {
            // بنفش برای روز من - استایل bg-xinspire-dark
            return "border-right: 5px solid #6f42c1; " +
                   "background: linear-gradient(90deg, rgba(111,66,193,0.08) 0%, rgba(255,255,255,0) 100%); " +
                   "border-block: 1px solid #ddd5f3;";
        }
        else if (model.IsCompleted)
        {
            // سبز برای تکمیل شده
            return "border-right: 5px solid #34a853; " +
                   "border-block: 1px solid #d4edda;";
        }
        else
        {
            // آبی پیش‌فرض برای بقیه
            return "border-right: 5px solid #4285f4; " +
                   "border-block: 1px solid #e4e7ed;";
        }
    }
}

<style>
    /* ⭐⭐⭐ استایل کارت نواری با فاصله بیشتر */
    .task-row-card {
        transition: all 0.2s ease !important;
        position: relative; /* ⭐ ضروری برای z-index */
        z-index: 1;
    }

    /* ⭐⭐⭐ افزایش z-index هنگام hover یا باز بودن dropdown */
    .task-row-card:hover,
    .task-row-card:has(.dropdown-menu.show) {
        transform: translateX(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.12) !important;
        z-index: 100 !important; /* ⭐ بالاتر از بقیه کارت‌ها */
    }

    /* ⭐ اطمینان از اینکه dropdown بالای همه چیز باشد */
    .task-row-card .dropdown-menu {
        z-index: 1000;
    }

    .task-title:hover {
        color: #4285f4 !important;
    }

    /* ⭐⭐⭐ اطمینان از نمایش صحیح tooltip */
    .task-member-avatar {
        cursor: pointer;
    }

    /* Responsive adjustments */
    @@media (max-width: 768px) {
        .task-row-card .block-content {
            padding: 0.75rem !important;
        }
        
        .task-row-card .col-auto:first-child {
            min-width: 60px !important;
        }
    }
</style>
