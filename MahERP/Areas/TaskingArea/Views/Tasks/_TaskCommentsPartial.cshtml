@model List<TaskCommentViewModel>

@if (Model?.Any() == true)
{
    @foreach (var comment in Model)
    {
        var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        var isMyMessage = comment.CreatorUserId == currentUserId;
        var messageClass = isMyMessage ? "chat-message-right" : "chat-message-left";

        <div class="chat-message @messageClass mb-3" data-comment-id="@comment.Id">
            <div class="d-flex @(isMyMessage ? "flex-row-reverse" : "")">
           
                <!-- Message Content -->
                <div class="flex-grow-1 @(isMyMessage ? "me-3" : "ms-3")" style="max-width: 75%;">
                    <!-- Message Bubble -->
                    <div class="message-bubble @(isMyMessage ? "bg-primary text-white" : "bg-white") shadow-sm">
                        <!-- Header -->
                        <div class="message-header pb-2 mb-2 border-bottom @(isMyMessage ? "border-white-25" : "")">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong class="@(isMyMessage ? "text-white" : "text-dark")">
                                    @(isMyMessage ? "شما" : comment.CreatorName)
                                </strong>
                                <small class="@(isMyMessage ? "text-white-75" : "text-muted")">
                                    @ConvertDateTime.ConvertMiladiToShamsi(comment.CreateDate, "dddd dd MMMM yyyy ساعت HH:mm ")
                                </small>
                            </div>
                        </div>

                        <!-- Message Text -->
                        <div class="message-text">
                            @Html.Raw(comment.CommentText.Replace("\n", "<br/>"))
                        </div>

                        <!-- Attachments -->
                        @if (comment.Attachments?.Any() == true)
                        {
                            <div class="message-attachments mt-3 pt-3 border-top @(isMyMessage ? "border-white-25" : "")">
                                @foreach (var attachment in comment.Attachments)
                                {
                                    var extension = System.IO.Path.GetExtension(attachment.FileName)?.ToLower();
                                    var iconClass = "fa-file";
                                    var badgeClass = "secondary";

                                    // تعیین آیکون بر اساس نوع فایل
                                    if (new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp" }.Contains(extension))
                                    {
                                        iconClass = "fa-file-image";
                                        badgeClass = "success";
                                    }
                                    else if (extension == ".pdf")
                                    {
                                        iconClass = "fa-file-pdf";
                                        badgeClass = "danger";
                                    }
                                    else if (new[] { ".doc", ".docx" }.Contains(extension))
                                    {
                                        iconClass = "fa-file-word";
                                        badgeClass = "primary";
                                    }
                                    else if (new[] { ".xls", ".xlsx", ".csv" }.Contains(extension))
                                    {
                                        iconClass = "fa-file-excel";
                                        badgeClass = "success";
                                    }
                                    else if (new[] { ".ppt", ".pptx" }.Contains(extension))
                                    {
                                        iconClass = "fa-file-powerpoint";
                                        badgeClass = "warning";
                                    }
                                    else if (extension == ".txt")
                                    {
                                        iconClass = "fa-file-alt";
                                        badgeClass = "info";
                                    }
                                    else if (new[] { ".zip", ".rar", ".7z" }.Contains(extension))
                                    {
                                        iconClass = "fa-file-archive";
                                        badgeClass = "dark";
                                    }

                                    <a href="@Url.Action("DownloadAttachment", "Tasks", new { id = attachment.Id })"
                                       class="btn btn-sm @(isMyMessage ? "btn-light" : $"btn-outline-{badgeClass}") mb-1 me-1"
                                       download
                                       title="دانلود @attachment.FileName">
                                        <i class="fa @iconClass me-1"></i>
                                        @attachment.FileName
                                        @if (attachment.FileSize != 0)
                                        {
                                            <small class="ms-1">(@((attachment.FileSize / 1024.0).ToString("F2")) KB)</small>
                                        }
                                        <i class="fa fa-download ms-1"></i>
                                    </a>
                                }
                            </div>
                        }



                        <!-- Badges -->
                        @if (comment.IsImportant || comment.IsEdited)
                        {
                            <div class="message-badges mt-2">
                                @if (comment.IsImportant)
                                {
                                    <span class="badge bg-danger badge-sm me-1">
                                        <i class="fa fa-exclamation-circle"></i> مهم
                                    </span>
                                }
                                
                            </div>
                        }
                    </div>

                    <!-- Actions -->
                    @if (isMyMessage)
                    {
                        <div class="message-actions mt-1 @(isMyMessage ? "text-end" : "")">
                          
                            <button type="button"
                                    class="btn btn-sm btn-link text-danger p-0"
                                    onclick="deleteComment(@comment.Id)"
                                    title="حذف">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    }
                </div>
                <!-- Avatar -->
                <div class="flex-shrink-0">
                    <img src="@(comment.CreatorProfileImage ?? "/images/default-avatar.png")"
                         class="rounded-circle shadow-sm"
                         style="width: 48px; height: 48px; object-fit: cover;"
                         alt="@comment.CreatorName">
                </div>



            </div>
        </div>
    }
}
else
{
    <!-- Empty State -->
    <div class="text-center py-5">
        <div class="mb-4">
            <i class="fa fa-comments fa-4x text-muted opacity-25"></i>
        </div>
        <h4 class="text-muted">هنوز پیامی ارسال نشده است</h4>
        <p class="text-muted">اولین نفری باشید که پیام می‌فرستد!</p>
    </div>
}