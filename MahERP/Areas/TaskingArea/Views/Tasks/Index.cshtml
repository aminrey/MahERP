@model MahERP.DataModelLayer.ViewModels.TaskListViewModel

@{
    ViewData["Title"] = "لیست تسک‌ها";
}

<div class="content">
    <!-- ⭐ Header با آمار -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-tasks me-1"></i>
                مدیریت تسک‌ها
            </h3>
            <div class="block-options">
                <a asp-action="CreateNewTask" class="btn btn-sm btn-alt-primary">
                    <i class="fa fa-plus me-1"></i>تسک جدید
                </a>
            </div>
        </div>
        <!-- ⭐⭐⭐ آمار سریع -->
        <div class="block-content">
            <div class="row g-sm">
                <div class="col-6 col-md-3">
                    <a href="javascript:void(0)"
                       class="text-decoration-none quick-status-filter"
                       data-filter="1"
                       style="display: block;">
                        <div class="p-3 bg-body-light rounded text-center hover-lift @(Model.CurrentStatusFilter == QuickStatusFilter.Pending ? "border border-2 border-primary" : "")">
                            <div class="fs-3 fw-semibold text-primary">@Model.Stats.TotalPending</div>
                            <div class="text-muted">در حال انجام</div>
                        </div>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="javascript:void(0)"
                       class="text-decoration-none quick-status-filter"
                       data-filter="2"
                       style="display: block;">
                        <div class="p-3 bg-body-light rounded text-center hover-lift @(Model.CurrentStatusFilter == QuickStatusFilter.Completed ? "border border-2 border-success" : "")">
                            <div class="fs-3 fw-semibold text-success">@Model.Stats.TotalCompleted</div>
                            <div class="text-muted">تکمیل شده</div>
                        </div>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="javascript:void(0)"
                       class="text-decoration-none quick-status-filter"
                       data-filter="3"
                       style="display: block;">
                        <div class="p-3 bg-body-light rounded text-center hover-lift @(Model.CurrentStatusFilter == QuickStatusFilter.Overdue ? "border border-2 border-danger" : "")">
                            <div class="fs-3 fw-semibold text-danger">@Model.Stats.TotalOverdue</div>
                            <div class="text-muted">عقب افتاده</div>
                        </div>
                    </a>
                </div>
                <div class="col-6 col-md-3">
                    <a href="javascript:void(0)"
                       class="text-decoration-none quick-status-filter"
                       data-filter="4"
                       style="display: block;">
                        <div class="p-3 bg-body-light rounded text-center hover-lift @(Model.CurrentStatusFilter == QuickStatusFilter.Urgent ? "border border-2 border-warning" : "")">
                            <div class="fs-3 fw-semibold text-warning">@Model.Stats.TotalUrgent</div>
                            <div class="text-muted">فوری</div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ⭐⭐⭐ تب‌های اصلی -->
    <div class="block block-rounded">
        <ul class="nav nav-tabs nav-tabs-block" role="tablist">
            <li class="nav-item">
                <button class="nav-link @(Model.CurrentViewType == TaskViewType.MyTasks ? "active" : "")" 
                        onclick="changeViewType(@((int)TaskViewType.MyTasks))">
                    <i class="fa fa-user me-1"></i>تسک‌های من
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(Model.CurrentViewType == TaskViewType.AssignedByMe ? "active" : "")" 
                        onclick="changeViewType(@((int)TaskViewType.AssignedByMe))">
                    <i class="fa fa-share-square me-1"></i>واگذار شده
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(Model.CurrentViewType == TaskViewType.Supervised ? "active" : "")" 
                        onclick="changeViewType(@((int)TaskViewType.Supervised))">
                    <i class="fa fa-eye me-1"></i>نظارتی
                </button>
            </li>
        </ul>
    </div>

    <!-- ⭐⭐⭐ دکمه‌های گروه‌بندی + دکمه جستجوی پیشرفته -->
    <div class="block block-rounded">
        <div class="block-content">
            <div class="d-flex flex-wrap gap-2 align-items-center">
             
                <!-- دکمه‌های گروه‌بندی -->
                <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.Team ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.Team)"
                        onclick="changeGrouping(@((int)TaskGroupingType.Team))">
                    <i class="fa fa-users me-1"></i>تیم
                </button>
                   <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.Stakeholder ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.Stakeholder)"
                        onclick="changeGrouping(@((int)TaskGroupingType.Stakeholder))">
                    <i class="fa fa-address-book me-1"></i>طرف حساب
                </button>

                <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.Creator ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.Creator)"
                        onclick="changeGrouping(@((int)TaskGroupingType.Creator))">
                    <i class="fa fa-user-tie me-1"></i>سازنده
                </button>
                    <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.Priority ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.Priority)"
                        onclick="changeGrouping(@((int)TaskGroupingType.Priority))">
                    <i class="fa fa-flag me-1"></i>اولویت
                </button>
                <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.CreateDate ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.CreateDate)"
                        onclick="changeGrouping(@((int)TaskGroupingType.CreateDate))">
                    <i class="fa fa-calendar-plus me-1"></i>زمان ساخت
                </button>
                <button class="btn btn-sm btn-grouping @(Model.CurrentGrouping == TaskGroupingType.DueDate ? "btn-primary" : "btn-alt-secondary")"
                        data-grouping="@((int)TaskGroupingType.DueDate)"
                        onclick="changeGrouping(@((int)TaskGroupingType.DueDate))">
                    <i class="fa fa-calendar-check me-1"></i>زمان پایان
                </button>
            
                <!-- ⭐⭐⭐ دکمه جدید طرف حساب -->
             
                <!-- ⭐⭐⭐ دکمه جستجوی پیشرفته -->
                <button type="button" 
                        class="btn btn-sm btn-alt-success" 
                        id="toggle-advanced-filters-btn" 
                        title="جستجوی پیشرفته">
                    <i class="fa fa-filter me-1"></i>
                    جستجوی پیشرفته
                </button>
                
                <!-- ⭐⭐⭐ دکمه‌های باز/بسته کردن همه -->
                <div class="btn-group ms-auto gap-2" role="group">
                    <button type="button" class="btn btn-sm btn-alt-secondary " id="expand-all-groups" title="بازکردن همه گروه‌ها">
                        <i class="fa fa-chevron-down me-1"></i>بازکردن همه
                    </button>
                    <button type="button" class="btn btn-sm btn-alt-secondary" id="collapse-all-groups" title="بستن همه گروه‌ها">
                        <i class="fa fa-chevron-up me-1"></i>بستن همه
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- ⭐⭐⭐ پنل فیلترهای پیشرفته (مخفی به صورت پیش‌فرض) -->
    @await Html.PartialAsync("_AdvancedFiltersPanel", Model)

    <!-- ⭐⭐⭐ لیست گروه‌ها -->
    <div id="task-groups-container">
        @await Html.PartialAsync("_TaskListGroupsPartial", Model)
    </div>
</div>

@section Scripts {
    <script>
        // ⭐⭐⭐ مقداردهی اولیه State
        window.TaskListInitialState = {
            currentViewType: @((int)Model.CurrentViewType),
            currentGrouping: @((int)Model.CurrentGrouping),
            currentStatusFilter: @((int)Model.CurrentStatusFilter),
            currentFilters: @Html.Raw(Json.Serialize(Model.Filters ?? new TaskFilterViewModel()))
        };

        window.TaskListConfig = {
            currentViewType: @((int)Model.CurrentViewType),
            currentGrouping: @((int)Model.CurrentGrouping),
            currentStatusFilter: @((int)Model.CurrentStatusFilter),
            urls: {
                changeGrouping: '@Url.Action("ChangeGrouping", "Tasks")',
                changeStatusFilter: '@Url.Action("ChangeQuickStatusFilter", "Tasks")',
                toggleComplete: '@Url.Action("ToggleTaskComplete", "Tasks")',
                deleteTask: '@Url.Action("Delete", "Tasks")'
            }
        };
    </script>
    
    <!-- ⭐⭐⭐ فقط یک بار فایل اصلی رو لود کن -->
    <script src="~/assets/js/TaskList.js"></script>
    
    <style>
        /* ⭐ افکت hover برای آمار کلیک‌پذیر */
        .hover-lift {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1) !important;
        }
        
        .quick-status-filter:hover .hover-lift {
            background-color: #f0f0f0 !important;
        }
        
        /* انیمیشن برای border فعال */
        .quick-status-filter .p-3 {
            transition: all 0.3s ease;
        }
    </style>
}