@model TaskViewModel

@{
    // دریافت فایل‌های پیوست از ViewBag یا Model
    var attachments = ViewBag.TaskAttachments as List<MahERP.DataModelLayer.Entities.TaskManagement.TaskAttachment>
                      ?? new List<MahERP.DataModelLayer.Entities.TaskManagement.TaskAttachment>();
}

@if (attachments.Any())
{
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-paperclip text-success me-2"></i>فایل‌های پیوست
            </h3>
            <div class="block-options">
                <span class="badge bg-success">
                    @attachments.Count فایل
                </span>
            </div>
        </div>
        <div class="block-content">
            <div class="row g-3">
                @foreach (var attachment in attachments)
                {
                    var extension = attachment.FileExtension?.ToLower() ?? "";
                    var iconClass = "fa-file";
                    var badgeClass = "secondary";
                    var cardColor = "border-secondary";

                    // تعیین آیکون و رنگ بر اساس نوع فایل
                    if (new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp" }.Contains(extension))
                    {
                        iconClass = "fa-file-image";
                        badgeClass = "success";
                        cardColor = "border-success";
                    }
                    else if (extension == ".pdf")
                    {
                        iconClass = "fa-file-pdf";
                        badgeClass = "danger";
                        cardColor = "border-danger";
                    }
                    else if (new[] { ".doc", ".docx" }.Contains(extension))
                    {
                        iconClass = "fa-file-word";
                        badgeClass = "primary";
                        cardColor = "border-primary";
                    }
                    else if (new[] { ".xls", ".xlsx", ".csv" }.Contains(extension))
                    {
                        iconClass = "fa-file-excel";
                        badgeClass = "success";
                        cardColor = "border-success";
                    }
                    else if (new[] { ".ppt", ".pptx" }.Contains(extension))
                    {
                        iconClass = "fa-file-powerpoint";
                        badgeClass = "warning";
                        cardColor = "border-warning";
                    }
                    else if (extension == ".txt")
                    {
                        iconClass = "fa-file-alt";
                        badgeClass = "info";
                        cardColor = "border-info";
                    }
                    else if (new[] { ".zip", ".rar", ".7z" }.Contains(extension))
                    {
                        iconClass = "fa-file-archive";
                        badgeClass = "dark";
                        cardColor = "border-dark";
                    }

                    var fileSizeKB = attachment.FileSize / 1024.0;
                    var fileSizeText = fileSizeKB < 1024
                        ? $"{fileSizeKB:F2} KB"
                        : $"{fileSizeKB / 1024:F2} MB";

                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 @cardColor attachment-card">
                            <div class="card-body d-flex flex-column">
                                <!-- آیکون فایل -->
                                <div class="text-center mb-3">
                                    <i class="fa @iconClass fa-4x text-@badgeClass"></i>
                                </div>

                                <!-- اطلاعات فایل -->
                                <div class="flex-grow-1">
                                    <h6 class="card-title text-truncate" title="@attachment.FileName">
                                        @attachment.FileName
                                    </h6>
                                    
                                    <!-- توضیحات -->
                                    @if (!string.IsNullOrEmpty(attachment.Description))
                                    {
                                        <p class="card-text small text-muted mb-2">
                                            @attachment.Description
                                        </p>
                                    }

                                    <!-- جزئیات فایل -->
                                    <div class="small text-muted">
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>
                                                <i class="fa fa-hdd me-1"></i>حجم:
                                            </span>
                                            <span class="fw-semibold">@fileSizeText</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-1">
                                            <span>
                                                <i class="fa fa-calendar me-1"></i>تاریخ:
                                            </span>
                                            <span class="fw-semibold">
                                                @MahERP.CommonLayer.PublicClasses.ConvertDateTime.ConvertMiladiToShamsi(attachment.UploadDate, "yyyy/MM/dd")
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>
                                                <i class="fa fa-user me-1"></i>بارگذار:
                                            </span>
                                            <span class="fw-semibold">
                                                @(attachment.Uploader != null
                                                    ? $"{attachment.Uploader.FirstName} {attachment.Uploader.LastName}"
                                                    : "نامشخص")
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <!-- دکمه دانلود -->
                                <div class="mt-3">
                                    <a href="@Url.Action("DownloadTaskAttachment", "Tasks", new { id = attachment.Id })"
                                       class="btn btn-sm btn-outline-@badgeClass w-100"
                                       download
                                       title="دانلود @attachment.FileName">
                                        <i class="fa fa-download me-1"></i>
                                        دانلود
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<style>
    .attachment-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .attachment-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .attachment-card .card-title {
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .attachment-card i.fa-4x {
        opacity: 0.8;
    }

    .attachment-card:hover i.fa-4x {
        opacity: 1;
    }
</style>
