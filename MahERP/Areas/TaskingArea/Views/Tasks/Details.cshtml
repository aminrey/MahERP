@model TaskViewModel
@{
    ViewData["Title"] = "جزئیات تسک";
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

    ViewBag.Task = Model;

    var isAssignedToCurrentUser = Model.IsAssignedToCurrentUser;
    var isCreator = Model.IsCreator;
    var isManager = Model.IsManager;
    var isSupervisor = Model.IsSupervisor;
    var isCompletedByMe = Model.IsCompletedByMe;
    var isFocused = Model.IsFocused ?? false;
    var isAdmin = ViewBag.IsAdmin ?? false;

    // تعیین رنگ و وضعیت
    string statusColor = "primary";
    string statusText = "در حال انجام";
    string statusIcon = "fa-clock";
    var isInMyDay = ViewBag.IsInMyDay ?? false;

    if (Model.IsDeleted)
    {
        statusColor = "danger"; statusText = "حذف شده"; statusIcon = "fa-trash";
    }
    else if (!Model.IsActive)
    {
        statusColor = "warning"; statusText = "غیرفعال"; statusIcon = "fa-pause-circle";
    }
    else if (Model.CompletionDate.HasValue && Model.ManagerApprovedDate.HasValue)
    {
        statusColor = "success"; statusText = "تایید نهایی"; statusIcon = "fa-check-double";
    }
    else if (Model.CompletionDate.HasValue && Model.SupervisorApprovedDate.HasValue)
    {
        statusColor = "info"; statusText = "تایید سرپرست"; statusIcon = "fa-user-check";
    }
    else if (Model.CompletionDate.HasValue)
    {
        statusColor = "success"; statusText = "تکمیل شده"; statusIcon = "fa-check-circle";
    }
    else if (Model.DueDate.HasValue && DateTime.Now > Model.DueDate.Value)
    {
        statusColor = "danger"; statusText = "تاخیر دارد"; statusIcon = "fa-exclamation-triangle";
    }
}
@Html.AntiForgeryToken()

<!-- ⭐⭐⭐ Hero Section - از Partial استفاده می‌کنیم -->
@await Html.PartialAsync("_TaskHeroSection", Model)

<!-- Main Content با Tabs -->
<div class="content content-full">
    <ul class="nav nav-tabs nav-tabs-alt nav-justified push task-detail-tabs sticky-tabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" type="button" role="tab">
                <i class="fa fa-info-circle d-block mb-1"></i>
                <span class="tab-title">نگاه کلی</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="work-logs-tab" data-bs-toggle="tab" data-bs-target="#tab-work-logs" type="button" role="tab">
                <i class="fa fa-clipboard-list d-block mb-1"></i>
                <span class="tab-title">گزارش‌ها</span>
                @if (Model.WorkLogs?.Any() == true)
                {
                    <span class="badge bg-info rounded-pill ms-1">@Model.WorkLogs.Count</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#tab-operations" type="button" role="tab">
                <i class="fa fa-cogs d-block mb-1"></i>
                <span class="tab-title">عملیات</span>
                @if (Model.Operations?.Any() == true)
                {
                    <span class="badge bg-primary rounded-pill ms-1" id="operations-badge-count">@Model.Operations.Count</span>
                }
                else
                {
                    <span class="badge bg-primary rounded-pill ms-1" id="operations-badge-count" style="display: none;">0</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-team" type="button" role="tab">
                <i class="fa fa-users d-block mb-1"></i>
                <span class="tab-title">اعضا</span>
                @if (Model.AssignmentsTaskUser?.Any() == true)
                {
                    <span class="badge bg-info rounded-pill ms-1">@Model.AssignmentsTaskUser.Count</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#tab-chat" type="button" role="tab">
                <i class="fa fa-comments d-block mb-1"></i>
                <span class="tab-title">گفتگو</span>
                <span class="badge bg-primary rounded-pill ms-1" id="chat-badge-count">
                    @(Model.Comments?.Count ?? 0)
                </span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#tab-reminders" type="button" role="tab">
                <i class="fa fa-bell d-block mb-1"></i>
                <span class="tab-title">یادآوری</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="viewers-tab" data-bs-toggle="tab" data-bs-target="#tab-viewers" type="button" role="tab">
                <i class="fa fa-eye d-block mb-1"></i>
                <span class="tab-title">ناظرین</span>
                <span class="badge bg-info rounded-pill ms-1" id="viewers-badge-count">0</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-timeline" type="button" role="tab">
                <i class="fa fa-history d-block mb-1"></i>
                <span class="tab-title">تاریخچه</span>
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content">
        <!-- ⭐⭐⭐ Overview Tab - از Partial استفاده می‌کنیم -->
        <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
            @await Html.PartialAsync("_TaskOverviewTab", Model)
        </div>

        <!-- Tab 2: گزارش های کاری-->
<div class="tab-pane fade" id="tab-work-logs" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-info text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-clipboard-list me-2"></i>گزارش‌های کاری ثبت شده
            </h3>
            <div class="block-options">
                @if (isAssignedToCurrentUser && !isCompletedByMe)
                {
                    <button type="button" 
                            class="btn btn-sm btn-light" 
                            data-toggle="modal-ajax" 
                            href="@Url.Action("SubmitTaskWorkLogModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-plus me-1"></i>ثبت گزارش جدید
                    </button>
                }
            </div>
        </div>
        <div class="block-content">
            <div id="work-logs-container">
                @if (Model.WorkLogs?.Any() == true)
                {
                    <!-- Timeline Design -->
                    <div class="timeline timeline-alt py-0">
                        @foreach (var log in Model.WorkLogs.OrderByDescending(w => w.WorkDate))
                        {
                            <div class="timeline-event">
                                <div class="timeline-event-icon bg-info">
                                    <i class="fa fa-clipboard-check"></i>
                                </div>
                                <div class="timeline-event-block block block-rounded block-fx-shadow">
                                    <div class="block-header">
                                        <div class="d-flex align-items-center w-100">
                                            <!-- عکس کاربر -->
                                            <div class="flex-shrink-0 me-3">
                                                <img src="@(log.UserProfileImage ?? "/images/default-avatar.png")"
                                                     class="rounded-circle"
                                                     style="width: 48px; height: 48px; object-fit: cover;"
                                                     alt="@log.UserName">
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">@log.UserName</h6>
                                                <small class="text-muted">
                                                    <i class="fa fa-calendar me-1"></i>
                                                    @ConvertDateTime.ConvertMiladiToShamsi(log.WorkDate, "yyyy/MM/dd")
                                                    <i class="fa fa-clock me-1 ms-2"></i>
                                                    @log.WorkDate.ToString("HH:mm")
                                                </small>
                                            </div>
                                            @if (log.DurationMinutes.HasValue)
                                            {
                                                <div class="flex-shrink-0">
                                                    <span class="badge bg-primary rounded-pill">
                                                        <i class="fa fa-hourglass-half me-1"></i>
                                                        @log.DurationMinutes دقیقه
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="block-content">
                                        <p class="mb-2">@Html.Raw(log.WorkDescription.Replace("\n", "<br/>"))</p>
                                        
                                        @if (log.ProgressPercentage.HasValue)
                                        {
                                            <div class="mt-3">
                                                <small class="text-muted">پیشرفت پس از این کار:</small>
                                                <div class="progress" style="height: 10px;">
                                                    <div class="progress-bar bg-success" 
                                                         style="width: @log.ProgressPercentage%" 
                                                         role="progressbar">
                                                    </div>
                                                </div>
                                                <small class="text-success fw-bold">@log.ProgressPercentage%</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Empty State -->
                    <div class="text-center py-5 text-muted">
                        <i class="fa fa-clipboard-list fa-4x opacity-25 mb-3"></i>
                        <h5>هیچ گزارشی ثبت نشده است</h5>
                        @if (isAssignedToCurrentUser)
                        {
                            <p class="mb-3">برای ثبت اولین گزارش کاری، از دکمه زیر استفاده کنید</p>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    data-toggle="modal-ajax" 
                                    href="@Url.Action("SubmitTaskWorkLogModal", "Tasks", new { taskId = Model.Id })">
                                <i class="fa fa-plus me-1"></i>ثبت گزارش جدید
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>


        <!-- Tab 3: عملیات‌ها -->
        <div class="tab-pane fade" id="tab-operations" role="tabpanel">
            <div class="block block-rounded block-fx-shadow">
                <div class="block-header bg-primary text-white">
                    <h3 class="block-title text-white mb-0">
                        <i class="fa fa-cogs me-2"></i>مدیریت عملیات تسک
                    </h3>
                    <div class="block-options">
                        @if ((isAssignedToCurrentUser || isCreator || isManager) && !Model.CompletionDate.HasValue)
                        {
                            <button type="button" class="btn btn-sm btn-light"
                                    onclick="$('#newOperationTitleInput').focus()">
                                <i class="fa fa-plus me-1"></i>افزودن سریع
                            </button>
                        }
                        else if (Model.CompletionDate.HasValue)
                        {
                            <span class="badge bg-light text-dark">
                                <i class="fa fa-lock me-1"></i>قفل شده
                            </span>
                        }
                    </div>
                </div>

                <div class="block-content">

                    <div id="pending-operations-container">

                        <partial name="/Areas/TaskingArea/Views/TaskOperations/_OperationListPartialView.cshtml" model="Model.Operations" />
                                                </div>


                
                
                
                </div>
            </div>
        </div>


        <!-- Tab 3: اعضای تسک -->
<div class="tab-pane fade" id="tab-team" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-info text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-users me-2"></i>اعضای تسک
            </h3>
            <div class="block-options">
                @if ((isCreator || isManager) && !isCompletedByMe)
                {
                    <button type="button" 
                            class="btn btn-sm btn-light" 
                            data-toggle="modal-ajax" 
                            href="@Url.Action("AssignUserToTaskModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-user-plus me-1"></i>افزودن کاربر
                    </button>
                }
                else if (isCompletedByMe)
                {
                    <span class="badge bg-light text-dark">
                        <i class="fa fa-lock me-1"></i>قفل شده
                    </span>
                }
            </div>
        </div>
        <div class="block-content">
            <!-- ⭐⭐⭐ Container برای بروزرسانی AJAX -->
            <div id="task-members-container">
                @{
                    ViewBag.Assignments = Model.AssignmentsTaskUser;
                    ViewBag.IsCreator = isCreator;
                    ViewBag.IsManager = isManager;
                    ViewBag.IsTaskCompleted = Model.CompletionDate.HasValue;
                }
                @await Html.PartialAsync("_TaskMembersList")
            </div>
        </div>
    </div>
</div>


        <!-- Tab: گفتگوها - نسخه جدید با طراحی مدرن -->
        <div class="tab-pane fade" id="tab-chat" role="tabpanel">
            <div class="block block-rounded block-fx-shadow" style="margin-bottom: 0;">
                <!-- Chat Header -->
                <div class="block-header bg-primary text-white">
                    <h3 class="block-title text-white mb-0">
                        <i class="fa fa-comments me-2"></i>گفتگوها و پیام‌ها
                        <span class="badge bg-white text-primary ms-2" id="chat-badge-count">
                            @(Model.Comments?.Count ?? 0)
                        </span>
                    </h3>
                    <div class="block-options">
                        @if (!isCompletedByMe)
                        {
                            <button type="button" class="btn btn-sm btn-light" onclick="$('#chat-message-input').focus()">
                                <i class="fa fa-plus me-1"></i>پیام جدید
                            </button>
                        }
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="block-content block-content-full p-0" style="height: 600px;">
                    <div class="row g-0 h-100">
                        <!-- Messages Area - Full Width -->
                        <div class="col-12 d-flex flex-column h-100">
                            <!-- Messages List -->
                            <div class="flex-grow-1 overflow-auto p-4 bg-body-light"
                                 id="chat-messages-container"
                                 style="min-height: 0;">

                                @if (Model.Comments?.Any() == true)
                                {
                                    @foreach (var comment in Model.Comments.OrderBy(c => c.CreateDate))
                                    {
                                        var isMyMessage = comment.CreatorUserId == currentUserId;
                                        var messageClass = isMyMessage ? "chat-message-right " : "chat-message-left";

                                        <div class="chat-message  @messageClass mb-3" data-comment-id="@comment.Id">
                                            <div class="d-flex @(isMyMessage ? "flex-row-reverse justify-content-right" : "justify-content-left")">
                                             

                                                <!-- Message Content -->
                                                <div class="flex-grow-1 @(isMyMessage ? "me-3" : "ms-3")" style="max-width: 75%;">
                                                    <!-- Message Bubble -->
                                                    <div class="message-bubble @(isMyMessage ? "bg-primary text-white" : "bg-white") shadow-sm">
                                                        <!-- Header -->
                                                        <div class="message-header pb-2 mb-2 border-bottom @(isMyMessage ? "border-white-25" : "")">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <strong class="@(isMyMessage ? "text-white" : "text-dark")">
                                                                    @(isMyMessage ? "شما" : comment.CreatorName)
                                                                </strong>
                                                                <small class="@(isMyMessage ? "text-white-75" : "text-muted")">
                                                                    @ConvertDateTime.ConvertMiladiToShamsi(comment.CreateDate, "dddd dd MMMM yyyy ساعت HH:mm ")
                                                                </small>
                                                            </div>
                                                        </div>

                                                        <!-- Message Text -->
                                                        <div class="message-text">
                                                            @Html.Raw(comment.CommentText.Replace("\n", "<br/>"))
                                                        </div>

                                                        <!-- Attachments -->
                                                        @if (comment.Attachments?.Any() == true)
                                                        {
                                                            <div class="message-attachments mt-3 pt-3 border-top @(isMyMessage ? "border-white-25" : "")">
                                                                @foreach (var attachment in comment.Attachments)
                                                                {
                                                                    var extension = System.IO.Path.GetExtension(attachment.FileName)?.ToLower();
                                                                    var iconClass = "fa-file";
                                                                    var badgeClass = "secondary";

                                                                    // تعیین آیکون بر اساس نوع فایل
                                                                    if (new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp" }.Contains(extension))
                                                                    {
                                                                        iconClass = "fa-file-image";
                                                                        badgeClass = "success";
                                                                    }
                                                                    else if (extension == ".pdf")
                                                                    {
                                                                        iconClass = "fa-file-pdf";
                                                                        badgeClass = "danger";
                                                                    }
                                                                    else if (new[] { ".doc", ".docx" }.Contains(extension))
                                                                    {
                                                                        iconClass = "fa-file-word";
                                                                        badgeClass = "primary";
                                                                    }
                                                                    else if (new[] { ".xls", ".xlsx", ".csv" }.Contains(extension))
                                                                    {
                                                                        iconClass = "fa-file-excel";
                                                                        badgeClass = "success";
                                                                    }
                                                                    else if (new[] { ".ppt", ".pptx" }.Contains(extension))
                                                                    {
                                                                        iconClass = "fa-file-powerpoint";
                                                                        badgeClass = "warning";
                                                                    }
                                                                    else if (extension == ".txt")
                                                                    {
                                                                        iconClass = "fa-file-alt";
                                                                        badgeClass = "info";
                                                                    }
                                                                    else if (new[] { ".zip", ".rar", ".7z" }.Contains(extension))
                                                                    {
                                                                        iconClass = "fa-file-archive";
                                                                        badgeClass = "dark";
                                                                    }

                                                                    <a href="@Url.Action("DownloadAttachment", "Tasks", new { id = attachment.Id })"
                                                                       class="btn btn-sm @(isMyMessage ? "btn-light" : $"btn-outline-{badgeClass}") mb-1 me-1"
                                                                       download
                                                                       title="دانلود @attachment.FileName">
                                                                        <i class="fa @iconClass me-1"></i>
                                                                        @attachment.FileName
                                                                        @if (attachment.FileSize != 0)
                                                                        {
                                                                            <small class="ms-1">(@((attachment.FileSize / 1024.0).ToString("F2")) KB)</small>
                                                                        }
                                                                        <i class="fa fa-download ms-1"></i>
                                                                    </a>
                                                                }
                                                            </div>
                                                        }

                                                        <!-- Badges -->
                                                        @if (comment.IsImportant || comment.IsEdited)
                                                        {
                                                            <div class="message-badges mt-2">
                                                                @if (comment.IsImportant)
                                                                {
                                                                    <span class="badge bg-danger badge-sm me-1">
                                                                        <i class="fa fa-exclamation-circle"></i> مهم
                                                                    </span>
                                                                }
                                                                @if (comment.IsEdited)
                                                                {
                                                                    <small class="@(isMyMessage ? "text-white-75" : "text-muted") fst-italic">
                                                                        (ویرایش شده)
                                                                    </small>
                                                                }
                                                            </div>
                                                        }
                                                    </div>

                                                    <!-- Actions -->
                                                    @if (isMyMessage && !isCompletedByMe)
                                                    {
                                                        <div class="message-actions mt-1 @(isMyMessage ? "text-end" : "")">
                                                         
                                                            <button type="button"
                                                                    class="btn btn-sm btn-link text-danger p-0"
                                                                    onclick="deleteComment(@comment.Id)"
                                                                    title="حذف">
                                                                <i class="fa fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Avatar -->
                                                <div class="flex-shrink-0">
                                                    <img src="@(comment.CreatorProfileImage ?? "/images/default-avatar.png")"
                                                         class="rounded-circle shadow-sm"
                                                         style="width: 48px; height: 48px; object-fit: cover;"
                                                         alt="@comment.CreatorName">
                                                </div>

                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- Empty State -->
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <i class="fa fa-comments fa-4x text-muted opacity-25"></i>
                                        </div>
                                        <h4 class="text-muted">هنوز پیامی ارسال نشده است</h4>
                                        <p class="text-muted">اولین نفری باشید که پیام می‌فرستد!</p>
                                    </div>
                                }
                            </div>

                            <!-- Input Area -->
                            @if (!isCompletedByMe)
                            {
                                <div class="border-top bg-white p-3">
                                    <form id="chat-form" onsubmit="return sendChatMessage(event);">
                                        <!-- File Selection Display -->
                                        <div id="chat-selected-files" class="mb-2" style="display: none;"></div>

                                        <!-- Input Group -->
                                        <div class="input-group input-group-lg">
                                            <!-- File Upload Button -->
                                            <button class="btn btn-outline-secondary"
                                                    type="button"
                                                    onclick="$('#chat-file-input').click()"
                                                    title="پیوست فایل">
                                                <i class="fa fa-paperclip"></i>
                                            </button>
                                            <input type="file"
                                                   id="chat-file-input"
                                                   multiple
                                                   style="display: none;"
                                                   onchange="handleChatFileSelect(this)">

                                            <!-- Message Input -->
                                            <textarea class="form-control"
                                                  id="chat-message-input"
                                                  placeholder="پیام خود را بنویسید... (Ctrl+Enter برای ارسال)"
                                                  rows="1"
                                                  style="resize: none; max-height: 120px;"
                                                  onkeydown="handleChatKeyPress(event)"></textarea>

                                            <!-- Send Button -->
                                            <button class="btn btn-primary px-4" type="submit">
                                                <i class="fa fa-paper-plane me-1"></i>
                                                <span class="d-none d-sm-inline">ارسال</span>
                                            </button>
                                        </div>

                                        <!-- Options -->
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <!-- Important Checkbox -->
                                            <div class="form-check">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       id="chat-important-check">
                                                <label class="form-check-label" for="chat-important-check">
                                                    <i class="fa fa-exclamation-circle text-danger me-1"></i>
                                                    پیام مهم
                                                </label>
                                            </div>

                                            <!-- Help Text -->
                                            <small class="text-muted">
                                                <i class="fa fa-info-circle me-1"></i>
                                                Ctrl+Enter برای ارسال سریع
                                            </small>
                                        </div>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <!-- Locked State -->
                                <div class="border-top bg-body-light p-3">
                                    <div class="alert alert-warning mb-0">
                                        <i class="fa fa-lock me-2"></i>
                                        تسک تکمیل شده - ارسال پیام امکان‌پذیر نیست
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
       <!-- تب یادآوری‌ها -->
<div class="tab-pane fade" id="tab-reminders" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-warning text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-bell me-2"></i>یادآوری‌های تسک
            </h3>
            <div class="block-options">
                @if (!isCompletedByMe)
                {
                    <button type="button"
                            class="btn btn-sm btn-light"
                            data-toggle="modal-ajax"
                            href="@Url.Action("AddReminderModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-plus me-1"></i>افزودن یادآوری
                    </button>
                }
                else
                {
                    <span class="badge bg-light text-dark">
                        <i class="fa fa-lock me-1"></i>قفل شده
                    </span>
                }
            </div>
        </div>
        <div class="block-content">
                    @if (isCompletedByMe)
            {
                <div class="alert alert-info mb-3">
                    <i class="fa fa-info-circle me-2"></i>
                    <strong>توجه:</strong> این تسک تکمیل شده است. یادآوری‌ها فقط قابل مشاهده هستند و امکان ویرایش یا حذف آن‌ها وجود ندارد.
                </div>
            }
            <div id="reminders-list-container">
                <div class="text-center py-4">
                    <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="text-muted mt-2">در حال بارگذاری...</p>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- ⭐⭐⭐ تب ناظرین تسک -->
        <div class="tab-pane fade" id="tab-viewers" role="tabpanel">
            <div class="row">
                <!-- ⭐ بخش 1: ناظرین خودکار سیستمی -->
                <div class="col-lg-6">
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header bg-primary text-white">
                            <h3 class="block-title text-white mb-0">
                                <i class="fa fa-robot me-2"></i>ناظرین خودکار (سیستمی)
                            </h3>
                            <div class="block-options">
                                <span class="badge bg-white text-primary" id="system-viewers-count">0</span>
                            </div>
                        </div>
                        <div class="block-content">
                            <!-- راهنما -->
                            <div class="alert alert-info mb-3">
                                <h6 class="mb-2">
                                    <i class="fa fa-info-circle me-1"></i>ناظرین خودکار شامل:
                                </h6>
                                <ul class="mb-0 small">
                                    <li>سازنده تسک</li>
                                    <li>کاربران منتصب به تسک</li>
                                    <li>مدیر تیم (اگر تیم مشخص باشد)</li>
                                    <li>سرپرستان بر اساس سلسله مراتب</li>
                                </ul>
                            </div>

                            <!-- لیست ناظران سیستمی -->
                            <div id="system-viewers-list">
                                <div class="text-center py-4">
                                    <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="text-muted mt-2">در حال بارگذاری...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ⭐ بخش 2: ناظرین رونوشت (دستی) -->
                <div class="col-lg-6">
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header bg-success text-white">
                            <h3 class="block-title text-white mb-0">
                                <i class="fa fa-user-plus me-2"></i>ناظرین رونوشت (دستی)
                            </h3>
                            <div class="block-options d-flex align-items-center gap-2">
                                <span class="badge bg-white text-success" id="carbon-copy-viewers-count">0</span>
                                @if ((isCreator || isManager) && !isCompletedByMe)
                                {
                                    <button type="button" 
                                            class="btn btn-sm btn-light"
                                            data-toggle="modal-ajax"
                                            href="@Url.Action("AddCarbonCopyModal", "TaskViewers", new { taskId = Model.Id })">
                                        <i class="fa fa-plus me-1"></i>افزودن ناظر
                                    </button>
                                }
                                else if (isCompletedByMe)
                                {
                                    <span class="badge bg-light text-dark">
                                        <i class="fa fa-lock me-1"></i>قفل شده
                                    </span>
                                }
                            </div>
                        </div>
                        <div class="block-content">
                            <!-- راهنما -->
                            <div class="alert alert-success mb-3">
                                <h6 class="mb-2">
                                    <i class="fa fa-info-circle me-1"></i>درباره ناظرین رونوشت:
                                </h6>
                                <ul class="mb-0 small">
                                    <li>افرادی که به صورت دستی اضافه می‌شوند</li>
                                    <li>می‌توانند تسک را مشاهده کنند</li>
                                    <li>نمی‌توانند تسک را تکمیل یا ویرایش کنند</li>
                                    <li>فقط سازنده یا مدیر می‌تواند آن‌ها را حذف کند</li>
                                </ul>
                            </div>

                            @if (isCompletedByMe)
                            {
                                <div class="alert alert-warning mb-3">
                                    <i class="fa fa-exclamation-triangle me-2"></i>
                                    <strong>توجه:</strong> این تسک تکمیل شده است. امکان افزودن یا حذف ناظر رونوشتی وجود ندارد.
                                </div>
                            }

                            <!-- لیست ناظران رونوشت -->
                            <div id="carbon-copy-viewers-list">
                                <div class="text-center py-4">
                                    <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                                    <p class="text-muted mt-2">در حال بارگذاری...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ⭐ آمار کل ناظران -->
            <div class="block block-rounded block-fx-shadow mt-3">
                <div class="block-content">
                    <div class="row text-center g-3">
                        <div class="col-md-4">
                            <div class="p-3 bg-body-light rounded-3">
                                <div class="fs-2 fw-bold text-primary" id="total-viewers-count">0</div>
                                <small class="text-muted">کل ناظران</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-body-light rounded-3">
                                <div class="fs-2 fw-bold text-primary" id="system-viewers-stat">0</div>
                                <small class="text-muted">ناظرین خودکار</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-body-light rounded-3">
                                <div class="fs-2 fw-bold text-success" id="carbon-copy-viewers-stat">0</div>
                                <small class="text-muted">ناظرین رونوشت</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 5: تاریخچه کامل -->
        <div class="tab-pane fade" id="tab-timeline" role="tabpanel">
            <div class="block block-rounded block-fx-shadow">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-history text-warning me-2"></i>تاریخچه کامل تسک
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn btn-sm btn-primary" onclick="loadTaskHistory()">
                            <i class="fa fa-sync me-1"></i>بروزرسانی
                        </button>
                    </div>
                </div>
                <div class="block-content">
                    <div id="task-timeline-container" class="timeline">
                        <!-- محتوا از AJAX بارگذاری می‌شود -->
                    </div>
                </div>
            </div>
        </div>
      
    </div>
</div>

@section Scripts {
    <script>
        window.TaskDetailConfig = {
            taskId: @Model.Id,
            isTaskCompleted: @(Model.CompletionDate.HasValue ? "true" : "false"),
            urls: {
                getTaskComments: '@Url.Action("GetTaskComments", "Tasks")',
                addTaskComment: '@Url.Action("AddTaskComment", "Tasks")',
                deleteTaskComment: '@Url.Action("DeleteTaskComment", "Tasks")',
                getTaskHeroStats: '@Url.Action("GetTaskHeroStats", "Tasks")',
                getTaskProgress: '@Url.Action("GetTaskProgress", "Tasks")',
                getTaskSidebarStats: '@Url.Action("GetTaskSidebarStats", "Tasks")',
                getTaskReminders: '@Url.Action("GetTaskReminders", "Tasks", new { taskId = Model.Id })',
                getTaskHistory: '@Url.Action("GetTaskHistory", "Tasks", new { area = "TaskingArea" })',
                getOperationsGroup: '@Url.Action("GetOperationsGroup", "TaskOperations", new { area = "TaskingArea" })',
                toggleOperationComplete: '@Url.Action("ToggleOperationComplete", "TaskOperations", new { area = "TaskingArea" })',
                toggleOperationStar: '@Url.Action("ToggleOperationStar", "TaskOperations", new { area = "TaskingArea" })',
                deleteOperation: '@Url.Action("DeleteOperation", "TaskOperations", new { area = "TaskingArea" })',
                addOperation: '@Url.Action("AddOperation", "TaskOperations", new { area = "TaskingArea" })',
                getAllOperations: '@Url.Action("GetAllOperations", "TaskOperations", new { area = "TaskingArea" })',
                refreshAllTaskStats: '@Url.Action("RefreshAllTaskStats", "Tasks", new { area = "TaskingArea" })',
                getTaskViewers: '@Url.Action("GetTaskViewers", "TaskViewers", new { area = "TaskingArea" })',
                removeCarbonCopy: '@Url.Action("RemoveCarbonCopy", "TaskViewers", new { area = "TaskingArea" })'
            }
        };
    </script>
    <script src="~/assets/js/taskdetail.js"></script>

    <!-- ⭐⭐⭐ اسکریپت Viewers -->
    @await Html.PartialAsync("_TaskViewersScript")
}

<!-- ⭐⭐⭐ اضافه کردن CSS سفارشی -->
@section Styles {
    <style>
     
</style>
}