@model TaskViewModel
@{
    ViewData["Title"] = "جزئیات تسک";
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

    ViewBag.Task = Model;

    var isAssignedToCurrentUser = Model.IsAssignedToCurrentUser;
    var isCreator = Model.IsCreator;
    var isManager = Model.IsManager;
    var isSupervisor = Model.IsSupervisor;
    var isCompletedByMe = Model.IsCompletedByMe;
    var isFocused = Model.IsFocused ?? false;
    var isAdmin = ViewBag.IsAdmin ?? false;

    // ⭐⭐⭐ دسترسی‌های مبتنی بر تنظیمات تسک
    var canAddMembers = ViewBag.CanAddMembers ?? false;
    var canRemoveMembers = ViewBag.CanRemoveMembers ?? false;
    var canComment = ViewBag.CanComment ?? true;

    // تعیین رنگ و وضعیت
    string statusColor = "primary";
    string statusText = "در حال انجام";
    string statusIcon = "fa-clock";
    var isInMyDay = ViewBag.IsInMyDay ?? false;

    if (Model.IsDeleted)
    {
        statusColor = "danger"; statusText = "حذف شده"; statusIcon = "fa-trash";
    }
    else if (!Model.IsActive)
    {
        statusColor = "warning"; statusText = "غیرفعال"; statusIcon = "fa-pause-circle";
    }
    else if (Model.CompletionDate.HasValue && Model.ManagerApprovedDate.HasValue)
    {
        statusColor = "success"; statusText = "تایید نهایی"; statusIcon = "fa-check-double";
    }
    else if (Model.CompletionDate.HasValue && Model.SupervisorApprovedDate.HasValue)
    {
        statusColor = "info"; statusText = "تایید سرپرست"; statusIcon = "fa-user-check";
    }
    else if (Model.CompletionDate.HasValue)
    {
        statusColor = "success"; statusText = "تکمیل شده"; statusIcon = "fa-check-circle";
    }
    else if (Model.DueDate.HasValue && DateTime.Now > Model.DueDate.Value)
    {
        statusColor = "danger"; statusText = "تاخیر دارد"; statusIcon = "fa-exclamation-triangle";
    }

    // ⭐⭐⭐ تنظیم متغیرهای ViewBag برای partial viewها
    ViewBag.CurrentUserId = currentUserId;
    ViewBag.IsAssignedToCurrentUser = isAssignedToCurrentUser;
    ViewBag.IsCreator = isCreator;
    ViewBag.IsManager = isManager;
    ViewBag.IsSupervisor = isSupervisor;
    ViewBag.IsCompletedByMe = isCompletedByMe;
    ViewBag.CanAddMembers = canAddMembers;
    ViewBag.CanRemoveMembers = canRemoveMembers;
}
@Html.AntiForgeryToken()

<!-- ⭐⭐⭐ Hero Section -->
@await Html.PartialAsync("_TaskHeroSection", Model)

<!-- Main Content با Tabs -->
<div class="content content-full">
    <!-- ⭐⭐⭐ Tab Navigation -->
    @await Html.PartialAsync("TaskDetailPartials/_TaskDetailTabs", Model)

    <!-- Tabs Content -->
    <div class="tab-content">
        <!-- ⭐⭐⭐ Overview Tab -->
        <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
            @await Html.PartialAsync("_TaskOverviewTab", Model)
        </div>

        <!-- ⭐⭐⭐ Work Logs Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_WorkLogsTab", Model)

        <!-- ⭐⭐⭐ Operations Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_OperationsTab", Model)

        <!-- ⭐⭐⭐ Team Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_TeamTab", Model)

        <!-- ⭐⭐⭐ Chat Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_ChatTab", Model)

        <!-- ⭐⭐⭐ Reminders Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_RemindersTab", Model)

        <!-- ⭐⭐⭐ Viewers Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_ViewersTab", Model)

        <!-- ⭐⭐⭐ Attachments Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_AttachmentsTab", Model)

        <!-- ⭐⭐⭐ Timeline Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_TimelineTab", Model)

        <!-- ⭐⭐⭐ Settings Tab -->
        @await Html.PartialAsync("TaskDetailPartials/_SettingsTab", Model)
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("TaskDetailPartials/_TaskDetailScripts", Model)
}
