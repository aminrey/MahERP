@model TaskViewModel
@{
    ViewData["Title"] = "جزئیات تسک";
    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isAssignedToCurrentUser = Model.AssignmentsTaskUser?.Any(a => a.AssignedUserId == currentUserId) ?? false;
    var isCreator = Model.CreatorUserId == currentUserId;
    var isAdmin = ViewBag.IsAdmin ?? false;
    var isManager = ViewBag.IsManager ?? false;
    var isSupervisor = ViewBag.IsSupervisor ?? false;
    var isCompletedByMe = Model.AssignmentsTaskUser?.Any(a=> a.CompletionDate.HasValue && a.AssignedUserId == currentUserId) ?? false;
    var isFocused = Model.AssignmentsTaskUser?.Any(a=> a.IsFocused && a.AssignedUserId == currentUserId) ?? false;

    // تعیین رنگ و وضعیت
    string statusColor = "primary";
    string statusText = "در حال انجام";
    string statusIcon = "fa-clock";
    var isInMyDay = ViewBag.IsInMyDay ?? false;

    if (Model.IsDeleted) {
        statusColor = "danger"; statusText = "حذف شده"; statusIcon = "fa-trash";
    } else if (!Model.IsActive) {
        statusColor = "warning"; statusText = "غیرفعال"; statusIcon = "fa-pause-circle";
    } else if (Model.CompletionDate.HasValue && Model.ManagerApprovedDate.HasValue) {
        statusColor = "success"; statusText = "تایید نهایی"; statusIcon = "fa-check-double";
    } else if (Model.CompletionDate.HasValue && Model.SupervisorApprovedDate.HasValue) {
        statusColor = "info"; statusText = "تایید سرپرست"; statusIcon = "fa-user-check";
    } else if (Model.CompletionDate.HasValue) {
        statusColor = "success"; statusText = "تکمیل شده"; statusIcon = "fa-check-circle";
    } else if (Model.DueDate.HasValue && DateTime.Now > Model.DueDate.Value) {
        statusColor = "danger"; statusText = "تاخیر دارد"; statusIcon = "fa-exclamation-triangle";
    }
}
@Html.AntiForgeryToken()

<!-- Hero Section - بنر بهبود یافته -->
<div class="hero-section position-relative overflow-hidden">
    <!-- Background Image با Overlay -->
    <div class="hero-bg position-absolute top-0 start-0 w-100 h-100">
        <img src="~/assets/media/photos/photo21.jpg" alt="Background" class="w-100 h-100 object-fit-cover opacity-10">

        <!-- Gradient Overlay -->
        <div class="bg-black-75 position-absolute top-0 start-0 w-100 h-100"></div>

        <!-- Animated Pattern -->
        <div class="hero-pattern position-absolute top-0 start-0 w-100 h-100">
            <svg class="w-100 h-100 opacity-10" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <pattern id="hero-pattern" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
                        <circle cx="30" cy="30" r="2" fill="currentColor" class="text-white" />
                        <circle cx="0" cy="0" r="2" fill="currentColor" class="text-white" />
                        <circle cx="60" cy="0" r="2" fill="currentColor" class="text-white" />
                        <circle cx="0" cy="60" r="2" fill="currentColor" class="text-white" />
                        <circle cx="60" cy="60" r="2" fill="currentColor" class="text-white" />
                    </pattern>
                </defs>
                <rect width="100%" height="100%" fill="url(#hero-pattern)" />
            </svg>
        </div>

        <!-- Floating Shapes -->
        <div class="hero-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>
    </div>

    <div class="content content-full position-relative" style="z-index: 10;">
        <div class="py-5">
            <!-- Task Header -->
            <div class="row align-items-center g-4">
                <div class="col-lg-8">
                    <div class="d-flex align-items-start gap-3">
                        <!-- Status Icon -->
                        <div class="flex-shrink-0">
                            <div class="hero-status-icon @($"status-{statusColor}")">
                                <div class="icon-wrapper">
                                    <i class="fa @statusIcon fa-2x"></i>
                                </div>
                                <div class="status-label">@statusText</div>
                            </div>
                        </div>

                        <!-- Task Info -->
                        <div class="flex-grow-1">
                            <!-- Task Title -->
                            <div class="hero-title-wrapper mb-3">
                                <h1 class="hero-title text-white mb-2">@Model.Title</h1>
                                <div class="hero-subtitle d-flex flex-wrap align-items-center gap-2">
                                    <span class="badge badge-modern bg-white text-dark px-3 py-2 rounded-pill">
                                        <i class="fa fa-hashtag me-1"></i>
                                        <span class="fw-bold">@Model.TaskCode</span>
                                    </span>
                                    <span class="text-white opacity-75 d-none d-md-inline">•</span>
                                    <span class="badge badge-modern bg-white bg-opacity-20 text-dark px-3 py-2 rounded-pill">
                                        <i class="fa fa-calendar-alt me-1"></i>
                                        <span>@ConvertDateTime.ConvertMiladiToShamsi(Model.CreateDate, "yyyy/MM/dd")</span>
                                    </span>
                                    @if (Model.Important)
                                    {
                                                        
                                        <span class="text-white opacity-75 d-none d-md-inline">•</span>

                                        <span class="badge badge-modern bg-danger px-3 py-2 rounded-pill pulse-animation">
                                            <i class="fa fa-star me-1"></i>
                                            <span>مهم</span>
                                        </span>

                                    }
                                    @if (Model.Priority == 2)
                                    {
                                                                
                                        <span class="text-white opacity-75 d-none d-md-inline">•</span>

                                        <span class="badge badge-modern bg-warning px-3 py-2 rounded-pill pulse-animation">
                                            <i class="fa fa-bolt me-1"></i>
                                            <span>فوری</span>
                                        </span>
                                    }

                                    @if (isFocused)
                                    {
                                        <span class="text-white opacity-75 d-none d-md-inline">•</span>

                                        <span class="badge badge-modern bg-warning px-3 py-2 rounded-pill pulse-animation">
                                            <i class="fa fa-star me-1"></i>
                                            <span>متمرکز</span>
                                        </span>
                                    }
                               


                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div class="hero-stats">
                                <div class="row g-3">
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon">
                                                <i class="fa fa-chart-line"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-label">پیشرفت</div>
                                                <div class="stat-value">@Model.ProgressPercentage<span class="stat-unit">%</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon">
                                                <i class="fa fa-users"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-label">اعضا</div>
                                                <div class="stat-value">@(Model.AssignmentsTaskUser?.Count ?? 0)<span class="stat-unit">نفر</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stat-card">
                                            <div class="stat-icon">
                                                <i class="fa fa-tasks"></i>
                                            </div>
                                            <div class="stat-content">
                                                <div class="stat-label">عملیات</div>
                                                <div class="stat-value">
                                                    @(Model.Operations?.Count(o => o.IsCompleted) ?? 0)/@(Model.Operations?.Count ?? 0)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    @if (Model.DueDate.HasValue)
                                    {
                                        var remainingDays = (Model.DueDate.Value - DateTime.Now).Days;
                                        <div class="col-6 col-md-3">
                                            <div class="stat-card @(remainingDays < 0 ? "stat-danger" : remainingDays <= 3 ? "stat-warning" : "")">
                                                <div class="stat-icon">
                                                    <i class="fa fa-clock"></i>
                                                </div>
                                                <div class="stat-content">
                                                    <div class="stat-label">مهلت</div>
                                                    <div class="stat-value">
                                                        @if (remainingDays < 0)
                                                        {
                                                            <span>@Math.Abs(remainingDays)</span>
                                                            <span class="stat-unit">روز تاخیر</span>
                                                        }
                                                        else if (remainingDays == 0)
                                                        {
                                                            <span>امروز</span>
                                                        }
                                                        else
                                                        {
                                                            <span>@remainingDays</span>
                                                            <span class="stat-unit">روز</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

              @* در بخش Action Buttons *@
<div class="col-lg-4">
                    <!-- Breadcrumb -->
                    <nav class="mb-3" aria-label="breadcrumb">
                        <ol class="breadcrumb breadcrumb-modern justify-content-lg-end mb-0">
                            <li class="breadcrumb-item">
                                <a asp-area="AdminArea" asp-controller="Home" asp-action="Dashboard" class="text-white-75">
                                    <i class="fa fa-home me-1"></i>داشبورد
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a asp-area="AdminArea" asp-controller="Tasks" asp-action="Index" class="text-white-75">
                                    تسک‌ها
                                </a>
                            </li>
                            <li class="breadcrumb-item active text-white">جزئیات تسک</li>
                        </ol>
                    </nav>

    <div class="hero-actions d-flex flex-wrap gap-2 justify-content-lg-end">
        @if (isCompletedByMe)
        {
            <!-- ⭐ نمایش Badge قفل شده -->
            <div class="alert alert-success d-flex align-items-center mb-0">
                <i class="fa fa-lock fa-2x me-3"></i>
                <div>
                    <div class="fw-bold">تسک قفل شده</div>
                    <small>این تسک تکمیل شده و قابل ویرایش نیست</small>
                </div>
            </div>
        }
        else
        {
            @if (isCreator || isManager)
            {
                <a href="#"
                   onclick="showComingSoonNotification(event, 'ویرایش تسک')"
                   class="btn btn-hero btn-warning btn-lg">
                    <i class="fa fa-pencil-alt me-2"></i>
                    <span>ویرایش</span>
                </a>
            }

            @if (isAssignedToCurrentUser)
            {
                <a href="@Url.Action("CompleteTask", new { id = Model.Id })"
                   data-toggle="modal-ajax"
                   class="btn btn-hero btn-success btn-lg">
                    <i class="fa fa-check me-2"></i>
                    <span>تکمیل تسک</span>
                </a>
            }
        }

        <div class="dropdown">
            <button type="button" class="btn btn-hero btn-light btn-lg dropdown-toggle"
                    data-bs-toggle="dropdown"
                    @(Model.CompletionDate.HasValue ? "disabled" : "")>
                <i class="fa fa-ellipsis-h"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end dropdown-menu-modern">
                @if (!isCompletedByMe)
                {
                    <li>
                        @if (isInMyDay)
                        {
                            <button type="button"
                                    class="dropdown-item disabled"
                                    style="cursor: not-allowed; opacity: 0.6;">
                                <i class="fa fa-check-circle text-success me-2"></i>
                                <span class="text-success fw-bold">در روز من قرار دارد</span>
                            </button>
                        }
                        else
                        {
                            <button type="button"
                                    class="dropdown-item"
                                    data-toggle="modal-ajax"
                                    href="@Url.Action("AddToMyDayModal", "Tasks", new { taskId = Model.Id })">
                                <i class="fa fa-calendar-alt me-2"></i>
                                افزودن به روز من
                            </button>
                        }
                    </li>
                                    <li>
                                        <a class="dropdown-item"
                                           href="@Url.Action("LogTaskWorkModal", new { taskId = Model.Id })"
                                           data-toggle="modal-ajax">
                                            <i class="fa fa-clock text-success me-2"></i>
                                            <span>ثبت کار انجام شده</span>
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        @if (isFocused )
                                        {
                                            <a class="dropdown-item text-warning"
                                               href="javascript:void(0)"
                                               onclick="removeTaskFocus(@Model.Id)">
                                                <i class="fa fa-star text-warning me-2"></i>
                                                <span class="fw-bold">حذف از فوکوس</span>
                                            </a>
                                        }
                                        else
                                        {
                                            <a class="dropdown-item"
                                               href="javascript:void(0)"
                                               onclick="setTaskFocus(@Model.Id)">
                                                <i class="fa fa-bullseye text-info me-2"></i>
                                                <span>تنظیم به عنوان فوکوس</span>
                                            </a>
                                        }
                                    </li>
                    <li><hr class="dropdown-divider"></li>
                }

           

                @if (isAdmin || isManager)
                {
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item"
                           href="#"
                           onclick="showComingSoonNotification(event, '@(Model.IsActive ? "غیرفعال‌سازی" : "فعال‌سازی")')">
                            <i class="fa @(Model.IsActive ? "fa-ban text-warning" : "fa-check text-success") me-2"></i>
                            <span>@(Model.IsActive ? "غیرفعال‌سازی" : "فعال‌سازی")</span>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item text-danger"
                           href="#"
                           onclick="showComingSoonNotification(event, 'حذف تسک')">
                            <i class="fa fa-trash-alt me-2"></i>
                            <span>حذف تسک</span>
                        </a>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>
            </div>
        </div>
    </div>
</div>


<!-- Main Content با Tabs -->
<div class="content content-full">
    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs nav-tabs-alt nav-justified push" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview" 
                    type="button" role="tab">
                <i class="fa fa-info-circle me-1"></i>
                <span class="d-none d-sm-inline">نگاه کلی</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="work-logs-tab" data-bs-toggle="tab" data-bs-target="#tab-work-logs" type="button" role="tab">
                <i class="fa fa-clipboard-list me-1"></i>
                <span class="d-none d-sm-inline">گزارش‌های کاری</span>
                @if (Model.WorkLogs?.Any() == true)
                {
                    <span class="badge bg-info rounded-pill ms-1">@Model.WorkLogs.Count</span>
                }
            </button>
        </li>

        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-operations" 
                    type="button" role="tab">
                <i class="fa fa-cogs me-1"></i>
                <span class="d-none d-sm-inline">عملیات</span>
                @if (Model.Operations?.Any() == true) {
                    <span class="badge bg-primary rounded-pill ms-1">@Model.Operations.Count</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-team" 
                    type="button" role="tab">
                <i class="fa fa-users me-1"></i>
                <span class="d-none d-sm-inline">اعضای تسک</span>
                @if (Model.AssignmentsTaskUser?.Any() == true) {
                    <span class="badge bg-info rounded-pill ms-1">@Model.AssignmentsTaskUser.Count</span>
                }
            </button>
        </li>
        <!-- در nav-tabs -->

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#tab-chat" type="button" role="tab">
                <i class="fa fa-comments me-1"></i>
                <span class="d-none d-sm-inline">گفتگوها</span>
                <!-- ⭐ اضافه کردن ID -->
                <span class="badge bg-primary rounded-pill ms-1" id="chat-badge-count">
                    @(Model.Comments?.Count ?? 0)
                </span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#tab-reminders" type="button" role="tab">
                <i class="fa fa-bell me-1"></i>
                <span class="d-none d-sm-inline">یادآوری‌ها</span>
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-timeline" 
                    type="button" role="tab">
                <i class="fa fa-history me-1"></i>
                <span class="d-none d-sm-inline">تاریخچه</span>
            </button>
        </li>
    
    </ul>
    
    <!-- Tabs Content -->
    <div class="tab-content">
        <!-- Tab 1: نگاه کلی -->
        <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
            <div class="row">
                <!-- بخش اصلی -->
                <div class="col-lg-8">
                    <!-- توضیحات -->
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-align-right text-primary me-2"></i>توضیحات تسک
                            </h3>
                        </div>
                        <div class="block-content">
                            @if (string.IsNullOrEmpty(Model.Description)) {
                                <div class="py-5 text-center text-muted">
                                    <i class="fa fa-file-alt fa-3x opacity-25 mb-3"></i>
                                    <p class="mb-0">توضیحاتی برای این تسک ثبت نشده است.</p>
                                </div>
                            } else {
                                <div class="fs-sm">
                                    @Html.Raw(Model.Description.Replace("\n", "<br/>"))
                                </div>
                            }
                        </div>
                    </div>
                    <!-- در تب اول (tab-overview) بعد از بخش "توضیحات تسک" -->
                    @if (Model.CompletionDate.HasValue)
                    {
                        <!-- ⭐⭐⭐ گزارش تکمیل تسک -->
                        <div class="block block-rounded block-fx-shadow">
                            <div class="block-header bg-success text-white">
                                <h3 class="block-title text-white mb-0">
                                    <i class="fa fa-check-circle me-2"></i>گزارش تکمیل تسک
                                </h3>
                                <div class="block-options">
                                    <span class="badge bg-light text-success">
                                        @ConvertDateTime.ConvertMiladiToShamsi(Model.CompletionDate.Value, "yyyy/MM/dd HH:mm")
                                    </span>
                                </div>
                            </div>
                            <div class="block-content">
                                @{
                                    var completionAssignment = Model.AssignmentsTaskUser?
                                    .FirstOrDefault(a => a.CompletionDate.HasValue);
                                }

                                @if (completionAssignment != null)
                                {
                                    <div class="row g-3">
                                        <!-- عکس و اطلاعات تکمیل کننده -->
                                        <div class="col-md-4">
                                            <div class="p-3 bg-body-light rounded-3 text-center">
                                                <div class="mb-3">
                                                    <img src="@(completionAssignment.AssignedUserProfileImage ?? "/images/default-avatar.png")"
                                                         class="rounded-circle"
                                                         style="width: 80px; height: 80px; object-fit: cover;"
                                                         alt="@completionAssignment.AssignedUserName">
                                                </div>
                                                <h6 class="mb-1">@completionAssignment.AssignedUserName</h6>
                                                <small class="text-muted">تکمیل کننده تسک</small>
                                            </div>
                                        </div>

                                        <!-- گزارش تکمیل -->
                                        <div class="col-md-8">
                                            <div class="p-3 bg-body-light rounded-3">
                                                <h6 class="mb-2">
                                                    <i class="fa fa-file-alt text-success me-1"></i>
                                                    گزارش تکمیل:
                                                </h6>
                                                @if (!string.IsNullOrEmpty(completionAssignment.CompletionNote))
                                                {
                                                    <p class="mb-2">@Html.Raw(completionAssignment.CompletionNote.Replace("\n", "<br/>"))</p>
                                                }
                                                else
                                                {
                                                    <p class="text-muted mb-2">
                                                        <i class="fa fa-info-circle me-1"></i>
                                                        بدون توضیحات
                                                    </p>
                                                }

                                            <!-- آمار عملیات -->
                                            <div class="row g-2 mt-3">
                                                <div class="col-6">
                                                    <div class="p-2 bg-white rounded text-center">
                                                        <div class="fs-3 fw-bold text-success">
                                                            @(Model.Operations?.Count(o => o.IsCompleted) ?? 0)/@(Model.Operations?.Count ?? 0)
                                                        </div>
                                                        <small class="text-muted">عملیات تکمیل شده</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="p-2 bg-white rounded text-center">
                                                        <div class="fs-3 fw-bold text-primary">
                                                            @Model.ProgressPercentage%
                                                        </div>
                                                        <small class="text-muted">درصد پیشرفت</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- اطلاعات بیشتر -->
                                <div class="row g-2 mt-3">
                                    <div class="col-md-4">
                                        <div class="p-2 bg-body-light rounded">
                                            <small class="text-muted d-block">تاریخ شروع</small>
                                            <strong>
                                                @(completionAssignment.PersonalStartDate.HasValue
                                                                                            ? ConvertDateTime.ConvertMiladiToShamsi(completionAssignment.PersonalStartDate.Value, "yyyy/MM/dd HH:mm")
                                                                                            : "ثبت نشده")
                                                </strong>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 bg-body-light rounded">
                                                <small class="text-muted d-block">تاریخ تکمیل</small>
                                                <strong>
                                                    @ConvertDateTime.ConvertMiladiToShamsi(completionAssignment.CompletionDate.Value, "yyyy/MM/dd HH:mm")
                                                </strong>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="p-2 bg-body-light rounded">
                                                <small class="text-muted d-block">مدت زمان</small>
                                                <strong>
                                                    @if (completionAssignment.PersonalStartDate.HasValue)
                                                    {
                                                        var duration = completionAssignment.CompletionDate.Value - completionAssignment.PersonalStartDate.Value;
                                                        <text>@duration.Days روز، @duration.Hours ساعت</text>
                                                    }
                                                    else
                                                    {
                                                        <text>نامشخص</text>
                                                    }
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="text-center py-4 text-muted">
                                        <i class="fa fa-info-circle fa-2x mb-2"></i>
                                        <p class="mb-0">اطلاعات تکمیل یافت نشد</p>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    <!-- اطلاعات جزئیات -->
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-info-circle text-info me-2"></i>اطلاعات جزئیات
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="row g-3">
                                <!-- دسته‌بندی -->
                                <div class="col-sm-6">
                                    <div class="p-3 bg-body-light rounded-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-shrink-0">
                                                <i class="fa fa-folder fa-2x text-primary"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <div class="fs-xs text-muted">دسته‌بندی</div>
                                                <div class="fw-semibold">
                                                    @(string.IsNullOrEmpty(Model.CategoryTitle) ? "بدون دسته‌بندی" : Model.CategoryTitle)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            <!-- در بخش نمایش اطلاعات تسک، جایگزین بخش Stakeholder قدیمی: -->

<div class="col-sm-6">
    <div class="p-3 bg-body-light rounded-3">
        <div class="d-flex align-items-center mb-2">
            <div class="flex-shrink-0">
                @if (Model.SelectedContactId.HasValue || Model.SelectedOrganizationId.HasValue)
                {
                    <i class="fa fa-handshake fa-2x text-success"></i>
                }
                else
                {
                    <i class="fa fa-ban fa-2x text-muted"></i>
                }
            </div>
            <div class="flex-grow-1 ms-3">
                <div class="fs-xs text-muted">طرف حساب</div>
                <div class="fw-semibold">
                    @if (Model.SelectedContactId.HasValue)
                    {
                        <div>
                            <i class="fa fa-user me-1 text-primary"></i>
                            <strong>@Model.ContactFullName</strong>
                            @if (Model.SelectedOrganizationId.HasValue)
                            {
                                <div class="mt-1 ms-3">
                                    <i class="fa fa-building me-1 text-info"></i>
                                    <small class="text-muted">@Model.OrganizationName</small>
                                </div>
                            }
                        </div>
                    }
                    else if (Model.SelectedOrganizationId.HasValue)
                    {
                        <div>
                            <i class="fa fa-building me-1 text-info"></i>
                            <strong>@Model.OrganizationName</strong>
                        </div>
                    }
                    else if (Model.StakeholderId.HasValue)
                    {
                        <!-- ⚠️ Fallback به سیستم قدیمی -->
                        <div>
                            <i class="fa fa-archive me-1 text-warning"></i>
                            <small class="text-muted">(قدیمی) @Model.StakeholderName</small>
                        </div>
                    }
                    else
                    {
                        <span class="text-muted">ندارد</span>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
                                
                                <!-- ایجاد کننده -->
                                <div class="col-sm-6">
                                    <div class="p-3 bg-body-light rounded-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-shrink-0">
                                                <i class="fa fa-user-circle fa-2x text-info"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <div class="fs-xs text-muted">ایجاد کننده</div>
                                                <div class="fw-semibold">
                                                    @(string.IsNullOrEmpty(Model.CreatorName) ? "نامشخص" : Model.CreatorName)
                                                </div>
                                                <div class="fs-xs text-muted">
                                                    @ConvertDateTime.ConvertMiladiToShamsi(Model.CreateDate, "yyyy/MM/dd HH:mm")
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- اولویت -->
                                <div class="col-sm-6">
                                    <div class="p-3 bg-body-light rounded-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-shrink-0">
                                                <i class="fa fa-flag fa-2x text-warning"></i>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <div class="fs-xs text-muted">اولویت</div>
                                                <div>
                                                    @switch (Model.Priority) {
                                                        case 0:
                                                            <span class="badge bg-info-light text-info">
                                                                <i class="fa fa-circle me-1"></i>عادی
                                                            </span>
                                                            break;
                                                        case 1:
                                                            <span class="badge bg-warning-light text-warning">
                                                                <i class="fa fa-star me-1"></i>مهم
                                                            </span>
                                                            break;
                                                        case 2:
                                                            <span class="badge bg-danger-light text-danger">
                                                                <i class="fa fa-bolt me-1"></i>فوری
                                                            </span>
                                                            break;
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- آمار سریع -->
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-chart-bar text-success me-2"></i>آمار
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="row g-2 text-center">
                                <div class="col-6">
                                    <div class="p-3 bg-success-light rounded-3">
                                        <div class="fs-2 fw-bold text-success">
                                            @(Model.Operations?.Count(o => o.IsCompleted) ?? 0)
                                        </div>
                                        <div class="fs-xs text-muted">عملیات تکمیل</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-warning-light rounded-3">
                                        <div class="fs-2 fw-bold text-warning">
                                            @(Model.Operations?.Count(o => !o.IsCompleted) ?? 0)
                                        </div>
                                        <div class="fs-xs text-muted">در انتظار</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-info-light rounded-3">
                                        <div class="fs-2 fw-bold text-info">
                                            @(Model.AssignmentsTaskUser?.Count ?? 0)
                                        </div>
                                        <div class="fs-xs text-muted">اعضای تیم</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="p-3 bg-primary-light rounded-3">
                                        <div class="fs-2 fw-bold text-primary">
                                            @Model.ProgressPercentage%
                                        </div>
                                        <div class="fs-xs text-muted">پیشرفت</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- وضعیت تایید -->
                    @if (Model.CompletionDate.HasValue || isSupervisor || isManager) {
                        <div class="block block-rounded block-fx-shadow">
                            <div class="block-header block-header-default">
                                <h3 class="block-title">
                                    <i class="fa fa-check-double text-success me-2"></i>وضعیت تایید
                                </h3>
                            </div>
                            <div class="block-content">
                                <div class="list-group list-group-flush">
                                    <!-- تکمیل -->
                                    <div class="list-group-item d-flex align-items-center px-0">
                                        <div class="flex-shrink-0 me-3">
                                            @if (Model.CompletionDate.HasValue) {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-success"></i>
                                                    <i class="fa fa-check fa-stack-1x text-white"></i>
                                                </span>
                                            } else {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-muted"></i>
                                                    <i class="fa fa-clock fa-stack-1x text-white"></i>
                                                </span>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">تکمیل تسک</div>
                                            @if (Model.CompletionDate.HasValue) {
                                                <div class="fs-xs text-muted">
                                                    @ConvertDateTime.ConvertMiladiToShamsi(Model.CompletionDate.Value, "yyyy/MM/dd HH:mm")
                                                </div>
                                            } else {
                                                <div class="fs-xs text-muted">در انتظار</div>
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- تایید سرپرست -->
                                    <div class="list-group-item d-flex align-items-center px-0">
                                        <div class="flex-shrink-0 me-3">
                                            @if (Model.SupervisorApprovedDate.HasValue) {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-info"></i>
                                                    <i class="fa fa-check fa-stack-1x text-white"></i>
                                                </span>
                                            } else {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-muted"></i>
                                                    <i class="fa fa-clock fa-stack-1x text-white"></i>
                                                </span>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">تایید سرپرست</div>
                                            @if (Model.SupervisorApprovedDate.HasValue) {
                                                <div class="fs-xs text-muted">
                                                    @ConvertDateTime.ConvertMiladiToShamsi(Model.SupervisorApprovedDate.Value, "yyyy/MM/dd")
                                                </div>
                                            } else if (Model.CompletionDate.HasValue && isSupervisor) {
                                                <button type="button" class="btn btn-xs btn-info mt-1" 
                                                        onclick="approveBySupervisor(@Model.Id)">
                                                    <i class="fa fa-check me-1"></i>تایید
                                                </button>
                                            } else {
                                                <div class="fs-xs text-muted">در انتظار</div>
                                            }
                                        </div>
                                    </div>
                                    
                                    <!-- تایید مدیر -->
                                    <div class="list-group-item d-flex align-items-center px-0 border-0">
                                        <div class="flex-shrink-0 me-3">
                                            @if (Model.ManagerApprovedDate.HasValue) {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-success"></i>
                                                    <i class="fa fa-award fa-stack-1x text-white"></i>
                                                </span>
                                            } else {
                                                <span class="fa-stack fa-1x">
                                                    <i class="fa fa-circle fa-stack-2x text-muted"></i>
                                                    <i class="fa fa-clock fa-stack-1x text-white"></i>
                                                </span>
                                            }
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">تایید مدیر</div>
                                            @if (Model.ManagerApprovedDate.HasValue) {
                                                <div class="fs-xs text-muted">
                                                    @ConvertDateTime.ConvertMiladiToShamsi(Model.ManagerApprovedDate.Value, "yyyy/MM/dd")
                                                </div>
                                            } else if (Model.SupervisorApprovedDate.HasValue && isManager) {
                                                <button type="button" class="btn btn-xs btn-success mt-1" 
                                                        onclick="approveByManager(@Model.Id)">
                                                    <i class="fa fa-check me-1"></i>تایید
                                                </button>
                                            } else {
                                                <div class="fs-xs text-muted">در انتظار</div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <!-- Progress Bar -->
                    <div class="block block-rounded block-fx-shadow">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-chart-line text-primary me-2"></i>پیشرفت کار
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-semibold">درصد تکمیل</span>
                                    <span class="fw-bold text-primary">@Model.ProgressPercentage%</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated @(Model.ProgressPercentage == 100 ? "bg-success" : "bg-primary")" 
                                         role="progressbar" 
                                         style="width: @Model.ProgressPercentage%" 
                                         aria-valuenow="@Model.ProgressPercentage" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        @Model.ProgressPercentage%
                                    </div>
                                </div>
                            </div>
                            
                            @if (Model.DueDate.HasValue) {
                                var remainingDays = (Model.DueDate.Value - DateTime.Now).Days;
                                <div class="alert @(remainingDays < 0 ? "alert-danger" : remainingDays <= 3 ? "alert-warning" : "alert-info") mb-0">
                                    <div class="d-flex align-items-center">
                                        <i class="fa @(remainingDays < 0 ? "fa-exclamation-triangle" : "fa-clock") fa-2x me-3"></i>
                                        <div>
                                            <div class="fw-bold">مهلت انجام</div>
                                            <div class="fs-sm">
                                                @ConvertDateTime.ConvertMiladiToShamsi(Model.DueDate.Value, "yyyy/MM/dd")
                                                @if (!Model.CompletionDate.HasValue) {
                                                    @if (remainingDays < 0) {
                                                        <span class="badge bg-danger ms-1">@Math.Abs(remainingDays) روز تاخیر</span>
                                                    } else if (remainingDays == 0) {
                                                        <span class="badge bg-warning ms-1">امروز</span>
                                                    } else if (remainingDays <= 3) {
                                                        <span class="badge bg-warning ms-1">@remainingDays روز مانده</span>
                                                    }
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Tab 2: گزارش های کاری-->
<div class="tab-pane fade" id="tab-work-logs" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-info text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-clipboard-list me-2"></i>گزارش‌های کاری ثبت شده
            </h3>
            <div class="block-options">
                @if (isAssignedToCurrentUser && !isCompletedByMe)
                {
                    <button type="button" 
                            class="btn btn-sm btn-light" 
                            data-toggle="modal-ajax" 
                            href="@Url.Action("LogTaskWorkModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-plus me-1"></i>ثبت گزارش جدید
                    </button>
                }
            </div>
        </div>
        <div class="block-content">
            <div id="work-logs-container">
                @if (Model.WorkLogs?.Any() == true)
                {
                    <!-- Timeline Design -->
                    <div class="timeline timeline-alt py-0">
                        @foreach (var log in Model.WorkLogs.OrderByDescending(w => w.WorkDate))
                        {
                            <div class="timeline-event">
                                <div class="timeline-event-icon bg-info">
                                    <i class="fa fa-clipboard-check"></i>
                                </div>
                                <div class="timeline-event-block block block-rounded block-fx-shadow">
                                    <div class="block-header">
                                        <div class="d-flex align-items-center w-100">
                                            <!-- عکس کاربر -->
                                            <div class="flex-shrink-0 me-3">
                                                <img src="@(log.UserProfileImage ?? "/images/default-avatar.png")"
                                                     class="rounded-circle"
                                                     style="width: 48px; height: 48px; object-fit: cover;"
                                                     alt="@log.UserName">
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">@log.UserName</h6>
                                                <small class="text-muted">
                                                    <i class="fa fa-calendar me-1"></i>
                                                    @ConvertDateTime.ConvertMiladiToShamsi(log.WorkDate, "yyyy/MM/dd")
                                                    <i class="fa fa-clock me-1 ms-2"></i>
                                                    @log.WorkDate.ToString("HH:mm")
                                                </small>
                                            </div>
                                            @if (log.DurationMinutes.HasValue)
                                            {
                                                <div class="flex-shrink-0">
                                                    <span class="badge bg-primary rounded-pill">
                                                        <i class="fa fa-hourglass-half me-1"></i>
                                                        @log.DurationMinutes دقیقه
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="block-content">
                                        <p class="mb-2">@Html.Raw(log.WorkDescription.Replace("\n", "<br/>"))</p>
                                        
                                        @if (log.ProgressPercentage.HasValue)
                                        {
                                            <div class="mt-3">
                                                <small class="text-muted">پیشرفت پس از این کار:</small>
                                                <div class="progress" style="height: 10px;">
                                                    <div class="progress-bar bg-success" 
                                                         style="width: @log.ProgressPercentage%" 
                                                         role="progressbar">
                                                    </div>
                                                </div>
                                                <small class="text-success fw-bold">@log.ProgressPercentage%</small>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <!-- Empty State -->
                    <div class="text-center py-5 text-muted">
                        <i class="fa fa-clipboard-list fa-4x opacity-25 mb-3"></i>
                        <h5>هیچ گزارشی ثبت نشده است</h5>
                        @if (isAssignedToCurrentUser)
                        {
                            <p class="mb-3">برای ثبت اولین گزارش کاری، از دکمه زیر استفاده کنید</p>
                            <button type="button" 
                                    class="btn btn-primary" 
                                    data-toggle="modal-ajax" 
                                    href="@Url.Action("LogTaskWorkModal", "Tasks", new { taskId = Model.Id })">
                                <i class="fa fa-plus me-1"></i>ثبت گزارش جدید
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>

        <!-- Tab 3: عملیات‌ها - نسخه نهایی با گروه‌بندی -->
        <div class="tab-pane fade" id="tab-operations" role="tabpanel">
            <div class="block block-rounded block-fx-shadow">
                <!-- ⭐ هدینگ بنفش با متن سفید -->
               <div class="block-header bg-primary text-white">
    <h3 class="block-title text-white mb-0">
        <i class="fa fa-cogs me-2"></i>مدیریت عملیات تسک
    </h3>
    <div class="block-options">
        @if ((isAssignedToCurrentUser || isCreator || isManager) && !Model.CompletionDate.HasValue)
        {
            <button type="button" class="btn btn-sm btn-light"
                    onclick="$('#newOperationTitleInput').focus()">
                <i class="fa fa-plus me-1"></i>افزودن سریع
            </button>
        }
        else if (Model.CompletionDate.HasValue)
        {
            <span class="badge bg-light text-dark">
                <i class="fa fa-lock me-1"></i>قفل شده
            </span>
        }
    </div>
</div>

                <div class="block-content">
                    @if (Model.Operations == null || !Model.Operations.Any())
                    {
                        <!-- پیام خالی -->
                        <div class="py-5 text-center text-muted">
                            <i class="fa fa-tasks fa-4x opacity-25 mb-3"></i>
                            <h5>هیچ عملیاتی تعریف نشده است</h5>
                            @if (isAssignedToCurrentUser || isCreator || isManager)
                            {
                                <p class="mb-3">برای شروع، اولین عملیات را اضافه کنید</p>
                                <div class="card border-primary mx-auto" style="max-width: 600px;">
                                    <div class="card-body">
                                        <div class="input-group">
                                            <input class="form-control"
                                                   id="newOperationTitleInput"
                                                   placeholder="عنوان عملیات جدید..."
                                                   type="text"
                                                   autocomplete="off" />
                                            <button class="btn btn-primary" type="button" id="addNewOperationBtn">
                                                <i class="fa fa-plus me-1"></i>افزودن
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <!-- فرم افزودن عملیات جدید -->
                      
                            @if (!Model.CompletionDate.HasValue && (isAssignedToCurrentUser || isCreator || isManager))
{
                            <div class="card border-primary mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0 text-white">
                                        <i class="fa fa-plus-circle me-1"></i>افزودن عملیات جدید
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="input-group input-group-lg">
                                        <textarea class="form-control border-2"
                                               id="newOperationTitleInput"
                                               placeholder="عنوان عملیات جدید را وارد کنید و Enter بزنید..."
                                               type="text"
                                               rows="2"
                                               autocomplete="off"
                                               ></textarea>
                                        <button class="btn btn-primary px-4" type="button" id="addNewOperationBtn">
                                            <i class="fa fa-plus me-1"></i>افزودن
                                        </button>
                                    </div>
                                    <small class="form-text text-muted mt-2">
                                        <i class="fa fa-keyboard me-1"></i>برای افزودن سریع، Enter را فشار دهید
                                    </small>
                                </div>
                            </div>
                            }
else if (isCompletedByMe)
{
    <div class="alert alert-info mb-4">
        <i class="fa fa-info-circle me-2"></i>
        <strong>توجه:</strong> این تسک تکمیل شده و امکان افزودن عملیات جدید وجود ندارد.
    </div>
}
                        

                        <!-- آمار عملیات -->
                        <div class="row g-2 mb-4">
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-primary-light rounded-3 text-center">
                                    <div class="fs-2 fw-bold text-primary" id="totalOpsCount">
                                        @Model.Operations.Count()
                                    </div>
                                    <div class="fs-xs text-muted">کل عملیات</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-success-light rounded-3 text-center">
                                    <div class="fs-2 fw-bold text-success" id="completedOpsCount">
                                        @Model.Operations.Count(o => o.IsCompleted)
                                    </div>
                                    <div class="fs-xs text-muted">تکمیل شده</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-warning-light rounded-3 text-center">
                                    <div class="fs-2 fw-bold text-warning" id="starredOpsCount">
                                        @Model.Operations.Count(o => o.IsStarred)
                                    </div>
                                    <div class="fs-xs text-muted">ستاره‌دار</div>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <div class="p-3 bg-info-light rounded-3 text-center">
                                    <div class="fs-2 fw-bold text-info" id="withWorkLogCount">
                                        @Model.Operations.Count(o => o.WorkLogs?.Any() == true)
                                    </div>
                                    <div class="fs-xs text-muted">با گزارش کار</div>
                                </div>
                            </div>
                        </div>

                        <!-- ⭐ لیست عملیات - با Placeholder برای ترتیب ثابت -->
                        <div id="operationsList">
                            @{
                                var starredOps = Model.Operations.Where(o => o.IsStarred && !o.IsCompleted).OrderBy(o => o.OperationOrder).ToList();
                                var pendingOps = Model.Operations.Where(o => !o.IsStarred && !o.IsCompleted).OrderBy(o => o.OperationOrder).ToList();
                                var completedOps = Model.Operations.Where(o => o.IsCompleted).OrderBy(o => o.OperationOrder).ToList();
                            }

                            <!-- ⭐ Placeholder برای گروه ستاره‌دار -->
                            <div id="starred-group-placeholder" data-order="1">
                                @if (starredOps.Any())
                                {
                                    <div class="mb-4 operations-group" data-group="starred" id="starred-group">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-shrink-0">
                                                <div class="bg-warning text-white rounded-circle d-flex align-items-center justify-content-center"
                                                     style="width: 40px; height: 40px;">
                                                    <i class="fa fa-star"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-0 text-warning">
                                                    <strong>عملیات ستاره‌دار</strong>
                                                    <span class="badge bg-warning text-dark ms-2">@starredOps.Count</span>
                                                </h6>
                                                <small class="text-muted">عملیات‌های با اولویت بالا</small>
                                            </div>
                                        </div>
                                        <div class="starred-operations" id="starred-operations-container">
                                            @foreach (var operation in starredOps)
                                            {
                                                @await Html.PartialAsync("~/Areas/AdminArea/Views/TaskOperations/_OperationItem.cshtml", operation)
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- ⭐ Placeholder برای گروه در انتظار -->
                            <div id="pending-group-placeholder" data-order="2">
                                @if (pendingOps.Any())
                                {
                                    <div class="mb-4 operations-group" data-group="pending" id="pending-group">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-shrink-0">
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                                     style="width: 40px; height: 40px;">
                                                    <i class="fa fa-clock"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-0 text-primary">
                                                    <strong>در انتظار انجام</strong>
                                                    <span class="badge bg-primary ms-2">@pendingOps.Count</span>
                                                </h6>
                                                <small class="text-muted">عملیات‌های در حال انجام</small>
                                            </div>
                                        </div>
                                        <div class="pending-operations" id="pending-operations-container">
                                            @foreach (var operation in pendingOps)
                                            {
                                                @await Html.PartialAsync("~/Areas/AdminArea/Views/TaskOperations/_OperationItem.cshtml", operation)
                                            }
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- ⭐ Placeholder برای گروه تکمیل شده -->
                            <div id="completed-group-placeholder" data-order="3">
                                @if (completedOps.Any())
                                {
                                    <div class="mb-4 operations-group" data-group="completed" id="completed-group">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="flex-shrink-0">
                                                <div class="bg-success text-white rounded-circle d-flex align-items-center justify-content-center"
                                                     style="width: 40px; height: 40px;">
                                                    <i class="fa fa-check-circle"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-0 text-success">
                                                    <strong>تکمیل شده</strong>
                                                    <span class="badge bg-success ms-2">@completedOps.Count</span>
                                                </h6>
                                                <small class="text-muted">عملیات‌های به اتمام رسیده</small>
                                            </div>
                                        </div>
                                        <div class="completed-operations" id="completed-operations-container">
                                            @foreach (var operation in completedOps)
                                            {
                                                @await Html.PartialAsync("~/Areas/AdminArea/Views/TaskOperations/_OperationItem.cshtml", operation)
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
        <!-- Tab 3: اعضای تسک -->
<div class="tab-pane fade" id="tab-team" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-info text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-users me-2"></i>اعضای تسک
            </h3>
            <div class="block-options">
                @if ((isCreator || isManager) && !isCompletedByMe)
                {
                    <button type="button" 
                            class="btn btn-sm btn-light" 
                            data-toggle="modal-ajax" 
                            href="@Url.Action("AssignUserToTaskModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-user-plus me-1"></i>افزودن کاربر
                    </button>
                }
                else if (isCompletedByMe)
                {
                    <span class="badge bg-light text-dark">
                        <i class="fa fa-lock me-1"></i>قفل شده
                    </span>
                }
            </div>
        </div>
        <div class="block-content">
            <!-- ⭐⭐⭐ Container برای بروزرسانی AJAX -->
            <div id="task-members-container">
                @{
                    ViewBag.Assignments = Model.AssignmentsTaskUser;
                    ViewBag.IsCreator = isCreator;
                    ViewBag.IsManager = isManager;
                    ViewBag.IsTaskCompleted = Model.CompletionDate.HasValue;
                }
                @await Html.PartialAsync("_TaskMembersList")
            </div>
        </div>
    </div>
</div>


        <!-- Tab: گفتگوها - نسخه جدید با طراحی مدرن -->
        <div class="tab-pane fade" id="tab-chat" role="tabpanel">
            <div class="block block-rounded block-fx-shadow" style="margin-bottom: 0;">
                <!-- Chat Header -->
                <div class="block-header bg-primary text-white">
                    <h3 class="block-title text-white mb-0">
                        <i class="fa fa-comments me-2"></i>گفتگوها و پیام‌ها
                        <span class="badge bg-white text-primary ms-2" id="chat-badge-count">
                            @(Model.Comments?.Count ?? 0)
                        </span>
                    </h3>
                    <div class="block-options">
                        @if (!isCompletedByMe)
                        {
                            <button type="button" class="btn btn-sm btn-light" onclick="$('#chat-message-input').focus()">
                                <i class="fa fa-plus me-1"></i>پیام جدید
                            </button>
                        }
                    </div>
                </div>

                <!-- Chat Container -->
                <div class="block-content block-content-full p-0" style="height: 600px;">
                    <div class="row g-0 h-100">
                        <!-- Messages Area - Full Width -->
                        <div class="col-12 d-flex flex-column h-100">
                            <!-- Messages List -->
                            <div class="flex-grow-1 overflow-auto p-4 bg-body-light"
                                 id="chat-messages-container"
                                 style="min-height: 0;">

                                @if (Model.Comments?.Any() == true)
                                {
                                    @foreach (var comment in Model.Comments.OrderBy(c => c.CreateDate))
                                    {
                                        var isMyMessage = comment.CreatorUserId == currentUserId;
                                        var messageClass = isMyMessage ? "chat-message-right" : "chat-message-left";

                                        <div class="chat-message @messageClass mb-3" data-comment-id="@comment.Id">
                                            <div class="d-flex @(isMyMessage ? "flex-row-reverse" : "")">
                                             

                                                <!-- Message Content -->
                                                <div class="flex-grow-1 @(isMyMessage ? "me-3" : "ms-3")" style="max-width: 75%;">
                                                    <!-- Message Bubble -->
                                                    <div class="message-bubble @(isMyMessage ? "bg-primary text-white" : "bg-white") shadow-sm">
                                                        <!-- Header -->
                                                        <div class="message-header pb-2 mb-2 border-bottom @(isMyMessage ? "border-white-25" : "")">
                                                            <div class="d-flex justify-content-between align-items-center">
                                                                <strong class="@(isMyMessage ? "text-white" : "text-dark")">
                                                                    @(isMyMessage ? "شما" : comment.CreatorName)
                                                                </strong>
                                                                <small class="@(isMyMessage ? "text-white-75" : "text-muted")">
                                                                    @ConvertDateTime.ConvertMiladiToShamsi(comment.CreateDate, "dddd dd MMMM yyyy ساعت HH:mm ")
                                                                </small>
                                                            </div>
                                                        </div>

                                                        <!-- Message Text -->
                                                        <div class="message-text">
                                                            @Html.Raw(comment.CommentText.Replace("\n", "<br/>"))
                                                        </div>

                                                        <!-- Attachments -->
                                                        @if (comment.Attachments?.Any() == true)
                                                        {
                                                            <div class="message-attachments mt-3 pt-3 border-top @(isMyMessage ? "border-white-25" : "")">
                                                                @foreach (var attachment in comment.Attachments)
                                                                {
                                                                    <a href="@attachment.FilePath"
                                                                       class="btn btn-sm @(isMyMessage ? "btn-light" : "btn-outline-primary") mb-1 me-1"
                                                                       target="_blank">
                                                                        <i class="fa fa-paperclip me-1"></i>
                                                                        @attachment.FileName
                                                                    </a>
                                                                }
                                                            </div>
                                                        }

                                                        <!-- Badges -->
                                                        @if (comment.IsImportant || comment.IsEdited)
                                                        {
                                                            <div class="message-badges mt-2">
                                                                @if (comment.IsImportant)
                                                                {
                                                                    <span class="badge bg-danger badge-sm me-1">
                                                                        <i class="fa fa-exclamation-circle"></i> مهم
                                                                    </span>
                                                                }
                                                                @if (comment.IsEdited)
                                                                {
                                                                    <small class="@(isMyMessage ? "text-white-75" : "text-muted") fst-italic">
                                                                        (ویرایش شده)
                                                                    </small>
                                                                }
                                                            </div>
                                                        }
                                                    </div>

                                                    <!-- Actions -->
                                                    @if (isMyMessage && !isCompletedByMe)
                                                    {
                                                        <div class="message-actions mt-1 @(isMyMessage ? "text-end" : "")">
                                                         
                                                            <button type="button"
                                                                    class="btn btn-sm btn-link text-danger p-0"
                                                                    onclick="deleteComment(@comment.Id)"
                                                                    title="حذف">
                                                                <i class="fa fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>

                                                <!-- Avatar -->
                                                <div class="flex-shrink-0">
                                                    <img src="@(comment.CreatorProfileImage ?? "/images/default-avatar.png")"
                                                         class="rounded-circle shadow-sm"
                                                         style="width: 48px; height: 48px; object-fit: cover;"
                                                         alt="@comment.CreatorName">
                                                </div>

                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <!-- Empty State -->
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <i class="fa fa-comments fa-4x text-muted opacity-25"></i>
                                        </div>
                                        <h4 class="text-muted">هنوز پیامی ارسال نشده است</h4>
                                        <p class="text-muted">اولین نفری باشید که پیام می‌فرستد!</p>
                                    </div>
                                }
                            </div>

                            <!-- Input Area -->
                            @if (!isCompletedByMe)
                            {
                                <div class="border-top bg-white p-3">
                                    <form id="chat-form" onsubmit="return sendChatMessage(event);">
                                        <!-- File Selection Display -->
                                        <div id="chat-selected-files" class="mb-2" style="display: none;"></div>

                                        <!-- Input Group -->
                                        <div class="input-group input-group-lg">
                                            <!-- File Upload Button -->
                                            <button class="btn btn-outline-secondary"
                                                    type="button"
                                                    onclick="$('#chat-file-input').click()"
                                                    title="پیوست فایل">
                                                <i class="fa fa-paperclip"></i>
                                            </button>
                                            <input type="file"
                                                   id="chat-file-input"
                                                   multiple
                                                   style="display: none;"
                                                   onchange="handleChatFileSelect(this)">

                                            <!-- Message Input -->
                                            <textarea class="form-control"
                                                  id="chat-message-input"
                                                  placeholder="پیام خود را بنویسید... (Ctrl+Enter برای ارسال)"
                                                  rows="1"
                                                  style="resize: none; max-height: 120px;"
                                                  onkeydown="handleChatKeyPress(event)"></textarea>

                                            <!-- Send Button -->
                                            <button class="btn btn-primary px-4" type="submit">
                                                <i class="fa fa-paper-plane me-1"></i>
                                                <span class="d-none d-sm-inline">ارسال</span>
                                            </button>
                                        </div>

                                        <!-- Options -->
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <!-- Important Checkbox -->
                                            <div class="form-check">
                                                <input class="form-check-input"
                                                       type="checkbox"
                                                       id="chat-important-check">
                                                <label class="form-check-label" for="chat-important-check">
                                                    <i class="fa fa-exclamation-circle text-danger me-1"></i>
                                                    پیام مهم
                                                </label>
                                            </div>

                                            <!-- Help Text -->
                                            <small class="text-muted">
                                                <i class="fa fa-info-circle me-1"></i>
                                                Ctrl+Enter برای ارسال سریع
                                            </small>
                                        </div>
                                    </form>
                                </div>
                            }
                            else
                            {
                                <!-- Locked State -->
                                <div class="border-top bg-body-light p-3">
                                    <div class="alert alert-warning mb-0">
                                        <i class="fa fa-lock me-2"></i>
                                        تسک تکمیل شده - ارسال پیام امکان‌پذیر نیست
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
       <!-- تب یادآوری‌ها -->
<div class="tab-pane fade" id="tab-reminders" role="tabpanel">
    <div class="block block-rounded block-fx-shadow">
        <div class="block-header bg-warning text-white">
            <h3 class="block-title text-white mb-0">
                <i class="fa fa-bell me-2"></i>یادآوری‌های تسک
            </h3>
            <div class="block-options">
                @if (!isCompletedByMe)
                {
                    <button type="button"
                            class="btn btn-sm btn-light"
                            data-toggle="modal-ajax"
                            href="@Url.Action("AddReminderModal", "Tasks", new { taskId = Model.Id })">
                        <i class="fa fa-plus me-1"></i>افزودن یادآوری
                    </button>
                }
                else
                {
                    <span class="badge bg-light text-dark">
                        <i class="fa fa-lock me-1"></i>قفل شده
                    </span>
                }
            </div>
        </div>
        <div class="block-content">
                    @if (isCompletedByMe)
            {
                <div class="alert alert-info mb-3">
                    <i class="fa fa-info-circle me-2"></i>
                    <strong>توجه:</strong> این تسک تکمیل شده است. یادآوری‌ها فقط قابل مشاهده هستند و امکان ویرایش یا حذف آن‌ها وجود ندارد.
                </div>
            }
            <div id="reminders-list-container">
                <div class="text-center py-4">
                    <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
                    <p class="text-muted mt-2">در حال بارگذاری...</p>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- Tab 5: تاریخچه کامل -->
        <div class="tab-pane fade" id="tab-timeline" role="tabpanel">
            <div class="block block-rounded block-fx-shadow">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-history text-warning me-2"></i>تاریخچه کامل تسک
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn btn-sm btn-primary" onclick="loadTaskHistory()">
                            <i class="fa fa-sync me-1"></i>بروزرسانی
                        </button>
                    </div>
                </div>
                <div class="block-content">
                    <div id="task-timeline-container" class="timeline">
                        <!-- محتوا از AJAX بارگذاری می‌شود -->
                    </div>
                </div>
            </div>
        </div>
      
    </div>
</div>

@section Scripts {
        <script>
        window.TaskDetailConfig = {
             taskId: @Model.Id,
             isTaskCompleted: @(Model.CompletionDate.HasValue ? "true" : "false"),
             urls: {
                 getTaskComments: '@Url.Action("GetTaskComments", "Tasks")',
                 addTaskComment: '@Url.Action("AddTaskComment", "Tasks")',
                 deleteTaskComment: '@Url.Action("DeleteTaskComment", "Tasks")',
                 getTaskHeroStats: '@Url.Action("GetTaskHeroStats", "Tasks")',
                 getTaskProgress: '@Url.Action("GetTaskProgress", "Tasks")',
                 getTaskSidebarStats: '@Url.Action("GetTaskSidebarStats", "Tasks")',
                 getTaskReminders: '@Url.Action("GetTaskReminders", "Tasks", new { taskId = Model.Id })',
                 getTaskHistory: '@Url.Action("GetTaskHistory", "Tasks", new { area = "AdminArea" })',
                 approveTaskByManager: '@Url.Action("ApproveTaskByManager", "Tasks")',
                 getOperationsGroup: '@Url.Action("GetOperationsGroup", "TaskOperations", new { area = "AdminArea" })',
                 toggleOperationComplete: '@Url.Action("ToggleOperationComplete", "TaskOperations", new { area = "AdminArea" })',
                 toggleOperationStar: '@Url.Action("ToggleOperationStar", "TaskOperations", new { area = "AdminArea" })',
                 deleteOperation: '@Url.Action("DeleteOperation", "TaskOperations", new { area = "AdminArea" })',
                 addOperation: '@Url.Action("AddOperation", "TaskOperations", new { area = "AdminArea" })',
                 getAllOperations: '@Url.Action("GetAllOperations", "TaskOperations", new { area = "AdminArea" })'
             }
         };

    </script>

<script src="~/assets/js/taskdetail.js"></script>
}


<!-- ⭐⭐⭐ اضافه کردن CSS سفارشی -->
@section Styles {
    <style>
        /* Chat Message Styles */
        .message-bubble {
            padding: 1rem;
            border-radius: 1rem;
            position: relative;
            animation: messageSlideIn 0.3s ease-out;
        }

        .chat-message-right .message-bubble {
            border-top-right-radius: 0.25rem;
        }

        .chat-message-left .message-bubble {
            border-top-left-radius: 0.25rem;
        }

        .message-bubble::before {
            content: '';
            position: absolute;
            top: 0;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .chat-message-right .message-bubble::before {
            right: -8px;
            border-width: 0 0 12px 12px;
            border-color: transparent transparent transparent var(--bs-primary);
        }

        .chat-message-left .message-bubble::before {
            left: -8px;
            border-width: 0 12px 12px 0;
            border-color: transparent var(--bs-white) transparent transparent;
        }

        .message-text {
            word-wrap: break-word;
            line-height: 1.6;
        }

        .message-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .chat-message:hover .message-actions {
            opacity: 1;
        }

        /* Smooth Scroll */
        #chat-messages-container {
            scroll-behavior: smooth;
        }

            #chat-messages-container::-webkit-scrollbar {
                width: 8px;
            }

            #chat-messages-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,.2);
                border-radius: 4px;
            }

        /* Animation */
        @@keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Auto-resize textarea */
        #chat-message-input {
            transition: height 0.2s;
        }

        /* Border utilities */
        .border-white-25 {
            border-color: rgba(255,255,255,0.25) !important;
        }

        .text-white-75 {
            color: rgba(255,255,255,0.75) !important;
        }
    </style>
}