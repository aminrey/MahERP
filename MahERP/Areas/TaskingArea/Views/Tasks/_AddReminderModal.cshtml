@model TaskReminderViewModel

<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <form id="addReminderForm" asp-action="SaveReminder" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="TaskId" />
            <input type="hidden" asp-for="NotificationTime" id="hiddenNotificationTime" />

            <div class="modal-header bg-warning text-white">
                <h4 class="modal-title text-white mb-0">
                    <i class="fa fa-bell me-2"></i>افزودن یادآوری جدید
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- اطلاعات تسک -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading">
                        <i class="fa fa-info-circle me-1"></i>تسک: @Model.TaskTitle
                    </h6>
                    <p class="mb-0">کد: <strong>@Model.TaskCode</strong></p>
                </div>

                <!-- عنوان یادآوری -->
                <div class="mb-4">
                    <label asp-for="Title" class="form-label">
                        <i class="fa fa-heading me-1"></i>عنوان یادآوری <span class="text-danger">*</span>
                    </label>
                    <input asp-for="Title" 
                           class="form-control" 
                           placeholder="مثال: یادآوری قبل از پایان مهلت" 
                           maxlength="200" 
                           required />
                    <span asp-validation-for="Title" class="text-danger"></span>
                </div>

                <!-- توضیحات -->
                <div class="mb-4">
                    <label asp-for="Description" class="form-label">
                        <i class="fa fa-align-right me-1"></i>توضیحات
                    </label>
                    <textarea asp-for="Description" 
                              class="form-control" 
                              rows="3" 
                              placeholder="توضیحات تکمیلی (اختیاری)..."></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <!-- نوع یادآوری -->
                <div class="mb-4">
                    <label class="form-label">
                        <i class="fa fa-cog me-1"></i>نوع یادآوری <span class="text-danger">*</span>
                    </label>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <div class="form-check form-check-block p-3 bg-light rounded">
                                <input asp-for="ReminderType" 
                                       class="form-check-input" 
                                       type="radio" 
                                       value="0" 
                                       id="reminderType0"
                                       onchange="toggleReminderFields()">
                                <label class="form-check-label" for="reminderType0">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-calendar fa-2x text-primary me-3"></i>
                                        <div>
                                            <strong>یکبار در زمان مشخص</strong>
                                            <small class="d-block text-muted">در تاریخ و ساعت مشخصی ارسال شود</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-check-block p-3 bg-light rounded">
                                <input asp-for="ReminderType" 
                                       class="form-check-input" 
                                       type="radio" 
                                       value="1" 
                                       id="reminderType1"
                                       onchange="toggleReminderFields()">
                                <label class="form-check-label" for="reminderType1">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-sync fa-2x text-info me-3"></i>
                                        <div>
                                            <strong>تکراری</strong>
                                            <small class="d-block text-muted">هر چند روز یکبار ارسال شود</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-check-block p-3 bg-light rounded">
                                <input asp-for="ReminderType" 
                                       class="form-check-input" 
                                       type="radio" 
                                       value="2" 
                                       id="reminderType2" 
                                       checked
                                       onchange="toggleReminderFields()">
                                <label class="form-check-label" for="reminderType2">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-hourglass-half fa-2x text-warning me-3"></i>
                                        <div>
                                            <strong>قبل از مهلت</strong>
                                            <small class="d-block text-muted">X روز قبل از پایان مهلت</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-check-block p-3 bg-light rounded">
                                <input asp-for="ReminderType" 
                                       class="form-check-input" 
                                       type="radio" 
                                       value="3" 
                                       id="reminderType3"
                                       onchange="toggleReminderFields()">
                                <label class="form-check-label" for="reminderType3">
                                    <div class="d-flex align-items-center">
                                        <i class="fa fa-play fa-2x text-success me-3"></i>
                                        <div>
                                            <strong>در روز شروع تسک</strong>
                                            <small class="d-block text-muted">در تاریخ شروع تسک ارسال شود</small>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <span asp-validation-for="ReminderType" class="text-danger"></span>
                </div>

                <!-- تنظیمات بر اساس نوع -->
                <div class="row">
                    <!-- فاصله تکرار (برای نوع 1) -->
                    <div class="col-md-6 mb-4" id="intervalField" style="display: none;">
                        <label asp-for="IntervalDays" class="form-label">
                            <i class="fa fa-repeat text-info me-1"></i>فاصله تکرار (روز) <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input asp-for="IntervalDays" 
                                   type="number" 
                                   class="form-control" 
                                   min="1" 
                                   max="365" 
                                   placeholder="7" />
                            <span class="input-group-text">روز</span>
                        </div>
                        <small class="form-text text-muted">مثال: 7 = هفتگی، 30 = ماهانه</small>
                        <span asp-validation-for="IntervalDays" class="text-danger"></span>
                    </div>

                    <!-- حداکثر تعداد تکرار -->
                    <div class="col-md-6 mb-4" id="maxSendCountField" style="display: none;">
                        <label asp-for="MaxSendCount" class="form-label">
                            <i class="fa fa-hashtag text-danger me-1"></i>
                            <span id="maxSendCountLabel">حداکثر تعداد ارسال</span> 
                            <small class="text-muted" id="maxSendCountOptional">(اختیاری)</small>
                        </label>
                        <div class="input-group">
                            <input asp-for="MaxSendCount"
                                   type="number"
                                   class="form-control"
                                   min="1"
                                   max="100"
                                   placeholder="بدون محدودیت" />
                            <span class="input-group-text">بار</span>
                        </div>
                        <small class="form-text text-muted" id="maxSendCountHelp">
                            اگر خالی بگذارید، یادآوری تا پایان تسک ادامه خواهد داشت
                        </small>
                        <span asp-validation-for="MaxSendCount" class="text-danger"></span>
                    </div>

                    <!-- چند روز قبل (برای نوع 2) -->
                    <div class="col-md-6 mb-4" id="daysBeforeField">
                        <label asp-for="DaysBeforeDeadline" class="form-label">
                            <i class="fa fa-clock text-warning me-1"></i>چند روز قبل از مهلت <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input asp-for="DaysBeforeDeadline" 
                                   type="number" 
                                   class="form-control" 
                                   min="1" 
                                   max="30" 
                                   value="3" 
                                   placeholder="3" />
                            <span class="input-group-text">روز</span>
                        </div>
                        <span asp-validation-for="DaysBeforeDeadline" class="text-danger"></span>
                    </div>

                    <!-- ساعت ارسال -->
                    <div class="col-md-6 mb-4">
                        <label class="form-label">
                            <i class="fa fa-clock text-primary me-1"></i>ساعت ارسال
                        </label>
                        <input type="time" 
                               class="form-control" 
                               id="notificationTimeInput"
                               value="09:00"
                               onchange="updateHiddenTimeField()" />
                        <small class="form-text text-muted">زمان ارسال یادآوری در روز مشخص شده</small>
                    </div>
                </div>

                <!-- تاریخ شروع و پایان (برای نوع 0 و 1) -->
                @* ⭐⭐⭐ استفاده از class persian-datepicker و data-initial-value-type *@
                <div class="row" id="dateRangeFields" style="display: none;">
                    <div class="col-md-6 mb-4">
                        <label asp-for="StartDatePersian" class="form-label">
                            <i class="fa fa-calendar-alt text-success me-1"></i>
                            تاریخ شروع <span class="text-danger">*</span>
                        </label>
                        <input asp-for="StartDatePersian"
                               class="form-control persian-datepicker"
                               data-initial-value-type="persian"
                               placeholder="انتخاب تاریخ..."
                               readonly />
                        <span asp-validation-for="StartDatePersian" class="text-danger"></span>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label asp-for="EndDatePersian" class="form-label">
                            <i class="fa fa-calendar-times text-danger me-1"></i>
                            تاریخ پایان <small class="text-muted">(اختیاری)</small>
                        </label>
                        <input asp-for="EndDatePersian"
                               class="form-control persian-datepicker"
                               data-initial-value-type="persian"
                               placeholder="انتخاب تاریخ..."
                               readonly />
                        <span asp-validation-for="EndDatePersian" class="text-danger"></span>
                    </div>
                </div>

                <!-- پیش‌نمایش -->
                <div class="alert alert-light border" id="reminderPreview">
                    <h6><i class="fa fa-eye me-1"></i> پیش‌نمایش:</h6>
                    <p class="mb-0" id="previewText">یادآوری 3 روز قبل از پایان مهلت در ساعت 09:00 ارسال خواهد شد</p>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-alt-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>انصراف
                </button>
                <button type="button" class="btn btn-warning" data-save="modal-ajax-save">
                    <i class="fa fa-check me-1"></i>ذخیره یادآوری
                </button>
            </div>
        </form>
    </div>
</div>

@* ⭐⭐⭐ حذف تمام initialization دستی - فقط استفاده از global initPersianDatePicker *@
<script>
(function() {
    // ⭐⭐⭐ بروزرسانی فیلد hidden برای NotificationTime
    window.updateHiddenTimeField = function() {
        const timeValue = $('#notificationTimeInput').val();
        if (timeValue) {
            $('#hiddenNotificationTime').val(timeValue + ':00');
        }
    };

    $(document).ready(function() {
        // تنظیم مقدار اولیه
        updateHiddenTimeField();
        toggleReminderFields();
        updatePreview();

        // رویدادها
        $('input[name="ReminderType"]').on('change', function() {
            toggleReminderFields();
            updatePreview();
        });

        $('#notificationTimeInput').on('input change', function() {
            updateHiddenTimeField();
            updatePreview();
        });

        $('#IntervalDays, #DaysBeforeDeadline, #MaxSendCount, #StartDatePersian, #EndDatePersian').on('input change', function() {
            updatePreview();
        });

        $('[data-save="modal-ajax-save"]').on('click', function() {
            updateHiddenTimeField();
        });
    });

    // ⭐⭐⭐ تغییر فیلدها بر اساس نوع یادآوری
    window.toggleReminderFields = function() {
        const reminderType = $('input[name="ReminderType"]:checked').val();
        
        $('#intervalField').hide();
        $('#maxSendCountField').hide();
        $('#daysBeforeField').hide();
        $('#dateRangeFields').hide();
        
        if (reminderType === '0') {
            // یکبار - نمایش تاریخ شروع/پایان
            $('#dateRangeFields').slideDown(300, function() {
                // ⭐⭐⭐ فراخوانی global initPersianDatePicker
                if (typeof window.initPersianDatePicker === 'function') {
                    window.initPersianDatePicker($('#dateRangeFields'));
                }
            });
            $('#MaxSendCount').val(1).prop('readonly', true);
            $('#maxSendCountLabel').text('تعداد ارسال (ثابت)');
            $('#maxSendCountOptional').hide();
            $('#maxSendCountHelp').text('این یادآوری فقط یک بار ارسال می‌شود');
            $('#maxSendCountField').slideDown();
        } else if (reminderType === '1') {
            // تکراری
            $('#intervalField').slideDown();
            $('#MaxSendCount').val('').prop('readonly', false);
            $('#maxSendCountLabel').text('حداکثر تعداد ارسال');
            $('#maxSendCountOptional').show();
            $('#maxSendCountHelp').text('اگر خالی بگذارید، یادآوری تا پایان تسک ادامه خواهد داشت');
            $('#maxSendCountField').slideDown();
            $('#dateRangeFields').slideDown(300, function() {
                // ⭐⭐⭐ فراخوانی global initPersianDatePicker
                if (typeof window.initPersianDatePicker === 'function') {
                    window.initPersianDatePicker($('#dateRangeFields'));
                }
            });
        } else if (reminderType === '2') {
            // قبل از مهلت
            $('#daysBeforeField').slideDown();
            $('#MaxSendCount').val(1).prop('readonly', true);
            $('#maxSendCountLabel').text('تعداد ارسال (ثابت)');
            $('#maxSendCountOptional').hide();
            $('#maxSendCountHelp').text('این یادآوری فقط یک بار ارسال می‌شود');
            $('#maxSendCountField').slideDown();
        } else if (reminderType === '3') {
            // در روز شروع
            $('#MaxSendCount').val(1).prop('readonly', true);
            $('#maxSendCountLabel').text('تعداد ارسال (ثابت)');
            $('#maxSendCountOptional').hide();
            $('#maxSendCountHelp').text('این یادآوری فقط یک بار ارسال می‌شود');
            $('#maxSendCountField').slideDown();
        }

        updatePreview();
    };

    // ⭐⭐⭐ پیش‌نمایش یادآوری
    window.updatePreview = function() {
        const reminderType = $('input[name="ReminderType"]:checked').val();
        const time = $('#notificationTimeInput').val() || '09:00';
        const maxSendCount = $('#MaxSendCount').val();
        let text = '';
        
        switch(reminderType) {
            case '0':
                const startDate = $('#StartDatePersian').val() || 'تاریخ مشخص';
                const endDate = $('#EndDatePersian').val();
                text = `یادآوری <strong>یکبار</strong> در تاریخ <strong>${startDate}</strong> ساعت <strong>${time}</strong> ارسال خواهد شد`;
                if (endDate) {
                    text += ` (تا تاریخ ${endDate})`;
                }
                break;
            case '1':
                const interval = $('#IntervalDays').val() || 'X';
                text = `یادآوری هر <strong>${interval} روز</strong> یکبار در ساعت <strong>${time}</strong> ارسال خواهد شد`;
                if (maxSendCount && maxSendCount > 0) {
                    text += ` (حداکثر <strong>${maxSendCount} بار</strong>)`;
                } else {
                    text += ` (<strong>نامحدود</strong>)`;
                }
                break;
            case '2':
                const daysBefore = $('#DaysBeforeDeadline').val() || '3';
                text = `یادآوری <strong>${daysBefore} روز</strong> قبل از پایان مهلت در ساعت <strong>${time}</strong> ارسال خواهد شد (<strong>یکبار</strong>)`;
                break;
            case '3':
                text = `یادآوری در <strong>روز شروع تسک</strong> ساعت <strong>${time}</strong> ارسال خواهد شد (<strong>یکبار</strong>)`;
                break;
        }
        
        $('#previewText').html(text);
    };
})();
</script>

<style>
    .form-check-block {
        border: 2px solid transparent;
        transition: all 0.3s;
        cursor: pointer;
    }

    .form-check-block:hover {
        border-color: #dee2e6;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form-check-input:checked + .form-check-label {
        color: #007bff;
    }

    .form-check-block:has(.form-check-input:checked) {
        border-color: #007bff;
        background: linear-gradient(to right, rgba(0,123,255,0.05), transparent);
    }

    .persian-datepicker {
        cursor: pointer;
        background-color: white;
    }

    .persian-datepicker:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    input[readonly] {
        background-color: #f8f9fa !important;
        cursor: not-allowed;
        opacity: 0.8;
    }
</style>