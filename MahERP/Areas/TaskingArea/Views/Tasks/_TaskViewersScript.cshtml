<script>
// ⭐⭐⭐ بارگذاری ناظران تسک
$(document).ready(function() {
    // بارگذاری ناظران هنگام کلیک روی تب
    $('#viewers-tab').on('shown.bs.tab', function() {
        loadTaskViewers();
    });

    // ⭐⭐⭐ بروزرسانی لیست بعد از افزودن ناظر رونوشتی موفق
    $(document).on('modal-ajax-success', function(event, response) {
        // بررسی که آیا این response مربوط به افزودن ناظر است
        if (response && response.status === 'success' && 
            response.message && response.message[0] && 
            response.message[0].text && 
            response.message[0].text.includes('ناظر')) {
            
            console.log('✅ Carbon copy added successfully, refreshing viewers list...');
            
            // بارگذاری مجدد لیست ناظران
            setTimeout(function() {
                loadTaskViewers();
            }, 300);
        }
    });
});

function loadTaskViewers() {
    console.log('🔄 Loading task viewers...');

    // نمایش loading
    $('#system-viewers-list').html(`
        <div class="text-center py-4">
            <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">در حال بارگذاری...</p>
        </div>
    `);

    $('#carbon-copy-viewers-list').html(`
        <div class="text-center py-4">
            <i class="fa fa-spinner fa-spin fa-2x text-muted"></i>
            <p class="text-muted mt-2">در حال بارگذاری...</p>
        </div>
    `);

    $.ajax({
        url: window.TaskDetailConfig.urls.getTaskViewers,
        type: 'GET',
        data: { taskId: window.TaskDetailConfig.taskId },
        success: function(response) {
            console.log('✅ Task viewers loaded:', response);

            if (response.systemViewers) {
                renderSystemViewers(response.systemViewers);
            }

            if (response.carbonCopyViewers) {
                renderCarbonCopyViewers(response.carbonCopyViewers);
            }

            updateViewersStats(response);
        },
        error: function(xhr, status, error) {
            console.error('❌ Error loading viewers:', error);

            $('#system-viewers-list').html(`
                <div class="alert alert-danger">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    خطا در بارگذاری ناظران خودکار
                </div>
            `);

            $('#carbon-copy-viewers-list').html(`
                <div class="alert alert-danger">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    خطا در بارگذاری ناظران رونوشت
                </div>
            `);

            if (typeof toastr !== 'undefined') {
                toastr.error('خطا در بارگذاری ناظران تسک');
            }
        }
    });
}

function renderSystemViewers(viewers) {
    const $container = $('#system-viewers-list');

    if (!viewers || viewers.length === 0) {
        $container.html(`
            <div class="text-center py-4 text-muted">
                <i class="fa fa-users-slash fa-3x mb-3 opacity-25"></i>
                <p class="mb-1">هیچ ناظر سیستمی یافت نشد</p>
                <small>ناظران خودکار پس از تخصیص کاربران نمایش داده می‌شوند</small>
            </div>
        `);
        return;
    }

    let html = '<div class="list-group">';

    viewers.forEach(viewer => {
        html += `
            <div class="list-group-item">
                <div class="d-flex align-items-center">
                    <img src="${viewer.profileImage || '/images/default-avatar.png'}"
                         class="rounded-circle me-3"
                         style="width: 48px; height: 48px; object-fit: cover;"
                         alt="${viewer.fullName}">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${viewer.fullName}</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge bg-primary">
                                <i class="fa fa-shield-alt me-1"></i>${viewer.viewerReason}
                            </span>
                            ${viewer.teamName ? `<span class="badge bg-info"><i class="fa fa-users me-1"></i>${viewer.teamName}</span>` : ''}
                        </div>
                        ${viewer.email ? `<small class="text-muted"><i class="fa fa-envelope me-1"></i>${viewer.email}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    $container.html(html);
}

function renderCarbonCopyViewers(viewers) {
    const $container = $('#carbon-copy-viewers-list');

    if (!viewers || viewers.length === 0) {
        $container.html(`
            <div class="text-center py-4 text-muted">
                <i class="fa fa-user-slash fa-3x mb-3 opacity-25"></i>
                <p class="mb-1">هیچ ناظر رونوشتی اضافه نشده است</p>
                <small>فقط سازنده یا مدیر می‌تواند ناظر رونوشتی اضافه کند</small>
            </div>
        `);
        return;
    }

    let html = '<div class="list-group">';

    viewers.forEach(viewer => {
        html += `
            <div class="list-group-item">
                <div class="d-flex align-items-start">
                    <img src="${viewer.profileImage || '/images/default-avatar.png'}"
                         class="rounded-circle me-3"
                         style="width: 48px; height: 48px; object-fit: cover;"
                         alt="${viewer.fullName}">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${viewer.fullName}</h6>
                                <span class="badge bg-success mb-2">
                                    <i class="fa fa-copy me-1"></i>رونوشت
                                </span>
                            </div>
                            ${viewer.canRemove && !window.TaskDetailConfig.isTaskCompleted ? 
                                `<button type="button" 
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="removeCarbonCopyViewer(${viewer.id})"
                                        title="حذف ناظر">
                                    <i class="fa fa-trash"></i>
                                </button>` 
                                : ''}
                        </div>
                        ${viewer.email ? `<small class="text-muted d-block"><i class="fa fa-envelope me-1"></i>${viewer.email}</small>` : ''}
                        ${viewer.note ? `<div class="alert alert-light p-2 mb-0 mt-2"><small class="text-muted"><i class="fa fa-sticky-note me-1"></i>${viewer.note}</small></div>` : ''}
                        <small class="text-muted d-block mt-1">
                            <i class="fa fa-user me-1"></i>اضافه شده توسط: ${viewer.addedByUserName}
                            <i class="fa fa-calendar me-1 ms-2"></i>${viewer.addedDatePersian}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    $container.html(html);
}

function updateViewersStats(response) {
    const systemCount = response.systemViewers?.length || 0;
    const carbonCopyCount = response.carbonCopyViewers?.length || 0;
    const totalCount = systemCount + carbonCopyCount;

    $('#system-viewers-count, #system-viewers-stat').text(systemCount);
    $('#carbon-copy-viewers-count, #carbon-copy-viewers-stat').text(carbonCopyCount);
    $('#total-viewers-count').text(totalCount);
    $('#viewers-badge-count').text(totalCount);

    console.log(`📊 Viewers stats updated: Total=${totalCount}, System=${systemCount}, CarbonCopy=${carbonCopyCount}`);
}

function removeCarbonCopyViewer(carbonCopyId) {
    if (!confirm('آیا از حذف این ناظر رونوشتی اطمینان دارید؟')) {
        return;
    }

    console.log('🗑️ Removing carbon copy viewer:', carbonCopyId);

    $.ajax({
        url: window.TaskDetailConfig.urls.removeCarbonCopy,
        type: 'POST',
        data: {
            carbonCopyId: carbonCopyId,
            __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
        },
        success: function(response) {
            console.log('✅ Carbon copy removed:', response);

            if (response.status === 'success') {
                if (typeof toastr !== 'undefined') {
                    toastr.success('ناظر رونوشتی با موفقیت حذف شد');
                }

                // بارگذاری مجدد لیست
                loadTaskViewers();
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error(response.message?.[0]?.text || 'خطا در حذف ناظر');
                }
            }
        },
        error: function(xhr, status, error) {
            console.error('❌ Error removing carbon copy:', error);
            if (typeof toastr !== 'undefined') {
                toastr.error('خطا در حذف ناظر رونوشتی');
            }
        }
    });
}
</script>
