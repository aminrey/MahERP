@{
    var errors = ViewData.ModelState.Values.SelectMany(v => v.Errors);
    // دریافت پیام‌های ResponseMessage از TempData
    List<MahERP.CommonLayer.ViewModels.WebResponseMessageViewModel> responseMessages = null;
    if (TempData["ResponseMessages"] != null)
    {
        var jsonString = TempData["ResponseMessages"].ToString();
        try
        {
            responseMessages = System.Text.Json.JsonSerializer.Deserialize<List<MahERP.CommonLayer.ViewModels.WebResponseMessageViewModel>>(jsonString);
        }
        catch
        {
            // در صورت خطا در deserialize، نادیده گرفته می‌شود
        }
    }
}

<!DOCTYPE html>
<html dir="rtl" lang="fa">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width,initial-scale=1.0" name="viewport" />

    <title>MahERP Systems - مدیریت تسک‌ها</title>

    <meta content="سیستم برنامه‌ریزی منابع سازمانی" name="description" />
    <meta content="MahERP" name="author" />
    <meta content="noindex, nofollow" name="robots" />

    <!-- Open Graph Meta -->
    <meta content="MahERP" property="og:title" />
    <meta content="MahERP" property="og:site_name" />
    <meta content="سیستم برنامه‌ریزی منابع سازمانی" property="og:description" />
    <meta content="website" property="og:type" />
    <meta content="" property="og:url" />
    <meta content="" property="og:image" />

    <!-- Icons -->
    <link href="/assets/media/favicons/favicon.png" rel="shortcut icon" />
    <link href="/assets/media/favicons/favicon-192x192.png" rel="icon" sizes="192x192" type="image/png" />
    <link href="/assets/media/favicons/apple-touch-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" />
    <!-- END Icons -->
    
    <!-- Stylesheets -->
    <!-- Page JS Plugins CSS -->
    <link href="/assets/js/plugins/datatables-bs5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/datatables-buttons-bs5/css/buttons.bootstrap5.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/datatables-responsive-bs5/css/responsive.bootstrap5.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/raty-js/jquery.raty.css" rel="stylesheet" />
    <link href="/assets/js/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/select2/css/select2.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/dropzone/min/dropzone.min.css" rel="stylesheet" />
    <link href="/assets/js/plugins/flatpickr/flatpickr.min.css" rel="stylesheet" />
    <!-- Dashmix framework -->
    <link href="/assets/css/dashmix.min.css" id="css-main" rel="stylesheet" />
    <link href="~/assets/js/plugins/sweetalert2/sweetalert2.min.css" rel="stylesheet" />

    <!-- 🌿 TaskingArea Theme: xEco (Green Nature) -->
    <link rel="stylesheet" id="css-theme" href="/assets/css/themes/xeco.min.css">

    <link href="/assets/css/notifications.css" rel="stylesheet" />
    <link href="~/assets/css/taskingstyles.css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link href="/assets/css/custom-fonts.css" rel="stylesheet" />
    <link href="/assets/css/CustomStyle.css" rel="stylesheet" />
    
    <!-- ⭐⭐⭐ Custom Tooltip Styles -->
    <link href="/assets/css/custom-tooltip.css?v=2.3" rel="stylesheet" />

    @RenderSection("styles", required: false)


</head>

<body>
    <!-- Page Container -->
    <!-- 🌿 TaskingArea: xEco Theme Classes -->
    <div class="rtl-support sidebar-o sidebar-dark enable-page-overlay side-scroll page-header-fixed main-content-narrow remember-theme" id="page-container">

        <!-- Side Overlay-->
        <partial name="_SideOverlay" />
        <!-- END Side Overlay -->
        <!-- Sidebar -->
        <partial name="_SideBarPartial" />
        <!-- END Sidebar -->
        <!-- Header -->
        <partial name="_Headerpartial" />
        <!-- END Header -->
        <!-- Main Container -->
        <main id="main-container" class="content-top-padding">
            @RenderBody()
        </main>
        <!-- END Main Container -->
        <!-- Footer -->
        <partial name="_FooterPartial" />
        <!-- END Footer -->
    </div>
    <!-- END Page Container -->
    
    <!-- ⭐⭐⭐ Core JavaScript Libraries - Load in Order -->
    <!-- jQuery is already loaded in HEAD -->
    
    <!-- Dashmix JS -->
    <script src="/assets/js/dashmix.app.min.js"></script>
    <script src="/assets/js/lib/jquery.min.js"></script>

    <script src="/assets/js/main.js"></script>


    <!-- Page JS Plugins -->
    <script src="/assets/js/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"></script>
    <script src="/assets/js/plugins/select2/js/select2.full.min.js"></script>
    <script src="/assets/js/plugins/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script src="/assets/js/plugins/sweetalert2/sweetalert2.min.js"></script>
    <script src="/assets/js/plugins/dropzone/min/dropzone.min.js"></script>
    <script src="/assets/js/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="/assets/js/plugins/datatables-bs5/js/dataTables.bootstrap5.min.js"></script>
    <script src="/assets/js/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="/assets/js/plugins/datatables-responsive-bs5/js/responsive.bootstrap5.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons/dataTables.buttons.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons-bs5/js/buttons.bootstrap5.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons-jszip/jszip.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons-pdfmake/pdfmake.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons-pdfmake/vfs_fonts.js"></script>
    <script src="/assets/js/plugins/datatables-buttons/buttons.print.min.js"></script>
    <script src="/assets/js/plugins/datatables-buttons/buttons.html5.min.js"></script>
    <script src="/assets/js/plugins/raty-js/jquery.raty.js"></script>
    <script src="/assets/js/plugins/flatpickr/flatpickr.min.js"></script>
	<script src="~/assets/js/signalr.js"></script>
    
    <!-- ⭐⭐⭐ Persian DatePicker (باید بعد از jQuery لود شود) -->
    <script src="~/assets/js/plugins/persiandatepicker/persian-date.min.js"></script>

    <script src="~/assets/js/plugins/persiandatepicker/js-flatpickr.min.js"></script>
    <!-- Page JS Code -->
    <script src="/assets/js/pages/be_tables_datatables.min.js"></script>
    <script src="/assets/js/pages/be_comp_rating.min.js"></script>
    <script src="~/assets/js/plugins/sweetalert2/sweetalert2.all.min.js"></script>

    <script src="~/lib/tinymce/tinymce.min.js"></script>
    <script src="~/assets/js/tinymceConfig.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.14/signalr.min.js"></script>

    <!-- ⭐⭐⭐ Global Re-initialization Function -->
    <script>
        // ⭐⭐⭐ تابع سراسری برای Re-initialize کردن تمام plugin‌ها بعد از AJAX
        window.reinitializePlugins = function(container) {
            var $container = container ? $(container) : $(document);

            try {
                console.log('🔄 Re-initializing plugins...');

                // 1. Re-initialize Dashmix Helpers
                if (typeof Dashmix !== 'undefined' && Dashmix.helpersOnLoad) {
                    Dashmix.helpersOnLoad([
                        'jq-select2', 
                        'dm-table-tools-sections', 
                        'jq-slick', 
                        'bs-tooltip', 
                        'jq-notify'
                    ]);
                }

                // 2. Re-initialize Select2
                $container.find('.js-select2:not(.select2-hidden-accessible)').each(function() {
                    $(this).select2({
                        width: '100%',
                        dir: 'rtl'
                    });
                });

             

                // 4. Re-initialize Bootstrap Tooltips
                $container.find('[data-bs-toggle="tooltip"]').each(function() {
                    if (!$(this).data('bs.tooltip')) {
                        new bootstrap.Tooltip(this);
                    }
                });

                // 5. Re-initialize Bootstrap Popovers
                $container.find('[data-bs-toggle="popover"]').each(function() {
                    if (!$(this).data('bs.popover')) {
                        new bootstrap.Popover(this);
                    }
                });

                // 6. Re-initialize DataTables (if exists)
                $container.find('.js-dataTable-full:not(.dataTable)').each(function() {
                    if ($.fn.DataTable && !$.fn.DataTable.isDataTable(this)) {
                        $(this).DataTable({
                            pageLength: 10,
                            lengthMenu: [[5, 10, 15, 20], [5, 10, 15, 20]],
                            autoWidth: false,
                            language: {
                                url: '/assets/js/plugins/datatables/i18n/Persian.json'
                            }
                        });
                    }
                });


            } catch (error) {
                console.warn('⚠️ Error re-initializing plugins:', error);
            }
        };

        // ⭐⭐⭐ تابع سراسری برای Re-initialize DataTable
        window.reinitDataTable = function(tableId, options) {
            try {
                if ($.fn.DataTable.isDataTable('#' + tableId)) {
                    $('#' + tableId).DataTable().destroy();
                }
                $('#' + tableId).DataTable(options);
            } catch (error) {
                console.warn('مشکل در initialize کردن DataTable:', error);
            }
        };

        // ⭐⭐⭐ Initialize همه چیز در بارگذاری اولیه صفحه
        $(document).ready(function() {
            reinitializePlugins();
            
            // جلوگیری از نمایش خطاهای DataTable
            if ($.fn.dataTable) {
                $.fn.dataTable.ext.errMode = 'none';
            }
        });
    </script>

    <!-- Page JS Helpers -->
    <script>
        Dashmix.helpersOnLoad(['js-flatpickr', 'jq-datepicker', 'jq-select2', 'dm-table-tools-sections', 'jq-slick', 'bs-tooltip', 'jq-notify','jq-masked-inputs', 'jq-pw-strength']);
    </script>

    <!-- Error notifications from ModelState -->
    <script>
        @foreach (var item in errors)
        {
                <text>
                    Dashmix.helpers('jq-notify', { type: 'danger', icon: 'fa fa-times me-1', message: "@Html.Raw(item.ErrorMessage) " });
                </text>
        }
    </script>

    <!-- Response Messages from TempData -->
    <script>
        @if (responseMessages != null && responseMessages.Any())
        {
                foreach (var message in responseMessages)
                {
                        var notificationType = message.status switch
                        {
                                "success" => "success",
                                "warning" => "warning",
                                "info" => "info",
                                "error" => "danger",
                                _ => "info"
                        };

                        var icon = message.status switch
                        {
                                "success" => "fa fa-check me-1",
                                "warning" => "fa fa-exclamation-triangle me-1",
                                "info" => "fa fa-info me-1",
                                "error" => "fa fa-times me-1",
                                _ => "fa fa-info me-1"
                        };

                        <text>
                            Dashmix.helpers('jq-notify', { type: '@notificationType', icon: '@icon', message: "@Html.Raw(message.text)" });
                        </text>
                }
        }
    </script>

    <script src="~/assets/js/methods.js"></script>
    <script src="/assets/js/notifications.js"></script>
    <script src="~/assets/js/callenderconfig.js"></script>
    
    <!-- ⭐⭐⭐ Custom Tooltip System -->
    <script src="/assets/js/custom-tooltip.js?v=2.3"></script>
    
    <!-- ⭐⭐⭐ Initialize Custom Tooltips -->
    <script>
        console.log('🎨 Custom Tooltip System Loading...');
        
        // Wait for everything to load
        $(document).ready(function() {
            // Check if CustomTooltip is loaded
            if (typeof CustomTooltip !== 'undefined') {
                console.log('✅ CustomTooltip class loaded successfully');
                
                // Initialize tooltips
                try {
                    CustomTooltip.init('[data-tooltip]', {
                        delay: 150,
                        hideDelay: 50
                    });
                    console.log('✅ Custom tooltips initialized');
                } catch (error) {
                    console.error('❌ Error initializing tooltips:', error);
                }
            } else {
                console.error('❌ CustomTooltip class not found!');
                console.error('Make sure /assets/js/custom-tooltip.js is loaded properly');
            }
            
            // Debug: Show all elements with data-tooltip
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            console.log(`📌 Found ${tooltipElements.length} elements with data-tooltip attribute`);
            
            if (tooltipElements.length > 0) {
                console.log('First 3 tooltip elements:', Array.from(tooltipElements).slice(0, 3));
            }
        });
    </script>
  
    <!-- ⭐⭐⭐ Page-specific Scripts - Load LAST -->
    @RenderSection("Scripts", required: false)
</body>
</html>