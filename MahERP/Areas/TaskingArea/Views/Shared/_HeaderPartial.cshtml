@{
    var currentUser = ViewBag.CurrentUser as dynamic;
    var userName = ViewBag.UserName as string ?? User.Identity.Name;
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
    var currentArea = ViewContext.RouteData.Values["area"]?.ToString();
    bool HasCoreAccess = ViewBag.HasCoreAccess;
    bool HasCrmAccess = ViewBag.HasCrmAccess;
    bool HasTaskingAccess = ViewBag.HasTaskingAccess;
}

<!-- Header -->
<header id="page-header">
    <!-- Header Content -->
    <div class="content-header">
        <!-- Left Section -->
        <div class="space-x-1">
            <!-- Toggle Sidebar -->
            <button class="btn btn-alt-secondary" data-action="sidebar_toggle" data-toggle="layout" type="button">
                <i class="fa fa-fw fa-bars"></i>
            </button>
            <!-- END Toggle Sidebar -->
            <!-- Open Search Section -->
            <!-- END Open Search Section -->
            <!-- ============== 🎨 MODULE SELECTOR ============== -->
            @{
                var isTaskingEnabled = ViewBag.IsTaskingModuleEnabled ?? true;
                var isCrmEnabled = ViewBag.IsCrmModuleEnabled ?? true;
                var isAdmin = User.IsInRole("Admin");
            }

            @if (isTaskingEnabled || isCrmEnabled || isAdmin)
            {
                <div class="dropdown d-inline-block">
                    <button aria-expanded="false" aria-haspopup="true"
                            class="btn btn-alt-secondary @(currentArea != "AppCoreArea" ? "active" : "")"
                            data-bs-toggle="dropdown" id="module-selector-dropdown" type="button">
                        <i class="fa fa-fw fa-th-large d-sm-none"></i>
                        <span class="d-none d-sm-inline-block">
                            @if (currentArea == "TaskingArea")
                            {
                                <i class="fa fa-tasks me-1"></i>

                                <text>تسکینگ</text>
                            }
                            else if (currentArea == "CrmArea")
                            {
                                <i class="fa fa-chart-line me-1"></i>

                                <text>CRM</text>
                            }
                            else
                            {
                                <i class="fa fa-home me-1"></i>

                                <text>هسته مرکزی</text>
                            }
                        </span>
                        <i class="fa fa-fw fa-angle-down opacity-50 ms-1 d-none d-sm-inline-block"></i>
                    </button>

                    <div aria-labelledby="module-selector-dropdown" class="dropdown-menu dropdown-menu-lg p-0" style="min-width: 300px;">
                        <!-- Header -->
                        <div class="bg-primary-dark rounded-top fw-semibold text-white text-center p-3">
                            <i class="fa fa-cube me-2"></i>
                            انتخاب ماژول
                        </div>

                        <!-- Modules List -->
                        <div class="p-2">
                            <!-- Core Module (Always Available for Admin) -->
                            @if (isAdmin || HasCoreAccess)
                            {
                                <a class="dropdown-item module-item d-flex align-items-center @(currentArea == "AppCoreArea" ? "active current-module" : "")"
                                   asp-area="AppCoreArea" asp-controller="Dashboard" asp-action="Index">
                                    <div class="module-icon me-3">
                                        <i class="fa fa-home fa-2x text-primary"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">هسته مرکزی</div>
                                        <div class="fs-xs text-muted">مدیریت سیستم و تنظیمات</div>
                                    </div>
                                    @if (currentArea == "AppCoreArea")
                                    {
                                        <i class="fa fa-check-circle text-success ms-2"></i>
                                    }
                                </a>
                            }

                            <!-- Tasking Module -->
                            @if (isTaskingEnabled && HasTaskingAccess)
                            {
                                <a class="dropdown-item module-item d-flex align-items-center @(currentArea == "TaskingArea" ? "active current-module" : "")"
                                   asp-area="TaskingArea" asp-controller="Dashboard" asp-action="Index">
                                    <div class="module-icon me-3">
                                        <i class="fa fa-tasks fa-2x text-success"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">مدیریت تسک‌ها</div>
                                        <div class="fs-xs text-muted">تسکینگ و زمان‌بندی</div>
                                    </div>
                                    @if (currentArea == "TaskingArea")
                                    {
                                        <i class="fa fa-check-circle text-success ms-2"></i>
                                    }
                                </a>
                            }
                            else if (!isTaskingEnabled && isAdmin)
                            {
                                <div class="dropdown-item module-item disabled d-flex align-items-center opacity-50">
                                    <div class="module-icon me-3">
                                        <i class="fa fa-tasks fa-2x text-muted"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">مدیریت تسک‌ها</div>
                                        <div class="fs-xs text-muted">
                                            <i class="fa fa-lock me-1"></i>غیرفعال
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- CRM Module -->
                            @if (isCrmEnabled && HasCrmAccess)
                            {
                                <a class="dropdown-item module-item d-flex align-items-center @(currentArea == "CrmArea" ? "active current-module" : "")"
                                   asp-area="CrmArea" asp-controller="Dashboard" asp-action="Index">
                                    <div class="module-icon me-3">
                                        <i class="fa fa-chart-line fa-2x text-info"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">مدیریت CRM</div>
                                        <div class="fs-xs text-muted">ارتباط با مشتری</div>
                                    </div>
                                    @if (currentArea == "CrmArea")
                                    {
                                        <i class="fa fa-check-circle text-success ms-2"></i>
                                    }
                                </a>
                            }
                            else if (!isCrmEnabled && isAdmin)
                            {
                                <div class="dropdown-item module-item disabled d-flex align-items-center opacity-50">
                                    <div class="module-icon me-3">
                                        <i class="fa fa-chart-line fa-2x text-muted"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="fw-semibold">مدیریت CRM</div>
                                        <div class="fs-xs text-muted">
                                            <i class="fa fa-lock me-1"></i>غیرفعال
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Footer for Admin -->
                        @if (isAdmin)
                        {
                            <div class="p-2 border-top bg-body-light">
                                <a class="dropdown-item text-center fw-semibold text-primary"
                                   asp-area="AppCoreArea" asp-controller="Settings" asp-action="ModuleSettings">
                                    <i class="fa fa-cog me-1"></i> تنظیمات ماژول‌ها
                                </a>
                            </div>
                        }
                    </div>
                </div>
            }



            <!-- ============== END MODULE SELECTOR ============== -->
        </div>
        <!-- END Left Section -->
        <!-- Right Section -->


        <div class="space-x-1">

            <!-- ============== ⚡ QUICK ADD TASK BUTTON ============== -->
            @if (currentArea == "TaskingArea" && Html.CanAccessAny("TASK", "TASK.OPERATIONS.CREATE"))
            {
                <a asp-area="TaskingArea" asp-controller="Tasks" asp-action="CreateNewTask"
                   class="btn btn-success btn-quick-add d-none d-md-inline-block"
                   title="ایجاد تسک جدید">
                    <i class="fa fa-plus-circle me-1"></i>
                    <span class="d-none d-lg-inline-block">تسک جدید</span>
                </a>

                <!-- Mobile Version -->
                <a asp-area="TaskingArea" asp-controller="Tasks" asp-action="CreateNewTask"
                   class="btn btn-success btn-quick-add-mobile d-md-none"
                   title="ایجاد تسک جدید">
                    <i class="fa fa-plus"></i>
                </a>
            }
            <!-- ============== END QUICK ADD TASK BUTTON ============== -->
            <!-- ⭐ User Dropdown - Enhanced -->
            <div class="dropdown d-inline-block">
                <button aria-expanded="false" aria-haspopup="true"
                        class="btn btn-alt-secondary @(IsUserMenuActive(currentController, currentAction) ? "active" : "")"
                        data-bs-toggle="dropdown" id="page-header-user-dropdown" type="button">
                    <!-- ⭐ Avatar Image -->
                    <img alt="تصویر پروفایل" class="img-avatar img-avatar32 img-avatar-thumb d-none d-sm-inline-block me-1"
                         src=" @(!string.IsNullOrEmpty(currentUser.ProfileImagePath) ? currentUser.ProfileImagePath : " /assets/media/avatars/avatar0.jpg")"
                         style="border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);" />

                    <!-- ⭐ User Icon for mobile -->
                    <i class="fa fa-fw fa-user d-sm-none"></i>

                    <!-- ⭐ User Name -->
                    <span class="d-none d-sm-inline-block">@userName</span>
                    <i class="fa fa-fw fa-angle-down opacity-50 ms-1 d-none d-sm-inline-block"></i>
                </button>

                <!-- ⭐ Enhanced Dropdown Menu -->
                <div aria-labelledby="page-header-user-dropdown" class="dropdown-menu dropdown-menu-end dropdown-menu-lg p-0" style="min-width: 320px;">
                    <!-- ⭐ User Profile Header -->
                    <div class="rounded-top fw-semibold text-center p-3 border-bottom bg-primary-dark text-white">
                        <div class="mb-2">
                            <img alt="تصویر پروفایل" class="img-avatar img-avatar48 img-avatar-thumb"
                                 src=" @(!string.IsNullOrEmpty(currentUser.ProfileImagePath) ? currentUser.ProfileImagePath : " /assets/media/avatars/avatar0.jpg")"
                                 style="border: 3px solid rgba(255,255,255,0.3);" />
                        </div>

                        @if (currentUser != null)
                        {
                            <div class="fw-semibold fs-5 mb-1">@currentUser.FullName</div>
                            <div class="fs-sm opacity-75">@currentUser.PositionName</div>
                            @if (!string.IsNullOrEmpty(currentUser.Email))
                            {
                                <div class="fs-xs opacity-75 mt-1">
                                    <i class="fa fa-envelope me-1"></i>@currentUser.Email
                                </div>
                            }
                        }
                        else
                        {
                            <div class="fw-semibold fs-5 mb-1">@userName</div>
                            <div class="fs-sm opacity-75">کاربر سیستم</div>
                        }
                    </div>

                    <!-- ⭐ User Details Section -->
                    @if (currentUser != null)
                    {
                        <div class="p-3 border-bottom bg-body-light">
                            <div class="row text-center">
                                @if (!string.IsNullOrEmpty(currentUser.CompanyName))
                                {
                                    <div class="col-12 mb-2">
                                        <div class="fs-xs text-muted">شرکت</div>
                                        <div class="fw-semibold fs-sm">@currentUser.CompanyName</div>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(currentUser.PhoneNumber))
                                {
                                    <div class="col-6">
                                        <div class="fs-xs text-muted">تلفن</div>
                                        <div class="fw-semibold fs-sm" dir="ltr">@currentUser.PhoneNumber</div>
                                    </div>
                                }

                                @if (!string.IsNullOrEmpty(currentUser.City))
                                {
                                    <div class="col-6">
                                        <div class="fs-xs text-muted">شهر</div>
                                        <div class="fw-semibold fs-sm">@currentUser.City</div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- ⭐ Menu Items -->
                    <div class="p-2">
                        <a class="dropdown-item d-flex align-items-center @(IsMenuItemActive(currentController, currentAction, "UserManager", "Profile") ? "active" : "")"
                           asp-area="TaskingArea" asp-controller="UserManager" asp-action="Profile">
                            <i class="fa fa-fw fa-user me-2 text-primary"></i>
                            <div>
                                <div class="fw-semibold">پروفایل من</div>
                                <div class="fs-xs text-muted">مشاهده و ویرایش اطلاعات</div>
                            </div>
                        </a>

                        <a class="dropdown-item d-flex align-items-center @(IsMenuItemActive(currentController, currentAction, "UserManager", "Settings") ? "active" : "")"
                           onclick="showComingSoonNotification(event, 'تنظیمات کاربری')" href="#">
                            <i class="fa fa-fw fa-cog me-2 text-info"></i>
                            <div>
                                <div class="fw-semibold">تنظیمات</div>
                                <div class="fs-xs text-muted">تنظیمات شخصی</div>
                            </div>
                        </a>

                        <div class="dropdown-divider"></div>



                        <a class="dropdown-item d-flex align-items-center @(IsMenuItemActive(currentController, currentAction, "Tasks", "TaskReminders") ? "active" : "")"
                           asp-area="TaskingArea" asp-controller="Tasks" asp-action="TaskReminders">
                            <i class="fa fa-fw fa-bell me-2 text-success"></i>
                            <div>
                                <div class="fw-semibold">یادآوری‌ها</div>
                                <div class="fs-xs text-muted">یادآوری‌های فعال</div>
                            </div>
                        </a>
                    </div>

                    <!-- ⭐ Logout Section -->
                    <div class="p-2">
                        <a class="dropdown-item text-center fw-semibold text-danger" href="/Account/LogOut">
                            <i class="fa fa-fw fa-sign-out-alt me-1"></i> خروج از سیستم
                        </a>
                    </div>
                </div>
            </div>
            <!-- END User Dropdown -->
            <!-- ⭐ Notifications Dropdown -->
            <div class="dropdown d-inline-block">
                <button aria-expanded="false" aria-haspopup="true"
                        class="btn btn-alt-secondary position-relative @(IsNotificationMenuActive(currentController, currentAction) ? "active" : "")"
                        data-bs-toggle="dropdown" id="page-header-notifications-dropdown" type="button">
                    <i class="fa fa-fw fa-bell notification-bell"></i>

                </button>
                <span class="position-absolute  top-0 end-0 translate-middle badge rounded-pill bg-danger notification-badge"
                      id="headerNotificationBadge"
                      style="display: none;">
                    0
                </span>
                <div aria-labelledby="page-header-notifications-dropdown" class="dropdown-menu dropdown-menu-lg dropdown-menu-end p-0" style="width: 380px; max-height: 500px;">
                    <!-- Notification Header -->
                    <div class="bg-primary-dark rounded-top fw-semibold text-white text-center p-3 d-flex justify-content-between align-items-center">
                        <span>نوتیفیکیشن‌ها</span>
                        <div>
                            <button class="btn btn-sm btn-outline-light me-1" onclick="markAllHeaderNotificationsAsRead()" title="همه را خوانده شده علامت‌گذاری کن">
                                <i class="fa fa-check-double fa-xs"></i>
                            </button>
                            <a href="@Url.Action("Index", "Notification", new { area = "TaskingArea" })" class="btn btn-sm btn-outline-light" title="مشاهده همه">
                                <i class="fa fa-external-link-alt fa-xs"></i>
                            </a>
                        </div>
                    </div>

                    <!-- Notification List -->
                    <div id="headerNotificationsList" style="max-height: 350px; overflow-y: auto;">
                        <div class="text-center p-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">در حال بارگذاری...</span>
                            </div>
                            <div class="mt-2 text-muted small">در حال بارگذاری...</div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="p-2 border-top">
                        <a class="btn btn-alt-primary w-100 text-center" href="@Url.Action("Index", "Notification", new { area = "TaskingArea" })">
                            <i class="fa fa-fw fa-eye opacity-50 me-1"></i> مشاهده همه
                        </a>
                    </div>
                </div>
            </div>
            <!-- END Notifications Dropdown -->
            <!-- END Notifications Dropdown -->
            <!-- Toggle Side Overlay -->
            <!-- END Toggle Side Overlay -->
        </div>
        <!-- END Right Section -->
    </div>
    <!-- END Header Content -->
    <!-- Header Search -->
    <div class="overlay-header bg-header-dark" id="page-header-search">
        <div class="bg-white-10">
            <div class="content-header">
                <form action="be_pages_generic_search.html" class="w-100" method="POST">
                    <div class="input-group">
                        <button class="btn btn-alt-primary" data-action="header_search_off" data-toggle="layout" type="button">
                            <i class="fa fa-fw fa-times-circle"></i>
                        </button>
                        <input class="form-control border-0" id="page-header-search-input" name="page-header-search-input" placeholder="جستجو کنید یا ESC را بزنید" type="text" />
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- END Header Search -->
    <!-- Header Loader -->
    <div class="overlay-header bg-header-dark" id="page-header-loader">
        <div class="bg-white-10">
            <div class="content-header">
                <div class="w-100 text-center">
                    <i class="fa fa-fw fa-sun fa-spin text-white"></i>
                </div>
            </div>
        </div>
    </div>
    <!-- END Header Loader -->
    <!-- ⭐ Audio notification element -->
    <audio id="notificationSound" preload="auto">
        <source src="/assets/sounds/notification.mp3" type="audio/mpeg">
        <source src="/assets/sounds/notification.wav" type="audio/wav">
    </audio>
</header>
<!-- END Header -->
@functions {
    /// <summary>
    /// بررسی active بودن منوی کاربر
    /// </summary>
    public bool IsUserMenuActive(string currentController, string currentAction)
    {
        var userMenuControllers = new[] { "UserManager" };
        var userMenuActions = new[] { "Profile", "Settings", "Index", "Edit" };

        return userMenuControllers.Contains(currentController) &&
               userMenuActions.Contains(currentAction);
    }

    /// <summary>
    /// بررسی active بودن منوی نوتیفیکیشن
    /// </summary>
    public bool IsNotificationMenuActive(string currentController, string currentAction)
    {
        return currentController == "Notification";
    }

    /// <summary>
    /// بررسی active بودن آیتم‌های منو
    /// </summary>
    public bool IsMenuItemActive(string currentController, string currentAction, string targetController, string targetAction)
    {
        return currentController == targetController && currentAction == targetAction;
    }
}

<script>
    // ⭐⭐⭐ اطمینان از لود شدن کامل صفحه
    
</script>

