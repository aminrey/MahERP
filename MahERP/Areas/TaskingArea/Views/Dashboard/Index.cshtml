@model DashboardViewModel
@{
    ViewData["Title"] = "داشبورد";
}

<!-- Hero Banner Section -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo12@2x.jpg');">
    <div class="bg-black-75">
        <div class="content content-boxed content-full py-5">
            <div class="row">
                <div class="col-md-8 d-flex align-items-center py-3">
                    <div class="w-100 text-center text-md-start">
                        <h1 class="h2 text-white mb-2">داشبورد</h1>
                        <h2 class="h4 fs-sm text-uppercase fw-semibold text-white-75">خوش آمدید  @ViewBag.CurrentUser.FullName </h2>
                        <div class="text-white-50 fs-sm">آخرین بروزرسانی: @DateTime.Now.ToString("HH:mm")</div>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-center">
                    <div class="block block-rounded block-link-shadow block-transparent bg-black-50 text-center mb-0 mx-auto">
                        <div class="block-content block-content-full px-4 py-3">
                            <div class="d-grid gap-2">
                                <a asp-area="TaskingArea" asp-controller="MyDayTask" asp-action="Index" class="btn btn-primary">
                                    <i class="fa fa-calendar-day me-1"></i> تسک‌های روز من
                                </a>
                             
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- آمار کلی - ردیف دوم -->
<div class="content">
    <div class="row">
        <!-- تسک‌های من -->
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" asp-area="TaskingArea" asp-controller="Tasks" asp-action="Index" asp-route-filter="MyTasks">
                <div class="block-content block-content-full">
                    <div class="fs-2 fw-bold text-primary" id="mytasks">-</div>
                    <div class="fs-sm fw-semibold text-uppercase text-muted">تسک‌های فعال من</div>
                    <div class="fs-xs text-muted">ساخته‌شده + واگذارشده</div>
                </div>
            </a>
        </div>

        <!-- تسک‌های به موقع -->
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" asp-area="TaskingArea" asp-controller="Tasks" asp-action="Index" asp-route-filter="ontime">
                <div class="block-content block-content-full">
                    <div class="fs-2 fw-bold text-success" id="onTimeTasksCount">-</div>
                    <div class="fs-sm fw-semibold text-uppercase text-muted">به موقع</div>
                </div>
            </a>
        </div>

        <!-- تسک‌های عقب افتاده -->
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" asp-area="TaskingArea" asp-controller="Tasks" asp-action="Index" asp-route-filter="overdue">
                <div class="block-content block-content-full">
                    <div class="fs-2 fw-bold text-danger" id="overdueTasksCount">-</div>
                    <div class="fs-sm fw-semibold text-uppercase text-muted">عقب افتاده</div>
                </div>
            </a>
        </div>

        <!-- تسک‌های نظارتی -->
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" asp-area="TaskingArea" asp-controller="Tasks" asp-action="SupervisedTasks">
                <div class="block-content block-content-full">
                    <div class="fs-2 fw-bold text-info" id="supervisedtasks">-</div>
                    <div class="fs-sm fw-semibold text-uppercase text-muted">تحت نظارت</div>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- آخرین تسک‌ها - ردیف سوم -->
<div class="content">
    <div class="row">
        <div class="col-xl-6">
            <!-- تسک‌های دریافتی -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">آخرین تسک‌های دریافتی</h3>
                    <div class="block-options">
                        <button class="btn-block-option" data-action="state_toggle" data-action-mode="demo" data-toggle="block-option" type="button">
                            <i class="si si-refresh" onclick="loadRecentTasks()"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content" id="receivedTasksContainer">
                    <!-- ⭐⭐⭐ کارت‌های تسک از طریق AJAX بارگذاری می‌شوند -->
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END تسک‌های دریافتی -->
        </div>
        <div class="col-xl-6">
            <!-- تسک‌های واگذار شده -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">آخرین تسک‌های واگذار شده</h3>
                    <div class="block-options">
                        <button class="btn-block-option" data-action="state_toggle" data-action-mode="demo" data-toggle="block-option" type="button">
                            <i class="si si-refresh" onclick="loadRecentTasks()"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content" id="assignedTasksContainer">
                    <!-- ⭐⭐⭐ کارت‌های تسک از طریق AJAX بارگذاری می‌شوند -->
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END تسک‌های واگذار شده -->
        </div>
    </div>
</div>
<!-- END آخرین تسک‌ها -->
<!-- یادآوری‌ها - ردیف چهارم -->
<div class="content">
    <div class="row">
        <div class="col-12">
            <!-- جدول یادآوری‌ها -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-bell text-warning me-2"></i>یادآوری‌های مهم
                    </h3>
                    <div class="block-options">
                        <button class="btn-block-option" data-action="state_toggle" data-action-mode="demo" data-toggle="block-option" type="button">
                            <i class="si si-refresh" onclick="loadReminders()"></i>
                        </button>
                        <div class="dropdown">
                            <button type="button" class="btn-block-option dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="si si-options"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end">
                                <a class="dropdown-item" href="#" onclick="markAllRemindersAsRead()">
                                    <i class="fa fa-check me-1"></i> علامت‌گذاری همه به عنوان خوانده شده
                                </a>
                                <a class="dropdown-item" href="/TaskingArea/Tasks/Reminders">
                                    <i class="fa fa-list me-1"></i> مشاهده همه یادآوری‌ها
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="block-content">
                    <table class="table table-borderless table-striped table-vcenter fs-sm" id="remindersTable">
                        <tbody>
                            <!-- داده‌ها از طریق AJAX بارگذاری می‌شوند -->
                            <tr>
                                <td class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">در حال بارگذاری یادآوری‌ها...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- END جدول یادآوری‌ها -->
        </div>
    </div>
</div>
<!-- END یادآوری‌ها -->


@section Scripts {

    
    <script>
        $(document).ready(function() {
          @if (ViewBag.ShowTelegramGuide == true)
            {
                    <text>
                    // استفاده از createAndShowModal از main.js
                    createAndShowModal({
                        url: '@Url.Action("ShowTelegramGuideModal", "Dashboard", new { area = "TaskingArea" })',
                        backdrop: 'static',
                        keyboard: false,
                        removeOnHide: true
                    });
                    </text>
            }

            // بارگذاری داده‌های داشبورد
            loadDashboardData();
            loadRecentTasks();
            loadReminders();

            // بروزرسانی هر 60 ثانیه
            setInterval(function() {
                loadDashboardData();
                loadRecentTasks();
                loadReminders();
            }, 60000);
        });

        function loadDashboardData() {
            // بارگذاری آمار کلی
            $.get('@Url.Action("GetDashboardSummary", "Dashboard", new { area = "TaskingArea" })')
                .done(function(response) {
                    if (response.success) {
                        $('#mytasks').text(response.tasksStats.activePersonalTasksCount || response.tasksStats.myTasksCount || 0);
                        $('#onTimeTasksCount').text(response.tasksStats.onTimeTasksCount || 0);
                        $('#overdueTasksCount').text(response.tasksStats.overdueTasksCount);
                        $('#supervisedtasks').text(response.tasksStats.supervisedTasksCount);

                        // بروزرسانی badge های sidebar
                        updateSidebarBadges(response.tasksStats);
                    }
                })
                .fail(function() {
                    $('.fs-2').text('خطا');
                });
        }

        function loadRecentTasks() {
            // بارگذاری تسک‌های دریافتی
            $.get('@Url.Action("GetRecentReceivedTasks", "Dashboard", new { area = "TaskingArea" })')
                .done(function(response) {
                    if (response.success && response.tasks) {
                        populateTaskTable('#receivedTasksContainer', response.tasks, 'received');
                    }
                })
                .fail(function() {
                    $('#receivedTasksContainer').html('<div class="text-center text-muted p-3"><i class="fa fa-exclamation-triangle me-2"></i>خطا در بارگذاری</div>');
                });

            // بارگذاری تسک‌های واگذار شده
            $.get('@Url.Action("GetRecentAssignedTasks", "Dashboard", new { area = "TaskingArea" })')
                .done(function(response) {
                    if (response.success && response.tasks) {
                        populateTaskTable('#assignedTasksContainer', response.tasks, 'assigned');
                    }
                })
                .fail(function() {
                    $('#assignedTasksContainer').html('<div class="text-center text-muted p-3"><i class="fa fa-exclamation-triangle me-2"></i>خطا در بارگذاری</div>');
                });
        }

        // ⭐ تابع جدید برای بارگذاری یادآوری‌ها
        function loadReminders() {
            $.get('@Url.Action("GetDashboardReminders", "Dashboard", new { area = "TaskingArea" })')
                .done(function(response) {
                    if (response.success && response.reminders) {
                        populateRemindersTable(response.reminders);
                    }
                })
                .fail(function() {
                    $('#remindersTable tbody').html('<tr><td colspan="5" class="text-center text-muted">خطا در بارگذاری یادآوری‌ها</td></tr>');
                });
        }

        // ⭐ تابع پر کردن جدول یادآوری‌ها
        function populateRemindersTable(reminders) {
            const tbody = $('#remindersTable tbody');
            tbody.empty();

            if (!reminders || reminders.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center text-muted"><i class="fa fa-check-circle text-success me-1"></i>همه یادآوری‌ها خوانده شده!</td></tr>');
                return;
            }

            reminders.forEach(function(reminder) {
                const statusBadge = getReminderStatusBadge(reminder.status);
                const priorityIcon = reminder.priority === 1 ? '<i class="fa fa-exclamation-triangle text-warning me-1"></i>' : '';
                const taskLink = reminder.taskId ? `/TaskingArea/Tasks/Details/${reminder.taskId}` : '#';

                // ⭐ تشخیص یادآوری جدید
                const isNewReminder = !reminder.isRead && reminder.status !== 'read';
                const newReminderClass = isNewReminder ? 'table-warning notification-blink' : '';

                const row = `
                    <tr class="reminder-row ${reminder.status} ${newReminderClass}" data-reminder-id="${reminder.id}">
                        <td class="text-center" style="width: 60px;">
                            ${statusBadge}
                            ${isNewReminder ? '<span class="badge bg-success ms-1">جدید</span>' : ''}
                        </td>
                        <td style="max-width: 400px;">
                            <div class="fw-medium mb-1 text-truncate">
                                ${priorityIcon}${reminder.title}
                            </div>
                            <div class="fs-xs text-muted mb-1 text-truncate">${reminder.message || ''}</div>
                            ${reminder.taskTitle ? `<div class="fs-xs text-truncate"><span class="text-muted">تسک:</span> <a href="${taskLink}" class="text-decoration-none">${reminder.taskCode} - ${reminder.taskTitle}</a></div>` : ''}
                        </td>
                        <td class="d-none d-sm-table-cell text-center" style="width: 100px;">
                            <div class="fs-xs text-muted">${reminder.timeInfo}</div>
                        </td>
                        <td class="d-none d-lg-table-cell text-center" style="width: 120px;">
                            <div class="fs-xs text-muted">${reminder.scheduledDatePersian}</div>
                        </td>
                        <td class="text-center" style="width: 80px;">
                            <div class="btn-group btn-group-sm" role="group">
                                ${!reminder.isRead ? `<button type="button" class="btn btn-sm btn-outline-success" onclick="markReminderAsRead(${reminder.id})" title="علامت‌گذاری به عنوان خوانده شده"><i class="fa fa-check"></i></button>` : ''}
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteReminder(${reminder.id})" title="حذف یادآوری"><i class="fa fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        // ⭐ تابع دریافت badge وضعیت یادآوری
        function getReminderStatusBadge(status) {
            switch (status) {
                case 'overdue':
                    return '<span class="badge bg-danger" title="عقب افتاده"><i class="fa fa-clock"></i></span>';
                case 'upcoming':
                    return '<span class="badge bg-warning" title="آینده نزدیک"><i class="fa fa-bell"></i></span>';
                case 'unread':
                    return '<span class="badge bg-info" title="ارسال شده"><i class="fa fa-envelope"></i></span>';
                case 'read':
                    return '<span class="badge bg-success" title="خوانده شده"><i class="fa fa-check"></i></span>';
                default:
                    return '<span class="badge bg-secondary"><i class="fa fa-bell"></i></span>';
            }
        }

        // ⭐ علامت‌گذاری یادآوری به عنوان خوانده شده
        function markReminderAsRead(reminderId) {
            $.post('@Url.Action("MarkReminderAsRead", "Tasks", new { area = "TaskingArea" })', { reminderId: reminderId })
                .done(function(response) {
                    if (response.success) {
                        loadReminders(); // بروزرسانی جدول
                        loadDashboardData(); // بروزرسانی آمار
                    }
                })
                .fail(function() {
                    alert('خطا در علامت‌گذاری یادآوری');
                });
        }

        // ⭐ علامت‌گذاری همه یادآوری‌ها به عنوان خوانده شده
        function markAllRemindersAsRead() {
            if (confirm('آیا مطمئنید که می‌خواهید همه یادآوری‌ها را به عنوان خوانده شده علامت‌گذاری کنید؟')) {
                $.post('@Url.Action("MarkAllRemindersAsRead", "Tasks", new { area = "TaskingArea" })')
                    .done(function(response) {
                        if (response.success) {
                            loadReminders(); // بروزرسانی جدول
                            loadDashboardData(); // بروزرسانی آمار
                        }
                    })
                    .fail(function() {
                        alert('خطا در علامت‌گذاری یادآوری‌ها');
                    });
            }
        }

        // ⭐ حذف یادآوری
        function deleteReminder(reminderId) {
            if (confirm('آیا مطمئنید که می‌خواهید این یادآوری را حذف کنید؟')) {
                $.post('@Url.Action("DeleteReminder", "Tasks", new { area = "TaskingArea" })', { reminderId: reminderId })
                    .done(function(response) {
                        if (response.success) {
                            loadReminders(); // بروزرسانی جدول
                            loadDashboardData(); // بروزرسانی آمار
                        }
                    })
                    .fail(function() {
                        alert('خطا در حذف یادآوری');
                    });
            }
        }

        // ⭐⭐⭐ تابع اصلی برای نمایش تسک‌ها به صورت کارتی
        function populateTaskTable(tableSelector, tasks, type) {
            const container = $(tableSelector).closest('.block-content');
            container.empty();

            if (!tasks || tasks.length === 0) {
                container.html('<div class="text-center text-muted p-3"><i class="fa fa-inbox me-2"></i>تسکی یافت نشد</div>');
                return;
            }

            // ایجاد container برای کارت‌ها
            const cardsContainer = $('<div class="row g-2"></div>');
            
            tasks.forEach(function(task) {
                const card = createDashboardTaskCard(task, type);
                cardsContainer.append(card);
            });

            container.append(cardsContainer);
        }

        // ⭐⭐⭐ تابع ایجاد کارت تسک برای داشبورد
        function createDashboardTaskCard(task, type) {
            const isCompleted = task.isCompleted || false;
            const borderColor = isCompleted ? '#34a853' : '#4285f4';
            
            // تشخیص اولویت
            let priorityBadge = 'bg-secondary';
            let priorityText = 'عادی';
            if (task.important || task.priority === 2) {
                priorityBadge = 'bg-danger';
                priorityText = 'فوری';
            } else if (task.priority === 1) {
                priorityBadge = 'bg-warning';
                priorityText = 'مهم';
            }

            // توضیحات کوتاه
            const shortDesc = task.description && task.description.length > 50 
                ? task.description.substring(0, 50) + '...' 
                : (task.description || '');

            // تاریخ
            const taskDate = task.startDate || task.createDate;
            const formattedDate = formatDate(taskDate);

            // کاربر
            let userBadge = '';
            if (type === 'received') {
                userBadge = `<span class="badge bg-secondary" style="font-size: 0.6rem;"><i class="fa fa-user me-1"></i>از: ${task.creatorName || 'نامشخص'}</span>`;
            } else {
                userBadge = `<span class="badge bg-info" style="font-size: 0.6rem;"><i class="fa fa-user me-1"></i>به: ${task.assignedToName || 'نامشخص'}</span>`;
            }

            // Badge تکمیل یا پیشرفت
            let statusBadge = '';
            if (type === 'received' && isCompleted) {
                statusBadge = '<span class="badge bg-success" style="font-size: 0.6rem;"><i class="fa fa-check me-1"></i>تکمیل</span>';
            } else if (type === 'assigned') {
                const completionPercentage = task.totalAssignees > 0 
                    ? Math.round((task.completedCount / task.totalAssignees) * 100) 
                    : 0;
                
                let progressBadge = 'bg-secondary';
                if (completionPercentage === 100) progressBadge = 'bg-success';
                else if (completionPercentage >= 50) progressBadge = 'bg-info';
                else if (task.hasOverdueAssignees) progressBadge = 'bg-danger';
                else progressBadge = 'bg-warning';

                statusBadge = `<span class="badge ${progressBadge}" style="font-size: 0.6rem;">${task.completedCount}/${task.totalAssignees}</span>`;
            }

            return `
                <div class="col-12 mb-2">
                    <div class="block block-rounded mb-0 position-relative task-dashboard-card"
                         style="border-right: 4px solid ${borderColor}; 
                                box-shadow: 0 1px 4px rgba(0,0,0,0.08);
                                transition: all 0.2s ease;">
                        
                        <div class="block-content p-2">
                            <div class="row align-items-center g-2">
                                
                                <div class="col-auto">
                                    <div class="text-center" style="min-width: 50px;">
                                        <a href="/TaskingArea/Tasks/Details/${task.id}" class="fw-bold text-primary" style="font-size: 0.85rem;">
                                            ${task.taskCode || '---'}
                                        </a>
                                    </div>
                                </div>

                                <div class="col">
                                    <div class="d-flex flex-column">
                                        <a href="/TaskingArea/Tasks/Details/${task.id}" 
                                           class="fw-semibold text-dark text-decoration-none mb-1"
                                           style="font-size: 0.85rem;">
                                            ${task.title}
                                        </a>
                                        
                                        ${shortDesc ? `<small class="text-muted d-none d-md-block mb-1">${shortDesc}</small>` : ''}

                                        <div class="d-flex flex-wrap gap-1 align-items-center">
                                            ${userBadge}
                                            <span class="badge ${priorityBadge}" style="font-size: 0.6rem;">${priorityText}</span>
                                            ${statusBadge}
                                            <span class="badge bg-light text-dark d-md-none" style="font-size: 0.6rem;">
                                                <i class="fa fa-calendar me-1"></i>${formattedDate}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-auto d-none d-md-block text-end" style="min-width: 90px;">
                                    <div class="fs-xs text-muted">
                                        <i class="fa fa-calendar me-1"></i>${formattedDate}
                                    </div>
                                </div>

                                <div class="col-auto">
                                    <a href="/TaskingArea/Tasks/Details/${task.id}" 
                                       class="btn btn-sm btn-alt-primary"
                                       data-bs-toggle="tooltip"
                                       title="جزئیات">
                                        <i class="fa fa-arrow-left"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('fa-IR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function updateSidebarBadges(stats) {
            if (typeof window.updateTaskBadges === 'function') {
                window.updateTaskBadges(stats);
            }
        }
    </script>

    <style>
        /* ⭐⭐⭐ استایل کارت‌های تسک در داشبورد */
        .task-dashboard-card {
            transition: all 0.2s ease !important;
            position: relative;
            z-index: 1;
        }

        .task-dashboard-card:hover {
            transform: translateX(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15) !important;
            z-index: 10;
        }

        .task-dashboard-card a {
            text-decoration: none;
        }

        .task-dashboard-card a:hover {
            color: #4285f4 !important;
        }

        /* ⭐ Responsive adjustments */
        @@media (max-width: 768px) {
            .task-dashboard-card .block-content {
                padding: 0.5rem !important;
            }
            
            .task-dashboard-card .col-auto:first-child {
                min-width: 45px !important;
            }

            .task-dashboard-card .fw-semibold {
                font-size: 0.8rem !important;
            }
        }
    </style>
}