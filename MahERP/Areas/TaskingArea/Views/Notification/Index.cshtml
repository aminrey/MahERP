@model MahERP.DataModelLayer.ViewModels.Core.NotificationViewModels.CoreNotificationListViewModel

@{
    ViewData["Title"] = "اعلان‌های من";
    var systemId = ViewBag.SystemId as byte?;
    var unreadOnly = ViewBag.UnreadOnly as bool? ?? false;
}

<div class="content">
    <!-- Header -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-bell me-1 text-primary"></i>
                اعلان‌های من
                @if (Model.UnreadCount > 0)
                {
                    <span class="badge bg-danger ms-2">@Model.UnreadCount خوانده نشده</span>
                }
            </h3>
            <div class="block-options">
                <button class="btn btn-sm btn-alt-secondary" onclick="markAllAsRead()">
                    <i class="fa fa-check-double me-1"></i>
                    همه را خوانده شده علامت‌گذاری کن
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="block-content border-bottom">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select" id="systemFilter" onchange="applyFilters()">
                        <option value="">همه سیستم‌ها</option>
                        @if (systemId == 7)
                        {                        <option value="7" selected >تسکینگ</option>

                        }
                        else
                        {
                                                    <option value="7" >تسکینگ</option>

                        }

                        @if(systemId == 3){
                                                <option value="3" selected >CRM</option>

                        }
                        else
                        {
                                                    <option value="3" >CRM</option>

                        }

                    </select>
                </div>
                <div class="col-md-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="unreadOnlyCheck" 
                               @(unreadOnly ? "checked" : "") onchange="applyFilters()">
                        <label class="form-check-label" for="unreadOnlyCheck">
                            فقط خوانده نشده‌ها
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications List -->
        <div class="block-content">
            @if (Model.Notifications.Any())
            {
                <div class="list-group list-group-flush">
                    @foreach (var notification in Model.Notifications)
                    {
                        <a href="@Url.Action("Click", "Notification", new { id = notification.Id, area = "TaskingArea" })"
                           class="list-group-item list-group-item-action @(!notification.IsRead ? "list-group-item-primary" : "")">
                            <div class="d-flex w-100 justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <!-- Icon & Title -->
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fa fa-fw @notification.Icon fa-2x me-3 @(notification.IsRead ? "text-muted" : "text-primary")"></i>
                                        <div>
                                            <h5 class="mb-1 @(notification.IsRead ? "text-muted" : "")">
                                                @notification.Title
                                                @if (!notification.IsRead)
                                                {
                                                    <span class="badge bg-danger ms-1">جدید</span>
                                                }
                                            </h5>
                                            <small class="text-muted">
                                                <i class="fa fa-clock me-1"></i>
                                                @notification.RelativeTime
                                            </small>
                                        </div>
                                    </div>

                                    <!-- Message -->
                                    <p class="mb-1 @(notification.IsRead ? "text-muted" : "")">
                                        @notification.Message
                                    </p>

                                    <!-- Meta Info -->
                                    <div class="d-flex align-items-center gap-3 mt-2">
                                        @if (!string.IsNullOrEmpty(notification.SenderUserName))
                                        {
                                            <small class="text-muted">
                                                <i class="fa fa-user me-1"></i>
                                                @notification.SenderUserName
                                            </small>
                                        }
                                        <small class="text-muted">
                                            <i class="fa fa-layer-group me-1"></i>
                                            @notification.SystemName
                                        </small>
                                        <small class="text-muted">
                                            <i class="fa fa-tag me-1"></i>
                                            @notification.NotificationTypeName
                                        </small>
                                    </div>
                                </div>

                                <!-- Priority Badge -->
                                @if (notification.Priority > 0)
                                {
                                    <div class="ms-3">
                                        <span class="badge @GetPriorityClass(notification.Priority)">
                                            @notification.PriorityName
                                        </span>
                                    </div>
                                }
                            </div>
                        </a>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalCount > Model.PageSize)
                {
                    <nav aria-label="Pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            @for (int i = 1; i <= Math.Ceiling((double)Model.TotalCount / Model.PageSize); i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    <a class="page-link" 
                                       href="@Url.Action("Index", new { page = i, systemId, unreadOnly })">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fa fa-bell-slash fa-3x text-muted mb-3"></i>
                    <p class="text-muted">اعلانی یافت نشد</p>
                </div>
            }
        </div>
    </div>
</div>

@functions {
    string GetPriorityClass(byte priority)
    {
        return priority switch
        {
            0 => "bg-secondary",
            1 => "bg-warning",
            2 => "bg-danger",
            3 => "bg-dark",
            _ => "bg-secondary"
        };
    }
}

<script>
    function applyFilters() {
        const systemId = $('#systemFilter').val();
        const unreadOnly = $('#unreadOnlyCheck').is(':checked');
        
        window.location.href = '@Url.Action("Index")' +
            '?systemId=' + systemId +
            '&unreadOnly=' + unreadOnly;
    }

    function markAllAsRead() {
        $.post('@Url.Action("MarkAllAsRead")').done(function(data) {
            if (data.success) {
                toastr.success(`${data.count} اعلان به عنوان خوانده شده علامت‌گذاری شد`);
                location.reload();
            }
        });
    }
</script>