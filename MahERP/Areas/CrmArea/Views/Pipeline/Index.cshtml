@model MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmPipelineBoardViewModel
@{
    ViewData["Title"] = "Pipeline فروش";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        /* ========================================
           ⭐⭐⭐ PIPELINE KANBAN STYLES
           ======================================== */
        
        .pipeline-container {
            overflow-x: auto;
            padding: 1rem;
            min-height: calc(100vh - 200px);
        }
        
        .pipeline-board {
            display: flex;
            gap: 1rem;
            min-width: max-content;
        }
        
        .pipeline-column {
            min-width: 300px;
            max-width: 350px;
            background: var(--bs-gray-100);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
        }
        
        .pipeline-column-header {
            padding: 1rem;
            border-radius: 0.75rem 0.75rem 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .pipeline-column-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pipeline-column-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .pipeline-column-body {
            padding: 0.5rem;
            flex: 1;
            overflow-y: auto;
            max-height: calc(100vh - 350px);
        }
        
        .pipeline-card {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: grab;
            transition: all 0.2s ease;
            border-right: 4px solid transparent;
        }
        
        .pipeline-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .pipeline-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        
        .pipeline-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: var(--bs-dark);
        }
        
        .pipeline-card-customer {
            font-size: 0.85rem;
            color: var(--bs-secondary);
            margin-bottom: 0.75rem;
        }
        
        .pipeline-card-value {
            font-weight: 700;
            font-size: 1rem;
            color: var(--bs-success);
        }
        
        .pipeline-card-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--bs-gray-200);
            font-size: 0.75rem;
        }
        
        .pipeline-card-action {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        .pipeline-card-action.overdue {
            background: rgba(220, 53, 69, 0.1);
            color: var(--bs-danger);
        }
        
        .pipeline-card-action.today {
            background: rgba(255, 193, 7, 0.1);
            color: var(--bs-warning);
        }
        
        .pipeline-card-action.upcoming {
            background: rgba(13, 110, 253, 0.1);
            color: var(--bs-primary);
        }
        
        /* ========================================
           ⭐⭐⭐ STATISTICS BAR
           ======================================== */
        
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--bs-secondary);
        }
        
        /* ========================================
           ⭐⭐⭐ WON/LOST COLUMNS
           ======================================== */
        
        .pipeline-column.won-column .pipeline-column-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .pipeline-column.lost-column .pipeline-column-header {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .pipeline-column.won-column .pipeline-card {
            border-right-color: #10b981;
        }
        
        .pipeline-column.lost-column .pipeline-card {
            border-right-color: #ef4444;
        }
        
        /* ========================================
           ⭐⭐⭐ DROP ZONE
           ======================================== */
        
        .pipeline-column-body.drag-over {
            background: rgba(13, 110, 253, 0.1);
            border: 2px dashed var(--bs-primary);
            border-radius: 0.5rem;
        }
        
        /* ========================================
           ⭐⭐⭐ EMPTY STATE
           ======================================== */
        
        .empty-column {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--bs-secondary);
        }
        
        .empty-column i {
            font-size: 2rem;
            opacity: 0.5;
            margin-bottom: 0.5rem;
        }
    </style>
}

<div class="container-fluid">
    <!-- ========================================
         ⭐⭐⭐ HEADER & FILTERS
         ======================================== -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-1">
                <i class="fas fa-chart-line text-primary"></i>
                Pipeline فروش
            </h4>
            <p class="text-muted mb-0 small">مدیریت فرصت‌های فروش به صورت کانبان</p>
        </div>
        <div class="d-flex gap-2">
            <!-- فیلتر شعبه -->
            <select id="branchFilter" class="form-select form-select-sm" style="width: 180px;">
                @if (ViewBag.Branches != null)
                {
                    foreach (var branch in ViewBag.Branches as SelectList)
                    {
                        if (branch.Selected)
                        {
                            <option value="@branch.Value" selected>@branch.Text</option>
                        }
                        else
                        {
                            <option value="@branch.Value">@branch.Text</option>
                        }
                    }
                }
            </select>
            
            <!-- فیلتر کاربر -->
            <select id="userFilter" class="form-select form-select-sm" style="width: 180px;">
                <option value="">همه کاربران</option>
                @if (ViewBag.Users != null)
                {
                    foreach (var user in ViewBag.Users as SelectList)
                    {
                        <option value="@user.Value">@user.Text</option>
                    }
                }
            </select>
            
            <!-- دکمه ایجاد -->
            <a href="@Url.Action("Create")" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i>
                فرصت جدید
            </a>
            
            <!-- تنظیمات -->
            <a href="@Url.Action("ManageStages")" class="btn btn-outline-secondary btn-sm" title="تنظیمات مراحل">
                <i class="fas fa-cog"></i>
            </a>
        </div>
    </div>
    
    <!-- ========================================
         ⭐⭐⭐ STATISTICS BAR
         ======================================== -->
    @if (Model.Statistics != null)
    {
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.OpenOpportunities</div>
                    <div class="stat-label">فرصت باز</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon bg-info bg-opacity-10 text-info">
                    <i class="fas fa-coins"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.TotalValueFormatted</div>
                    <div class="stat-label">ارزش کل</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                    <i class="fas fa-balance-scale"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.TotalWeightedValueFormatted</div>
                    <div class="stat-label">ارزش وزن‌دار</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon bg-success bg-opacity-10 text-success">
                    <i class="fas fa-trophy"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.WonOpportunities</div>
                    <div class="stat-label">برنده شده</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon bg-danger bg-opacity-10 text-danger">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.LostOpportunities</div>
                    <div class="stat-label">از دست رفته</div>
                </div>
            </div>
            
            <div class="stat-item">
                <div class="stat-icon bg-purple bg-opacity-10 text-purple" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                    <i class="fas fa-percentage"></i>
                </div>
                <div>
                    <div class="stat-value">@Model.Statistics.WinRateFormatted</div>
                    <div class="stat-label">نرخ موفقیت</div>
                </div>
            </div>
        </div>
    }
    
    <!-- ========================================
         ⭐⭐⭐ KANBAN BOARD
         ======================================== -->
    <div class="pipeline-container">
        <div class="pipeline-board" id="pipelineBoard">
            @foreach (var column in Model.Columns.OrderBy(c => c.DisplayOrder))
            {
                var columnClass = column.IsWonStage ? "won-column" : (column.IsLostStage ? "lost-column" : "");
                var headerStyle = !column.IsWonStage && !column.IsLostStage 
                    ? $"background: {column.StageColor}20; color: {column.StageColor};" 
                    : "";
                
                <div class="pipeline-column @columnClass" data-stage-id="@column.StageId">
                    <!-- Header -->
                    <div class="pipeline-column-header" style="@headerStyle">
                        <div class="pipeline-column-title">
                            <i class="@column.StageIcon"></i>
                            @column.StageName
                            <span class="badge bg-white text-dark ms-auto">@column.Count</span>
                        </div>
                        <div class="pipeline-column-stats">
                            <span>@column.TotalValueFormatted</span>
                            @if (!column.IsWonStage && !column.IsLostStage)
                            {
                                <span>@column.WinProbability% احتمال</span>
                            }
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div class="pipeline-column-body" 
                         data-stage-id="@column.StageId"
                         ondrop="handleDrop(event)"
                         ondragover="handleDragOver(event)"
                         ondragleave="handleDragLeave(event)">
                        
                        @if (column.Opportunities.Any())
                        {
                            @foreach (var opp in column.Opportunities)
                            {
                                var actionClass = "";
                                if (opp.NextActionDate.HasValue)
                                {
                                    if (opp.NextActionDate.Value.Date < DateTime.Today)
                                        actionClass = "overdue";
                                    else if (opp.NextActionDate.Value.Date == DateTime.Today)
                                        actionClass = "today";
                                    else
                                        actionClass = "upcoming";
                                }
                                
                                <div class="pipeline-card" 
                                     data-opportunity-id="@opp.Id"
                                     draggable="true"
                                     ondragstart="handleDragStart(event)"
                                     ondragend="handleDragEnd(event)"
                                     onclick="showOpportunityDetails(@opp.Id)">
                                    
                                    <div class="pipeline-card-title">@opp.Title</div>
                                    <div class="pipeline-card-customer">
                                        <i class="fas fa-@(opp.CustomerType == "Individual" ? "user" : "building") me-1"></i>
                                        @opp.CustomerName
                                    </div>
                                    <div class="pipeline-card-value">@opp.ValueFormatted تومان</div>
                                    
                                    <div class="pipeline-card-meta">
                                        <div class="d-flex align-items-center gap-1">
                                            @if (!string.IsNullOrEmpty(opp.AssignedUserName))
                                            {
                                                <span class="badge bg-light text-dark">
                                                    <i class="fas fa-user-tag"></i>
                                                    @opp.AssignedUserName
                                                </span>
                                            }
                                        </div>
                                        
                                        @if (opp.NextActionType.HasValue)
                                        {
                                            <div class="pipeline-card-action @actionClass">
                                                @GetActionIcon(opp.NextActionType)
                                                @if (opp.NextActionDate.HasValue)
                                                {
                                                    @MahERP.CommonLayer.PublicClasses.ConvertDateTime.ConvertMiladiToShamsi(opp.NextActionDate.Value, "MM/dd")
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-column">
                                <i class="fas fa-inbox d-block"></i>
                                <small>بدون فرصت</small>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- ========================================
     ⭐⭐⭐ MARK AS LOST MODAL
     ======================================== -->
<div class="modal fade" id="lostModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-times-circle me-2"></i>
                    ثبت از دست رفتن فرصت
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="lostOpportunityId" />
                
                <div class="mb-3">
                    <label class="form-label">دلیل از دست رفتن</label>
                    <select id="lostReason" class="form-select">
                        <option value="">انتخاب کنید...</option>
                        <option value="قیمت بالا">قیمت بالا</option>
                        <option value="انتخاب رقیب">انتخاب رقیب</option>
                        <option value="تغییر نیاز مشتری">تغییر نیاز مشتری</option>
                        <option value="عدم بودجه">عدم بودجه</option>
                        <option value="زمان‌بندی نامناسب">زمان‌بندی نامناسب</option>
                        <option value="عدم تصمیم‌گیری">عدم تصمیم‌گیری</option>
                        <option value="سایر">سایر</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">نام رقیب برنده (اختیاری)</label>
                    <input type="text" id="winningCompetitor" class="form-control" placeholder="نام شرکت رقیب..." />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-danger" onclick="confirmMarkAsLost()">
                    <i class="fas fa-times-circle me-1"></i>
                    ثبت از دست رفتن
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     ⭐⭐⭐ MARK AS WON MODAL
     ======================================== -->
<div class="modal fade" id="wonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-trophy me-2"></i>
                    🎉 تبریک! ثبت برنده شدن
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <input type="hidden" id="wonOpportunityId" />
                
                <div class="mb-4">
                    <i class="fas fa-trophy text-success" style="font-size: 4rem;"></i>
                </div>
                
                <p class="lead">آیا از برنده شدن این فرصت اطمینان دارید؟</p>
                
                <div class="mb-3">
                    <label class="form-label">یادداشت (اختیاری)</label>
                    <textarea id="wonNote" class="form-control" rows="2" placeholder="توضیحات..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-success" onclick="confirmMarkAsWon()">
                    <i class="fas fa-check me-1"></i>
                    ثبت برنده شدن
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // ========================================
        // ⭐⭐⭐ DRAG & DROP FUNCTIONALITY
        // ========================================
        
        let draggedCard = null;
        let draggedOpportunityId = null;
        
        function handleDragStart(e) {
            draggedCard = e.target;
            draggedOpportunityId = e.target.dataset.opportunityId;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggedOpportunityId);
        }
        
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedCard = null;
            
            // Remove drag-over class from all columns
            document.querySelectorAll('.pipeline-column-body').forEach(col => {
                col.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const newStageId = e.currentTarget.dataset.stageId;
            const opportunityId = e.dataTransfer.getData('text/plain');
            
            // Check if dropping to Won/Lost stage
            const column = e.currentTarget.closest('.pipeline-column');
            if (column.classList.contains('won-column')) {
                showWonModal(opportunityId);
                return;
            }
            if (column.classList.contains('lost-column')) {
                showLostModal(opportunityId);
                return;
            }
            
            // Move to regular stage
            moveToStage(opportunityId, newStageId);
        }
        
        function moveToStage(opportunityId, newStageId) {
            fetch('@Url.Action("MoveToStage")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `opportunityId=${opportunityId}&newStageId=${newStageId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success(data.message);
                    refreshBoard();
                } else {
                    toastr.error(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('خطا در تغییر مرحله');
            });
        }
        
        // ========================================
        // ⭐⭐⭐ WON/LOST MODALS
        // ========================================
        
        function showWonModal(opportunityId) {
            document.getElementById('wonOpportunityId').value = opportunityId;
            document.getElementById('wonNote').value = '';
            new bootstrap.Modal(document.getElementById('wonModal')).show();
        }
        
        function showLostModal(opportunityId) {
            document.getElementById('lostOpportunityId').value = opportunityId;
            document.getElementById('lostReason').value = '';
            document.getElementById('winningCompetitor').value = '';
            new bootstrap.Modal(document.getElementById('lostModal')).show();
        }
        
        function confirmMarkAsWon() {
            const opportunityId = document.getElementById('wonOpportunityId').value;
            const note = document.getElementById('wonNote').value;
            
            fetch('@Url.Action("MarkAsWon")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${opportunityId}&note=${encodeURIComponent(note)}`
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('wonModal')).hide();
                if (data.success) {
                    toastr.success(data.message);
                    // Confetti effect
                    if (typeof confetti !== 'undefined') {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    }
                    refreshBoard();
                } else {
                    toastr.error(data.message);
                }
            });
        }
        
        function confirmMarkAsLost() {
            const opportunityId = document.getElementById('lostOpportunityId').value;
            const lostReason = document.getElementById('lostReason').value;
            const competitor = document.getElementById('winningCompetitor').value;
            
            if (!lostReason) {
                toastr.warning('لطفاً دلیل از دست رفتن را انتخاب کنید');
                return;
            }
            
            fetch('@Url.Action("MarkAsLost")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `id=${opportunityId}&lostReason=${encodeURIComponent(lostReason)}&competitor=${encodeURIComponent(competitor)}`
            })
            .then(response => response.json())
            .then(data => {
                bootstrap.Modal.getInstance(document.getElementById('lostModal')).hide();
                if (data.success) {
                    toastr.info(data.message);
                    refreshBoard();
                } else {
                    toastr.error(data.message);
                }
            });
        }
        
        // ========================================
        // ⭐⭐⭐ REFRESH & FILTERS
        // ========================================
        
        function refreshBoard() {
            const branchId = document.getElementById('branchFilter').value;
            const userId = document.getElementById('userFilter').value;
            
            window.location.href = `@Url.Action("Index")?branchId=${branchId}&userId=${userId}`;
        }
        
        document.getElementById('branchFilter').addEventListener('change', refreshBoard);
        document.getElementById('userFilter').addEventListener('change', refreshBoard);
        
        // ========================================
        // ⭐⭐⭐ DETAILS
        // ========================================
        
        function showOpportunityDetails(id) {
            window.location.href = '@Url.Action("Details")/' + id;
        }
    </script>
}

@functions {
    string GetActionIcon(MahERP.DataModelLayer.Enums.CrmNextActionType? type)
    {
        if (!type.HasValue) return "";
        
        return type.Value switch
        {
            MahERP.DataModelLayer.Enums.CrmNextActionType.Call => "📞",
            MahERP.DataModelLayer.Enums.CrmNextActionType.Meeting => "🤝",
            MahERP.DataModelLayer.Enums.CrmNextActionType.Email => "📧",
            MahERP.DataModelLayer.Enums.CrmNextActionType.Sms => "💬",
            MahERP.DataModelLayer.Enums.CrmNextActionType.SendQuote => "📋",
            MahERP.DataModelLayer.Enums.CrmNextActionType.FollowUpQuote => "🔄",
            MahERP.DataModelLayer.Enums.CrmNextActionType.Visit => "🏢",
            MahERP.DataModelLayer.Enums.CrmNextActionType.Demo => "💻",
            _ => "📝"
        };
    }
}
