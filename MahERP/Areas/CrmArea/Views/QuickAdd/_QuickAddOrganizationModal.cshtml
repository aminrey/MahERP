@model MahERP.DataModelLayer.ViewModels.CrmViewModels.QuickAddOrganizationViewModel
@{
    var branchName = ViewBag.BranchName as string;
}

<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
        <form id="quickAddOrganizationForm" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="BranchId" value="@Model.BranchId" id="organizationBranchId" />
            
            <div class="modal-header bg-success">
                <h5 class="modal-title text-white">
                    <i class="fa fa-building me-2"></i>
                    افزودن سریع سازمان
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <!-- اطلاعات شعبه -->
                <div class="alert alert-info d-flex align-items-center mb-3">
                    <i class="fa fa-building fa-2x me-3"></i>
                    <div>
                        <strong>شعبه:</strong> @branchName
                    </div>
                </div>

                <!-- نام سازمان -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        نام سازمان
                        <span class="text-danger">*</span>
                    </label>
                    <input asp-for="Name" 
                           class="form-control form-control-lg" 
                           placeholder="نام سازمان" 
                           required 
                           autofocus />
                    <span asp-validation-for="Name" class="text-danger small"></span>
                </div>

                <!-- نام برند -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        نام برند
                        <span class="text-muted small">(اختیاری)</span>
                    </label>
                    <input asp-for="Brand" 
                           class="form-control" 
                           placeholder="نام برند" />
                </div>

                <!-- نوع سازمان -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        نوع سازمان
                    </label>
                    <select asp-for="OrganizationType" class="form-select">
                        <option value="0">شرکت</option>
                        <option value="1">سازمان</option>
                        <option value="2">موسسه</option>
                        <option value="3">نهاد</option>
                    </select>
                </div>

                <!-- شماره تماس -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fa fa-phone me-1"></i>
                        شماره تماس
                        <span class="text-muted small">(اختیاری)</span>
                    </label>
                    <input asp-for="PhoneNumber" 
                           type="tel"
                           class="form-control" 
                           placeholder="02112345678" 
                           dir="ltr" />
                    <small class="form-text text-muted">
                        در صورت وارد کردن، به عنوان شماره پیش‌فرض ثبت می‌شود
                    </small>
                </div>

                <!-- ایمیل -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fa fa-envelope me-1"></i>
                        ایمیل
                        <span class="text-muted small">(اختیاری)</span>
                    </label>
                    <input asp-for="Email" 
                           type="email"
                           class="form-control" 
                           placeholder="info@example.com" 
                           dir="ltr" />
                    <span asp-validation-for="Email" class="text-danger small"></span>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-alt-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-success" id="btnSubmitOrganization">
                    <i class="fa fa-check me-1"></i>
                    ذخیره و انتخاب
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        // فقط اعداد برای شماره تماس
        $('#PhoneNumber').on('input', function() {
            let value = $(this).val().replace(/[^0-9]/g, '');
            $(this).val(value);
        });

        // Submit
        $('#btnSubmitOrganization').on('click', function() {
            submitQuickAddOrganization();
        });

        // Focus
        $('#Name').focus();
    });

    function submitQuickAddOrganization() {
        const $form = $('#quickAddOrganizationForm');
        const $btn = $('#btnSubmitOrganization');
        const originalText = $btn.html();
        
        // Validation
        if (!$form[0].checkValidity()) {
            $form[0].reportValidity();
            return;
        }
        
        // ⭐⭐⭐ اطمینان از وجود BranchId
        const branchId = $('#organizationBranchId').val();
        if (!branchId || branchId === '0') {
            alert('خطا: شناسه شعبه یافت نشد. لطفاً دوباره تلاش کنید.');
            return;
        }
        
        console.log('📤 Submitting organization with BranchId:', branchId);
        
        $btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> در حال ذخیره...');
        
        $.ajax({
            url: '@Url.Action("CreateOrganization", "QuickAdd", new { area = "CrmArea" })',
            type: 'POST',
            data: $form.serialize(),
            dataType: 'json',
            success: function(response) {
                if (response.status === 'success') {
                    // بستن modal
                    $('.modal').modal('hide');
                    
                    // نمایش پیام
                    SendResposeMessage([{ status: 'success', text: response.message }]);
                    
                    // Callback به صفحه اصلی
                    if (typeof window.onQuickAddComplete === 'function') {
                        window.onQuickAddComplete('organization', response);
                    }
                } else {
                    $btn.prop('disabled', false).html(originalText);
                    SendResposeMessage([{ status: 'error', text: response.message }]);
                }
            },
            error: function(xhr) {
                $btn.prop('disabled', false).html(originalText);
                NotificationHelper.error('خطا در ایجاد سازمان');
            }
        });
    }
</script>

<style>
    input[dir="ltr"] {
        text-align: left;
        font-family: 'Courier New', monospace;
    }

    .form-control-lg {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
    }
</style>
