@{
    ViewData["Title"] = "مدیریت مراحل";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-layer-group text-primary me-2"></i>
                مدیریت مراحل
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">CRM</li>
                    <li class="breadcrumb-item active">مراحل</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fa fa-check-circle me-2"></i>
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- مراحل قیف فروش (Lead Stages) -->
        <div class="col-lg-6">
            <div class="block block-rounded">
                <div class="block-header block-header-default bg-primary">
                    <h3 class="block-title text-white">
                        <i class="fa fa-funnel-dollar me-1"></i>
                        مراحل قیف فروش
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn btn-sm btn-alt-primary" onclick="openAddLeadStageModal()">
                            <i class="fa fa-plus me-1"></i>
                            افزودن
                        </button>
                    </div>
                </div>
                <div class="block-content">
                    <p class="text-muted small mb-3">
                        <i class="fa fa-info-circle me-1"></i>
                        مراحلی که یک سرنخ (Lead) در مسیر تبدیل به مشتری طی می‌کند
                    </p>
                    <div id="leadStagesList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted small">در حال بارگذاری...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- مراحل بعد از خرید (Post-Purchase Stages) -->
        <div class="col-lg-6">
            <div class="block block-rounded">
                <div class="block-header block-header-default bg-success">
                    <h3 class="block-title text-white">
                        <i class="fa fa-shopping-cart me-1"></i>
                        مراحل بعد از خرید
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn btn-sm btn-alt-success" onclick="openAddPostPurchaseModal()">
                            <i class="fa fa-plus me-1"></i>
                            افزودن
                        </button>
                    </div>
                </div>
                <div class="block-content">
                    <p class="text-muted small mb-3">
                        <i class="fa fa-info-circle me-1"></i>
                        مراحلی که مشتری بعد از خرید برای پشتیبانی و نگهداری طی می‌کند
                    </p>
                    <div id="postPurchaseStagesList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-success" role="status"></div>
                            <p class="mt-2 text-muted small">در حال بارگذاری...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- راهنما -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-lightbulb me-1"></i>
                راهنما
            </h3>
            <div class="block-options">
                <button type="button" class="btn-block-option" data-toggle="block-option" data-action="content_toggle"></button>
            </div>
        </div>
        <div class="block-content">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-semibold">مراحل قیف فروش</h6>
                    <p class="small mb-2">
                        این مراحل نشان می‌دهند که یک سرنخ (Lead) در چه مرحله‌ای از فرآیند خرید است:
                    </p>
                    <ul class="small text-muted">
                        <li><strong>آگاهی:</strong> سرنخ با محصول/خدمت شما آشنا شده</li>
                        <li><strong>علاقه‌مندی:</strong> سرنخ علاقه نشان داده و اطلاعات بیشتری می‌خواهد</li>
                        <li><strong>بررسی:</strong> سرنخ گزینه‌ها را مقایسه می‌کند</li>
                        <li><strong>مذاکره:</strong> در حال مذاکره قیمت و شرایط</li>
                        <li><strong>بسته شدن:</strong> آماده خرید یا رد شده</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-semibold">مراحل بعد از خرید</h6>
                    <p class="small mb-2">
                        این مراحل برای پیگیری مشتریان بعد از خرید استفاده می‌شود:
                    </p>
                    <ul class="small text-muted">
                        <li><strong>راه‌اندازی:</strong> محصول در حال نصب یا پیکربندی</li>
                        <li><strong>استفاده فعال:</strong> مشتری از محصول استفاده می‌کند</li>
                        <li><strong>پشتیبانی:</strong> نیاز به کمک یا آموزش دارد</li>
                        <li><strong>تمدید:</strong> زمان تمدید قرارداد نزدیک است</li>
                        <li><strong>ارتقا:</strong> فرصت فروش محصول بیشتر</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END Page Content -->

@section Scripts {
    <script>
        // ========== متغیرهای global برای tracking نوع عملیات ==========
        var currentModalType = null; // 'lead' یا 'postpurchase'

        $(document).ready(function() {
            loadLeadStages();
            loadPostPurchaseStages();

            // ⭐ Listen برای ajaxSuccess از main.js
            $(document).on('ajaxSuccess', '[data-save="modal-ajax-save"]', function(e, response) {
                console.log('✅ ajaxSuccess triggered, currentModalType:', currentModalType);
                
                if (response && response.status === 'success') {
                    // Refresh لیست مناسب
                    if (currentModalType === 'lead') {
                        loadLeadStages();
                    } else if (currentModalType === 'postpurchase') {
                        loadPostPurchaseStages();
                    } else {
                        // اگر نوع مشخص نبود، هر دو رو refresh کن
                        loadLeadStages();
                        loadPostPurchaseStages();
                    }
                }
            });
        });

        // ========== Load Functions ==========
        
        function loadLeadStages() {
            $.get('@Url.Action("GetLeadStages", "Stage", new { area = "CrmArea" })', function(data) {
                renderStagesList(data, '#leadStagesList', 'lead', 'primary');
            }).fail(function() {
                $('#leadStagesList').html('<div class="alert alert-danger">خطا در بارگذاری</div>');
            });
        }

        function loadPostPurchaseStages() {
            $.get('@Url.Action("GetPostPurchaseStages", "Stage", new { area = "CrmArea" })', function(data) {
                renderStagesList(data, '#postPurchaseStagesList', 'postpurchase', 'success');
            }).fail(function() {
                $('#postPurchaseStagesList').html('<div class="alert alert-danger">خطا در بارگذاری</div>');
            });
        }

        function renderStagesList(data, containerId, type, colorClass) {
            var html = '';
            if (data && data.length > 0) {
                html = '<div class="list-group list-group-flush">';
                data.forEach(function(item) {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <span class="badge rounded-pill me-3" style="background-color: ${item.color || '#6c757d'}; width: 24px; height: 24px;"></span>
                                <div>
                                    <strong>${item.title}</strong>
                                    ${item.stageTypeName ? '<span class="badge bg-secondary ms-2 small">' + item.stageTypeName + '</span>' : ''}
                                    ${item.description ? '<br><small class="text-muted">' + item.description + '</small>' : ''}
                                </div>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-alt-primary" onclick="openEdit${type === 'lead' ? 'Lead' : 'PostPurchase'}StageModal(${item.id})" title="ویرایش">
                                    <i class="fa fa-pencil-alt"></i>
                                </button>
                                <button class="btn btn-alt-danger" onclick="openDelete${type === 'lead' ? 'Lead' : 'PostPurchase'}StageModal(${item.id})" title="حذف">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            } else {
                html = `
                    <div class="text-center py-4">
                        <i class="fa fa-layer-group fa-3x text-muted mb-3"></i>
                        <p class="text-muted">هیچ مرحله‌ای تعریف نشده</p>
                    </div>
                `;
            }
            $(containerId).html(html);
        }

        // ========== Lead Stage Modals ==========
        
        function openAddLeadStageModal() {
            currentModalType = 'lead';
            createAndShowModal({
                url: '@Url.Action("AddLeadStageModal", "Stage", new { area = "CrmArea" })',
                onHidden: function() {
                    // بعد از بسته شدن مودال، لیست رو refresh کن
                    loadLeadStages();
                }
            });
        }

        function openEditLeadStageModal(id) {
            currentModalType = 'lead';
            createAndShowModal({
                url: '@Url.Action("EditLeadStageModal", "Stage", new { area = "CrmArea" })' + '?id=' + id,
                onHidden: function() {
                    loadLeadStages();
                }
            });
        }

        function openDeleteLeadStageModal(id) {
            currentModalType = 'lead';
            createAndShowModal({
                url: '@Url.Action("DeleteLeadStageModal", "Stage", new { area = "CrmArea" })' + '?id=' + id,
                onHidden: function() {
                    loadLeadStages();
                }
            });
        }

        // ========== Post-Purchase Stage Modals ==========
        
        function openAddPostPurchaseModal() {
            currentModalType = 'postpurchase';
            createAndShowModal({
                url: '@Url.Action("AddPostPurchaseStageModal", "Stage", new { area = "CrmArea" })',
                onHidden: function() {
                    loadPostPurchaseStages();
                }
            });
        }

        function openEditPostPurchaseStageModal(id) {
            currentModalType = 'postpurchase';
            createAndShowModal({
                url: '@Url.Action("EditPostPurchaseStageModal", "Stage", new { area = "CrmArea" })' + '?id=' + id,
                onHidden: function() {
                    loadPostPurchaseStages();
                }
            });
        }

        function openDeletePostPurchaseStageModal(id) {
            currentModalType = 'postpurchase';
            createAndShowModal({
                url: '@Url.Action("DeletePostPurchaseStageModal", "Stage", new { area = "CrmArea" })' + '?id=' + id,
                onHidden: function() {
                    loadPostPurchaseStages();
                }
            });
        }
    </script>
}
