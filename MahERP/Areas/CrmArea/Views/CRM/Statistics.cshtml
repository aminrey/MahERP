@{
    ViewData["Title"] = "آمار و گزارشات CRM";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">آمار و گزارشات CRM</h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-action="Index">تعاملات CRM</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">آمار و گزارشات</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <!-- Overall Statistics -->
    <div class="row">
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" href="@Url.Action("Index")">
                <div class="block-content py-4">
                    <div class="fs-1 fw-bold text-primary mb-1">@ViewBag.TotalCount</div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">کل تعاملات</p>
                </div>
            </a>
        </div>
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
                <div class="block-content py-4">
                    <div class="fs-1 fw-bold text-success mb-1">@ViewBag.TodayCount</div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">تعاملات امروز</p>
                </div>
            </a>
        </div>
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" href="javascript:void(0)">
                <div class="block-content py-4">
                    <div class="fs-1 fw-bold text-warning mb-1">@ViewBag.PendingFollowUps</div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">در انتظار پیگیری</p>
                </div>
            </a>
        </div>
        <div class="col-6 col-lg-3">
            <a class="block block-rounded block-link-shadow text-center" href="@Url.Action("MyInteractions")">
                <div class="block-content py-4">
                    <div class="fs-1 fw-bold text-info mb-1">
                        <i class="fa fa-user"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">تعاملات من</p>
                </div>
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Interactions by Type Chart -->
        <div class="col-xl-6">
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-chart-pie text-muted me-1"></i> تعاملات بر اساس نوع
                    </h3>
                </div>
                <div class="block-content text-center">
                    <canvas id="chart-interactions-by-type" style="height: 300px;"></canvas>
                </div>
                <div class="block-content">
                    <div class="row text-center">
                        @foreach (var typeData in ViewBag.InteractionsByType)
                        {
                            <div class="col-6 col-md-3 py-3">
                                <div class="fs-3 fw-bold text-primary mb-1">@typeData.Value</div>
                                <div class="fs-sm fw-semibold text-muted text-uppercase">@typeData.Key</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Interactions by Result Chart -->
        <div class="col-xl-6">
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-chart-bar text-muted me-1"></i> تعاملات بر اساس نتیجه
                    </h3>
                </div>
                <div class="block-content text-center">
                    <canvas id="chart-interactions-by-result" style="height: 300px;"></canvas>
                </div>
                <div class="block-content">
                    <div class="row text-center">
                        @foreach (var resultData in ViewBag.InteractionsByResult)
                        {
                            <div class="col-4 py-3">
                                <div class="fs-3 fw-bold @(resultData.Key == "موفق" ? "text-success" : resultData.Key == "نیاز به پیگیری" ? "text-warning" : "text-danger") mb-1">@resultData.Value</div>
                                <div class="fs-sm fw-semibold text-muted text-uppercase">@resultData.Key</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-sm-6 col-xl-3">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("Create")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold text-success mb-1">
                        <i class="fa fa-plus"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-success text-uppercase mb-0">
                        افزودن تعامل جدید
                    </p>
                </div>
            </a>
        </div>
        <div class="col-sm-6 col-xl-3">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("Index")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold text-primary mb-1">
                        <i class="fa fa-list"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-primary text-uppercase mb-0">
                        مشاهده همه تعاملات
                    </p>
                </div>
            </a>
        </div>
        <div class="col-sm-6 col-xl-3">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="javascript:void(0)" onclick="openAdvancedSearch()">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold text-info mb-1">
                        <i class="fa fa-search"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-info text-uppercase mb-0">
                        جستجوی پیشرفته
                    </p>
                </div>
            </a>
        </div>
        <div class="col-sm-6 col-xl-3">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("MyInteractions")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold text-dark mb-1">
                        <i class="fa fa-user"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-dark text-uppercase mb-0">
                        تعاملات من
                    </p>
                </div>
            </a>
        </div>
    </div>
</div>
<!-- END Page Content -->

<!-- Modal Container for dynamic content -->
<div class="modal fade" id="modal-crm" tabindex="-1" role="dialog" aria-labelledby="modal-crm" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <!-- Dynamic content will be loaded here -->
            <div class="modal-body">
                <div class="text-center">
                    <i class="fa fa-3x fa-spinner fa-spin text-primary my-3"></i>
                    <h3 class="mt-2 mb-3">در حال بارگذاری...</h3>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Chart.js -->
    <script src="/assets/js/plugins/chart.js/chart.min.js"></script>

    <script>
        // Function to open modal and load content
        function openModal(url) {
            $('#modal-crm .modal-content').html('<div class="modal-body text-center"><i class="fa fa-3x fa-spinner fa-spin text-primary my-3"></i><h3 class="mt-2 mb-3">در حال بارگذاری...</h3></div>');
            $('#modal-crm').modal('show');

            $.get(url, function(data) {
                $('#modal-crm .modal-content').html(data);
            });
        }

        function openAdvancedSearch() {
            openModal('@Url.Action("AdvancedSearch")');
        }

        $(document).ready(function() {
            // Interactions by Type Chart
            var ctxType = document.getElementById('chart-interactions-by-type').getContext('2d');
            var typeData = @Html.Raw(Json.Serialize(ViewBag.InteractionsByType));
            
            new Chart(ctxType, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeData),
                    datasets: [{
                        data: Object.values(typeData),
                        backgroundColor: [
                            '#3f51b5',
                            '#00bcd4',
                            '#ff9800',
                            '#9e9e9e',
                            '#4caf50'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Interactions by Result Chart
            var ctxResult = document.getElementById('chart-interactions-by-result').getContext('2d');
            var resultData = @Html.Raw(Json.Serialize(ViewBag.InteractionsByResult));
            
            new Chart(ctxResult, {
                type: 'bar',
                data: {
                    labels: Object.keys(resultData),
                    datasets: [{
                        data: Object.values(resultData),
                        backgroundColor: ['#f44336', '#4caf50', '#ff9800']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
}