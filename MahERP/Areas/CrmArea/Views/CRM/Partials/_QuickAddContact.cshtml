@model MahERP.DataModelLayer.ViewModels.ContactViewModels.QuickAddContactViewModel

<!-- ⭐⭐⭐ ساختار استاندارد Modal -->
<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <form id="quickAddContactForm" asp-action="QuickAddContact" asp-controller="CRM" method="post">
            @Html.AntiForgeryToken()

            <div class="modal-header bg-primary">
                <h4 class="modal-title text-white mb-0">
                    <i class="fa fa-user-plus me-2"></i>
                    افزودن سریع فرد جدید
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-1"></i>
                    <strong>راهنما:</strong> فقط نام خانوادگی الزامی است. شماره تماس و سایر اطلاعات را می‌توانید بعداً تکمیل کنید.
                </div>

                <!-- انتخاب سازمان (اختیاری) -->
                <div class="row g-3 mb-3">
                    <div class="col-12">
                        <div class="border rounded p-3 bg-light">
                            <label class="form-label fw-semibold" for="quickContactOrganization">
                                <i class="fa fa-building text-info me-1"></i>
                                سازمان (اختیاری)
                            </label>
                            <select asp-for="OrganizationId" 
                                    class="form-select" 
                                    id="quickContactOrganization">
                                <option value="">-- بدون سازمان --</option>
                            </select>
                            <small class="form-text text-muted mt-2">
                                <i class="fa fa-info-circle me-1"></i>
                                اگر سازمان را انتخاب کنید، این فرد به عنوان عضو سازمان ثبت می‌شود
                            </small>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات فرد -->
                <div class="row g-3">
                    <!-- نام -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickContactFirstName">
                            <i class="fa fa-user text-primary me-1"></i>
                            نام
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="quickContactFirstName" 
                               asp-for="FirstName"
                               placeholder="نام فرد">
                    </div>

                    <!-- نام خانوادگی -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickContactLastName">
                            <i class="fa fa-user text-danger me-1"></i>
                            نام خانوادگی <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="quickContactLastName" 
                               asp-for="LastName"
                               placeholder="نام خانوادگی فرد"
                               required>
                        <span class="invalid-feedback">نام خانوادگی الزامی است</span>
                    </div>

                    <!-- کد ملی -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickContactNationalCode">
                            <i class="fa fa-id-card text-info me-1"></i>
                            کد ملی
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="quickContactNationalCode" 
                               asp-for="NationalCode"
                               placeholder="کد ملی 10 رقمی"
                               maxlength="10"
                               pattern="[0-9]{10}"
                               dir="ltr">
                        <span class="invalid-feedback">کد ملی باید 10 رقم باشد</span>
                    </div>

                    <!-- ایمیل -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickContactEmail">
                            <i class="fa fa-envelope text-warning me-1"></i>
                            ایمیل
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="quickContactEmail" 
                               asp-for="PrimaryEmail"
                               placeholder="email@example.com"
                               dir="ltr">
                        <span class="invalid-feedback">فرمت ایمیل نامعتبر است</span>
                    </div>
                </div>

                <!-- شماره‌های تماس -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label fw-semibold mb-0">
                            <i class="fa fa-phone text-success me-1"></i>
                            شماره‌های تماس
                            <span class="text-muted small">(اختیاری)</span>
                        </label>
                        <button type="button" 
                                class="btn btn-sm btn-success" 
                                onclick="addQuickContactPhoneRow()">
                            <i class="fa fa-plus me-1"></i>
                            افزودن شماره
                        </button>
                    </div>

                    <div id="quickContactPhonesContainer">
                        <!-- شماره اول (اختیاری) -->
                        <div class="phone-row mb-3 p-3 border rounded" data-index="0" id="quickContactPhone-0">
                            <div class="row align-items-center">
                                <div class="col-md-5">
                                    <label class="form-label small">شماره تماس</label>
                                    <input name="Phones[0].PhoneNumber"
                                           type="tel"
                                           class="form-control"
                                           placeholder="09123456789"
                                           dir="ltr" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">نوع</label>
                                    <select name="Phones[0].PhoneType" class="form-select">
                                        <option value="0" selected>موبایل</option>
                                        <option value="1">ثابت</option>
                                        <option value="2">کاری</option>
                                        <option value="3">منزل</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small d-block">تنظیمات</label>
                                    <div class="form-check form-check-inline">
                                        <input type="hidden" name="Phones[0].IsDefault" value="false" />
                                        <input type="checkbox"
                                               name="Phones[0].IsDefault"
                                               value="true"
                                               class="form-check-input default-check"
                                               checked />
                                        <label class="form-check-label small">پیش‌فرض</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="hidden" name="Phones[0].IsSmsDefault" value="false" />
                                        <input type="checkbox"
                                               name="Phones[0].IsSmsDefault"
                                               value="true"
                                               class="form-check-input sms-check"
                                               checked />
                                        <label class="form-check-label small">SMS</label>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeQuickContactPhoneRow(0)">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info d-flex align-items-center mt-2">
                        <i class="fa fa-info-circle fa-2x me-3"></i>
                        <div>
                            <small>
                                <strong>نکته:</strong>
                                شماره تماس اختیاری است. می‌توانید چندین شماره اضافه کنید یا بعداً تکمیل کنید.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- شعبه (hidden) -->
                <input type="hidden" asp-for="BranchId" id="quickContactBranchId" />
                <input type="hidden" asp-for="OrganizationRelationType" value="3" />
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-primary" data-save="modal-ajax-save">
                    <i class="fa fa-save me-1"></i>
                    ذخیره و انتخاب
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let quickContactPhoneIndex = 1;

    $(document).ready(function() {
        // ⭐⭐⭐ دریافت و تنظیم BranchId از فرم اصلی
        var branchId = $('#branchSelect').val() || $('input[name="BranchId"]').val();
        
        if (!branchId) {
            console.error('❌ BranchId not found!');
            Dashmix.helpers('jq-notify', {
                type: 'danger',
                icon: 'fa fa-times me-1',
                message: 'خطا: شعبه انتخاب نشده است'
            });
            return;
        }
        
        $('#quickContactBranchId').val(branchId);
        console.log('✅ Quick Add Contact Modal loaded, BranchId:', branchId);

        // ⭐⭐⭐ بارگذاری فوری سازمان‌های شعبه
        loadBranchOrganizationsImmediate(branchId);

        // ⭐ مدیریت checkbox های IsDefault
        $(document).on('change', '.default-check', function() {
            if ($(this).is(':checked')) {
                $('.default-check').not(this).prop('checked', false);
            }
        });

        // ⭐ مدیریت checkbox های IsSmsDefault
        $(document).on('change', '.sms-check', function() {
            if ($(this).is(':checked')) {
                $('.sms-check').not(this).prop('checked', false);
            }
        });
    });

    // ⭐⭐⭐ بارگذاری فوری لیست سازمان‌های شعبه (با Loading State)
    function loadBranchOrganizationsImmediate(branchId) {
        if (!branchId) {
            console.warn('⚠️ No BranchId provided for loading organizations');
            return;
        }

        const $select = $('#quickContactOrganization');
        
        // نمایش حالت بارگذاری
        $select.html('<option value="">در حال بارگذاری...</option>');
        $select.prop('disabled', true);

        $.ajax({
            url: '@Url.Action("GetBranchOrganizations", "CRM")',
            type: 'GET',
            data: { branchId: branchId },
            success: function(organizations) {
                $select.empty();
                $select.append('<option value="">-- بدون سازمان --</option>');
                
                if (organizations && organizations.length > 0) {
                    organizations.forEach(org => {
                        $select.append(`<option value="${org.id}">${org.name}${org.brand ? ' (' + org.brand + ')' : ''}</option>`);
                    });
                    console.log(`✅ Loaded ${organizations.length} organizations for branch ${branchId}`);
                } else {
                    console.log('ℹ️ No organizations found for this branch');
                }
                
                $select.prop('disabled', false);
            },
            error: function(xhr) {
                console.error('❌ Error loading organizations:', xhr);
                $select.html('<option value="">خطا در بارگذاری</option>');
                $select.prop('disabled', false);
                
                if (typeof Dashmix !== 'undefined') {
                    Dashmix.helpers('jq-notify', {
                        type: 'warning',
                        icon: 'fa fa-exclamation-triangle me-1',
                        message: 'خطا در بارگذاری لیست سازمان‌ها'
                    });
                }
            }
        });
    }

    // ⭐ افزودن شماره جدید
    function addQuickContactPhoneRow() {
        const container = document.getElementById('quickContactPhonesContainer');
        const html = `
            <div class="phone-row mb-3 p-3 border rounded bg-light" data-index="${quickContactPhoneIndex}" id="quickContactPhone-${quickContactPhoneIndex}">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <label class="form-label small">شماره تماس</label>
                        <input name="Phones[${quickContactPhoneIndex}].PhoneNumber"
                               type="tel"
                               class="form-control"
                               placeholder="09123456789"
                               dir="ltr" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">نوع</label>
                        <select name="Phones[${quickContactPhoneIndex}].PhoneType" class="form-select">
                            <option value="0">موبایل</option>
                            <option value="1">ثابت</option>
                            <option value="2">کاری</option>
                            <option value="3">منزل</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small d-block">تنظیمات</label>
                        <div class="form-check form-check-inline">
                            <input type="hidden" name="Phones[${quickContactPhoneIndex}].IsDefault" value="false" />
                            <input type="checkbox"
                                   name="Phones[${quickContactPhoneIndex}].IsDefault"
                                   value="true"
                                   class="form-check-input default-check" />
                            <label class="form-check-label small">پیش‌فرض</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="hidden" name="Phones[${quickContactPhoneIndex}].IsSmsDefault" value="false" />
                            <input type="checkbox"
                                   name="Phones[${quickContactPhoneIndex}].IsSmsDefault"
                                   value="true"
                                   class="form-check-input sms-check" />
                            <label class="form-check-label small">SMS</label>
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuickContactPhoneRow(${quickContactPhoneIndex})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        quickContactPhoneIndex++;

        $(`#quickContactPhone-${quickContactPhoneIndex - 1}`).hide().fadeIn(300);
    }

    // ⭐ حذف شماره
    function removeQuickContactPhoneRow(index) {
        $(`#quickContactPhone-${index}`).fadeOut(300, function() {
            $(this).remove();
        });
    }
</script>
