@model MahERP.DataModelLayer.ViewModels.OrganizationViewModels.QuickAddOrganizationViewModel

<!-- ⭐⭐⭐ ساختار استاندارد Modal -->
<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
        <form id="quickAddOrganizationForm" asp-action="QuickAddOrganization" asp-controller="CRM" method="post">
            @Html.AntiForgeryToken()

            <div class="modal-header bg-info">
                <h4 class="modal-title text-white mb-0">
                    <i class="fa fa-building me-2"></i>
                    افزودن سریع سازمان جدید
                </h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fa fa-info-circle me-1"></i>
                    <strong>راهنما:</strong> فقط نام سازمان الزامی است. شماره تماس و سایر اطلاعات را می‌توانید بعداً تکمیل کنید.
                </div>

                <div class="row g-3">
                    <!-- نام سازمان -->
                    <div class="col-12">
                        <label class="form-label fw-semibold" for="quickOrgName">
                            <i class="fa fa-building text-danger me-1"></i>
                            نام سازمان <span class="text-danger">*</span>
                        </label>
                        <input type="text" 
                               class="form-control form-control-lg" 
                               id="quickOrgName" 
                               asp-for="Name"
                               placeholder="نام رسمی سازمان"
                               required>
                        <span class="invalid-feedback">نام سازمان الزامی است</span>
                    </div>

                    <!-- نام برند -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickOrgBrand">
                            <i class="fa fa-tag text-primary me-1"></i>
                            نام برند
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="quickOrgBrand" 
                               asp-for="Brand"
                               placeholder="نام تجاری">
                    </div>

                    <!-- نوع سازمان -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickOrgType">
                            <i class="fa fa-briefcase text-warning me-1"></i>
                            نوع سازمان
                        </label>
                        <select asp-for="OrganizationType" 
                                id="quickOrgType"
                                class="form-select">
                            <option value="0" selected>شرکت</option>
                            <option value="1">سازمان</option>
                            <option value="2">موسسه</option>
                            <option value="3">نهاد</option>
                        </select>
                    </div>

                    <!-- شماره ثبت -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickOrgRegistrationNumber">
                            <i class="fa fa-hashtag text-info me-1"></i>
                            شماره ثبت
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="quickOrgRegistrationNumber" 
                               asp-for="RegistrationNumber"
                               placeholder="شماره ثبت 11 رقمی"
                               maxlength="11"
                               pattern="[0-9]{11}"
                               dir="ltr">
                        <span class="invalid-feedback">شماره ثبت باید 11 رقم باشد</span>
                    </div>

                    <!-- ایمیل -->
                    <div class="col-md-6">
                        <label class="form-label" for="quickOrgEmail">
                            <i class="fa fa-envelope text-warning me-1"></i>
                            ایمیل
                        </label>
                        <input type="email" 
                               class="form-control" 
                               id="quickOrgEmail" 
                               asp-for="Email"
                               placeholder="info@company.com"
                               dir="ltr">
                        <span class="invalid-feedback">فرمت ایمیل نامعتبر است</span>
                    </div>
                </div>

                <!-- شماره‌های تماس -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <label class="form-label fw-semibold mb-0">
                            <i class="fa fa-phone text-success me-1"></i>
                            شماره‌های تماس
                            <span class="text-muted small">(اختیاری)</span>
                        </label>
                        <button type="button" 
                                class="btn btn-sm btn-success" 
                                onclick="addQuickOrgPhoneRow()">
                            <i class="fa fa-plus me-1"></i>
                            افزودن شماره
                        </button>
                    </div>

                    <div id="quickOrgPhonesContainer">
                        <!-- شماره اول (اختیاری) -->
                        <div class="phone-row mb-3 p-3 border rounded" data-index="0" id="quickOrgPhone-0">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label small">شماره تماس</label>
                                    <input name="Phones[0].PhoneNumber"
                                           type="tel"
                                           class="form-control"
                                           placeholder="02112345678"
                                           dir="ltr" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">نوع</label>
                                    <select name="Phones[0].PhoneType" class="form-select">
                                        <option value="0">موبایل</option>
                                        <option value="1" selected>ثابت</option>
                                        <option value="2">کاری</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">داخلی</label>
                                    <input name="Phones[0].Extension"
                                           type="text"
                                           class="form-control"
                                           placeholder="123"
                                           maxlength="10" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small d-block">پیش‌فرض</label>
                                    <div class="form-check">
                                        <input type="hidden" name="Phones[0].IsDefault" value="false" />
                                        <input type="checkbox"
                                               name="Phones[0].IsDefault"
                                               value="true"
                                               class="form-check-input org-default-check"
                                               checked />
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="removeQuickOrgPhoneRow(0)">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info d-flex align-items-center mt-2">
                        <i class="fa fa-info-circle fa-2x me-3"></i>
                        <div>
                            <small>
                                <strong>نکته:</strong>
                                شماره تماس اختیاری است. می‌توانید چندین شماره اضافه کنید یا بعداً تکمیل کنید.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- شعبه (hidden) -->
                <input type="hidden" asp-for="BranchId" id="quickOrgBranchId" />
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i>
                    انصراف
                </button>
                <button type="button" class="btn btn-info" data-save="modal-ajax-save">
                    <i class="fa fa-save me-1"></i>
                    ذخیره و انتخاب
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let quickOrgPhoneIndex = 1;

    $(document).ready(function() {
        // ⭐⭐⭐ دریافت و تنظیم BranchId از فرم اصلی
        var branchId = $('#branchSelect').val() || $('input[name="BranchId"]').val();
        
        if (!branchId) {
            console.error('❌ BranchId not found!');
            Dashmix.helpers('jq-notify', {
                type: 'danger',
                icon: 'fa fa-times me-1',
                message: 'خطا: شعبه انتخاب نشده است'
            });
            return;
        }
        
        $('#quickOrgBranchId').val(branchId);
        console.log('✅ Quick Add Organization Modal loaded, BranchId:', branchId);

        // ⭐ مدیریت checkbox های IsDefault
        $(document).on('change', '.org-default-check', function() {
            if ($(this).is(':checked')) {
                $('.org-default-check').not(this).prop('checked', false);
            }
        });

        // ⭐ فقط اعداد برای شماره ثبت
        $('#quickOrgRegistrationNumber').on('input', function() {
            let value = $(this).val().replace(/\D/g, '');
            $(this).val(value);
        });
    });

    // ⭐ افزودن شماره جدید
    function addQuickOrgPhoneRow() {
        const container = document.getElementById('quickOrgPhonesContainer');
        const html = `
            <div class="phone-row mb-3 p-3 border rounded bg-light" data-index="${quickOrgPhoneIndex}" id="quickOrgPhone-${quickOrgPhoneIndex}">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label small">شماره تماس</label>
                        <input name="Phones[${quickOrgPhoneIndex}].PhoneNumber"
                               type="tel"
                               class="form-control"
                               placeholder="02112345678"
                               dir="ltr" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">نوع</label>
                        <select name="Phones[${quickOrgPhoneIndex}].PhoneType" class="form-select">
                            <option value="0">موبایل</option>
                            <option value="1" selected>ثابت</option>
                            <option value="2">کاری</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">داخلی</label>
                        <input name="Phones[${quickOrgPhoneIndex}].Extension"
                               type="text"
                               class="form-control"
                               placeholder="123"
                               maxlength="10" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small d-block">پیش‌فرض</label>
                        <div class="form-check">
                            <input type="hidden" name="Phones[${quickOrgPhoneIndex}].IsDefault" value="false" />
                            <input type="checkbox"
                                   name="Phones[${quickOrgPhoneIndex}].IsDefault"
                                   value="true"
                                   class="form-check-input org-default-check" />
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeQuickOrgPhoneRow(${quickOrgPhoneIndex})">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
        quickOrgPhoneIndex++;

        $(`#quickOrgPhone-${quickOrgPhoneIndex - 1}`).hide().fadeIn(300);
    }

    // ⭐ حذف شماره
    function removeQuickOrgPhoneRow(index) {
        $(`#quickOrgPhone-${index}`).fadeOut(300, function() {
            $(this).remove();
        });
    }
</script>
