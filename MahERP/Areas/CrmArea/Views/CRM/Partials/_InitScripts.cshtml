<script>
    // ⭐⭐⭐ تابع کمکی برای تغییر Tab
    function goToTab(tabId) {
        const tabTrigger = new bootstrap.Tab(document.getElementById(tabId + '-tab'));
        tabTrigger.show();
        
        // اسکرول به بالای صفحه
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ⭐⭐⭐ مقداردهی اولیه Select2 هنگام بارگذاری صفحه
    $(document).ready(function() {
        console.log('🚀 CRM Interaction Form Initialized');

        // ⭐ اعمال Select2 به تمام dropdown ها
        if (typeof $.fn.select2 !== 'undefined') {
            initializeSelect2Fields();
        } else {
            console.error('❌ Select2 library not loaded!');
        }

        // ⭐ مدیریت انتخاب شعبه
        initializeBranchSelection();

        // ⭐ مدیریت انتخاب Contact
        initializeContactSelection();

        // ⭐ مدیریت انتخاب Organization
        initializeOrganizationSelection();

        // ⭐ مدیریت Upload فایل
        initializeFileUpload();

        // ⭐ Validation
        initializeFormValidation();
    });

    // ⭐⭐⭐ راه‌اندازی Select2 برای تمام فیلدها
    function initializeSelect2Fields() {
        // Select2 عمومی
        $('.form-select').not('.select2-contact, .select2-organization').select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'انتخاب کنید...',
            allowClear: true
        });

        // Select2 برای Contact با قالب سفارشی
        $('.select2-contact').select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'نام یا کد ملی را تایپ کنید...',
            allowClear: true,
            templateResult: formatContactOption,
            templateSelection: formatContactSelection
        });

        // Select2 برای Organization با قالب سفارشی
        $('.select2-organization').select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'نام سازمان را تایپ کنید...',
            allowClear: true,
            templateResult: formatOrganizationOption,
            templateSelection: formatOrganizationSelection
        });

        console.log('✅ Select2 initialized');
    }

    // ⭐⭐⭐ قالب نمایش Contact در Dropdown
    function formatContactOption(contact) {
        if (!contact.id || !contact.element) return contact.text;

        const $option = $(contact.element);
        const firstName = $option.data('firstname') || '';
        const lastName = $option.data('lastname') || '';
        const nationalCode = $option.data('nationalcode') || '-';
        const phone = $option.data('phone') || '-';

        const initials = `${firstName?.[0] || ''}${lastName?.[0] || ''}`.toUpperCase();

        return $(`
            <div class="stakeholder-option">
                <div class="stakeholder-avatar">${initials}</div>
                <div class="stakeholder-info">
                    <div class="stakeholder-name">${lastName} ${firstName}</div>
                    <div class="stakeholder-details">
                        <span class="stakeholder-badge"><i class="fa fa-id-card"></i> ${nationalCode}</span>
                        <span class="stakeholder-badge"><i class="fa fa-phone"></i> ${phone}</span>
                    </div>
                </div>
            </div>
        `);
    }

    function formatContactSelection(contact) {
        return contact.text;
    }

    // ⭐⭐⭐ قالب نمایش Organization در Dropdown
    function formatOrganizationOption(org) {
        if (!org.id || !org.element) return org.text;

        const $option = $(org.element);
        const name = $option.data('name') || '';
        const registration = $option.data('registration') || '-';
        const phone = $option.data('phone') || '-';

        const initials = name.substring(0, 2).toUpperCase();

        return $(`
            <div class="stakeholder-option">
                <div class="stakeholder-avatar">${initials}</div>
                <div class="stakeholder-info">
                    <div class="stakeholder-name">${name}</div>
                    <div class="stakeholder-details">
                        <span class="stakeholder-badge"><i class="fa fa-certificate"></i> ${registration}</span>
                        <span class="stakeholder-badge"><i class="fa fa-phone"></i> ${phone}</span>
                    </div>
                </div>
            </div>
        `);
    }

    function formatOrganizationSelection(org) {
        return org.text;
    }

    // ⭐⭐⭐ Validation
    function initializeFormValidation() {
        $('#createCRMForm').on('submit', function(e) {
            const branchId = $('#branchSelect').val() || $('input[name="BranchId"]').val();
            const title = $('input[name="Title"]').val();

            if (!branchId) {
                e.preventDefault();
                Dashmix.helpers('notify', {
                    type: 'danger',
                    icon: 'fa fa-times',
                    message: 'لطفاً شعبه را انتخاب کنید'
                });
                goToTab('main-info');
                return false;
            }

            if (!title || title.trim() === '') {
                e.preventDefault();
                Dashmix.helpers('notify', {
                    type: 'danger',
                    icon: 'fa fa-times',
                    message: 'لطفاً عنوان تعامل را وارد کنید'
                });
                goToTab('main-info');
                return false;
            }

            // نمایش Loading
            $('#submitBtn, #submitBtnBottom').prop('disabled', true).html('<i class="fa fa-spinner fa-spin me-1"></i> در حال ثبت...');
        });
    }

    console.log('✅ Init Scripts Loaded');
</script>
