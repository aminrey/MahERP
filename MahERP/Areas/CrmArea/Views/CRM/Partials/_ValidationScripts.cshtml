<partial name="_ValidationScriptsPartial" />

<script>
    // ⭐⭐⭐ مدیریت File Upload
    function initializeFileUpload() {
        $('#fileUpload').on('change', function() {
            const files = this.files;
            
            if (files.length === 0) {
                $('#filePreviewSection').hide();
                return;
            }

            renderFilePreview(files);
        });
    }

    // ⭐⭐⭐ نمایش پیش‌نمایش فایل‌ها
    function renderFilePreview(files) {
        const $list = $('#filePreviewList');
        $list.empty();

        $('#fileCount').text(files.length);

        Array.from(files).forEach((file, index) => {
            const fileSize = formatFileSize(file.size);
            const fileIcon = getFileIcon(file.name);

            const row = `
                <tr>
                    <td class="text-center fw-bold">${index + 1}</td>
                    <td>
                        <i class="${fileIcon} me-2"></i>
                        <strong>${file.name}</strong>
                    </td>
                    <td><span class="badge bg-info">${fileSize}</span></td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFile(${index})">
                            <i class="fa fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
            $list.append(row);
        });

        $('#filePreviewSection').slideDown();
    }

    // ⭐ فرمت کردن حجم فایل
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // ⭐ آیکون مناسب برای فایل
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'fa fa-file-pdf text-danger',
            'doc': 'fa fa-file-word text-primary',
            'docx': 'fa fa-file-word text-primary',
            'xls': 'fa fa-file-excel text-success',
            'xlsx': 'fa fa-file-excel text-success',
            'jpg': 'fa fa-file-image text-info',
            'jpeg': 'fa fa-file-image text-info',
            'png': 'fa fa-file-image text-info',
            'gif': 'fa fa-file-image text-info'
        };
        return icons[ext] || 'fa fa-file text-secondary';
    }

    // ⭐ حذف فایل از لیست
    function removeFile(index) {
        const input = document.getElementById('fileUpload');
        const dt = new DataTransfer();
        const files = input.files;

        for (let i = 0; i < files.length; i++) {
            if (i !== index) {
                dt.items.add(files[i]);
            }
        }

        input.files = dt.files;

        if (input.files.length === 0) {
            $('#filePreviewSection').hide();
        } else {
            renderFilePreview(input.files);
        }

        Dashmix.helpers('notify', {
            type: 'info',
            icon: 'fa fa-trash',
            message: 'فایل حذف شد'
        });
    }

    console.log('✅ Validation Scripts Loaded');
</script>
