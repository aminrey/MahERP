<script>
$(document).ready(function() {
    console.log('✅ CRM Contact/Organization Scripts Loading...');

    // ========== مدیریت تغییر شعبه ==========
    $('#branchSelect').on('change', function() {
        const branchId = $(this).val();

        if (!branchId) {
            $('#organizationSelect, #contactSelect, #contactSelectForOrg')
                .prop('disabled', true)
                .empty()
                .append('<option value="">ابتدا شعبه را انتخاب کنید</option>');
            $('#organizationContactsSection, #contactOrganizationsSection').hide();
            return;
        }

        console.log('🔄 Branch changed:', branchId);

        // نمایش loading
        $('#OrganizationSelectionDiv').html('<div class="text-center py-2"><i class="fa fa-spinner fa-spin"></i> در حال بارگذاری...</div>');
        $('#ContactSelectionDiv').html('<div class="text-center py-2"><i class="fa fa-spinner fa-spin"></i> در حال بارگذاری...</div>');

        $.ajax({
            url: '@Url.Action("BranchTriggerSelect", "CRM")',
            type: 'POST',
            data: {
                branchId: branchId,
                __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
            },
            success: function(response) {
                console.log('✅ Branch data loaded:', response);

                if (response.status === 'update-view' && response.viewList) {
                    // بروزرسانی Contact dropdown
                    const contactView = response.viewList.find(v => v.elementId === 'ContactSelectionDiv');
                    if (contactView && contactView.view && contactView.view.result) {
                        $('#ContactSelectionDiv').html(contactView.view.result);
                        initializeContactSelect2();
                    }

                    // بروزرسانی Organization dropdown
                    const orgView = response.viewList.find(v => v.elementId === 'OrganizationSelectionDiv');
                    if (orgView && orgView.view && orgView.view.result) {
                        $('#OrganizationSelectionDiv').html(orgView.view.result);
                        initializeOrganizationSelect2();
                    }

                    // پاک کردن بخش‌های نمایش
                    $('#organizationContactsSection').hide().find('#organizationContactsList').empty();
                    $('#contactOrganizationsSection').hide().find('#contactOrganizationsList').empty();

                    if (typeof Dashmix !== 'undefined') {
                        Dashmix.helpers('jq-notify', {
                            type: 'success',
                            icon: 'fa fa-check me-1',
                            message: 'لیست افراد و سازمان‌ها بروز شد'
                        });
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ Error loading branch data:', { status, error });
                $('#ContactSelectionDiv').html('<select class="form-select" disabled><option>خطا در بارگذاری</option></select>');
                $('#OrganizationSelectionDiv').html('<select class="form-select" disabled><option>خطا در بارگذاری</option></select>');

                if (typeof Dashmix !== 'undefined') {
                    Dashmix.helpers('jq-notify', {
                        type: 'danger',
                        icon: 'fa fa-times me-1',
                        message: 'خطا در بارگذاری اطلاعات'
                    });
                }
            }
        });
    });

    // ========== مدیریت تغییر Organization ==========
    $(document).on('change', '#organizationSelect', function() {
        const organizationId = $(this).val();

        console.log('🔍 Organization Select Changed:', organizationId);

        if (!organizationId || organizationId === '' || organizationId === '0') {
            console.log('⚠️ No organization selected, hiding members');
            $('#organizationContactsSection').slideUp();
            
            // پاک کردن dropdown افراد در panel سازمان
            $('#contactSelectForOrg')
                .empty()
                .append('<option value="">-- ابتدا سازمان را انتخاب کنید --</option>')
                .prop('disabled', true);
            
            return;
        }

        console.log(`🔄 Organization changed: ${organizationId}, loading members...`);
        loadOrganizationMembers(organizationId);
    });

    // ========== بارگذاری اعضای سازمان ==========
    function loadOrganizationMembers(organizationId) {
        console.log('📡 [CRM] Loading organization members for:', organizationId);

        // نمایش Loading
        $('#organizationContactsList').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <p class="mt-2 text-muted">در حال دریافت اعضای سازمان...</p>
            </div>
        `);
        $('#organizationContactsSection').slideDown();

        $.ajax({
            url: '@Url.Action("GetOrganizationMembers", "CRM")',
            type: 'GET',
            data: { organizationId: organizationId },
            beforeSend: function() {
                console.log('🚀 [CRM] Sending request to GetOrganizationMembers');
            },
            success: function(response) {
                console.log('✅ [CRM] Response received:', response);

                if (response.status === 'update-view' && response.viewList && response.viewList.length > 0) {
                    var viewData = response.viewList[0];
                    $('#organizationContactsList').html(viewData.view.result);

                    // ⭐⭐⭐ به‌روزرسانی Badge تعداد
                    if (response.membersCount !== undefined) {
                        $('#membersCount').text(response.membersCount);
                    }

                    console.log(`✅ [CRM] Organization members loaded: ${response.membersCount} members`);

                    // ⭐⭐⭐ به‌روزرسانی dropdown افراد با اعضای سازمان
                    if (response.members && Array.isArray(response.members) && response.members.length > 0) {
                        console.log('🔄 [CRM] Updating contact dropdown with members');
                        updateContactDropdownWithMembers(response.members);
                    } else {
                        console.warn('⚠️ [CRM] No members array in response');
                        
                        // غیرفعال کردن dropdown اگر هیچ عضوی نیست
                        $('#contactSelectForOrg')
                            .empty()
                            .append('<option value="">-- هیچ عضوی در این سازمان نیست --</option>')
                            .prop('disabled', true);
                    }

                    // نمایش نوتیفیکیشن
                    if (response.membersCount > 0 && typeof Dashmix !== 'undefined') {
                        Dashmix.helpers('jq-notify', {
                            type: 'info',
                            icon: 'fa fa-users me-1',
                            message: `${response.membersCount} عضو در این سازمان یافت شد`
                        });
                    }
                } else if (response.status === 'error') {
                    console.error('❌ [CRM] Server error:', response.message);
                    $('#organizationContactsList').html(`
                        <div class="alert alert-danger">
                            <i class="fa fa-exclamation-triangle me-2"></i>
                            ${response.message || 'خطا در دریافت اعضا'}
                        </div>
                    `);
                } else {
                    console.error('❌ [CRM] Invalid response format:', response);
                }
            },
            error: function(xhr, status, error) {
                console.error('❌ [CRM] AJAX Error:', { status, error, statusCode: xhr.status });

                $('#organizationContactsList').html(`
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        <strong>خطا در دریافت اعضای سازمان</strong>
                        <p class="mb-0 mt-2 small">Status: ${xhr.status} - ${error}</p>
                    </div>
                `);
            }
        });
    }

    // ========== به‌روزرسانی dropdown افراد با اعضای سازمان ==========
    function updateContactDropdownWithMembers(members) {
        console.log('🔄 Updating contact dropdown with', members.length, 'members');

        var $contactSelectForOrg = $('#contactSelectForOrg');

        if ($contactSelectForOrg.length === 0) {
            console.error('❌ contactSelectForOrg not found!');
            return;
        }

        // Destroy Select2 if exists
        if ($contactSelectForOrg.hasClass('select2-hidden-accessible')) {
            $contactSelectForOrg.select2('destroy');
        }

        // پاک کردن و افزودن option پیش‌فرض
        $contactSelectForOrg.empty().append('<option value="">-- انتخاب فرد از اعضای سازمان --</option>');

        // اضافه کردن اعضا
        var addedCount = 0;
        members.forEach(function(member) {
            var optionText = member.contactFullName || 'نام نامشخص';

            if (member.positionTitle) {
                optionText += ` (${member.positionTitle})`;
            }
            if (member.departmentName) {
                optionText += ` - ${member.departmentName}`;
            }

            var $option = $('<option></option>')
                .val(member.contactId)
                .text(optionText)
                .attr('data-position', member.positionTitle || '')
                .attr('data-department', member.departmentName || '')
                .attr('data-phone', member.contactPhone || '');

            $contactSelectForOrg.append($option);
            addedCount++;
        });

        console.log(`  → Added ${addedCount} member options`);

        // فعال کردن و راه‌اندازی مجدد Select2
        $contactSelectForOrg.prop('disabled', false);

        $contactSelectForOrg.select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'انتخاب فرد از اعضای سازمان...',
            allowClear: true
        });

        console.log(`✅ Contact dropdown updated with ${addedCount} members`);

        // نمایش پیام موفقیت
        if (typeof Dashmix !== 'undefined') {
            Dashmix.helpers('jq-notify', {
                type: 'success',
                icon: 'fa fa-filter me-1',
                message: `لیست افراد به ${addedCount} عضو سازمان محدود شد`
            });
        }
    }

    // ========== مدیریت تغییر Contact (اختیاری) ==========
    $(document).on('change', '#contactSelect', function() {
        const contactId = $(this).val();

        if (!contactId) {
            $('#contactOrganizationsSection').slideUp();
            return;
        }

        console.log(`🔄 Contact changed: ${contactId}`);
        // می‌توانید اینجا سازمان‌های مرتبط با فرد را بارگذاری کنید
        // loadContactOrganizations(contactId);
    });

    // ========== مدیریت تغییر Tab ==========
    $('button[data-bs-toggle="pill"]').on('shown.bs.tab', function(e) {
        const target = $(e.target).attr('data-bs-target');

        console.log('🔄 Tab changed:', target);

        if (target === '#contact-panel') {
            // پاک کردن انتخاب سازمان
            $('#organizationSelect').val('').trigger('change.select2');
            $('#contactSelectForOrg').val('').trigger('change.select2');
            $('#organizationContactsSection').slideUp();

        } else if (target === '#organization-panel') {
            // پاک کردن انتخاب فرد
            $('#contactSelect').val('').trigger('change.select2');
            $('#contactOrganizationsSection').slideUp();
        }
    });

    // ========== راه‌اندازی Select2 اولیه ==========
    function initializeContactSelect2() {
        $('#contactSelect').select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'انتخاب فرد...',
            allowClear: true
        });
        console.log('✅ Contact Select2 initialized');
    }

    function initializeOrganizationSelect2() {
        $('#organizationSelect').select2({
            dir: 'rtl',
            width: '100%',
            placeholder: 'انتخاب شرکت/سازمان...',
            allowClear: true
        });
        console.log('✅ Organization Select2 initialized');
    }

    // اجرای اولیه
    initializeContactSelect2();
    initializeOrganizationSelect2();

    console.log('✅ CRM Contact/Organization Scripts Loaded Successfully');
});

// ========== باز کردن Modal افزودن سریع ==========
window.openQuickAddModalForCRM = function(type) {
    console.log('🎯 Opening Quick Add Modal:', type);

    // بررسی انتخاب شعبه
    var branchId = $('#branchSelect').val() || $('input[name="BranchId"]').val();
    
    if (!branchId) {
        if (typeof Dashmix !== 'undefined') {
            Dashmix.helpers('jq-notify', {
                type: 'warning',
                icon: 'fa fa-exclamation-triangle me-1',
                message: 'لطفاً ابتدا شعبه را انتخاب کنید'
            });
        } else {
            alert('لطفاً ابتدا شعبه را انتخاب کنید');
        }
        return;
    }

    var url = '';
    if (type === 'contact') {
        url = '@Url.Action("QuickAddContactPartial", "CRM")';
    } else if (type === 'organization') {
        url = '@Url.Action("QuickAddOrganizationPartial", "CRM")';
    }

    console.log('  → URL:', url);
    console.log('  → Branch ID:', branchId);

    // ⭐⭐⭐ استفاده از createAndShowModal از main.js
    if (typeof createAndShowModal === 'function') {
        createAndShowModal({
            url: url,
            backdrop: true,
            keyboard: true,
            removeOnHide: true,
            onShown: function(modalInstance, $modal) {
                console.log('✅ Quick Add Modal shown');

                // تنظیم BranchId
                $('#quickContactBranchId, #quickOrgBranchId').val(branchId);
            },
            onSubmitSuccess: function(response, modalInstance) {
                console.log('✅ Quick Add Success:', response);

                if (response.success) {
                    // اضافه کردن به Select2
                    if (type === 'contact' && response.contact) {
                        // ⭐ چک کردن tab فعال
                        const activeTab = $('.nav-link.active[data-bs-toggle="pill"]').attr('data-bs-target');
                        
                        let contactSelect;
                        if (activeTab === '#organization-panel') {
                            contactSelect = '#contactSelectForOrg';
                        } else {
                            contactSelect = '#contactSelect';
                        }

                        var newOption = new Option(
                            response.contact.lastName + ' ' + response.contact.firstName,
                            response.contact.id,
                            true,
                            true
                        );
                        $(contactSelect).append(newOption).trigger('change');

                        console.log('  → Contact added to dropdown:', contactSelect);

                        // نمایش پیام
                        if (typeof Dashmix !== 'undefined') {
                            Dashmix.helpers('jq-notify', {
                                type: 'success',
                                icon: 'fa fa-check me-1',
                                message: 'فرد با موفقیت ایجاد و انتخاب شد'
                            });
                        }

                    } else if (type === 'organization' && response.organization) {
                        var orgSelect = '#organizationSelect';
                        var newOption = new Option(
                            response.organization.name,
                            response.organization.id,
                            true,
                            true
                        );
                        $(orgSelect).append(newOption).trigger('change');

                        console.log('  → Organization added to dropdown');

                        // نمایش پیام
                        if (typeof Dashmix !== 'undefined') {
                            Dashmix.helpers('jq-notify', {
                                type: 'success',
                                icon: 'fa fa-check me-1',
                                message: 'سازمان با موفقیت ایجاد و انتخاب شد'
                            });
                        }

                        // بارگذاری اعضای سازمان
                        setTimeout(function() {
                            $(orgSelect).trigger('change');
                        }, 500);
                    }

                    // بستن modal
                    modalInstance.hide();
                }
            }
        });
    } else {
        console.error('❌ createAndShowModal is not defined');
        alert('خطا در سیستم: createAndShowModal یافت نشد');
    }
};
</script>
