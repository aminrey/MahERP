@model List<MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmFollowUpViewModel>
@{
    var followUps = Model ?? new List<MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmFollowUpViewModel>();
    var pendingFollowUps = followUps.Where(f => f.Status == 0).OrderBy(f => f.DueDate).ToList();
    var completedFollowUps = followUps.Where(f => f.Status != 0).OrderByDescending(f => f.CompletedDate ?? f.DueDate).ToList();
}

<div class="follow-ups-list">
    <!-- پیگیری‌های در انتظار -->
    <div class="mb-4">
        <h6 class="text-warning fw-semibold mb-3">
            <i class="fa fa-clock me-1"></i>
            در انتظار انجام
            @if (pendingFollowUps.Any())
            {
                <span class="badge bg-warning text-dark ms-1">@pendingFollowUps.Count</span>
            }
        </h6>

        @if (!pendingFollowUps.Any())
        {
            <div class="text-center py-3 text-muted bg-light rounded">
                <i class="fa fa-check-circle fa-2x mb-2 text-success opacity-50"></i>
                <p class="mb-0 small">پیگیری در انتظاری وجود ندارد</p>
            </div>
        }
        else
        {
            foreach (var followUp in pendingFollowUps)
            {
                var priorityClass = followUp.Priority switch
                {
                    0 => "border-start-success",    // کم
                    1 => "border-start-warning",    // متوسط
                    2 => "border-start-danger",     // زیاد
                    3 => "border-start-purple",     // فوری
                    _ => ""
                };

                var priorityBadge = followUp.Priority switch
                {
                    0 => "bg-success",
                    1 => "bg-warning text-dark",
                    2 => "bg-danger",
                    3 => "bg-purple",
                    _ => "bg-secondary"
                };

                var isOverdue = followUp.DueDate < DateTime.Now;
                var isDueToday = followUp.DueDate.Date == DateTime.Today;
                var isDueTomorrow = followUp.DueDate.Date == DateTime.Today.AddDays(1);

                <div class="card mb-2 border-start border-4 @priorityClass @(isOverdue ? "bg-danger-subtle" : "")">
                    <div class="card-body py-2 px-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="badge @priorityBadge me-2 small">@followUp.PriorityTitle</span>
                                    <h6 class="mb-0 fw-semibold">@followUp.Title</h6>
                                </div>
                                <div class="small text-muted">
                                    <i class="fa fa-calendar me-1"></i>
                                    @followUp.DueDatePersian
                                    @if (!string.IsNullOrEmpty(followUp.DueTime))
                                    {
                                        <span class="ms-1">
                                            <i class="fa fa-clock me-1"></i>
                                            @followUp.DueTime
                                        </span>
                                    }
                                    
                                    @if (isOverdue)
                                    {
                                        <span class="badge bg-danger ms-2">
                                            <i class="fa fa-exclamation-triangle me-1"></i>
                                            گذشته
                                        </span>
                                    }
                                    else if (isDueToday)
                                    {
                                        <span class="badge bg-warning text-dark ms-2">
                                            <i class="fa fa-bell me-1"></i>
                                            امروز
                                        </span>
                                    }
                                    else if (isDueTomorrow)
                                    {
                                        <span class="badge bg-info ms-2">فردا</span>
                                    }
                                </div>
                                @if (!string.IsNullOrEmpty(followUp.Description))
                                {
                                    <p class="mb-0 mt-1 small text-muted">@followUp.Description</p>
                                }
                            </div>
                            <div class="btn-group btn-group-sm ms-2">
                                <button type="button" class="btn btn-success btn-sm" 
                                        onclick="completeFollowUp(@followUp.Id)" title="تکمیل شد">
                                    <i class="fa fa-check"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                        onclick="postponeFollowUp(@followUp.Id)" title="به تعویق انداختن">
                                    <i class="fa fa-clock"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="cancelFollowUp(@followUp.Id)" title="لغو">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <!-- پیگیری‌های تکمیل شده -->
    @if (completedFollowUps.Any())
    {
        <div class="mb-3">
            <h6 class="text-muted fw-semibold mb-3 d-flex align-items-center" 
                data-bs-toggle="collapse" data-bs-target="#completedFollowUps" 
                style="cursor: pointer;">
                <i class="fa fa-check-circle me-1"></i>
                تکمیل شده / لغو شده
                <span class="badge bg-secondary ms-1">@completedFollowUps.Count</span>
                <i class="fa fa-chevron-down ms-auto small"></i>
            </h6>

            <div class="collapse" id="completedFollowUps">
                @foreach (var followUp in completedFollowUps.Take(5))
                {
                    var statusBadge = followUp.Status switch
                    {
                        1 => ("bg-success", "تکمیل شده"),
                        2 => ("bg-secondary", "لغو شده"),
                        3 => ("bg-info", "به تعویق افتاده"),
                        _ => ("bg-light text-dark", "نامشخص")
                    };

                    <div class="card mb-2 border-0 bg-light opacity-75">
                        <div class="card-body py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge @statusBadge.Item1 me-2 small">@statusBadge.Item2</span>
                                    <span class="small">@followUp.Title</span>
                                </div>
                                <small class="text-muted">
                                    @(followUp.CompletedDatePersian ?? followUp.DueDatePersian)
                                </small>
                            </div>
                        </div>
                    </div>
                }

                @if (completedFollowUps.Count > 5)
                {
                    <div class="text-center">
                        <a href="#" class="small text-muted">
                            مشاهده همه (@completedFollowUps.Count)
                        </a>
                    </div>
                }
            </div>
        </div>
    }

    @if (!followUps.Any())
    {
        <div class="text-center py-4 text-muted">
            <i class="fa fa-bell fa-3x mb-3 opacity-50"></i>
            <p>هنوز پیگیری ثبت نشده است</p>
            <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#addFollowUpModal">
                <i class="fa fa-plus me-1"></i>
                ایجاد اولین پیگیری
            </button>
        </div>
    }
</div>

<style>
    .border-start-success { border-left-color: #198754 !important; }
    .border-start-warning { border-left-color: #ffc107 !important; }
    .border-start-danger { border-left-color: #dc3545 !important; }
    .border-start-purple { border-left-color: #6f42c1 !important; }
    .bg-purple { background-color: #6f42c1 !important; color: white; }
    .bg-danger-subtle { background-color: rgba(220, 53, 69, 0.1) !important; }
</style>

<script>
    // تکمیل پیگیری
    function completeFollowUp(id) {
        Swal.fire({
            title: 'تکمیل پیگیری',
            text: 'آیا این پیگیری انجام شده است؟',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#198754',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'بله، تکمیل شد',
            cancelButtonText: 'انصراف'
        }).then((result) => {
            if (result.isConfirmed) {
                updateFollowUpStatus(id, 1, 'پیگیری با موفقیت تکمیل شد');
            }
        });
    }

    // به تعویق انداختن پیگیری
    function postponeFollowUp(id) {
        Swal.fire({
            title: 'به تعویق انداختن',
            html: '<input type="text" id="newDate" class="form-control persian-datepicker" placeholder="تاریخ جدید">',
            showCancelButton: true,
            confirmButtonText: 'ذخیره',
            cancelButtonText: 'انصراف',
            didOpen: function() {
                $('#newDate').persianDatepicker({
                    format: 'YYYY/MM/DD',
                    autoClose: true
                });
            },
            preConfirm: function() {
                var newDate = $('#newDate').val();
                if (!newDate) {
                    Swal.showValidationMessage('لطفاً تاریخ جدید را وارد کنید');
                }
                return newDate;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                $.post('@Url.Action("PostponeFollowUp", "Leads")', {
                    id: id,
                    newDate: result.value,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }, function(response) {
                    if (response.success) {
                        Swal.fire('موفق', response.message, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('خطا', response.message, 'error');
                    }
                });
            }
        });
    }

    // لغو پیگیری
    function cancelFollowUp(id) {
        Swal.fire({
            title: 'لغو پیگیری',
            text: 'آیا از لغو این پیگیری اطمینان دارید؟',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'بله، لغو شود',
            cancelButtonText: 'انصراف'
        }).then((result) => {
            if (result.isConfirmed) {
                updateFollowUpStatus(id, 2, 'پیگیری لغو شد');
            }
        });
    }

    // بروزرسانی وضعیت پیگیری
    function updateFollowUpStatus(id, status, successMessage) {
        $.post('@Url.Action("UpdateFollowUpStatus", "Leads")', {
            id: id,
            status: status,
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        }, function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'موفق',
                    text: successMessage,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => location.reload());
            } else {
                Swal.fire('خطا', response.message, 'error');
            }
        });
    }
</script>
