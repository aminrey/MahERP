@model MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmLeadViewModel
@{
    ViewData["Title"] = $"ویرایش سرنخ - {Model.DisplayName}";
    var statuses = ViewBag.Statuses as SelectList;
    var users = ViewBag.Users as SelectList;
    var sources = ViewBag.SuggestedSources as List<string>;
}

<!-- Main Container -->
<main id="main-container">
    <!-- Hero -->
    <div class="bg-body-light">
        <div class="content content-full">
            <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
                <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                    <i class="fa fa-edit text-primary me-2"></i>
                    ویرایش سرنخ
                </h1>
                <nav aria-label="breadcrumb" class="flex-shrink-0 my-2 my-sm-0 ms-sm-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a asp-area="CrmArea" asp-controller="Dashboard" asp-action="Index">CRM</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-action="Index">سرنخ‌ها</a>
                        </li>
                        <li aria-current="page" class="breadcrumb-item active">ویرایش</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- END Hero -->

    <!-- Page Content -->
    <div class="content">
        <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="editLeadForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Id" value="@Model.Id" />
            <input type="hidden" name="ContactId" value="@Model.ContactId" />
            <input type="hidden" name="OrganizationId" value="@Model.OrganizationId" />
            <input type="hidden" name="BranchId" value="@Model.BranchId" />

            <div class="row">
                <!-- ستون اصلی -->
                <div class="col-lg-8">
                    <!-- اطلاعات سرنخ -->
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                @if (Model.IsContact)
                                {
                                    <i class="fa fa-user text-primary me-1"></i>
                                }
                                else
                                {
                                    <i class="fa fa-building text-info me-1"></i>
                                }
                                اطلاعات سرنخ
                            </h3>
                        </div>
                        <div class="block-content">
                            <!-- نمایش اطلاعات فرد/سازمان -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="bg-light rounded p-3">
                                        <div class="d-flex align-items-center">
                                            @if (Model.IsContact)
                                            {
                                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="fa fa-user fa-lg"></i>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center me-3" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="fa fa-building fa-lg"></i>
                                                </div>
                                            }
                                            <div>
                                                <h5 class="mb-1">@Model.DisplayName</h5>
                                                <div class="text-muted">
                                                    @if (!string.IsNullOrEmpty(Model.PrimaryPhone))
                                                    {
                                                        <span class="me-3">
                                                            <i class="fa fa-phone text-success"></i>
                                                            @Model.PrimaryPhone
                                                        </span>
                                                    }
                                                    @if (!string.IsNullOrEmpty(Model.PrimaryEmail))
                                                    {
                                                        <span>
                                                            <i class="fa fa-envelope text-info"></i>
                                                            @Model.PrimaryEmail
                                                        </span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">منبع سرنخ</label>
                                    <select class="form-select" name="Source" id="Source">
                                        <option value="">انتخاب کنید...</option>
                                        @if (sources != null)
                                        {
                                            foreach (var source in sources)
                                            {
                                                <option value="@source" selected="@(Model.Source == source)">@source</option>
                                            }
                                        }
                                        @if (!string.IsNullOrEmpty(Model.Source) && (sources == null || !sources.Contains(Model.Source)))
                                        {
                                            <option value="@Model.Source" selected>@Model.Source</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">امتیاز</label>
                                    <div class="input-group">
                                        <input type="range" class="form-range" name="Score" id="Score" 
                                               min="0" max="100" value="@Model.Score" 
                                               oninput="updateScoreDisplay(this.value)" />
                                        <span class="input-group-text" id="scoreDisplay" style="min-width: 60px;">
                                            @Model.Score
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ارزش تخمینی (ریال)</label>
                                    <input type="text" class="form-control" name="EstimatedValue" 
                                           value="@Model.EstimatedValue" placeholder="مثال: 50000000" 
                                           dir="ltr" data-inputmask="'alias': 'numeric', 'groupSeparator': ',', 'autoGroup': true" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">برچسب‌ها</label>
                                    <input type="text" class="form-control" name="Tags" 
                                           value="@Model.Tags" placeholder="برچسب‌ها را با کاما جدا کنید" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label class="form-label">یادداشت‌ها</label>
                                    <textarea class="form-control" name="Notes" rows="4" 
                                              placeholder="یادداشت‌ها و توضیحات...">@Model.Notes</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تاریخ‌های مهم -->
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-calendar me-1"></i>
                                تاریخ‌های مهم
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاریخ آخرین تماس</label>
                                    <input type="text" class="form-control persian-datepicker" 
                                           name="LastContactDatePersian" 
                                           value="@Model.LastContactDatePersian" 
                                           placeholder="انتخاب تاریخ..." />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاریخ پیگیری بعدی</label>
                                    <input type="text" class="form-control persian-datepicker" 
                                           name="NextFollowUpDatePersian" 
                                           value="@Model.NextFollowUpDatePersian" 
                                           placeholder="انتخاب تاریخ..." />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ستون کناری -->
                <div class="col-lg-4">
                    <!-- وضعیت و تخصیص -->
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-cog me-1"></i>
                                تنظیمات
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="mb-3">
                                <label class="form-label">وضعیت</label>
                                <select class="form-select" name="StatusId" id="StatusId">
                                    @if (statuses != null)
                                    {
                                        foreach (var status in statuses)
                                        {
                                            <option value="@status.Value" 
                                                    selected="@(status.Value == Model.StatusId.ToString())">
                                                @status.Text
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">کاربر مسئول</label>
                                <select class="form-select" name="AssignedUserId" id="AssignedUserId">
                                    @if (users != null)
                                    {
                                        foreach (var user in users)
                                        {
                                            <option value="@user.Value" 
                                                    selected="@(user.Value == Model.AssignedUserId)">
                                                @user.Text
                                            </option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="IsActive" 
                                           name="IsActive" @(Model.IsActive ? "checked" : "") />
                                    <label class="form-check-label" for="IsActive">
                                        فعال
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- دکمه‌ها -->
                    <div class="block block-rounded">
                        <div class="block-content">
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fa fa-save me-1"></i>
                                    ذخیره تغییرات
                                </button>
                                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info">
                                    <i class="fa fa-eye me-1"></i>
                                    مشاهده جزئیات
                                </a>
                                <a asp-action="Index" class="btn btn-secondary">
                                    <i class="fa fa-arrow-right me-1"></i>
                                    بازگشت به لیست
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- اطلاعات سیستمی -->
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-info-circle me-1"></i>
                                اطلاعات سیستمی
                            </h3>
                        </div>
                        <div class="block-content fs-sm">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">تاریخ ایجاد:</span>
                                <span>@Model.CreatedDatePersian</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">ایجاد کننده:</span>
                                <span>@Model.CreatorName</span>
                            </div>
                            @if (Model.LastUpdateDate.HasValue)
                            {
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">آخرین بروزرسانی:</span>
                                    <span>@Model.LastUpdateDatePersian</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-muted">بروزرسانی کننده:</span>
                                    <span>@Model.LastUpdaterName</span>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- آمار سرنخ -->
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-chart-bar me-1"></i>
                                آمار
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="fs-2 fw-bold text-primary">@Model.InteractionsCount</div>
                                    <div class="text-muted small">تعامل</div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="fs-2 fw-bold text-warning">@Model.PendingFollowUpsCount</div>
                                    <div class="text-muted small">پیگیری فعال</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <!-- END Page Content -->
</main>
<!-- END Main Container -->

@section Scripts {
    <script>
        $(document).ready(function() {
            // Select2 برای منبع با امکان تایپ
            $('#Source').select2({
                theme: 'bootstrap-5',
                width: '100%',
                tags: true,
                placeholder: 'انتخاب یا وارد کنید...'
            });

            // سایر Select2
            $('#StatusId, #AssignedUserId').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });

            // Persian Datepicker
            $('.persian-datepicker').persianDatepicker({
                format: 'YYYY/MM/DD',
                initialValue: false,
                autoClose: true
            });

            // Inputmask برای ارزش تخمینی
            $('[data-inputmask]').inputmask();
        });

        // نمایش امتیاز
        function updateScoreDisplay(value) {
            $('#scoreDisplay').text(value);
        }
    </script>
}
