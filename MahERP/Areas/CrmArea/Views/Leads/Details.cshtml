@model MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmLeadViewModel
@{
    ViewData["Title"] = $"جزئیات سرنخ - {Model.DisplayName}";
    var statuses = ViewBag.Statuses as SelectList;
}

<!-- Main Container -->
<main id="main-container">
    <!-- Hero -->
    <div class="bg-body-light">
        <div class="content content-full">
            <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
                <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                    @if (Model.IsContact)
                    {
                        <i class="fa fa-user text-primary me-2"></i>
                    }
                    else
                    {
                        <i class="fa fa-building text-info me-2"></i>
                    }
                    @Model.DisplayName
                </h1>
                <nav aria-label="breadcrumb" class="flex-shrink-0 my-2 my-sm-0 ms-sm-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a asp-area="CrmArea" asp-controller="Dashboard" asp-action="Index">CRM</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a asp-action="Index">سرنخ‌ها</a>
                        </li>
                        <li aria-current="page" class="breadcrumb-item active">جزئیات</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
    <!-- END Hero -->

    <!-- Page Content -->
    <div class="content">
        <div class="row">
            <!-- ستون اصلی -->
            <div class="col-lg-8">
                <!-- اطلاعات اصلی -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-info-circle me-1"></i>
                            اطلاعات سرنخ
                        </h3>
                        <div class="block-options">
                            <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-sm btn-primary">
                                <i class="fa fa-pencil-alt me-1"></i>
                                ویرایش
                            </a>
                        </div>
                    </div>
                    <div class="block-content">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">نام</label>
                                <div class="fw-semibold fs-5">@Model.DisplayName</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">نوع</label>
                                <div>
                                    @if (Model.IsContact)
                                    {
                                        <span class="badge bg-primary">
                                            <i class="fa fa-user me-1"></i>
                                            فرد
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-info">
                                            <i class="fa fa-building me-1"></i>
                                            سازمان
                                        </span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">تلفن</label>
                                <div>
                                    @if (!string.IsNullOrEmpty(Model.PrimaryPhone))
                                    {
                                        <a href="tel:@Model.PrimaryPhone" class="text-success">
                                            <i class="fa fa-phone me-1"></i>
                                            @Model.PrimaryPhone
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">ایمیل</label>
                                <div>
                                    @if (!string.IsNullOrEmpty(Model.PrimaryEmail))
                                    {
                                        <a href="mailto:@Model.PrimaryEmail" class="text-info">
                                            <i class="fa fa-envelope me-1"></i>
                                            @Model.PrimaryEmail
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">منبع</label>
                                <div>
                                    @if (!string.IsNullOrEmpty(Model.Source))
                                    {
                                        <span class="badge bg-secondary">@Model.Source</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">نامشخص</span>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label text-muted">ارزش تخمینی</label>
                                <div>
                                    @if (Model.EstimatedValue.HasValue)
                                    {
                                        <span class="fw-semibold text-success">
                                            @Model.EstimatedValueFormatted ریال
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">-</span>
                                    }
                                </div>
                            </div>
                        </div>

                        @if (!string.IsNullOrEmpty(Model.Notes))
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted">یادداشت‌ها</label>
                                <div class="bg-light rounded p-3">
                                    @Model.Notes
                                </div>
                            </div>
                        }

                        @if (Model.TagsList?.Any() == true)
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted">برچسب‌ها</label>
                                <div>
                                    @foreach (var tag in Model.TagsList)
                                    {
                                        <span class="badge bg-info me-1">@tag</span>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- تعاملات اخیر -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-comments me-1"></i>
                            تعاملات اخیر
                            @if (Model.InteractionsCount > 0)
                            {
                                <span class="badge bg-primary ms-1">@Model.InteractionsCount</span>
                            }
                        </h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-success"
                                    onclick="openInteractionModal(@Model.Id)">
                                <i class="fa fa-plus me-1"></i>
                                ثبت تعامل
                            </button>
                        </div>
                    </div>
                    <div class="block-content" id="InteractionsContainer">
                        @if (Model.RecentInteractions?.Any() == true)
                        {
                            <div class="timeline timeline-alt">
                                @foreach (var interaction in Model.RecentInteractions)
                                {
                                    <div class="timeline-event">
                                        <div class="timeline-event-icon bg-@interaction.InteractionTypeColor">
                                            <i class="fa @interaction.InteractionTypeIcon"></i>
                                        </div>
                                        <div class="timeline-event-block block block-rounded">
                                            <div class="block-header block-header-default">
                                                <h3 class="block-title">
                                                    @interaction.InteractionTypeText
                                                    @if (!string.IsNullOrEmpty(interaction.Subject))
                                                    {
                                                        <span class="text-muted">- @interaction.Subject</span>
                                                    }
                                                </h3>
                                                <div class="block-options">
                                                    <span class="fs-sm text-muted">
                                                        @interaction.InteractionDatePersian
                                                        @interaction.InteractionTime
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="block-content">
                                                <p>@interaction.Description</p>
                                                @if (interaction.Result.HasValue)
                                                {
                                                    <p class="text-muted mb-0">
                                                        <strong>نتیجه:</strong> @interaction.ResultTitle
                                                    </p>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-4">
                                <i class="fa fa-comments fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0">هنوز تعاملی ثبت نشده است</p>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- ستون کناری -->
            <div class="col-lg-4">
                <!-- وضعیت و امتیاز -->
                <div class="block block-rounded">
                    <div class="block-content text-center">
                        <!-- وضعیت -->
                        <div class="mb-4">
                            <span class="badge fs-5 px-4 py-2" style="background-color: @Model.StatusColor;">
                                @if (!string.IsNullOrEmpty(Model.StatusIcon))
                                {
                                    <i class="fa @Model.StatusIcon me-1"></i>
                                }
                                @Model.StatusTitle
                            </span>
                        </div>

                        <!-- تغییر وضعیت سریع -->
                        <div class="mb-4">
                            <label class="form-label">تغییر وضعیت</label>
                            <select class="form-select" id="statusSelect" onchange="changeStatus(this.value)">
                                @if (statuses != null)
                                {
                                    foreach (var status in statuses)
                                    {
                                        <option value="@status.Value" 
                                                selected="@(status.Value == Model.StatusId.ToString())">
                                            @status.Text
                                        </option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- امتیاز -->
                        <div class="mb-4">
                            <label class="form-label">امتیاز سرنخ</label>
                            <div class="progress mb-2" style="height: 30px;">
                                @{
                                    var scorePercent = Math.Min(Model.Score, 100);
                                    var scoreColor = Model.Score >= 70 ? "bg-success" : 
                                                    Model.Score >= 40 ? "bg-warning" : "bg-danger";
                                }
                                <div class="progress-bar @scoreColor fs-6" style="width: @scorePercent%;">
                                    @Model.Score / 100
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات تکمیلی -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">اطلاعات تکمیلی</h3>
                    </div>
                    <div class="block-content">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">مسئول پیگیری:</span>
                            <span class="fw-semibold">
                                @(Model.AssignedUserName ?? "تخصیص نشده")
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">آخرین تماس:</span>
                            <span>
                                @if (Model.LastContactDate.HasValue)
                                {
                                    @Model.LastContactDatePersian
                                    @if (Model.DaysSinceLastContact > 0)
                                    {
                                        <small class="text-muted">(@Model.DaysSinceLastContact روز پیش)</small>
                                    }
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">پیگیری بعدی:</span>
                            <span>
                                @if (Model.NextFollowUpDate.HasValue)
                                {
                                    var isOverdue = Model.NextFollowUpDate.Value < DateTime.Now;
                                    <span class="@(isOverdue ? "text-danger fw-semibold" : "")">
                                        @Model.NextFollowUpDatePersian
                                        @if (isOverdue)
                                        {
                                            <i class="fa fa-exclamation-triangle"></i>
                                        }
                                    </span>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">تاریخ ایجاد:</span>
                            <span>@Model.CreatedDatePersian</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">ایجاد کننده:</span>
                            <span>@Model.CreatorName</span>
                        </div>
                    </div>
                </div>

                <!-- پیگیری‌های در انتظار -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-clock me-1"></i>
                            پیگیری‌ها
                            @if (Model.PendingFollowUpsCount > 0)
                            {
                                <span class="badge bg-warning ms-1">@Model.PendingFollowUpsCount</span>
                            }
                        </h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-alt-success"
                                    onclick="openFollowUpModal(@Model.Id)">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="block-content" id="FollowUpsContainer">
                        @if (Model.PendingFollowUps?.Any() == true)
                        {
                            <ul class="list-group list-group-flush">
                                @foreach (var followUp in Model.PendingFollowUps.Take(5))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center @(followUp.IsOverdue ? "list-group-item-danger" : "")">
                                        <div>
                                            <i class="fa @followUp.FollowUpTypeIcon me-1"></i>
                                            <span class="@(followUp.IsOverdue ? "fw-semibold" : "")">
                                                @followUp.DisplayTitle
                                            </span>
                                            <br />
                                            <small class="text-muted">@followUp.DueDatePersian</small>
                                        </div>
                                        <span class="badge bg-@followUp.PriorityColor">
                                            @followUp.PriorityText
                                        </span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div class="text-center py-3">
                                <i class="fa fa-clock fa-2x text-muted mb-2"></i>
                                <p class="text-muted mb-0 small">پیگیری فعالی وجود ندارد</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- عملیات سریع -->
                <div class="block block-rounded">
                    <div class="block-content">
                        <div class="d-grid gap-2">
                            @if (!string.IsNullOrEmpty(Model.PrimaryPhone))
                            {
                                <a href="tel:@Model.PrimaryPhone" class="btn btn-success">
                                    <i class="fa fa-phone me-1"></i>
                                    تماس تلفنی
                                </a>
                            }
                            @if (!string.IsNullOrEmpty(Model.PrimaryEmail))
                            {
                                <a href="mailto:@Model.PrimaryEmail" class="btn btn-info">
                                    <i class="fa fa-envelope me-1"></i>
                                    ارسال ایمیل
                                </a>
                            }
                            <button type="button" class="btn btn-warning" onclick="openFollowUpModal(@Model.Id)">
                                <i class="fa fa-clock me-1"></i>
                                ایجاد پیگیری
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fa fa-arrow-right me-1"></i>
                                بازگشت به لیست
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- END Page Content -->
</main>
<!-- END Main Container -->

@section Scripts {
    <script>
        // تغییر وضعیت
        function changeStatus(statusId) {
            if (statusId == '@Model.StatusId') return;

            $.ajax({
                url: '@Url.Action("ChangeStatus")',
                type: 'POST',
                data: { 
                    id: @Model.Id, 
                    statusId: statusId 
                },
                headers: {
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'تغییر وضعیت',
                            text: response.message,
                            timer: 2000
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire('خطا', response.message, 'error');
                        $('#statusSelect').val('@Model.StatusId');
                    }
                },
                error: function() {
                    Swal.fire('خطا', 'خطا در ارتباط با سرور', 'error');
                    $('#statusSelect').val('@Model.StatusId');
                }
            });
        }

        // باز کردن مودال تعامل
        function openInteractionModal(leadId) {
            // TODO: Load modal via AJAX
            Swal.fire('در حال توسعه', 'این بخش به زودی فعال می‌شود', 'info');
        }

        // باز کردن مودال پیگیری
        function openFollowUpModal(leadId) {
            // TODO: Load modal via AJAX
            Swal.fire('در حال توسعه', 'این بخش به زودی فعال می‌شود', 'info');
        }
    </script>
}

<!-- Anti-Forgery Token -->
<form style="display: none;">
    @Html.AntiForgeryToken()
</form>
