@model MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmLeadInteractionViewModel
@{
    var interactionTypes = new List<SelectListItem>
    {
        new SelectListItem { Value = "0", Text = "تماس تلفنی" },
        new SelectListItem { Value = "1", Text = "ایمیل" },
        new SelectListItem { Value = "2", Text = "جلسه حضوری" },
        new SelectListItem { Value = "3", Text = "پیامک" },
        new SelectListItem { Value = "4", Text = "شبکه‌های اجتماعی" },
        new SelectListItem { Value = "5", Text = "چت آنلاین" },
        new SelectListItem { Value = "6", Text = "فرم وب‌سایت" },
        new SelectListItem { Value = "7", Text = "سایر" }
    };

    var directions = new List<SelectListItem>
    {
        new SelectListItem { Value = "0", Text = "ورودی (دریافتی)" },
        new SelectListItem { Value = "1", Text = "خروجی (ارسالی)" }
    };

    var results = new List<SelectListItem>
    {
        new SelectListItem { Value = "0", Text = "موفق" },
        new SelectListItem { Value = "1", Text = "ناموفق" },
        new SelectListItem { Value = "2", Text = "بدون پاسخ" },
        new SelectListItem { Value = "3", Text = "در انتظار" },
        new SelectListItem { Value = "4", Text = "نیاز به پیگیری" }
    };
}

<!-- Modal افزودن تعامل -->
<div class="modal fade" id="addInteractionModal" tabindex="-1" aria-labelledby="addInteractionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addInteractionForm" asp-action="AddInteraction" asp-controller="Leads" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="LeadId" id="interactionLeadId" value="@Model?.LeadId" />

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="addInteractionModalLabel">
                        <i class="fa fa-plus-circle me-2"></i>
                        ثبت تعامل جدید
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <!-- نوع تعامل -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-tag text-primary me-1"></i>
                                نوع تعامل <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" name="InteractionType" id="interactionType" required>
                                @foreach (var type in interactionTypes)
                                {
                                    <option value="@type.Value">@type.Text</option>
                                }
                            </select>
                        </div>

                        <!-- جهت تعامل -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-exchange-alt text-info me-1"></i>
                                جهت تعامل
                            </label>
                            <select class="form-select" name="Direction" id="interactionDirection">
                                @foreach (var dir in directions)
                                {
                                    <option value="@dir.Value">@dir.Text</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- تاریخ و ساعت -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-calendar text-success me-1"></i>
                                تاریخ تعامل <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control persian-datepicker" 
                                   name="InteractionDatePersian" id="interactionDate" required
                                   placeholder="انتخاب تاریخ..." />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-clock text-warning me-1"></i>
                                ساعت تعامل
                            </label>
                            <input type="time" class="form-control" name="InteractionTime" id="interactionTime" />
                        </div>
                    </div>

                    <div class="row">
                        <!-- مدت زمان -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-hourglass-half text-secondary me-1"></i>
                                مدت زمان (دقیقه)
                            </label>
                            <input type="number" class="form-control" name="DurationMinutes" 
                                   id="interactionDuration" min="0" max="480" placeholder="مثال: 30" />
                        </div>

                        <!-- نتیجه -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label">
                                <i class="fa fa-check-circle text-success me-1"></i>
                                نتیجه تعامل
                            </label>
                            <select class="form-select" name="Result" id="interactionResult">
                                @foreach (var result in results)
                                {
                                    <option value="@result.Value">@result.Text</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- موضوع -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa fa-heading text-primary me-1"></i>
                            موضوع <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" name="Subject" id="interactionSubject" 
                               required maxlength="200" placeholder="موضوع تعامل را وارد کنید..." />
                    </div>

                    <!-- توضیحات -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fa fa-align-left text-muted me-1"></i>
                            توضیحات
                        </label>
                        <textarea class="form-control" name="Description" id="interactionDescription" 
                                  rows="4" placeholder="جزئیات تعامل را شرح دهید..."></textarea>
                    </div>

                    <!-- پیگیری بعدی -->
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="needsFollowUp" 
                                       name="NeedsFollowUp" onchange="toggleFollowUpSection()">
                                <label class="form-check-label fw-semibold" for="needsFollowUp">
                                    <i class="fa fa-bell text-warning me-1"></i>
                                    نیاز به پیگیری دارد
                                </label>
                            </div>

                            <div id="followUpSection" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">تاریخ پیگیری</label>
                                        <input type="text" class="form-control persian-datepicker" 
                                               name="FollowUpDatePersian" id="followUpDate" 
                                               placeholder="انتخاب تاریخ..." />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">یادداشت پیگیری</label>
                                        <input type="text" class="form-control" name="FollowUpNote" 
                                               id="followUpNote" placeholder="یادداشت کوتاه..." />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa fa-times me-1"></i>
                        انصراف
                    </button>
                    <button type="submit" class="btn btn-primary" id="btnSaveInteraction">
                        <i class="fa fa-save me-1"></i>
                        ذخیره تعامل
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function toggleFollowUpSection() {
        var isChecked = $('#needsFollowUp').is(':checked');
        if (isChecked) {
            $('#followUpSection').slideDown();
        } else {
            $('#followUpSection').slideUp();
        }
    }

    // فرم ثبت تعامل
    $('#addInteractionForm').on('submit', function(e) {
        e.preventDefault();
        
        var form = $(this);
        var btn = $('#btnSaveInteraction');
        var originalText = btn.html();
        
        btn.prop('disabled', true).html('<i class="fa fa-spinner fa-spin me-1"></i>در حال ذخیره...');
        
        $.ajax({
            url: form.attr('action'),
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    $('#addInteractionModal').modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'موفق',
                        text: response.message,
                        timer: 2000,
                        showConfirmButton: false
                    }).then(function() {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: response.message
                    });
                }
            },
            error: function() {
                Swal.fire({
                    icon: 'error',
                    title: 'خطا',
                    text: 'خطا در ارتباط با سرور'
                });
            },
            complete: function() {
                btn.prop('disabled', false).html(originalText);
            }
        });
    });

    // Reset form on modal show
    $('#addInteractionModal').on('show.bs.modal', function() {
        $('#addInteractionForm')[0].reset();
        $('#followUpSection').hide();
        
        // تنظیم تاریخ امروز
        var today = new persianDate().format('YYYY/MM/DD');
        $('#interactionDate').val(today);
    });
</script>
