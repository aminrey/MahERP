@model MahERP.DataModelLayer.ViewModels.CrmViewModels.CrmLeadListViewModel

@if (Model.Leads.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped table-vcenter">
            <thead>
                <tr>
                    <th class="text-center" style="width: 60px;">#</th>
                    <th>سرنخ</th>
                    <th class="text-center" style="width: 120px;">وضعیت</th>
                    <th class="text-center" style="width: 100px;">منبع</th>
                    <th class="text-center" style="width: 80px;">امتیاز</th>
                    <th class="text-center" style="width: 120px;">پیگیری بعدی</th>
                    <th class="text-center" style="width: 100px;">مسئول</th>
                    <th class="text-center" style="width: 130px;">عملیات</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int counter = (Model.PageNumber - 1) * Model.PageSize + 1;
                }
                @foreach (var lead in Model.Leads)
                {
                    <tr class="@(lead.NeedsFollowUp ? "table-warning" : "")">
                        <td class="text-center fw-semibold">@counter</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    @if (lead.IsContact)
                                    {
                                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fa fa-user"></i>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" 
                                             style="width: 40px; height: 40px;">
                                            <i class="fa fa-building"></i>
                                        </div>
                                    }
                                </div>
                                <div>
                                    <a asp-action="Details" asp-route-id="@lead.Id" class="fw-semibold text-dark">
                                        @lead.DisplayName
                                    </a>
                                    <div class="small text-muted">
                                        @if (!string.IsNullOrEmpty(lead.PrimaryPhone))
                                        {
                                            <span class="me-2">
                                                <i class="fa fa-phone text-success"></i>
                                                @lead.PrimaryPhone
                                            </span>
                                        }
                                        @if (!string.IsNullOrEmpty(lead.PrimaryEmail))
                                        {
                                            <span>
                                                <i class="fa fa-envelope text-info"></i>
                                                @lead.PrimaryEmail
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge" style="background-color: @lead.StatusColor;">
                                @if (!string.IsNullOrEmpty(lead.StatusIcon))
                                {
                                    <i class="fa @lead.StatusIcon me-1"></i>
                                }
                                @lead.StatusTitle
                            </span>
                        </td>
                        <td class="text-center">
                            @if (!string.IsNullOrEmpty(lead.Source))
                            {
                                <span class="badge bg-secondary">@lead.Source</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td class="text-center">
                            <div class="progress" style="height: 20px;" title="امتیاز: @lead.Score">
                                @{
                                    var scorePercent = Math.Min(lead.Score, 100);
                                    var scoreColor = lead.Score >= 70 ? "bg-success" : 
                                                    lead.Score >= 40 ? "bg-warning" : "bg-danger";
                                }
                                <div class="progress-bar @scoreColor" style="width: @scorePercent%;">
                                    @lead.Score
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            @if (lead.NextFollowUpDate.HasValue)
                            {
                                var isOverdue = lead.NextFollowUpDate.Value < DateTime.Now;
                                var isToday = lead.NextFollowUpDate.Value.Date == DateTime.Today;
                                
                                <span class="badge @(isOverdue ? "bg-danger" : isToday ? "bg-warning" : "bg-info")">
                                    @if (isOverdue)
                                    {
                                        <i class="fa fa-exclamation-triangle me-1"></i>
                                    }
                                    @lead.NextFollowUpDatePersian
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td class="text-center">
                            @if (!string.IsNullOrEmpty(lead.AssignedUserName))
                            {
                                <span class="badge bg-secondary" title="@lead.AssignedUserName">
                                    @lead.AssignedUserName.Substring(0, Math.Min(10, lead.AssignedUserName.Length))
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">تخصیص نشده</span>
                            }
                        </td>
                        <td class="text-center">
                            <div class="btn-group">
                                <a asp-action="Details" asp-route-id="@lead.Id" 
                                   class="btn btn-sm btn-alt-secondary" title="مشاهده">
                                    <i class="fa fa-eye"></i>
                                </a>
                                <a asp-action="Edit" asp-route-id="@lead.Id" 
                                   class="btn btn-sm btn-alt-secondary" title="ویرایش">
                                    <i class="fa fa-pencil-alt"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-alt-success" 
                                        onclick="quickAddInteraction(@lead.Id)" title="ثبت تعامل">
                                    <i class="fa fa-comment"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    counter++;
                }
            </tbody>
        </table>
    </div>

    <!-- صفحه‌بندی -->
    @if (Model.TotalPages > 1)
    {
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                @if (Model.PageNumber > 1)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.PageNumber - 1)"
                           asp-route-searchText="@Model.Filters?.SearchText"
                           asp-route-statusId="@Model.Filters?.StatusId">
                            <i class="fa fa-angle-right"></i>
                        </a>
                    </li>
                }

                @for (int i = Math.Max(1, Model.PageNumber - 2); i <= Math.Min(Model.TotalPages, Model.PageNumber + 2); i++)
                {
                    <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@i"
                           asp-route-searchText="@Model.Filters?.SearchText"
                           asp-route-statusId="@Model.Filters?.StatusId">
                            @i
                        </a>
                    </li>
                }

                @if (Model.PageNumber < Model.TotalPages)
                {
                    <li class="page-item">
                        <a class="page-link" asp-action="Index" asp-route-page="@(Model.PageNumber + 1)"
                           asp-route-searchText="@Model.Filters?.SearchText"
                           asp-route-statusId="@Model.Filters?.StatusId">
                            <i class="fa fa-angle-left"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>
    }
}
else
{
    <div class="text-center py-5">
        <i class="fa fa-users fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">سرنخی یافت نشد</h4>
        <p class="text-muted">هنوز سرنخی ثبت نشده یا فیلترها نتیجه‌ای ندارند.</p>
        <a asp-action="Create" class="btn btn-success">
            <i class="fa fa-plus me-1"></i>
            ایجاد اولین سرنخ
        </a>
    </div>
}

<script>
    function quickAddInteraction(leadId) {
        // باز کردن مودال ثبت تعامل سریع
        Swal.fire({
            title: 'ثبت تعامل سریع',
            html: `
                <div class="text-start">
                    <div class="mb-3">
                        <label class="form-label">نوع تعامل</label>
                        <select class="form-select" id="swal-interaction-type">
                            <option value="0">تماس تلفنی</option>
                            <option value="1">ایمیل</option>
                            <option value="2">جلسه حضوری</option>
                            <option value="3">پیامک</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">توضیحات</label>
                        <textarea class="form-control" id="swal-description" rows="3" placeholder="خلاصه تعامل..."></textarea>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'ثبت',
            cancelButtonText: 'انصراف',
            preConfirm: () => {
                return {
                    type: document.getElementById('swal-interaction-type').value,
                    description: document.getElementById('swal-description').value
                }
            }
        }).then((result) => {
            if (result.isConfirmed && result.value.description) {
                // ارسال به سرور
                $.ajax({
                    url: '@Url.Action("QuickCreate", "LeadInteractions")',
                    type: 'POST',
                    data: {
                        leadId: leadId,
                        interactionType: result.value.type,
                        description: result.value.description
                    },
                    headers: {
                        'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            Swal.fire('ثبت شد', 'تعامل با موفقیت ثبت شد', 'success');
                        } else {
                            Swal.fire('خطا', response.message, 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('خطا', 'خطا در ارتباط با سرور', 'error');
                    }
                });
            }
        });
    }
</script>
