@model MahERP.DataModelLayer.ViewModels.CrmViewModels.InteractionCreateViewModel
@using MahERP.DataModelLayer.ViewModels.taskingModualsViewModels.AcControl
@{
    ViewData["Title"] = "ثبت تعامل جدید";
    var contactName = ViewBag.ContactName as string;
    var organizationName = ViewBag.OrganizationName as string;
    var contactType = ViewBag.ContactType;
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-handshake text-primary me-2"></i>
                ثبت تعامل جدید
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">CRM</li>
                    <li class="breadcrumb-item">
                        <a asp-action="Index">تعاملات</a>
                    </li>
                    <li class="breadcrumb-item active">ثبت جدید</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content content-full">
    <form asp-action="Create" method="post" id="interactionForm">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="BranchId" id="selectedBranchId" value="@(Model.BranchId ?? ViewBag.DefaultBranchId ?? 0)" />
        <input type="hidden" asp-for="OrganizationId" id="selectedOrganizationId" value="@(Model.OrganizationId ?? 0)" />
        <input type="hidden" asp-for="ContactId" id="selectedContactId" value="@Model.ContactId" />

        <div class="row">
            <!-- ستون اصلی -->
            <div class="col-lg-8">
                <!-- اطلاعات مخاطب انتخاب شده -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-user-check me-1"></i>
                            مخاطب انتخاب شده
                        </h3>
                        <div class="block-options">
                            <button type="button" 
                                    class="btn btn-sm btn-success me-1" 
                                    onclick="openQuickAddModalForInteraction()">
                                <i class="fa fa-plus me-1"></i>
                                افزودن سریع
                            </button>
                            <a asp-action="Create" class="btn btn-sm btn-alt-secondary">
                                <i class="fa fa-exchange-alt me-1"></i>
                                تغییر مخاطب
                            </a>
                        </div>
                    </div>
                    <div class="block-content block-content-full bg-body-light">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 me-3">
                                <i class="fa fa-user-circle fa-3x text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h4 class="mb-1">@contactName</h4>
                                @if (!string.IsNullOrEmpty(organizationName))
                                {
                                    <p class="text-muted mb-0">
                                        <i class="fa fa-building me-1"></i>
                                        @organizationName
                                    </p>
                                }
                                @if (contactType != null)
                                {
                                    var typeName = contactType switch
                                    {
                                        MahERP.DataModelLayer.Enums.ContactType.Lead => "سرنخ",
                                        MahERP.DataModelLayer.Enums.ContactType.Customer => "مشتری",
                                        _ => "سایر"
                                    };
                                    var typeColor = contactType switch
                                    {
                                        MahERP.DataModelLayer.Enums.ContactType.Lead => "warning",
                                        MahERP.DataModelLayer.Enums.ContactType.Customer => "success",
                                        _ => "secondary"
                                    };
                                    <span class="badge bg-@typeColor">@typeName</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات تعامل -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-info-circle me-1"></i>
                            اطلاعات تعامل
                        </h3>
                    </div>
                    <div class="block-content">
                        <!-- نوع تعامل -->
                        <div class="mb-4">
                            <label class="form-label" for="InteractionTypeId">
                                نوع تعامل <span class="text-danger">*</span>
                            </label>
                            <select asp-for="InteractionTypeId" class="form-select" id="interactionTypeSelect" required>
                                <option value="">-- انتخاب کنید --</option>
                                @foreach (var type in Model.InteractionTypes)
                                {
                                    <option value="@type.Id" data-stage="@type.LeadStageStatusTitle" data-stage-color="@type.LeadStageStatusColor">
                                        @type.Title
                                    </option>
                                }
                            </select>
                            <span asp-validation-for="InteractionTypeId" class="text-danger"></span>
                            <div id="leadStageInfo" class="mt-2" style="display: none;">
                                <small class="text-muted">
                                    <i class="fa fa-funnel-dollar me-1"></i>
                                    مرحله قیف: <span id="leadStageText" class="badge"></span>
                                </small>
                            </div>
                        </div>

                        <!-- موضوع -->
                        <div class="mb-4">
                            <label class="form-label" for="Subject">
                                موضوع تعامل <span class="text-danger">*</span>
                            </label>
                            <input asp-for="Subject" class="form-control" placeholder="مثال: تماس تلفنی برای پیگیری" required />
                            <span asp-validation-for="Subject" class="text-danger"></span>
                        </div>

                        <!-- توضیحات -->
                        <div class="mb-4">
                            <label class="form-label" for="Description">
                                شرح تعامل <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="جزئیات کامل تعامل..." required></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- تاریخ و زمان -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label class="form-label" for="InteractionDatePersian">
                                        تاریخ تعامل <span class="text-danger">*</span>
                                    </label>
                                    <input asp-for="InteractionDatePersian" class="form-control js-flatpickr" required readonly />
                                    <span asp-validation-for="InteractionDatePersian" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label class="form-label" for="InteractionTime">ساعت تعامل</label>
                                    <input asp-for="InteractionTime" type="time" class="form-control" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label class="form-label" for="DurationMinutes">مدت (دقیقه)</label>
                                    <input asp-for="DurationMinutes" type="number" class="form-control" min="0" placeholder="مثال: 30" />
                                </div>
                            </div>
                        </div>

                        <!-- نتیجه -->
                        <div class="mb-4">
                            <label class="form-label" for="Result">نتیجه تعامل</label>
                            <textarea asp-for="Result" class="form-control" rows="2" placeholder="نتیجه و دستاوردهای این تعامل..."></textarea>
                        </div>

                        <!-- اقدام بعدی -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-4">
                                    <label class="form-label" for="NextAction">اقدام بعدی</label>
                                    <input asp-for="NextAction" class="form-control" placeholder="مثال: ارسال پیشنهاد قیمت" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label class="form-label" for="NextActionDatePersian">تاریخ اقدام بعدی</label>
                                    <input asp-for="NextActionDatePersian" class="form-control js-flatpickr" readonly />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ستون کناری -->
            <div class="col-lg-4">
                <!-- مرحله بعد از خرید (فقط برای مشتریان) -->
                @if (contactType != null && (MahERP.DataModelLayer.Enums.ContactType)contactType == MahERP.DataModelLayer.Enums.ContactType.Customer)
                {
                    <div class="block block-rounded">
                        <div class="block-header block-header-default bg-success">
                            <h3 class="block-title text-white">
                                <i class="fa fa-shopping-cart me-1"></i>
                                مرحله بعد از خرید
                            </h3>
                        </div>
                        <div class="block-content">
                            <select asp-for="PostPurchaseStageId" class="form-select">
                                <option value="">-- انتخاب کنید --</option>
                                @foreach (var stage in Model.PostPurchaseStages)
                                {
                                    <option value="@stage.Id">@stage.Title</option>
                                }
                            </select>
                            <small class="form-text text-muted mt-2">
                                <i class="fa fa-info-circle me-1"></i>
                                مرحله فعلی مشتری در چرخه پس از خرید
                            </small>
                        </div>
                    </div>
                }

                <!-- اهداف مرتبط -->
                @if (Model.AvailableGoals.Any())
                {
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <i class="fa fa-bullseye me-1"></i>
                                اهداف مرتبط <span class="text-danger">*</span>
                            </h3>
                            <div class="block-options">
                                <span class="badge bg-primary">@Model.AvailableGoals.Count هدف</span>
                            </div>
                        </div>
                        <div class="block-content p-0">
                            <!-- جدول اهداف -->
                            <div class="table-responsive">
                                <table class="table table-hover table-vcenter mb-0">
                                    <thead class="bg-body-light">
                                        <tr>
                                            <th style="width: 50px;" class="text-center">
                                                <input type="checkbox" id="selectAllGoals" class="form-check-input" />
                                            </th>
                                            <th>عنوان هدف</th>
                                            <th style="width: 150px;">محصول/خدمت</th>
                                            <th style="width: 120px;" class="text-center">مرحله فعلی</th>
                                        </tr>
                                    </thead>
                                    <tbody id="goalsListContainer">
                                        @foreach (var goal in Model.AvailableGoals)
                                        {
                                            <tr class="goal-row">
                                                <td class="text-center">
                                                    <input class="form-check-input goal-checkbox" 
                                                           type="checkbox" 
                                                           name="GoalIds" 
                                                           value="@goal.Id" 
                                                           id="goal_@goal.Id" />
                                                </td>
                                                <td>
                                                    <label class="fw-semibold mb-0 d-block" for="goal_@goal.Id" style="cursor: pointer;">
                                                        <i class="fa fa-bullseye fa-fw text-primary me-1"></i>
                                                        @goal.Title
                                                    </label>
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(goal.ProductName))
                                                    {
                                                        <small class="text-muted">
                                                            <i class="fa fa-box fa-fw me-1"></i>
                                                            @goal.ProductName
                                                        </small>
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted">-</small>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @if (!string.IsNullOrEmpty(goal.CurrentLeadStageStatusTitle))
                                                    {
                                                        <span class="badge" style="background-color: @(goal.CurrentLeadStageStatusColor ?? "#6c757d")">
                                                            @goal.CurrentLeadStageStatusTitle
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-secondary">نامشخص</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Footer -->
                            <div class="block-content block-content-full bg-body-light border-top">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <small class="text-muted">
                                            <i class="fa fa-info-circle me-1"></i>
                                            حداقل انتخاب یک هدف الزامی است
                                        </small>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn btn-sm btn-alt-primary" onclick="openQuickGoalModal()">
                                            <i class="fa fa-plus me-1"></i>
                                            هدف جدید
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="block block-rounded">
                        <div class="block-header block-header-default bg-warning-light">
                            <h3 class="block-title text-warning">
                                <i class="fa fa-exclamation-triangle me-1"></i>
                                اهداف مرتبط <span class="text-danger">*</span>
                            </h3>
                        </div>
                        <div class="block-content">
                            <div class="alert alert-warning d-flex align-items-center mb-3">
                                <i class="fa fa-exclamation-triangle fa-2x me-3"></i>
                                <div>
                                    <strong>هیچ هدفی تعریف نشده است!</strong>
                                    <p class="mb-0 small">برای ثبت تعامل، ابتدا باید یک هدف تعریف کنید.</p>
                                </div>
                            </div>
                            
                            <!-- Container برای اهداف جدید -->
                            <div id="goalsListContainer" style="display: none;">
                                <div class="table-responsive">
                                    <table class="table table-hover table-vcenter mb-0">
                                        <thead class="bg-body-light">
                                            <tr>
                                                <th style="width: 50px;" class="text-center">
                                                    <input type="checkbox" id="selectAllGoals" class="form-check-input" />
                                                </th>
                                                <th>عنوان هدف</th>
                                                <th style="width: 150px;">محصول/خدمت</th>
                                                <th style="width: 120px;" class="text-center">مرحله فعلی</th>
                                            </tr>
                                        </thead>
                                        <tbody id="goalsTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="text-center py-3">
                                <button type="button" class="btn btn-primary btn-lg" onclick="openQuickGoalModal()">
                                    <i class="fa fa-plus-circle me-2"></i>
                                    تعریف هدف اول
                                </button>
                            </div>
                        </div>
                    </div>
                }

                <!-- ارجاع -->
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">
                            <i class="fa fa-users me-1"></i>
                            ارجاع/توصیه
                        </h3>
                    </div>
                    <div class="block-content">
                        @if (contactType != null && (MahERP.DataModelLayer.Enums.ContactType)contactType == MahERP.DataModelLayer.Enums.ContactType.Customer)
                        {
                            <!-- برای مشتری: معرفی کسی -->
                            <div class="form-check mb-3">
                                <input asp-for="HasReferral" class="form-check-input" type="checkbox" id="hasReferralCheck" />
                                <label asp-for="HasReferral" class="form-check-label">
                                    این مشتری کسی را معرفی کرده
                                </label>
                            </div>
                            <div id="referralSection" style="display: none;">
                                <label class="form-label">فرد معرفی شده</label>
                                <select asp-for="ReferredContactId" class="form-select js-select2-referral" id="referredContactSelect">
                                    <option value="">-- جستجو و انتخاب --</option>
                                </select>
                            </div>
                        }
                        else
                        {
                            <!-- برای لید: معرفی شده توسط -->
                            <div class="form-check mb-3">
                                <input asp-for="IsReferred" class="form-check-input" type="checkbox" id="isReferredCheck" />
                                <label asp-for="IsReferred" class="form-check-label">
                                    این لید توسط کسی معرفی شده
                                </label>
                            </div>
                            <div id="referrerSection" style="display: none;">
                                <label class="form-label">معرف (مشتری)</label>
                                <select asp-for="ReferrerContactId" class="form-select js-select2-referral" id="referrerContactSelect">
                                    <option value="">-- جستجو و انتخاب --</option>
                                </select>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- دکمه‌های عملیات -->
        <div class="block block-rounded">
            <div class="block-content block-content-full bg-body-light">
                <div class="d-flex justify-content-between">
                    <a asp-action="Index" class="btn btn-alt-secondary">
                        <i class="fa fa-arrow-right me-1"></i>
                        انصراف
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-check me-1"></i>
                        ثبت تعامل
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
<!-- END Page Content -->

@section Scripts {

    <!-- ⭐ QuickAdd Helper Script -->
    <script src="~/assets/js/crm/quickaddhelper.js"></script>

    <script>
        $(document).ready(function() {
            // ⭐⭐⭐ DEBUG: نمایش debug info
            var branchIdValue = $('#selectedBranchId').val();
            $('#hiddenBranchValue').text(branchIdValue || 'empty');
            
            console.log('🔍 Page loaded - Debug Info:');
            console.log('  - Hidden input #selectedBranchId:', branchIdValue);
            console.log('  - Model.BranchId:', '@(Model.BranchId?.ToString() ?? "null")');
            console.log('  - ViewBag.DefaultBranchId:', '@(ViewBag.DefaultBranchId?.ToString() ?? "null")');
            
            // نمایش debug panel (فقط برای development)
            if (window.location.hostname === 'localhost') {
                $('#debugInfo').show();
            }
            
            // Persian Datepicker
            Dashmix.helpersOnLoad(['js-flatpickr']);
            
            // ⭐ هایلایت کردن سطر انتخاب شده
            $(document).on('change', '.goal-checkbox', function() {
                if ($(this).is(':checked')) {
                    $(this).closest('tr').addClass('selected');
                } else {
                    $(this).closest('tr').removeClass('selected');
                }
                
                // بروزرسانی checkbox "انتخاب همه"
                var totalGoals = $('.goal-checkbox').length;
                var selectedGoals = $('.goal-checkbox:checked').length;
                $('#selectAllGoals').prop('checked', totalGoals === selectedGoals);
            });
            
            // ⭐ انتخاب/عدم انتخاب همه اهداف
            $('#selectAllGoals').on('change', function() {
                var isChecked = $(this).is(':checked');
                $('.goal-checkbox').prop('checked', isChecked).trigger('change');
            });
            
            // کلیک روی سطر برای انتخاب
            $(document).on('click', '.goal-row td:not(:first-child)', function() {
                var $checkbox = $(this).closest('tr').find('.goal-checkbox');
                $checkbox.prop('checked', !$checkbox.is(':checked')).trigger('change');
            });
            
            // نمایش مرحله لید
            $('#interactionTypeSelect').on('change', function() {
                var selectedOption = $(this).find('option:selected');
                var stage = selectedOption.data('stage');
                var stageColor = selectedOption.data('stage-color');
                
                if (stage) {
                    $('#leadStageText').text(stage).css('background-color', stageColor || '#6c757d');
                    $('#leadStageInfo').show();
                } else {
                    $('#leadStageInfo').hide();
                }
            });
            
            // ارجاع - مشتری معرفی کرده
            $('#hasReferralCheck').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#referralSection').slideDown();
                } else {
                    $('#referralSection').slideUp();
                    $('#referredContactSelect').val('').trigger('change');
                }
            });
            
            // ارجاع - لید معرفی شده
            $('#isReferredCheck').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#referrerSection').slideDown();
                } else {
                    $('#referrerSection').slideUp();
                    $('#referrerContactSelect').val('').trigger('change');
                }
            });
            
            // Select2 برای جستجوی ارجاع
            $('.js-select2-referral').select2({
                width: '100%',
                placeholder: 'جستجو...',
                allowClear: true,
                ajax: {
                    url: '@Url.Action("SearchContacts", "CrmAjax", new { area = "CrmArea" })',
                    dataType: 'json',
                    delay: 300,
                    data: function(params) {
                        return { term: params.term };
                    },
                    processResults: function(data) {
                        return { results: data.results };
                    }
                }
            });
            
            // ⭐ مقداردهی اولیه - علامت‌گذاری سطرهای انتخاب شده
            $('.goal-checkbox:checked').each(function() {
                $(this).closest('tr').addClass('selected');
            });
        });

        // تابع باز کردن مودال هدف جدید
        function openQuickGoalModal() {
            var contactId = $('#selectedContactId').val() || @Model.ContactId;
            var organizationId = $('#selectedOrganizationId').val() || @(Model.OrganizationId ?? 0);
            var currentUrl = window.location.href;
            
            createAndShowModal({
                url: '@Url.Action("CreateQuickModal", "Goal", new { area = "CrmArea" })' + 
                     '?contactId=' + contactId + 
                     '&organizationId=' + organizationId +
                     '&returnUrl=' + encodeURIComponent(currentUrl),
                onHidden: function() {
                    // Modal بسته شد
                }
            });
        }

        // ⭐ تابع باز کردن QuickAdd برای افزودن Contact/Organization
        function openQuickAddModalForInteraction() {
            // ⭐⭐⭐ DEBUG: چک کردن تمام منابع
            console.log('🔍 Checking BranchId sources:');
            console.log('  - selectedBranchId input:', $('#selectedBranchId').val());
            console.log('  - BranchId input:', $('#BranchId').val());
            console.log('  - Model.BranchId:', @(Model.BranchId ?? 0));
            console.log('  - ViewBag.DefaultBranchId:', @(ViewBag.DefaultBranchId ?? 0));
            
            // ⭐⭐⭐ دریافت BranchId از منابع مختلف (به ترتیب اولویت)
            var branchId = $('#selectedBranchId').val() ||          // از hidden input
                          $('#BranchId').val() ||                   // از form field
                          @(Model.BranchId ?? 0) ||                 // از Model
                          @(ViewBag.DefaultBranchId ?? 0);          // از ViewBag (Controller)
            
            // ⭐ تبدیل به عدد
            branchId = parseInt(branchId) || 0;
            
            var organizationId = $('#selectedOrganizationId').val() || 
                                @(Model.OrganizationId ?? 0) || 
                                null;
            
            console.log('🎯 QuickAdd - Final BranchId:', branchId, '(type:', typeof branchId, ')');
            console.log('🎯 QuickAdd - OrganizationId:', organizationId);
            
            // ⭐ اگر هنوز BranchId نداریم، خطا نمایش بده
            if (!branchId || branchId === 0) {
                console.error('❌ BranchId is invalid:', branchId);
                
                // ⭐⭐⭐ آخرین تلاش: از Contact گرفتن BranchId
                var contactId = @Model.ContactId;
                if (contactId > 0) {
                    console.log('🔄 Trying to get BranchId from Contact...');
                    $.ajax({
                        url: '@Url.Action("GetContactBranch", "CrmAjax", new { area = "CrmArea" })',
                        type: 'GET',
                        data: { contactId: contactId },
                        async: false, // Synchronous برای سادگی
                        success: function(response) {
                            if (response && response.branchId) {
                                branchId = response.branchId;
                                console.log('✅ Got BranchId from Contact:', branchId);
                            }
                        }
                    });
                }
                
                // اگر هنوز صفر هست، خطا
                if (!branchId || branchId === 0) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: 'شعبه مشخص نیست',
                            html: 'برای استفاده از QuickAdd، باید به حداقل یک شعبه دسترسی داشته باشید.<br><br>' +
                                  'لطفاً با مدیر سیستم تماس بگیرید.',
                            icon: 'warning',
                            confirmButtonText: 'متوجه شدم'
                        });
                    } else {
                        alert('شعبه مشخص نیست! لطفاً با مدیر سیستم تماس بگیرید.');
                    }
                    return;
                }
            }
            
            console.log('✅ Opening QuickAdd with BranchId:', branchId);
            openQuickAddModal(branchId, organizationId);
        }

        // ⭐ Override کردن callback بعد از QuickAdd
        window.onQuickAddComplete = function(type, response) {
            if (type === 'contact') {
                // انتخاب خودکار Contact در صفحه Interaction Create
                $('#selectedContactId').val(response.contactId);
                
                // نمایش اطلاعات Contact
                NotificationHelper.success(`فرد "${response.contactName}" با موفقیت ایجاد و انتخاب شد`);
                
                // Reload صفحه با Contact جدید
                window.location.href = '@Url.Action("Create", "Interaction", new { area = "CrmArea" })' + 
                                      '?contactId=' + response.contactId;
            } else if (type === 'organization') {
                // انتخاب خودکار Organization
                $('#selectedOrganizationId').val(response.organizationId);
                
                NotificationHelper.success(`سازمان "${response.organizationName}" با موفقیت ایجاد شد`);
                
                // می‌تونید Organization رو هم Reload کنید
                // window.location.href = '...?organizationId=' + response.organizationId;
            }
        };
    </script>
}
