@using MahERP.DataModelLayer.ViewModels.taskingModualsViewModels.AcControl
@using MahERP.DataModelLayer.ViewModels.CrmViewModels
@{
    ViewData["Title"] = "تعاملات";
    var userBranches = ViewBag.UserBranches as List<BranchViewModel> ?? new List<BranchViewModel>();
    var hasSingleBranch = ViewBag.HasSingleBranch as bool? ?? false;
    var defaultBranchId = ViewBag.DefaultBranchId as int?;
    var defaultBranchName = ViewBag.DefaultBranchName as string;
    var recentInteractions = ViewBag.RecentInteractions as List<RecentInteractionItemViewModel> ?? new List<RecentInteractionItemViewModel>();
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-comments text-primary me-2"></i>
                تعاملات
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">CRM</li>
                    <li class="breadcrumb-item active">تعاملات</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <div class="row">
        <!-- ستون اصلی -->
        <div class="col-lg-9">
            <!-- انتخاب شعبه و Stakeholder -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-filter me-1"></i>
                        انتخاب شعبه و مخاطب
                    </h3>
                </div>
                <div class="block-content">
                    <div class="row g-3">
                        <!-- انتخاب شعبه -->
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fa fa-building me-1"></i>
                                شعبه
                            </label>
                            @if (hasSingleBranch && defaultBranchId.HasValue)
                            {
                                <div class="form-control bg-body-light">
                                    <i class="fa fa-check-circle text-success me-1"></i>
                                    @defaultBranchName
                                </div>
                                <input type="hidden" id="selectedBranchId" value="@defaultBranchId" />
                            }
                            else
                            {
                                <select id="branchSelector" class="form-select js-select2">
                                    <option value="">انتخاب شعبه...</option>
                                    @foreach (var branch in userBranches)
                                    {
                                        <option value="@branch.Id">
                                            @branch.Name
                                            @if (branch.IsMainBranch)
                                            {
                                                @(" (اصلی)")
                                            }
                                        </option>
                                    }
                                </select>
                                <input type="hidden" id="selectedBranchId" value="" />
                            }
                        </div>

                        <!-- نوع مخاطب -->
                        <div class="col-md-3" id="stakeholderTypeCol" style="@(hasSingleBranch ? "" : "display: none;")">
                            <label class="form-label fw-semibold">
                                <i class="fa fa-user-tag me-1"></i>
                                نوع مخاطب
                            </label>
                            <select id="stakeholderTypeSelector" class="form-select">
                                <option value="contact">فرد</option>
                                <option value="organization">سازمان</option>
                            </select>
                        </div>

                        <!-- انتخاب مخاطب -->
                        <div class="col-md-5" id="stakeholderSelectCol" style="@(hasSingleBranch ? "" : "display: none;")">
                            <label class="form-label fw-semibold">
                                <i class="fa fa-search me-1"></i>
                                جستجو و انتخاب
                            </label>
                            <div id="contactSelectDiv" style="display: block;">
                                <select id="contactSelector" class="form-select js-select2-ajax" 
                                        data-placeholder="جستجوی فرد...">
                                </select>
                            </div>
                            <div id="organizationSelectDiv" style="display: none;">
                                <select id="organizationSelector" class="form-select js-select2-ajax"
                                        data-placeholder="جستجوی سازمان...">
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- محتوای تعاملات Stakeholder -->
            <div id="stakeholderContentArea">
                <!-- این بخش با AJAX پر می‌شود -->
                <div class="block block-rounded">
                    <div class="block-content text-center py-5">
                        <i class="fa fa-hand-pointer fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">لطفاً یک شعبه و مخاطب انتخاب کنید</h4>
                        <p class="text-muted small">پس از انتخاب، تعاملات مرتبط نمایش داده خواهد شد</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ستون کناری - 10 تعامل اخیر -->
        <div class="col-lg-3">
            <div class="block block-rounded">
                <div class="block-header block-header-default bg-primary-dark">
                    <h3 class="block-title text-white">
                        <i class="fa fa-clock me-1"></i>
                        تعاملات اخیر
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn-block-option text-white" onclick="refreshRecentInteractions()" title="بروزرسانی">
                            <i class="fa fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content p-0" id="recentInteractionsSidebar">
                    @await Html.PartialAsync("_RecentInteractionsSidebar", new RecentInteractionsViewModel { Interactions = recentInteractions })
                </div>
            </div>

            <!-- دکمه ثبت تعامل جدید -->
            <div class="block block-rounded bg-success-light">
                <div class="block-content text-center py-4">
                    <a asp-action="Create" class="btn btn-success btn-lg">
                        <i class="fa fa-plus-circle me-2"></i>
                        ثبت تعامل جدید
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END Page Content -->

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize Select2
            initializeSelect2();
            
            // Event handlers
            setupEventHandlers();
            
            // اگر شعبه پیش‌فرض داریم، فعال کن
            @if (hasSingleBranch && defaultBranchId.HasValue)
            {
                <text>
                $('#stakeholderTypeCol, #stakeholderSelectCol').show();
                </text>
            }
        });

        function initializeSelect2() {
            $('.js-select2').select2({
                width: '100%',
                allowClear: true
            });

            // Contact selector با AJAX
            $('#contactSelector').select2({
                width: '100%',
                allowClear: true,
                placeholder: 'جستجوی فرد...',
                ajax: {
                    url: '@Url.Action("SearchContacts", "CrmAjax", new { area = "CrmArea" })',
                    dataType: 'json',
                    delay: 300,
                    data: function(params) {
                        return {
                            term: params.term,
                            branchId: $('#selectedBranchId').val() || $('#branchSelector').val()
                        };
                    },
                    processResults: function(data) {
                        return { results: data.results || [] };
                    }
                }
            });

            // Organization selector با AJAX
            $('#organizationSelector').select2({
                width: '100%',
                allowClear: true,
                placeholder: 'جستجوی سازمان...',
                ajax: {
                    url: '@Url.Action("SearchOrganizations", "CrmAjax", new { area = "CrmArea" })',
                    dataType: 'json',
                    delay: 300,
                    data: function(params) {
                        return {
                            term: params.term,
                            branchId: $('#selectedBranchId').val() || $('#branchSelector').val()
                        };
                    },
                    processResults: function(data) {
                        return { results: data.results || [] };
                    }
                }
            });
        }

        function setupEventHandlers() {
            // تغییر شعبه
            $('#branchSelector').on('change', function() {
                var branchId = $(this).val();
                $('#selectedBranchId').val(branchId);
                
                if (branchId) {
                    $('#stakeholderTypeCol, #stakeholderSelectCol').fadeIn();
                    // Reset selectors
                    $('#contactSelector, #organizationSelector').val(null).trigger('change');
                    clearStakeholderContent();
                } else {
                    $('#stakeholderTypeCol, #stakeholderSelectCol').fadeOut();
                    clearStakeholderContent();
                }
            });

            // تغییر نوع مخاطب
            $('#stakeholderTypeSelector').on('change', function() {
                var type = $(this).val();
                if (type === 'contact') {
                    $('#contactSelectDiv').show();
                    $('#organizationSelectDiv').hide();
                    $('#organizationSelector').val(null).trigger('change');
                } else {
                    $('#contactSelectDiv').hide();
                    $('#organizationSelectDiv').show();
                    $('#contactSelector').val(null).trigger('change');
                }
                clearStakeholderContent();
            });

            // انتخاب Contact
            $('#contactSelector').on('change', function() {
                var contactId = $(this).val();
                if (contactId) {
                    loadStakeholderContent(contactId, null);
                } else {
                    clearStakeholderContent();
                }
            });

            // انتخاب Organization
            $('#organizationSelector').on('change', function() {
                var orgId = $(this).val();
                if (orgId) {
                    loadStakeholderContent(null, orgId);
                } else {
                    clearStakeholderContent();
                }
            });
        }

        function loadStakeholderContent(contactId, organizationId) {
            var branchId = $('#selectedBranchId').val() || $('#branchSelector').val();
            
            $('#stakeholderContentArea').html('<div class="block block-rounded block-mode-loading"><div class="block-content text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-3 text-muted">در حال بارگذاری...</p></div></div>');
            
            $.ajax({
                url: '@Url.Action("LoadStakeholderContent", "Interaction", new { area = "CrmArea" })',
                type: 'POST',
                data: {
                    contactId: contactId,
                    organizationId: organizationId,
                    branchId: branchId,
                    __RequestVerificationToken: getAntiForgeryToken()
                },
                success: function(html) {
                    $('#stakeholderContentArea').html(html);
                    // Initialize any new Select2 or datepickers
                    DynamicSelect2Manager.reinitializeSelect2InDiv($('#stakeholderContentArea'));
                },
                error: function(xhr) {
                    $('#stakeholderContentArea').html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle me-2"></i>خطا در بارگذاری اطلاعات</div>');
                    console.error('Error loading stakeholder content:', xhr);
                }
            });
        }

        function clearStakeholderContent() {
            $('#stakeholderContentArea').html(`
                <div class="block block-rounded">
                    <div class="block-content text-center py-5">
                        <i class="fa fa-hand-pointer fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">لطفاً یک مخاطب انتخاب کنید</h4>
                        <p class="text-muted small">پس از انتخاب، تعاملات مرتبط نمایش داده خواهد شد</p>
                    </div>
                </div>
            `);
        }

        function refreshRecentInteractions() {
            $.get('@Url.Action("GetRecentInteractions", "Interaction", new { area = "CrmArea" })', function(html) {
                $('#recentInteractionsSidebar').html(html);
            });
        }

        // تابع بارگذاری تعاملات یک هدف
        function loadGoalInteractions(goalId, page) {
            page = page || 1;
            var $container = $('#goalInteractionsContainer_' + goalId);
            
            $container.addClass('block-mode-loading');
            
            $.ajax({
                url: '@Url.Action("LoadGoalInteractions", "Interaction", new { area = "CrmArea" })',
                type: 'POST',
                data: {
                    goalId: goalId,
                    page: page,
                    __RequestVerificationToken: getAntiForgeryToken()
                },
                success: function(html) {
                    $container.html(html);
                    $container.removeClass('block-mode-loading');
                },
                error: function() {
                    $container.removeClass('block-mode-loading');
                    NotificationHelper.error('خطا در بارگذاری تعاملات');
                }
            });
        }

        // تابع بارگذاری تعاملات Contact (بدون هدف)
        function loadContactInteractions(contactId, page) {
            page = page || 1;
            var $container = $('#contactInteractionsContainer');
            
            $container.addClass('block-mode-loading');
            
            $.ajax({
                url: '@Url.Action("LoadContactInteractions", "Interaction", new { area = "CrmArea" })',
                type: 'POST',
                data: {
                    contactId: contactId,
                    page: page,
                    __RequestVerificationToken: getAntiForgeryToken()
                },
                success: function(html) {
                    $container.html(html);
                    $container.removeClass('block-mode-loading');
                },
                error: function() {
                    $container.removeClass('block-mode-loading');
                    NotificationHelper.error('خطا در بارگذاری تعاملات');
                }
            });
        }
    </script>
}
