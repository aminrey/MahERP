@using MahERP.DataModelLayer.ViewModels.taskingModualsViewModels.AcControl
@{
    ViewData["Title"] = "ثبت تعامل جدید - انتخاب مخاطب";
    var userBranches = ViewBag.UserBranches as List<BranchViewModel> ?? new List<BranchViewModel>();
    var hasSingleBranch = ViewBag.HasSingleBranch as bool? ?? false;
    var defaultBranchId = ViewBag.DefaultBranchId as int?;
    var defaultBranchName = ViewBag.DefaultBranchName as string;
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-handshake text-primary me-2"></i>
                ثبت تعامل جدید
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">CRM</li>
                    <li class="breadcrumb-item">
                        <a asp-action="Index">تعاملات</a>
                    </li>
                    <li class="breadcrumb-item active">انتخاب مخاطب</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content content-full">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">

            <!-- مرحله 1: انتخاب شعبه -->
            <div class="block block-rounded" id="step1Block">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <span class="badge bg-primary rounded-circle me-2">1</span>
                        انتخاب شعبه
                    </h3>
                </div>
                <div class="block-content">
                    @if (!userBranches.Any())
                    {
                        <div class="alert alert-warning d-flex align-items-center">
                            <i class="fa fa-exclamation-triangle fa-2x me-3"></i>
                            <div>
                                <strong>خطا:</strong> شما در هیچ شعبه‌ای تعریف نشده‌اید.
                                <br />
                                <small>لطفاً با مدیر سیستم تماس بگیرید.</small>
                            </div>
                        </div>
                    }
                    else if (hasSingleBranch && defaultBranchId.HasValue)
                    {
                        <div class="alert alert-info d-flex align-items-center mb-0">
                            <i class="fa fa-building fa-2x me-3"></i>
                            <div>
                                <strong>شعبه شما:</strong> @defaultBranchName
                                <br />
                                <small class="text-muted">شما فقط در یک شعبه عضو هستید</small>
                            </div>
                        </div>
                        <input type="hidden" id="selectedBranchId" value="@defaultBranchId" />
                    }
                    else
                    {
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                شعبه مورد نظر را انتخاب کنید <span class="text-danger">*</span>
                            </label>
                            <select id="branchSelector" class="form-select" style="width: 100%;">
                                <option value="">انتخاب شعبه...</option>
                                @foreach (var branch in userBranches)
                                {
                                    <option value="@branch.Id">
                                        @branch.Name
                                        @if (branch.IsMainBranch)
                                        {
                                            @(" (شعبه اصلی)")
                                        }
                                    </option>
                                }
                            </select>
                        </div>
                        <input type="hidden" id="selectedBranchId" value="" />
                    }
                </div>
            </div>

            <!-- مرحله 2: انتخاب نوع مخاطب -->
            <div class="block block-rounded" id="step2Block" style="@(hasSingleBranch ? "" : "display: none;")">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <span class="badge bg-primary rounded-circle me-2">2</span>
                        انتخاب نوع مخاطب
                    </h3>
                </div>
                <div class="block-content">
                    <p class="text-muted mb-4">
                        <i class="fa fa-info-circle me-1"></i>
                        آیا تعامل با فرد مستقیم است یا از طریق سازمان؟
                    </p>

                    <!-- Tab Navigation -->
                    <ul class="nav nav-pills mb-4" id="contactTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="direct-contact-tab" data-bs-toggle="pill" data-bs-target="#directContactPanel" type="button" role="tab">
                                <i class="fa fa-user me-1"></i>
                                فرد مستقیم
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="via-organization-tab" data-bs-toggle="pill" data-bs-target="#viaOrganizationPanel" type="button" role="tab">
                                <i class="fa fa-building me-1"></i>
                                از طریق سازمان
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <!-- Panel 1: فرد مستقیم -->
                        <div class="tab-pane fade show active" id="directContactPanel" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-semibold">انتخاب فرد</label>
                                <button type="button" class="btn btn-sm btn-alt-primary" onclick="openQuickAddForSelectContact('contact')" title="افزودن سریع فرد جدید">
                                    <i class="fa fa-user-plus me-1"></i>
                                    افزودن سریع
                                </button>
                            </div>
                            <select id="directContactSelect" class="form-select" style="width: 100%;">
                                <option value="">جستجو و انتخاب فرد...</option>
                            </select>
                            <small class="form-text text-muted mt-2">
                                <i class="fa fa-info-circle me-1"></i>
                                افراد تعریف شده در شعبه انتخاب شده
                            </small>

                            <!-- دکمه ادامه برای فرد مستقیم -->
                            <div class="mt-4" id="directContinueSection" style="display: none;">
                                <button type="button" class="btn btn-primary w-100" onclick="continueWithDirectContact()">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    ادامه ثبت تعامل
                                </button>
                            </div>
                        </div>

                        <!-- Panel 2: از طریق سازمان -->
                        <div class="tab-pane fade" id="viaOrganizationPanel" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0 fw-semibold">انتخاب سازمان</label>
                                <button type="button" class="btn btn-sm btn-alt-success" onclick="openQuickAddForSelectContact('organization')" title="افزودن سریع سازمان جدید">
                                    <i class="fa fa-building me-1"></i>
                                    افزودن سریع
                                </button>
                            </div>
                            <select id="organizationSelect" class="form-select" style="width: 100%;">
                                <option value="">جستجو و انتخاب سازمان...</option>
                            </select>
                            <small class="form-text text-muted mt-2">
                                <i class="fa fa-info-circle me-1"></i>
                                سازمان‌های تعریف شده در شعبه انتخاب شده
                            </small>

                            <!-- بخش انتخاب فرد از سازمان -->
                            <div id="organizationMembersSection" class="mt-4" style="display: none;">
                                <div class="border rounded p-3 bg-body-light">
                                    <h6 class="mb-3">
                                        <i class="fa fa-users text-primary me-1"></i>
                                        انتخاب فردی که تعامل با او صورت گرفته
                                        <span class="text-danger">*</span>
                                    </h6>
                                    <div id="organizationMembersList">
                                        <!-- محتوا از AJAX بارگذاری می‌شود -->
                                    </div>
                                </div>
                            </div>

                            <!-- دکمه ادامه برای سازمان -->
                            <div class="mt-4" id="orgContinueSection" style="display: none;">
                                <button type="button" class="btn btn-primary w-100" onclick="continueWithOrganization()">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    ادامه ثبت تعامل
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- راهنما -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-lightbulb me-1"></i>
                        راهنما
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn-block-option" data-toggle="block-option" data-action="content_toggle"></button>
                    </div>
                </div>
                <div class="block-content">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="fw-semibold mb-2">تعامل چیست؟</p>
                            <p class="text-muted small">
                                تعامل هر نوع ارتباط با مخاطب است: تماس تلفنی، جلسه حضوری، ایمیل، پیامک و...
                                ثبت تعاملات به شما کمک می‌کند تاریخچه ارتباط با هر مخاطب را پیگیری کنید.
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="fw-semibold mb-2">فرد مستقیم vs از طریق سازمان:</p>
                            <ul class="text-muted small mb-0">
                                <li><strong>فرد مستقیم:</strong> وقتی تعامل با شخص حقیقی مستقل است</li>
                                <li><strong>از طریق سازمان:</strong> وقتی تعامل در قالب یک سازمان انجام شده و باید مشخص شود با کدام عضو صحبت شده</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<!-- END Page Content -->

<!-- Modal برای افزودن سریع -->
<div class="modal fade" id="quickAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" id="quickAddModalContent">
            <!-- محتوا به صورت داینامیک بارگذاری می‌شود -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // متغیرهای global
        var selectedBranchId = '@(defaultBranchId ?? 0)';
        var selectedOrganizationId = null;
        var selectedContactId = null;
        var selectedOrganizationMemberId = null;

        $(document).ready(function() {
            // راه‌اندازی Select2
            initSelect2();

            // اگر فقط یک شعبه داریم، داده‌ها رو لود کن
            if (selectedBranchId && selectedBranchId !== '0') {
                loadBranchData(selectedBranchId);
            }

            // رویداد تغییر شعبه
            $('#branchSelector').on('change', function() {
                selectedBranchId = $(this).val();
                $('#selectedBranchId').val(selectedBranchId);

                if (selectedBranchId) {
                    loadBranchData(selectedBranchId);
                    $('#step2Block').slideDown();
                } else {
                    $('#step2Block').slideUp();
                    clearSelections();
                }
            });

            // رویداد تغییر فرد مستقیم
            $('#directContactSelect').on('change', function() {
                selectedContactId = $(this).val();
                if (selectedContactId) {
                    $('#directContinueSection').slideDown();
                } else {
                    $('#directContinueSection').slideUp();
                }
            });

            // رویداد تغییر سازمان
            $('#organizationSelect').on('change', function() {
                selectedOrganizationId = $(this).val();
                selectedOrganizationMemberId = null;

                if (selectedOrganizationId) {
                    loadOrganizationMembers(selectedOrganizationId);
                } else {
                    $('#organizationMembersSection').slideUp();
                    $('#orgContinueSection').slideUp();
                }
            });

            // وقتی تب عوض میشه، انتخاب‌های قبلی پاک بشه
            $('button[data-bs-toggle="pill"]').on('shown.bs.tab', function(e) {
                var target = $(e.target).attr('data-bs-target');

                if (target === '#directContactPanel') {
                    selectedOrganizationId = null;
                    selectedOrganizationMemberId = null;
                    $('#organizationSelect').val('').trigger('change.select2');
                    $('#organizationMembersSection').hide();
                    $('#orgContinueSection').hide();
                } else {
                    selectedContactId = null;
                    $('#directContactSelect').val('').trigger('change.select2');
                    $('#directContinueSection').hide();
                }
            });
        });

        function initSelect2() {
            // Select2 برای شعبه
            if ($('#branchSelector').length && !$('#branchSelector').hasClass('select2-hidden-accessible')) {
                $('#branchSelector').select2({
                    width: '100%',
                    placeholder: 'انتخاب شعبه...',
                    allowClear: true,
                    dir: 'rtl'
                });
            }
            
            // Select2 برای فرد مستقیم
            if ($('#directContactSelect').length && !$('#directContactSelect').hasClass('select2-hidden-accessible')) {
                $('#directContactSelect').select2({
                    width: '100%',
                    placeholder: 'جستجو و انتخاب فرد...',
                    allowClear: true,
                    dir: 'rtl'
                });
            }
            
            // Select2 برای سازمان
            if ($('#organizationSelect').length && !$('#organizationSelect').hasClass('select2-hidden-accessible')) {
                $('#organizationSelect').select2({
                    width: '100%',
                    placeholder: 'جستجو و انتخاب سازمان...',
                    allowClear: true,
                    dir: 'rtl'
                });
            }
        }

        function loadBranchData(branchId) {
            console.log('📍 Loading branch data for branchId:', branchId);
            
            // بارگذاری افراد شعبه
            $.ajax({
                url: '@Url.Action("GetBranchContacts", "CrmAjax", new { area = "CrmArea" })',
                data: { branchId: branchId },
                success: function(data) {
                    console.log('✅ Contacts loaded:', data);
                    
                    var $select = $('#directContactSelect');
                    
                    // Destroy Select2 قبلی
                    if ($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('destroy');
                    }
                    
                    $select.empty().append('<option value="">جستجو و انتخاب فرد...</option>');

                    if (data && data.length > 0) {
                        data.forEach(function(contact) {
                            var typeBadge = contact.contactType === 1 ? ' [مشتری]' : contact.contactType === 0 ? ' [سرنخ]' : '';
                            $select.append(new Option(contact.fullName + typeBadge, contact.id));
                        });
                    }

                    // Re-init Select2
                    $select.select2({
                        width: '100%',
                        placeholder: 'جستجو و انتخاب فرد...',
                        allowClear: true,
                        dir: 'rtl'
                    });
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error loading contacts:', error);
                }
            });

            // بارگذاری سازمان‌های شعبه
            $.ajax({
                url: '@Url.Action("GetBranchOrganizations", "CrmAjax", new { area = "CrmArea" })',
                data: { branchId: branchId },
                success: function(data) {
                    console.log('✅ Organizations loaded:', data);
                    
                    var $select = $('#organizationSelect');
                    
                    // Destroy Select2 قبلی
                    if ($select.hasClass('select2-hidden-accessible')) {
                        $select.select2('destroy');
                    }
                    
                    $select.empty().append('<option value="">جستجو و انتخاب سازمان...</option>');

                    if (data && data.length > 0) {
                        data.forEach(function(org) {
                            var text = org.name;
                            if (org.registrationNumber) {
                                text += ' (ثبت: ' + org.registrationNumber + ')';
                            }
                            $select.append(new Option(text, org.id));
                        });
                    }

                    // Re-init Select2
                    $select.select2({
                        width: '100%',
                        placeholder: 'جستجو و انتخاب سازمان...',
                        allowClear: true,
                        dir: 'rtl'
                    });
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error loading organizations:', error);
                }
            });
        }

        function loadOrganizationMembers(organizationId) {
            console.log('🏢 Loading members for organizationId:', organizationId);
            
            $('#organizationMembersList').html(`
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted small">در حال دریافت اعضای سازمان...</p>
                </div>
            `);
            $('#organizationMembersSection').slideDown();

            $.ajax({
                url: '@Url.Action("GetOrganizationMembers", "Interaction", new { area = "CrmArea" })',
                data: { organizationId: organizationId },
                success: function(response) {
                    console.log('✅ Organization members response:', response);
                    
                    if (response.success && response.members && response.members.length > 0) {
                        var html = '<div class="list-group">';
                        response.members.forEach(function(member, index) {
                            var position = member.positionTitle ? member.positionTitle : '';
                            var department = member.departmentName ? ' - ' + member.departmentName : '';
                            var subtitle = position + department;

                            html += `
                                <label class="list-group-item list-group-item-action d-flex align-items-center">
                                    <input class="form-check-input me-3" type="radio" name="organizationMember" 
                                           value="${member.contactId}" 
                                           onchange="selectOrganizationMember(${member.contactId})"
                                           ${index === 0 ? '' : ''}>
                                    <div>
                                        <span class="fw-semibold">${member.contactFullName}</span>
                                        ${subtitle ? '<br><small class="text-muted">' + subtitle + '</small>' : ''}
                                    </div>
                                </label>
                            `;
                        });
                        html += '</div>';
                        html += `<p class="text-muted small mt-2 mb-0"><i class="fa fa-info-circle me-1"></i>${response.totalCount} عضو یافت شد</p>`;
                        $('#organizationMembersList').html(html);
                    } else {
                        $('#organizationMembersList').html(`
                            <div class="alert alert-warning mb-0">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                <strong>هیچ عضوی در این سازمان تعریف نشده است.</strong>
                                <br />
                                <small class="d-block mt-2">
                                    برای تعریف اعضای سازمان:
                                    <ol class="mb-0 mt-1">
                                        <li>به بخش "سازمان‌ها" بروید</li>
                                        <li>سازمان مورد نظر را انتخاب کنید</li>
                                        <li>از منوی "چارت سازمانی" اعضا را اضافه کنید</li>
                                        <li>یا از منوی "روابط با افراد" فرد مرتبط اضافه کنید</li>
                                    </ol>
                                </small>
                            </div>
                        `);
                        $('#orgContinueSection').slideUp();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error loading organization members:', error);
                    $('#organizationMembersList').html(`
                        <div class="alert alert-danger mb-0">
                            <i class="fa fa-times-circle me-2"></i>
                            خطا در دریافت اعضای سازمان
                            <br>
                            <small>${error}</small>
                        </div>
                    `);
                }
            });
        }

        function selectOrganizationMember(contactId) {
            selectedOrganizationMemberId = contactId;
            console.log('👤 Selected member:', contactId);
            $('#orgContinueSection').slideDown();
        }

        function clearSelections() {
            selectedOrganizationId = null;
            selectedContactId = null;
            selectedOrganizationMemberId = null;
            
            if ($('#directContactSelect').hasClass('select2-hidden-accessible')) {
                $('#directContactSelect').val('').trigger('change.select2');
            }
            if ($('#organizationSelect').hasClass('select2-hidden-accessible')) {
                $('#organizationSelect').val('').trigger('change.select2');
            }
            
            $('#organizationMembersSection, #directContinueSection, #orgContinueSection').hide();
        }

        function continueWithDirectContact() {
            if (!selectedContactId) {
                if (typeof NotificationHelper !== 'undefined') {
                    NotificationHelper.warning('لطفاً یک فرد انتخاب کنید');
                } else {
                    alert('لطفاً یک فرد انتخاب کنید');
                }
                return;
            }

            window.location.href = '@Url.Action("Create", "Interaction", new { area = "CrmArea" })' +
                '?contactId=' + selectedContactId +
                '&branchId=' + selectedBranchId;
        }

        function continueWithOrganization() {
            if (!selectedOrganizationId) {
                if (typeof NotificationHelper !== 'undefined') {
                    NotificationHelper.warning('لطفاً یک سازمان انتخاب کنید');
                } else {
                    alert('لطفاً یک سازمان انتخاب کنید');
                }
                return;
            }

            if (!selectedOrganizationMemberId) {
                if (typeof NotificationHelper !== 'undefined') {
                    NotificationHelper.warning('لطفاً فردی که تعامل با او صورت گرفته را انتخاب کنید');
                } else {
                    alert('لطفاً فردی که تعامل با او صورت گرفته را انتخاب کنید');
                }
                return;
            }

            window.location.href = '@Url.Action("Create", "Interaction", new { area = "CrmArea" })' +
                '?contactId=' + selectedOrganizationMemberId +
                '&organizationId=' + selectedOrganizationId +
                '&branchId=' + selectedBranchId;
        }

        // ⭐⭐⭐ تابع QuickAdd برای SelectContact
        function openQuickAddForSelectContact(type) {
            console.log('🎯 openQuickAddForSelectContact called with type:', type);
            console.log('   - selectedBranchId:', selectedBranchId);
            
            // بررسی BranchId
            if (!selectedBranchId || selectedBranchId === '0' || selectedBranchId === 0) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'خطا',
                        text: 'لطفاً ابتدا شعبه را انتخاب کنید',
                        icon: 'warning',
                        confirmButtonText: 'باشه'
                    });
                } else {
                    alert('لطفاً ابتدا شعبه را انتخاب کنید');
                }
                return;
            }
            
            // تبدیل به عدد
            var branchId = parseInt(selectedBranchId);
            
            console.log('✅ Opening QuickAdd with branchId:', branchId, 'type:', type);
            
            // باز کردن Modal مناسب
            if (type === 'contact') {
                openQuickAddContact(branchId, null);
            } else if (type === 'organization') {
                openQuickAddOrganization(branchId);
            }
        }

        // ⭐ Override callback بعد از QuickAdd
        window.onQuickAddComplete = function(type, response) {
            console.log('✅ QuickAdd complete:', type, response);
            
            if (type === 'contact') {
                // بارگذاری مجدد لیست Contacts
                loadBranchData(selectedBranchId);
                
                // انتخاب خودکار Contact جدید
                setTimeout(function() {
                    $('#directContactSelect').val(response.contactId).trigger('change');
                }, 500);
                
                // نمایش پیام
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'موفق!',
                        text: 'فرد "' + response.contactName + '" با موفقیت ایجاد شد',
                        icon: 'success',
                        timer: 2000
                    });
                }
            } else if (type === 'organization') {
                // بارگذاری مجدد لیست Organizations
                loadBranchData(selectedBranchId);
                
                // انتخاب خودکار Organization جدید
                setTimeout(function() {
                    $('#organizationSelect').val(response.organizationId).trigger('change');
                }, 500);
                
                // نمایش پیام
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'موفق!',
                        text: 'سازمان "' + response.organizationName + '" با موفقیت ایجاد شد',
                        icon: 'success',
                        timer: 2000
                    });
                }
            }
        };

    </script>
    
    <!-- ⭐ QuickAdd Helper Script -->
    <script src="~/assets/js/crm/quickaddhelper.js"></script>
    
    <style>
        /* اطمینان از سایز درست Select2 */
        .select2-container {
            width: 100% !important;
        }
        .select2-container .select2-selection--single {
            height: 38px;
            padding: 4px 8px;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
        .list-group-item-action:hover {
            background-color: #f8f9fa;
        }
        .list-group-item input[type="radio"]:checked + div .fw-semibold {
            color: #0d6efd;
        }
    </style>
}
