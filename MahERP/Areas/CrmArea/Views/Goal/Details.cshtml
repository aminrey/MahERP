@model MahERP.DataModelLayer.ViewModels.CrmViewModels.GoalViewModel
@{
    ViewData["Title"] = "جزئیات هدف - " + Model.Title;

    // تعیین رنگ و وضعیت
    string statusColor = "primary";
    string statusText = "فعال";
    string statusIcon = "fa-play-circle";

    if (!Model.IsActive)
    {
        statusColor = "secondary"; statusText = "غیرفعال"; statusIcon = "fa-pause-circle";
    }
    else if (Model.IsConverted)
    {
        statusColor = "success"; statusText = "تبدیل شده"; statusIcon = "fa-check-double";
    }
}

<!-- Hero -->
<div class="bg-@statusColor-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-md-row justify-content-md-between align-items-md-center py-2">
            <div class="flex-grow-1 mb-1 mb-md-0">
                <div class="d-flex align-items-center mb-2">
                    <span class="badge bg-@statusColor me-2">
                        <i class="fa @statusIcon me-1"></i>
                        @statusText
                    </span>
                    @if (Model.CurrentLeadStageStatusTitle != null)
                    {
                        <span class="badge" style="background-color: @(Model.CurrentLeadStageStatusColor ?? "#6c757d")">
                            @Model.CurrentLeadStageStatusTitle
                        </span>
                    }
                </div>
                <h1 class="fs-3 fw-semibold mb-2">
                    <i class="fa fa-bullseye text-@statusColor me-2"></i>
                    @Model.Title
                </h1>
                <p class="mb-0 text-muted">
                    <i class="fa @(Model.TargetType == "Contact" ? "fa-user" : "fa-building") me-1"></i>
                    @Model.TargetName
                    <span class="mx-2">•</span>
                    <i class="fa fa-calendar me-1"></i>
                    @Model.CreatedDatePersian
                    @if (!string.IsNullOrEmpty(Model.CreatorName))
                    {
                        <span class="mx-2">•</span>
                        <i class="fa fa-user-edit me-1"></i>
                        @Model.CreatorName
                    }
                </p>
            </div>
            <div class="flex-shrink-0 mt-3 mt-md-0">
                @if (!Model.IsConverted && Model.IsActive)
                {
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#conversionModal">
                        <i class="fa fa-check-double me-1"></i>
                        تبدیل به خرید
                    </button>
                }
                <div class="btn-group">
                    <button type="button" class="btn btn-alt-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fa fa-cog"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                        @if (Model.IsActive && !Model.IsConverted)
                        {
                            <form asp-action="Delete" asp-route-id="@Model.Id" asp-route-contactId="@Model.ContactId" asp-route-organizationId="@Model.OrganizationId" method="post"
                                  onsubmit="return confirm('آیا از غیرفعال کردن این هدف مطمئن هستید؟');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="dropdown-item text-danger">
                                    <i class="fa fa-ban me-1"></i>
                                    غیرفعال کردن
                                </button>
                            </form>
                        }
                        <a class="dropdown-item" asp-action="Index">
                            <i class="fa fa-list me-1"></i>
                            لیست اهداف
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-alt">
                <li class="breadcrumb-item">CRM</li>
                <li class="breadcrumb-item">
                    <a asp-action="Index">اهداف</a>
                </li>
                <li class="breadcrumb-item active">جزئیات</li>
            </ol>
        </nav>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <div class="row">
        <!-- ستون اصلی -->
        <div class="col-lg-8">
            <!-- اطلاعات هدف -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-info-circle me-1"></i>
                        اطلاعات هدف
                    </h3>
                </div>
                <div class="block-content">
                    @if (!string.IsNullOrEmpty(Model.ProductName))
                    {
                        <div class="mb-4">
                            <label class="form-label text-muted">محصول/خدمت</label>
                            <p class="fs-5 fw-semibold text-primary mb-0">
                                <i class="fa fa-box me-2"></i>
                                @Model.ProductName
                            </p>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="mb-4">
                            <label class="form-label text-muted">توضیحات</label>
                            <div class="p-3 bg-body-light rounded" style="white-space: pre-wrap;">@Model.Description</div>
                        </div>
                    }

                    <!-- ارزش‌ها -->
                    <div class="row g-4">
                        @if (Model.EstimatedValue.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="p-3 bg-warning-light rounded text-center">
                                    <div class="fs-4 fw-bold text-warning">@Model.EstimatedValueFormatted</div>
                                    <div class="text-muted small">ریال - ارزش تخمینی</div>
                                </div>
                            </div>
                        }
                        @if (Model.IsConverted && Model.ActualValue.HasValue)
                        {
                            <div class="col-md-6">
                                <div class="p-3 bg-success-light rounded text-center">
                                    <div class="fs-4 fw-bold text-success">@Model.ActualValueFormatted</div>
                                    <div class="text-muted small">ریال - ارزش واقعی</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- تعاملات مرتبط -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-comments me-1"></i>
                        تعاملات مرتبط
                        <span class="badge bg-primary ms-1">@Model.InteractionsCount</span>
                    </h3>
                </div>
                <div class="block-content">
                    @if (Model.InteractionsCount > 0)
                    {
                        <p class="text-muted">
                            این هدف با @Model.InteractionsCount تعامل مرتبط است.
                        </p>
                    }
                    else
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="fa fa-comments fa-2x mb-2"></i>
                            <p class="mb-0">هنوز تعاملی برای این هدف ثبت نشده است</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- ستون کناری -->
        <div class="col-lg-4">
            <!-- مخاطب -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa @(Model.TargetType == "Contact" ? "fa-user" : "fa-building") me-1"></i>
                        @(Model.TargetType == "Contact" ? "فرد" : "سازمان")
                    </h3>
                </div>
                <div class="block-content">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 me-3">
                            <i class="fa @(Model.TargetType == "Contact" ? "fa-user-circle" : "fa-building") fa-3x text-primary"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-1">@Model.TargetName</h5>
                            @if (Model.ContactId.HasValue)
                            {
                                <a asp-action="ByContact" asp-route-contactId="@Model.ContactId" class="btn btn-sm btn-alt-primary">
                                    <i class="fa fa-list me-1"></i>
                                    سایر اهداف
                                </a>
                            }
                            else if (Model.OrganizationId.HasValue)
                            {
                                <a asp-action="ByOrganization" asp-route-organizationId="@Model.OrganizationId" class="btn btn-sm btn-alt-primary">
                                    <i class="fa fa-list me-1"></i>
                                    سایر اهداف
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- اطلاعات تکمیلی -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-clock me-1"></i>
                        تاریخچه
                    </h3>
                </div>
                <div class="block-content block-content-full">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="fa fa-plus-circle me-1"></i>
                                تاریخ ایجاد
                            </span>
                            <strong>@Model.CreatedDatePersian</strong>
                        </li>
                        @if (Model.IsConverted && Model.ConversionDatePersian != null)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span class="text-muted">
                                    <i class="fa fa-check-double me-1 text-success"></i>
                                    تاریخ تبدیل
                                </span>
                                <strong class="text-success">@Model.ConversionDatePersian</strong>
                            </li>
                        }
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted">
                                <i class="fa fa-user-edit me-1"></i>
                                ایجادکننده
                            </span>
                            <strong>@(Model.CreatorName ?? "-")</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END Page Content -->

<!-- Modal تبدیل به خرید -->
<div class="modal fade" id="conversionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="MarkAsConverted" asp-route-id="@Model.Id" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fa fa-check-double me-2"></i>
                        تبدیل به خرید
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-4">
                        آیا این هدف به خرید تبدیل شده است؟ با تأیید این عملیات، هدف به عنوان "تبدیل شده" ثبت خواهد شد.
                    </p>
                    <div class="mb-3">
                        <label class="form-label">ارزش واقعی معامله (ریال)</label>
                        <input type="number" name="actualValue" class="form-control" 
                               value="@Model.EstimatedValue" min="0" placeholder="ارزش واقعی معامله" />
                        <small class="form-text text-muted">
                            در صورت تفاوت با ارزش تخمینی، مقدار واقعی را وارد کنید
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-alt-secondary" data-bs-dismiss="modal">انصراف</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-check me-1"></i>
                        تأیید تبدیل
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
