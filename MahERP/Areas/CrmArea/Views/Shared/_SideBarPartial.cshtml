@using MahERP.Extensions
@{
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();

    var isAdmin = Html.IsAdmin();
}

<!-- Sidebar -->
<nav aria-label="Main Navigation" id="sidebar">
    <!-- Side Header -->
    <div class="bg-header-dark">
        <div class="content-header bg-white-5">
         <!-- Logo -->
          <a asp-area="CrmArea" asp-controller="Dashboard" asp-action="Index" class="fw-semibold text-white tracking-wide">
                <span class="smini-visible">
           M<span class="opacity-75">E</span>
</span>
     <span class="smini-hidden">
 Mah<span class="opacity-75">ERP</span>
  </span>
   </a>
       <!-- END Logo -->
     <!-- Options -->
  <div>
     <button class="btn btn-sm btn-alt-secondary" data-class="fa-toggle-off fa-toggle-on" data-target="#sidebar-style-toggler" data-toggle="class-toggle" onclick="Dashmix.layout('sidebar_style_toggle');Dashmix.layout('header_style_toggle');" type="button" title="تغییر حالت نوار کناری">
           <i class="fa fa-toggle-off" id="sidebar-style-toggler"></i>
  </button>
   <button class="btn btn-sm btn-alt-secondary" data-class="far fa" data-target="#dark-mode-toggler" data-toggle="class-toggle" onclick="Dashmix.layout('dark_mode_toggle');" type="button" title="حالت تاریک">
         <i class="far fa-moon" id="dark-mode-toggler"></i>
   </button>
       <button class="btn btn-sm btn-alt-secondary d-lg-none" data-action="sidebar_close" data-toggle="layout" type="button" title="بستن نوار کناری">
      <i class="fa fa-times-circle"></i>
    </button>
   </div>
      <!-- END Options -->
        </div>
    </div>
    <!-- END Side Header -->
    
    <!-- Sidebar Scrolling -->
    <div class="js-sidebar-scroll">
   <!-- Side Navigation -->
     <div class="content-side">
            <ul class="nav-main">

   <!-- ============== 📊 DASHBOARD SECTION ============== -->
  <li class="nav-main-heading">داشبورد</li>
           <li class="nav-main-item @(IsMenuItemActive(currentController, currentAction, "Dashboard", "Index") ? "active" : "")">
         <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Dashboard", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="Dashboard" asp-action="Index">
     <i class="nav-main-link-icon fa fa-tachometer-alt text-primary"></i>
  <span class="nav-main-link-name fw-semibold">داشبورد CRM</span>
   </a>
   </li>

                <!-- ============== 💼 CRM MANAGEMENT ============== -->
           @if (Html.CanAccessAnyIn("CRM"))
                {
   <li class="nav-main-heading">مدیریت CRM</li>
   
     <li class="nav-main-item @(IsCRMMenuActive(currentController) ? "open" : "")">
       <a aria-expanded="@(IsCRMMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
         <i class="nav-main-link-icon fa fa-chart-line text-success"></i>
 <span class="nav-main-link-name">تعاملات CRM</span>
          </a>
        <ul class="nav-main-submenu">
         @if (Html.CanAccessAny("CRM", "CRM.VIEW"))
   {
        <li class="nav-main-item">
       <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="CRM" asp-action="Index">
        <i class="nav-main-link-icon fa fa-list text-info"></i>
             <span class="nav-main-link-name">لیست تعاملات</span>
   </a>
      </li>
           }
      
       @if (Html.CanAccessAny("CRM", "CRM.CREATE"))
     {
    <li class="nav-main-item">
       <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "CRM", "Create") ? "active" : "")" asp-area="CrmArea" asp-controller="CRM" asp-action="Create">
 <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
<span class="nav-main-link-name fw-semibold">تعامل جدید</span>
          </a>
       </li>
        }

    @if (Html.CanAccessAny("CRM", "CRM.STATISTICS"))
          {
        <li class="nav-main-item nav-submenu-separator mt-2">
          <div class="nav-submenu-title">
   <small class="text-muted fw-semibold">آمار و گزارشات</small>
        </div>
   </li>
  <li class="nav-main-item">
<a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "Statistics") ? "active" : "")" asp-area="CrmArea" asp-controller="CRM" asp-action="Statistics">
    <i class="nav-main-link-icon fa fa-chart-pie text-primary"></i>
   <span class="nav-main-link-name">آمار CRM</span>
        </a>
 </li>
}
      </ul>
       </li>
                }

       <!-- ============== 📨 COMMUNICATION MANAGEMENT ============== -->
     @if (Html.CanAccessAnyIn("COMMUNICATION.SMS", "COMMUNICATION.EMAIL"))
                {
          <li class="nav-main-heading">مدیریت ارتباطات</li>

       <!-- مدیریت پیامک -->
          @if (Html.CanAccessAnyIn("COMMUNICATION.SMS"))
{
<li class="nav-main-item @(IsSmsMenuActive(currentController) ? "open" : "")">
       <a aria-expanded="@(IsSmsMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
     <i class="nav-main-link-icon fa fa-sms text-info"></i>
    <span class="nav-main-link-name">مدیریت پیامک</span>
         </a>
 <ul class="nav-main-submenu">
        @if (Html.CanAccessAny("COMMUNICATION.SMS", "COMMUNICATION.SMS.SEND"))
      {
        <li class="nav-main-item nav-submenu-separator">
         <div class="nav-submenu-title">
 <small class="text-muted fw-semibold">ارسال پیامک</small>
    </div>
</li>
  <li class="nav-main-item">
    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "SmsSend", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="SmsSend" asp-action="Index">
<i class="nav-main-link-icon fa fa-paper-plane text-primary"></i>
   <span class="nav-main-link-name">ارسال پیامک</span>
    </a>
      </li>
 }
     
 @if (Html.CanAccessAnyIn("COMMUNICATION.SMS.TEMPLATE"))
    {
  <li class="nav-main-item nav-submenu-separator mt-2">
     <div class="nav-submenu-title">
     <small class="text-muted fw-semibold">قالب‌های پیامک</small>
           </div>
             </li>

       @if (Html.CanAccessAny("COMMUNICATION.SMS.TEMPLATE", "COMMUNICATION.SMS.TEMPLATE.VIEW"))
      {
  <li class="nav-main-item">
 <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "SmsTemplate", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="SmsTemplate" asp-action="Index">
        <i class="nav-main-link-icon fa fa-file-alt text-info"></i>
      <span class="nav-main-link-name">لیست قالب‌ها</span>
      </a>
           </li>
     }

     @if (Html.CanAccessAny("COMMUNICATION.SMS.TEMPLATE", "COMMUNICATION.SMS.TEMPLATE.CREATE"))
   {
    <li class="nav-main-item">
  <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "SmsTemplate", "Create") ? "active" : "")" asp-area="CrmArea" asp-controller="SmsTemplate" asp-action="Create">
          <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
  <span class="nav-main-link-name fw-semibold">قالب جدید</span>
      </a>
    </li>
       }
          }
             
 @if (Html.CanAccessAny("COMMUNICATION.SMS", "COMMUNICATION.SMS.PROVIDER"))
   {
    <li class="nav-main-item nav-submenu-separator mt-2">
     <div class="nav-submenu-title">
 <small class="text-muted fw-semibold">تنظیمات</small>
          </div>
      </li>
        <li class="nav-main-item">
 <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "SmsProvider", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="SmsProvider" asp-action="Index">
   <i class="nav-main-link-icon fa fa-server text-warning"></i>
      <span class="nav-main-link-name">خدمات‌دهندگان پیامک</span>
        </a>
       </li>
     }
      </ul>
       </li>
   }

             <!-- مدیریت ایمیل -->
     @if (Html.CanAccessAnyIn("COMMUNICATION.EMAIL"))
   {
     <li class="nav-main-item @(IsEmailMenuActive(currentController) ? "open" : "")">
   <a aria-expanded="@(IsEmailMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
          <i class="nav-main-link-icon fa fa-envelope text-primary"></i>
      <span class="nav-main-link-name">مدیریت ایمیل</span>
      </a>
     <ul class="nav-main-submenu">
         @if (Html.CanAccessAny("COMMUNICATION.EMAIL", "COMMUNICATION.EMAIL.SEND"))
        {
  <li class="nav-main-item nav-submenu-separator">
    <div class="nav-submenu-title">
      <small class="text-muted fw-semibold">ارسال ایمیل</small>
  </div>
   </li>
     <li class="nav-main-item">
        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "EmailSend", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="EmailSend" asp-action="Index">
        <i class="nav-main-link-icon fa fa-paper-plane text-primary"></i>
         <span class="nav-main-link-name">ارسال ایمیل</span>
        </a>
   </li>
    }
         
        @if (Html.CanAccessAnyIn("COMMUNICATION.EMAIL.TEMPLATE"))
      {
  <li class="nav-main-item nav-submenu-separator mt-2">
      <div class="nav-submenu-title">
        <small class="text-muted fw-semibold">قالب‌های ایمیل</small>
    </div>
       </li>
 
    @if (Html.CanAccessAny("COMMUNICATION.EMAIL.TEMPLATE", "COMMUNICATION.EMAIL.TEMPLATE.VIEW"))
    {
          <li class="nav-main-item">
     <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "EmailTemplate", "Index") ? "active" : "")" asp-area="CrmArea" asp-controller="EmailTemplate" asp-action="Index">
      <i class="nav-main-link-icon fa fa-file-alt text-info"></i>
          <span class="nav-main-link-name">لیست قالب‌ها</span>
     </a>
</li>
       }
        
         @if (Html.CanAccessAny("COMMUNICATION.EMAIL.TEMPLATE", "COMMUNICATION.EMAIL.TEMPLATE.CREATE"))
     {
   <li class="nav-main-item">
   <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "EmailTemplate", "Create") ? "active" : "")" asp-area="CrmArea" asp-controller="EmailTemplate" asp-action="Create">
       <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
  <span class="nav-main-link-name fw-semibold">قالب جدید</span>
    </a>
          </li>
      }
         }
        </ul>
    </li>
 }
  }

    <!-- ============== 🚪 LOGOUT ============== -->
      <li class="nav-main-heading">خروج</li>
 <li class="nav-main-item">
                    <a class="nav-main-link logout-link" href="/Account/LogOut">
            <i class="nav-main-link-icon fa fa-sign-out-alt text-danger"></i>
            <span class="nav-main-link-name">خروج از سیستم</span>
           </a>
 </li>

            </ul>
    </div>
        <!-- END Side Navigation -->
    </div>
    <!-- END Sidebar Scrolling -->
</nav>
<!-- END Sidebar -->

@functions {
    public bool IsMenuItemActive(string currentController, string currentAction, string targetController, string targetAction)
    {
        return currentController == targetController && currentAction == targetAction;
    }

    public bool IsCRMMenuActive(string currentController) => currentController == "CRM";
    public bool IsSmsMenuActive(string currentController) => currentController == "SmsSend" || currentController == "SmsTemplate" || currentController == "SmsProvider";
    public bool IsEmailMenuActive(string currentController) => currentController == "EmailSend" || currentController == "EmailTemplate";
}

<style>
    .nav-submenu-separator {
      border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 0.5rem;
   margin-top: 0.5rem;
    }

    .nav-submenu-separator:first-child {
        border-top: none;
  padding-top: 0;
        margin-top: 0;
    }

    .nav-submenu-title {
        padding: 0.25rem 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .nav-main-link {
        transition: all 0.3s ease;
   border-radius: 0.375rem;
        margin: 0.125rem 0.5rem;
    }

    .nav-main-link:hover {
   background-color: rgba(255, 255, 255, 0.1);
     transform: translateX(-2px);
    }

    .nav-main-link-create {
  background: linear-gradient(135deg, rgba(25, 135, 84, 0.1), rgba(25, 135, 84, 0.2));
  border-left: 3px solid #198754;
    }

    .nav-main-link-create:hover {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(25, 135, 84, 0.3));
    }

    .logout-link {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2));
   border-left: 3px solid #dc3545;
    }

    .logout-link:hover {
background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.3));
    }

    .nav-main-heading {
   position: relative;
    font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
  letter-spacing: 0.5px;
color: rgba(255, 255, 255, 0.8);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        padding: 0 1rem;
    }

    .nav-main-heading:first-child {
  margin-top: 0.5rem;
    }

    .nav-main-heading::after {
        content: '';
    position: absolute;
        bottom: -0.25rem;
     left: 1rem;
        right: 1rem;
     height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }
</style>