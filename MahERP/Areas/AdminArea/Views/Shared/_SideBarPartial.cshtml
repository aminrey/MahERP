@using MahERP.Extensions
@{
    var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
    var currentAction = ViewContext.RouteData.Values["action"]?.ToString();
    var currentArea = ViewContext.RouteData.Values["area"]?.ToString();
    var taskViewType = Context.Request.Query["TaskViewType"].ToString();
    
    // بررسی دسترسی‌های کلی
    var isAdminOrManager = Html.IsAdminOrManager();
}

<!-- Sidebar -->
<nav aria-label="Main Navigation" id="sidebar">
    <!-- Side Header -->
    <div class="bg-header-dark">
        <div class="content-header bg-white-5">
            <!-- Logo -->
            <a asp-area="AdminArea" asp-controller="Dashboard" asp-action="Index" class="fw-semibold text-white tracking-wide">
                <span class="smini-visible">
                    M<span class="opacity-75">E</span>
                </span>
                <span class="smini-hidden">
                    Mah<span class="opacity-75">ERP</span>
                </span>
            </a>
            <!-- END Logo -->
            <!-- Options -->
            <div>
                <!-- Toggle Sidebar Style -->
                <button class="btn btn-sm btn-alt-secondary" data-class="fa-toggle-off fa-toggle-on" data-target="#sidebar-style-toggler" data-toggle="class-toggle" onclick="Dashmix.layout('sidebar_style_toggle');Dashmix.layout('header_style_toggle');" type="button" title="تغییر حالت نوار کناری">
                    <i class="fa fa-toggle-off" id="sidebar-style-toggler"></i>
                </button>
                <!-- END Toggle Sidebar Style -->
                <!-- Dark Mode -->
                <button class="btn btn-sm btn-alt-secondary" data-class="far fa" data-target="#dark-mode-toggler" data-toggle="class-toggle" onclick="Dashmix.layout('dark_mode_toggle');" type="button" title="حالت تاریک">
                    <i class="far fa-moon" id="dark-mode-toggler"></i>
                </button>
                <!-- END Dark Mode -->
                <!-- Close Sidebar, Visible only on mobile screens -->
                <button class="btn btn-sm btn-alt-secondary d-lg-none" data-action="sidebar_close" data-toggle="layout" type="button" title="بستن نوار کناری">
                    <i class="fa fa-times-circle"></i>
                </button>
                <!-- END Close Sidebar -->
            </div>
            <!-- END Options -->
        </div>
    </div>
    <!-- END Side Header -->
    
    <!-- Sidebar Scrolling -->
    <div class="js-sidebar-scroll">
        <!-- Side Navigation -->
        <div class="content-side">
            <ul class="nav-main">

                <!-- ============== 📊 DASHBOARD SECTION ============== -->
                <li class="nav-main-heading">داشبورد</li>
                <li class="nav-main-item @(IsMenuItemActive(currentController, currentAction, "Dashboard", "Index") ? "active" : "")">
                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Dashboard", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="Dashboard" asp-action="Index">
                        <i class="nav-main-link-icon fa fa-tachometer-alt text-primary"></i>
                        <span class="nav-main-link-name fw-semibold">داشبورد اصلی</span>
                    </a>
                </li>

                <!-- ============== 📋 TASK MANAGEMENT SECTION ============== -->
                <li class="nav-main-heading">مدیریت تسک‌ها</li>
                <li class="nav-main-item @(IsTaskMenuActive(currentController) ? "open" : "")">
                    <a aria-expanded="@(IsTaskMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                        <i class="nav-main-link-icon fa fa-tasks text-primary"></i>
                        <span class="nav-main-link-name">تسک‌ها</span>
                        <span class="nav-main-link-badge badge bg-primary rounded-pill ms-1" id="taskBadgeCount" style="display: none;">0</span>
                    </a>
                    <ul class="nav-main-submenu">
                     
                        <!-- ⚡ عملیات سریع -->
                        <li class="nav-main-item nav-submenu-separator mt-2">
                            <div class="nav-submenu-title">
                                <small class="text-muted fw-semibold">عملیات سریع</small>
                            </div>
                        </li>

                        <li class="nav-main-item">
                            <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "Tasks", "CreateNewTask") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="CreateNewTask" asp-route-AddressRouteInComingUrl="side">
                                <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
                                <span class="nav-main-link-name fw-semibold">ایجاد تسک جدید</span>
                            </a>
                        </li>
                        <!-- همه تسک‌ها -->
                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsTaskMenuItemActive(currentController, currentAction, taskViewType, "Tasks", "Index", "AllTasks") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="Index" asp-route-ViewType="AllTasks">
                                <i class="nav-main-link-icon fa fa-list text-info"></i>
                                <span class="nav-main-link-name">همه تسک‌ها</span>
                            </a>
                        </li>
                        <!-- 🎯 صفحات مهم -->
                        <li class="nav-main-item nav-submenu-separator">
                            <div class="nav-submenu-title">
                                <small class="text-muted fw-semibold">صفحات اصلی</small>
                            </div>
                        </li>
                     

                        <!-- تسک‌های من -->
                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsTaskMenuItemActive(currentController, currentAction, taskViewType, "Tasks", "Index", "MyTasks") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="Index" asp-route-ViewType="MyTasks">
                                <i class="nav-main-link-icon fa fa-clipboard-check text-warning"></i>
                                <span class="nav-main-link-name">تسک‌های من</span>
                                <span class="nav-main-link-badge badge bg-danger rounded-pill ms-1" id="myTasksCount" style="display: none;">0</span>
                            </a>
                        </li>

                        <!-- یادآوری‌های من -->
                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Tasks", "TaskReminders") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="TaskReminders">
                                <i class="nav-main-link-icon fa fa-bell text-orange"></i>
                                <span class="nav-main-link-name">یادآوری‌های من</span>
                                <span class="nav-main-link-badge badge bg-success rounded-pill ms-1" id="remindersCount" style="display: none;">0</span>
                            </a>
                        </li>

                        <!-- تسک‌های امروز من -->
                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "MyDayTask", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="MyDayTask" asp-action="Index">
                                <i class="nav-main-link-icon fa fa-calendar-day text-success"></i>
                                <span class="nav-main-link-name">تسک‌های روز من</span>
                                <span class="nav-main-link-badge badge bg-success rounded-pill ms-1" id="myDayCount" style="display: none;">0</span>
                            </a>
                        </li>

                        <!-- 📅 تقویم -->
                        <li class="nav-main-item nav-submenu-separator mt-2">
                            <div class="nav-submenu-title">
                                <small class="text-muted fw-semibold">تقویم</small>
                            </div>
                        </li>

                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Tasks", "TaskCalendar") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="TaskCalendar">
                                <i class="nav-main-link-icon fa fa-calendar text-success"></i>
                                <span class="nav-main-link-name">تقویم تسک‌ها</span>
                            </a>
                        </li>

                    
                      

                        <!-- 📊 آمار و گزارشات -->
                        <li class="nav-main-item nav-submenu-separator mt-2">
                            <div class="nav-submenu-title">
                                <small class="text-muted fw-semibold">آمار و گزارشات</small>
                            </div>
                        </li>

                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Tasks", "TaskDashboard") ? "active" : "")" asp-area="AdminArea" asp-controller="Tasks" asp-action="TaskDashboard">
                                <i class="nav-main-link-icon fa fa-chart-bar text-primary"></i>
                                <span class="nav-main-link-name">داشبورد تسک‌ها</span>
                            </a>
                        </li>
                    </ul>
                </li>

                <!-- ============== 🔔 NOTIFICATIONS ============== -->
                @if (Html.CanAccess("Notification") || isAdminOrManager)
                {
                    <li class="nav-main-item">
                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Notification", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="Notification" asp-action="Index">
                            <i class="nav-main-link-icon fa fa-bell text-warning"></i>
                            <span class="nav-main-link-name">نوتیفیکیشن‌ها</span>
                            <span class="nav-main-link-badge badge bg-danger rounded-pill ms-1" id="sidebarNotificationCount" style="display: none;">0</span>
                        </a>
                    </li>
                }

                <!-- ============== 🏢 ORGANIZATION SETUP ============== -->
                @if (Html.CanAccessAnyIn("Branch", "BranchUser", "Team", "UserManager") || isAdminOrManager)
                {
                    <li class="nav-main-heading">تعاریف سازمانی</li>

                    <!-- مدیریت شعب -->
                    @if (Html.CanAccessAnyIn("Branch", "BranchUser") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsBranchMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsBranchMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-sitemap text-primary"></i>
                                <span class="nav-main-link-name">مدیریت شعب</span>
                            </a>
                            <ul class="nav-main-submenu">
                                @if (Html.CanAccess("Branch") || isAdminOrManager)
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Branch", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="Branch" asp-action="Index">
                                            <i class="nav-main-link-icon fa fa-list"></i>
                                            <span class="nav-main-link-name">لیست شعب</span>
                                        </a>
                                    </li>
                                }
                                @if (Html.CanAccess("Branch", 1) || isAdminOrManager)
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Branch", "AddBranch") ? "active" : "")" asp-area="AdminArea" asp-controller="Branch" asp-action="AddBranch">
                                            <i class="nav-main-link-icon fa fa-plus-circle"></i>
                                            <span class="nav-main-link-name">افزودن شعبه جدید</span>
                                        </a>
                                    </li>
                                }
                                @if (Html.CanAccess("BranchUser") || isAdminOrManager)
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "BranchUser", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="BranchUser" asp-action="Index">
                                            <i class="nav-main-link-icon fa fa-users"></i>
                                            <span class="nav-main-link-name">کاربران شعب</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }

                    <!-- مدیریت تیم‌ها -->
                    @if (Html.CanAccess("Team") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsTeamMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsTeamMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-users text-info"></i>
                                <span class="nav-main-link-name">مدیریت تیم‌ها</span>
                            </a>
                            <ul class="nav-main-submenu">
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Team", "OrganizationalChart") ? "active" : "")" asp-area="AdminArea" asp-controller="Team" asp-action="OrganizationalChart">
                                        <i class="nav-main-link-icon fa fa-sitemap"></i>
                                        <span class="nav-main-link-name">چارت سازمانی</span>
                                    </a>
                                </li>
                          

                                @if (Html.CanAccess("Team", 1) || isAdminOrManager) 
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Team", "Create") ? "active" : "")" asp-area="AdminArea" asp-controller="Team" asp-action="Create">
                                            <i class="nav-main-link-icon fa fa-plus-circle"></i>
                                            <span class="nav-main-link-name">ایجاد تیم جدید</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }

                    <!-- مدیریت کاربران -->
                    @if (Html.CanAccess("UserManager") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsUserManagementMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsUserManagementMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-user-friends text-success"></i>
                                <span class="nav-main-link-name">مدیریت کاربران</span>
                            </a>
                            <ul class="nav-main-submenu">
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserManager", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="UserManager" asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-user-shield"></i>
                                        <span class="nav-main-link-name">مدیران سیستم</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserManager", "Users") ? "active" : "")" asp-area="AdminArea" asp-controller="UserManager" asp-action="Users">
                                        <i class="nav-main-link-icon fa fa-users"></i>
                                        <span class="nav-main-link-name">کاربران</span>
                                    </a>
                                </li>
                                @if (Html.CanAccess("UserManager", 1) || isAdminOrManager) 
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserManager", "AddUser") ? "active" : "")" asp-area="AdminArea" asp-controller="UserManager" asp-action="AddUser">
                                            <i class="nav-main-link-icon fa fa-user-plus"></i>
                                            <span class="nav-main-link-name">افزودن کاربر جدید</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }

                    <!-- مدیریت نقش‌ها و دسترسی‌ها -->
                    @if (Html.CanAccessAnyIn("RolePattern", "UserPermission") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsRoleMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsRoleMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-shield-alt text-warning"></i>
                                <span class="nav-main-link-name">مدیریت نقش‌ها و دسترسی‌ها</span>
                            </a>
                            <ul class="nav-main-submenu">
                                @if (Html.CanAccess("RolePattern") || isAdminOrManager)
                                {
                                    <!-- 🔑 الگوهای نقش -->
                                    <li class="nav-main-item nav-submenu-separator">
                                        <div class="nav-submenu-title">
                                            <small class="text-muted fw-semibold">الگوهای نقش</small>
                                        </div>
                                    </li>
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "RolePattern", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="RolePattern" asp-action="Index">
                                            <i class="nav-main-link-icon fa fa-key text-primary"></i>
                                            <span class="nav-main-link-name">الگوهای نقش</span>
                                        </a>
                                    </li>
                                    @if (Html.CanAccess("RolePattern", 1) || isAdminOrManager) 
                                    {
                                        <li class="nav-main-item">
                                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "RolePattern", "Create") ? "active" : "")" asp-area="AdminArea" asp-controller="RolePattern" asp-action="Create">
                                                <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
                                                <span class="nav-main-link-name">ایجاد الگوی نقش جدید</span>
                                            </a>
                                        </li>
                                    }
                                }

                                @if (Html.CanAccess("UserPermission") || isAdminOrManager)
                                {
                                    <!-- 👥 دسترسی کاربران -->
                                    <li class="nav-main-item nav-submenu-separator mt-2">
                                        <div class="nav-submenu-title">
                                            <small class="text-muted fw-semibold">دسترسی کاربران</small>
                                        </div>
                                    </li>
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserPermission", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="UserPermission" asp-action="Index">
                                            <i class="nav-main-link-icon fa fa-users-cog text-info"></i>
                                            <span class="nav-main-link-name">دسترسی کاربران</span>
                                        </a>
                                    </li>

                                    <!-- 📊 گزارشات و لاگ‌ها -->
                                    <li class="nav-main-item nav-submenu-separator mt-2">
                                        <div class="nav-submenu-title">
                                            <small class="text-muted fw-semibold">گزارشات و لاگ‌ها</small>
                                        </div>
                                    </li>
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserPermission", "PermissionLogs") ? "active" : "")" asp-area="AdminArea" asp-controller="UserPermission" asp-action="PermissionLogs">
                                            <i class="nav-main-link-icon fa fa-clipboard-list text-secondary"></i>
                                            <span class="nav-main-link-name">لاگ دسترسی‌ها</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                }

                <!-- ============== 💼 BUSINESS MANAGEMENT ============== -->
                @if (Html.CanAccessAnyIn("Organization", "Contact", "Contract", "CRM") || isAdminOrManager)
                {
                    <li class="nav-main-heading">مدیریت کسب‌وکار</li>

                    <!-- ========== 🏢 مدیریت سازمان‌ها - سیستم جدید ========== -->
                    @if (Html.CanAccess("Organization") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsOrganizationMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsOrganizationMenuActive(currentController) ? "true" : "false")"
                               aria-haspopup="true"
                               class="nav-main-link nav-main-link-submenu"
                               data-toggle="submenu"
                               href="#">
                                <i class="nav-main-link-icon fa fa-building text-primary"></i>
                                <span class="nav-main-link-name">مدیریت سازمان‌ها</span>
                            </a>
                            <ul class="nav-main-submenu">

                                <!-- 📋 لیست‌ها -->
                                <li class="nav-main-item nav-submenu-separator">
                                    <div class="nav-submenu-title">
                                        <small class="text-muted fw-semibold">لیست سازمان‌ها</small>
                                    </div>
                                </li>

                                <!-- همه سازمان‌ها -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Organizations", "Index") && string.IsNullOrEmpty(Context.Request.Query["organizationType"]) ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Organizations"
                                       asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-list text-info"></i>
                                        <span class="nav-main-link-name">همه سازمان‌ها</span>
                                    </a>
                                </li>

                                <!-- شرکت‌ها -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsOrganizationTypeActive(currentController, currentAction, "0") ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Organizations"
                                       asp-action="Index"
                                       asp-route-organizationType="0">
                                        <i class="nav-main-link-icon fa fa-briefcase text-primary"></i>
                                        <span class="nav-main-link-name">شرکت‌ها</span>
                                    </a>
                                </li>

                                <!-- سازمان‌ها -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsOrganizationTypeActive(currentController, currentAction, "1") ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Organizations"
                                       asp-action="Index"
                                       asp-route-organizationType="1">
                                        <i class="nav-main-link-icon fa fa-university text-info"></i>
                                        <span class="nav-main-link-name">سازمان‌ها</span>
                                    </a>
                                </li>

                                <!-- موسسات -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsOrganizationTypeActive(currentController, currentAction, "2") ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Organizations"
                                       asp-action="Index"
                                       asp-route-organizationType="2">
                                        <i class="nav-main-link-icon fa fa-landmark text-success"></i>
                                        <span class="nav-main-link-name">موسسات</span>
                                    </a>
                                </li>

                                <!-- نهادها -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsOrganizationTypeActive(currentController, currentAction, "3") ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Organizations"
                                       asp-action="Index"
                                       asp-route-organizationType="3">
                                        <i class="nav-main-link-icon fa fa-hands-helping text-warning"></i>
                                        <span class="nav-main-link-name">نهادها</span>
                                    </a>
                                </li>

                                <!-- ➕ عملیات -->
                                @if (Html.CanAccess("Organization", 1) || isAdminOrManager)
                                {
                                    <li class="nav-main-item nav-submenu-separator mt-2">
                                        <div class="nav-submenu-title">
                                            <small class="text-muted fw-semibold">عملیات</small>
                                        </div>
                                    </li>

                                    <li class="nav-main-item">
                                        <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "Organizations", "Create") ? "active" : "")"
                                           asp-area="AdminArea"
                                           asp-controller="Organizations"
                                           asp-action="Create">
                                            <i class="nav-main-link-icon fa fa-plus-circle text-success"></i>
                                            <span class="nav-main-link-name fw-semibold">سازمان جدید</span>
                                        </a>
                                    </li>
                                }

                                <!-- 🔍 جستجو -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link"
                                       href="#"
                                       data-bs-toggle="modal"
                                       data-bs-target="#modal-advanced-search-org"
                                       onclick="loadOrganizationAdvancedSearchModal()">
                                        <i class="nav-main-link-icon fa fa-search text-secondary"></i>
                                        <span class="nav-main-link-name">جستجوی پیشرفته</span>
                                    </a>
                                </li>

                            </ul>
                        </li>
                    }

                    <!-- ========== 👥 مدیریت افراد (Contacts) - سیستم جدید ========== -->
                    @if (Html.CanAccess("Contact") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsContactMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsContactMenuActive(currentController) ? "true" : "false")"
                               aria-haspopup="true"
                               class="nav-main-link nav-main-link-submenu"
                               data-toggle="submenu"
                               href="#">
                                <i class="nav-main-link-icon fa fa-users text-success"></i>
                                <span class="nav-main-link-name">مدیریت افراد</span>
                            </a>
                            <ul class="nav-main-submenu">

                                <!-- 📋 لیست افراد -->
                                <li class="nav-main-item nav-submenu-separator">
                                    <div class="nav-submenu-title">
                                        <small class="text-muted fw-semibold">لیست‌ها</small>
                                    </div>
                                </li>

                                <!-- همه افراد -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Contacts", "Index") && string.IsNullOrEmpty(Context.Request.Query["gender"]) ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Contacts"
                                       asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-list text-info"></i>
                                        <span class="nav-main-link-name">همه افراد</span>
                                    </a>
                                </li>

                               
                                <!-- ➕ عملیات -->
                                @if (Html.CanAccess("Contact", 1) || isAdminOrManager)
                                {
                                    <li class="nav-main-item nav-submenu-separator mt-2">
                                        <div class="nav-submenu-title">
                                            <small class="text-muted fw-semibold">عملیات</small>
                                        </div>
                                    </li>

                                    <li class="nav-main-item">
                                        <a class="nav-main-link nav-main-link-create @(IsMenuItemActive(currentController, currentAction, "Contacts", "Create") ? "active" : "")"
                                           asp-area="AdminArea"
                                           asp-controller="Contacts"
                                           asp-action="Create">
                                            <i class="nav-main-link-icon fa fa-user-plus text-success"></i>
                                            <span class="nav-main-link-name fw-semibold">فرد جدید</span>
                                        </a>
                                    </li>
                                }

                                <!-- 📊 آمار و گزارشات -->
                                <li class="nav-main-item nav-submenu-separator mt-2">
                                    <div class="nav-submenu-title">
                                        <small class="text-muted fw-semibold">آمار و گزارشات</small>
                                    </div>
                                </li>

                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Contacts", "Statistics") ? "active" : "")"
                                       asp-area="AdminArea"
                                       asp-controller="Contacts"
                                       asp-action="Statistics">
                                        <i class="nav-main-link-icon fa fa-chart-pie text-primary"></i>
                                        <span class="nav-main-link-name">آمار افراد</span>
                                    </a>
                                </li>

                                <!-- 🔍 جستجو -->
                                <li class="nav-main-item">
                                    <a class="nav-main-link"
                                       href="#"
                                       data-bs-toggle="modal"
                                       data-bs-target="#modal-advanced-search-contact"
                                       onclick="loadContactAdvancedSearchModal()">
                                        <i class="nav-main-link-icon fa fa-search text-secondary"></i>
                                        <span class="nav-main-link-name">جستجوی پیشرفته</span>
                                    </a>
                                </li>

                            </ul>
                        </li>
                    }

                    <!-- قراردادها -->
                    @if (Html.CanAccess("Contract") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsContractMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsContractMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-file-contract text-info"></i>
                                <span class="nav-main-link-name">قراردادها</span>
                            </a>
                            <ul class="nav-main-submenu">
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Contract", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="Contract" asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-list"></i>
                                        <span class="nav-main-link-name">لیست قراردادها</span>
                                    </a>
                                </li>

                                @if (Html.CanAccess("Contract", 1) || isAdminOrManager)
                                {
                                    <li class="nav-main-item">
                                        <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Contract", "AddContract") ? "active" : "")" asp-area="AdminArea" asp-controller="Contract" asp-action="AddContract">
                                            <i class="nav-main-link-icon fa fa-plus-circle"></i>
                                            <span class="nav-main-link-name">قرارداد جدید</span>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </li>
                    }

                    <!-- مدیریت CRM -->
                    @if (Html.CanAccess("CRM") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsCRMMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsCRMMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-chart-line text-success"></i>
                                <span class="nav-main-link-name">مدیریت CRM</span>
                            </a>
                            <ul class="nav-main-submenu">
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-tachometer-alt"></i>
                                        <span class="nav-main-link-name">داشبورد CRM</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "LeadManagement") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="LeadManagement">
                                        <i class="nav-main-link-icon fa fa-user-plus"></i>
                                        <span class="nav-main-link-name">مدیریت سرنخ‌ها</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "OpportunityManagement") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="OpportunityManagement">
                                        <i class="nav-main-link-icon fa fa-bullseye"></i>
                                        <span class="nav-main-link-name">مدیریت فرصت‌ها</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "CustomerFollowUp") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="CustomerFollowUp">
                                        <i class="nav-main-link-icon fa fa-phone"></i>
                                        <span class="nav-main-link-name">پیگیری مشتریان</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "SalesReports") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="SalesReports">
                                        <i class="nav-main-link-icon fa fa-chart-bar"></i>
                                        <span class="nav-main-link-name">گزارشات فروش</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "CRM", "CustomerAnalytics") ? "active" : "")" asp-area="AdminArea" asp-controller="CRM" asp-action="CustomerAnalytics">
                                        <i class="nav-main-link-icon fa fa-analytics"></i>
                                        <span class="nav-main-link-name">تحلیل مشتریان</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    }
                }
                    
                

                <!-- ============== 📊 MONITORING & LOGS ============== -->
                @if (Html.CanAccess("UserActivityLog") || isAdminOrManager)
                {
                    <li class="nav-main-heading">نظارت و لاگ‌ها</li>

                    <!-- لاگ فعالیت‌ها -->
                    <li class="nav-main-item @(IsActivityLogMenuActive(currentController) ? "open" : "")">
                        <a aria-expanded="@(IsActivityLogMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                            <i class="nav-main-link-icon fa fa-history text-secondary"></i>
                            <span class="nav-main-link-name">لاگ فعالیت‌ها</span>
                        </a>
                        <ul class="nav-main-submenu">
                            <li class="nav-main-item">
                                <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserActivityLog", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="UserActivityLog" asp-action="Index">
                                    <i class="nav-main-link-icon fa fa-list"></i>
                                    <span class="nav-main-link-name">لیست فعالیت‌ها</span>
                                </a>
                            </li>
                            <li class="nav-main-item">
                                <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserActivityLog", "Search") ? "active" : "")" asp-area="AdminArea" asp-controller="UserActivityLog" asp-action="Search">
                                    <i class="nav-main-link-icon fa fa-search"></i>
                                    <span class="nav-main-link-name">جستجوی پیشرفته</span>
                                </a>
                            </li>
                            <li class="nav-main-item">
                                <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "UserActivityLog", "Statistics") ? "active" : "")" asp-area="AdminArea" asp-controller="UserActivityLog" asp-action="Statistics">
                                    <i class="nav-main-link-icon fa fa-chart-line"></i>
                                    <span class="nav-main-link-name">آمار و گزارشات</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                }

                <!-- ============== 🏷️ SYSTEM CONFIGURATION ============== -->
                @if (Html.CanAccessAnyIn("TaskInitialSettings", "Settings") || isAdminOrManager)
                {
                    <li class="nav-main-heading">تنظیمات سیستم</li>

                    <!-- Categories - System Configuration -->
                    @if (Html.CanAccess("TaskInitialSettings") || isAdminOrManager)
                    {
                        <li class="nav-main-item @(IsTaskCategoryMenuActive(currentController) ? "open" : "")">
                            <a aria-expanded="@(IsTaskCategoryMenuActive(currentController) ? "true" : "false")" aria-haspopup="true" class="nav-main-link nav-main-link-submenu" data-toggle="submenu" href="#">
                                <i class="nav-main-link-icon fa fa-tags text-secondary"></i>
                                <span class="nav-main-link-name">دسته‌بندی تسک‌ها</span>
                            </a>
                            <ul class="nav-main-submenu">
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "TaskCategory", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="TaskCategory" asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-list"></i>
                                        <span class="nav-main-link-name">دسته‌بندی‌های عمومی</span>
                                    </a>
                                </li>
                                <li class="nav-main-item">
                                    <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "BranchTaskCategory", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="BranchTaskCategory" asp-action="Index">
                                        <i class="nav-main-link-icon fa fa-building"></i>
                                        <span class="nav-main-link-name">دسته‌بندی‌های شعب</span>
                                    </a>
                                </li>
                            </ul>
                        </li>
                    }

                    <!-- تنظیمات عمومی -->
                    @if (Html.CanAccess("Settings") || isAdminOrManager)
                    {
                        <li class="nav-main-item">
                            <a class="nav-main-link @(IsMenuItemActive(currentController, currentAction, "Settings", "Index") ? "active" : "")" asp-area="AdminArea" asp-controller="Settings" asp-action="Index">
                                <i class="nav-main-link-icon fa fa-cogs text-primary"></i>
                                <span class="nav-main-link-name">تنظیمات عمومی</span>
                            </a>
                        </li>
                    }
                }

                <!-- ============== 🚪 LOGOUT ============== -->
                <li class="nav-main-heading">خروج</li>
                <li class="nav-main-item">
                    <a class="nav-main-link logout-link" href="/Account/LogOut">
                        <i class="nav-main-link-icon fa fa-sign-out-alt text-danger"></i>
                        <span class="nav-main-link-name">خروج از سیستم</span>
                    </a>
                </li>

            </ul>
        </div>
        <!-- END Side Navigation -->
    </div>
    <!-- END Sidebar Scrolling -->
</nav>
<!-- END Sidebar -->


<!-- Modal Advanced Search -->
<div class="modal fade" id="modal-advanced-search" tabindex="-1" role="dialog" aria-labelledby="modal-advanced-search" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="advanced-search-content">
            <!-- Content will be loaded here via AJAX -->
        </div>
    </div>
</div>

<!-- Modal Advanced Search for Tasks -->
<div class="modal fade" id="modal-advanced-search-task" tabindex="-1" role="dialog" aria-labelledby="modal-advanced-search-task" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content" id="advanced-search-task-content">
            <!-- Content will be loaded here via AJAX -->
        </div>
    </div>
</div>

@functions {
    /// <summary>
    /// بررسی active بودن آیتم‌های منو
    /// </summary>
    public bool IsMenuItemActive(string currentController, string currentAction, string targetController, string targetAction)
    {
        return currentController == targetController && currentAction == targetAction;
    }

    /// <summary>
    /// بررسی active بودن نوع طرف حساب
    /// </summary>
    public bool IsStakeholderTypeActive(string currentController, string currentAction, string personType)
    {
        if (currentController != "Stakeholder" || currentAction != "Index")
            return false;

        var queryPersonType = Context.Request.Query["personType"].ToString();
        return queryPersonType == personType;
    }

    /// <summary>
    /// بررسی active بودن آیتم‌های منوی تسک با در نظر گیری TaskViewType
    /// </summary>
    public bool IsTaskMenuItemActive(string currentController, string currentAction, string taskViewType, string targetController, string targetAction, string targetViewType)
    {
        return currentController == targetController &&
               currentAction == targetAction &&
               taskViewType == targetViewType;
    }

    /// <summary>
    /// بررسی active بودن منوی تسک‌ها
    /// </summary>
    public bool IsTaskMenuActive(string currentController)
    {
        return currentController == "Tasks";
    }

    /// <summary>
    /// بررسی active بودن منوی شعب
    /// </summary>
    public bool IsBranchMenuActive(string currentController)
    {
        return currentController == "Branch" || currentController == "BranchUser";
    }

    /// <summary>
    /// بررسی active بودن منوی تیم‌ها
    /// </summary>
    public bool IsTeamMenuActive(string currentController)
    {
        return currentController == "Team";
    }

    /// <summary>
    /// بررسی active بودن منوی مدیریت کاربران
    /// </summary>
    public bool IsUserManagementMenuActive(string currentController)
    {
        return currentController == "UserManager";
    }

    /// <summary>
    /// بررسی active بودن منوی نقش‌ها و دسترسی‌ها
    /// </summary>
    public bool IsRoleMenuActive(string currentController)
    {
        return currentController == "RolePattern" || currentController == "UserPermission";
    }

    /// <summary>
    /// بررسی active بودن منوی طرف حساب‌ها
    /// </summary>
    public bool IsStakeholderMenuActive(string currentController)
    {
        return currentController == "Stakeholder";
    }

    /// <summary>
    /// بررسی active بودن منوی قراردادها
    /// </summary>
    public bool IsContractMenuActive(string currentController)
    {
        return currentController == "Contract";
    }

    /// <summary>
    /// بررسی active بودن منوی CRM
    /// </summary>
    public bool IsCRMMenuActive(string currentController)
    {
        return currentController == "CRM";
    }

    /// <summary>
    /// بررسی active بودن منوی لاگ فعالیت‌ها
    /// </summary>
    public bool IsActivityLogMenuActive(string currentController)
    {
        return currentController == "UserActivityLog";
    }

    /// <summary>
    /// بررسی active بودن منوی دسته‌بندی تسک‌ها
    /// </summary>
    public bool IsTaskCategoryMenuActive(string currentController)
    {
        return currentController == "TaskCategory" || currentController == "BranchTaskCategory";
    }
    /// <summary>
    /// بررسی active بودن منوی سازمان‌ها
    /// </summary>
    public bool IsOrganizationMenuActive(string currentController)
    {
        return currentController == "Organizations";
    }

    /// <summary>
    /// بررسی active بودن نوع سازمان
    /// </summary>
    public bool IsOrganizationTypeActive(string currentController, string currentAction, string organizationType)
    {
        if (currentController != "Organizations" || currentAction != "Index")
            return false;

        var queryOrgType = Context.Request.Query["organizationType"].ToString();
        return queryOrgType == organizationType;
    }

    /// <summary>
    /// بررسی active بودن منوی افراد
    /// </summary>
    public bool IsContactMenuActive(string currentController)
    {
        return currentController == "Contacts";
    }

  
}

<!-- JavaScript for Sidebar Functionality -->
<script>
    function loadAdvancedSearchModal() {
        createAndShowModal('@Url.Action("AdvancedSearch", "Stakeholder", new { area = "AdminArea" })');
    }

    function loadTaskAdvancedSearchModal() {
        createAndShowModal('@Url.Action("AdvancedSearch", "Tasks", new { area = "AdminArea" })');
    }

    function createAndShowModal(url) {
        $('#advanced-search-content, #advanced-search-task-content').html(`
            <div class="modal-body text-center">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">در حال بارگذاری...</span>
                    </div>
                </div>
                <p class="mt-3">در حال بارگذاری...</p>
            </div>
        `);

        $.get(url, function(data) {
            if (url.includes('Tasks')) {
                $('#advanced-search-task-content').html(data);
            } else {
                $('#advanced-search-content').html(data);
            }
        }).fail(function() {
            const errorContent = `
                <div class="modal-body text-center">
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        خطا در بارگذاری محتوا. لطفاً دوباره تلاش کنید.
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                </div>
            `;
            if (url.includes('Tasks')) {
                $('#advanced-search-task-content').html(errorContent);
            } else {
                $('#advanced-search-content').html(errorContent);
            }
        });
    }

    $(document).ready(function() {
        updateTaskCounts();
        updateMyDayCount();
        setInterval(function() {
            updateTaskCounts();
            updateMyDayCount();
        }, 120000);
    });

    function updateTaskCounts() {
        $.get('@Url.Action("GetDashboardSummary", "Dashboard", new { area = "AdminArea" })')
            .done(function(response) {
                if (response.success) {
                    updateBadgeCount('#myTasksCount', response.tasksStats.myTasksCount);
                    updateBadgeCount('#assignedByMeCount', response.tasksStats.assignedByMeCount);
                    updateBadgeCount('#supervisedTasksCount', response.tasksStats.supervisedTasksCount);
                    updateBadgeCount('#remindersCount', response.tasksStats.remindersCount);
                    updateBadgeCount('#taskBadgeCount', response.tasksStats.myTasksCount + response.tasksStats.remindersCount);
                }
            });
    }

    function updateMyDayCount() {
        $.get('@Url.Action("GetMyDayTasksCount", "Tasks", new { area = "AdminArea" })').done(function(data) {
            if (data.success) {
                updateBadgeCount('#myDayCount', data.count);
            }
        });
    }

    function updateBadgeCount(selector, count) {
        const badge = $(selector);
        if (count > 0) {
            badge.text(count).show();
        } else {
            badge.hide();
        }
    }

    $('.nav-main-link').on('click', function(e) {
        if ($(this).hasClass('nav-main-link-submenu')) return;
        const icon = $(this).find('.nav-main-link-icon');
        const originalIcon = icon.attr('class');
        icon.attr('class', 'nav-main-link-icon fa fa-spinner fa-spin');
        setTimeout(() => {
            icon.attr('class', originalIcon);
        }, 1000);
    });
</script>

<!-- Enhanced Styles - باقی مانده مشابه قبل... -->
<style>
    /* همان CSS های قبلی */
    .nav-submenu-separator {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 0.5rem;
        margin-top: 0.5rem;
    }

    .nav-submenu-separator:first-child {
        border-top: none;
        padding-top: 0;
        margin-top: 0;
    }

    .nav-submenu-title {
        padding: 0.25rem 1rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .nav-main-link-badge {
        animation: badgePulse 2s infinite;
        font-size: 0.625rem;
        min-width: 1.25rem;
        height: 1.25rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    @@keyframes badgePulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .text-orange { color: #fd7e14 !important; }
    .text-purple { color: #6f42c1 !important; }

    .nav-main-link {
        transition: all 0.3s ease;
        border-radius: 0.375rem;
        margin: 0.125rem 0.5rem;
    }

    .nav-main-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: translateX(-2px);
    }

    .nav-main-link-create {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.1), rgba(25, 135, 84, 0.2));
        border-left: 3px solid #198754;
    }

    .nav-main-link-create:hover {
        background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(25, 135, 84, 0.3));
    }

    .logout-link {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.2));
        border-left: 3px solid #dc3545;
    }

    .logout-link:hover {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.3));
    }

    @@media (max-width: 991.98px) {
        .nav-main-link-name { font-size: 0.875rem; }
        .nav-submenu-title small { font-size: 0.7rem; }
    }

    .nav-main-link.loading .nav-main-link-icon {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .nav-main-heading {
        position: relative;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: rgba(255, 255, 255, 0.8);
        margin-top: 1.5rem;
        margin-bottom: 0.75rem;
        padding: 0 1rem;
    }

    .nav-main-heading:first-child {
        margin-top: 0.5rem;
    }

    .nav-main-heading::after {
        content: '';
        position: absolute;
        bottom: -0.25rem;
        left: 1rem;
        right: 1rem;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    }
</style>