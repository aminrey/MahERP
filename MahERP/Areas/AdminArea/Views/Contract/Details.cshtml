@model ContractViewModel
@{
    ViewData["Title"] = $"جزئیات قرارداد - {Model.Title}";
}

<!-- Hero -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo10.jpg');">
    <div class="bg-primary-dark-op">
        <div class="content content-full text-center py-6">
            <h1 class="h2 text-white mb-2">@Model.Title</h1>
            <h2 class="h4 fw-normal text-white-75 mb-0">@Model.ContractNumber</h2>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- Quick Actions -->
    <div class="row items-push">
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("EditContract", "Contract", new { id = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-pencil-alt text-primary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        ویرایش
                    </p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="javascript:void(0)" onclick="openModal('@Url.Action("ChangeStatus", "Contract", new { id = Model.Id })')">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-sync-alt text-info"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        تغییر وضعیت
                    </p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="javascript:void(0)" onclick="openModal('@Url.Action("ToggleActivation", "Contract", new { id = Model.Id })')">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-@(Model.IsActive ? "ban text-danger" : "check text-success")"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        @(Model.IsActive ? "غیرفعال کردن" : "فعال کردن")
                    </p>
                </div>
            </a>
        </div>
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" href="@Url.Action("AddTask", "Task", new { contractId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-tasks text-success"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        افزودن تسک
                    </p>
                </div>
            </a>
        </div>
    </div>
    <!-- END Quick Actions -->
    <!-- Contract Information -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-file-contract text-muted me-1"></i> اطلاعات قرارداد
            </h3>
            <div class="block-options">
                <a href="@Url.Action("EditContract", "Contract", new { id = Model.Id })" class="btn btn-sm btn-alt-primary">
                    <i class="fa fa-pencil-alt me-1"></i> ویرایش
                </a>
            </div>
        </div>
        <div class="block-content">
            <div class="row">
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">عنوان قرارداد</label>
                        <div class="form-control-plaintext">@Model.Title</div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">شماره قرارداد</label>
                        <div class="form-control-plaintext">@Model.ContractNumber</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">طرف حساب</label>
                        <div class="form-control-plaintext">
                            <a href="@Url.Action("Details", "Stakeholder", new { id = Model.StakeholderId })">
                                @Model.StakeholderFullName
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">وضعیت</label>
                        <div class="form-control-plaintext">
                            @switch (Model.Status)
                            {
                                case 0:
                                    <span class="badge bg-info">پیش‌نویس</span>
                                    break;
                                case 1:
                                    <span class="badge bg-success">فعال</span>
                                    break;
                                case 2:
                                    <span class="badge bg-warning">تمام شده</span>
                                    break;
                                case 3:
                                    <span class="badge bg-danger">لغو شده</span>
                                    break;
                                default:
                                    <span class="badge bg-secondary">نامشخص</span>
                                    break;
                            }
                            @if (!Model.IsActive)
                            {
                                <span class="badge bg-danger ms-1">غیرفعال</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">تاریخ شروع</label>
                        <div class="form-control-plaintext">@Model.StartDatePersian</div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">تاریخ پایان</label>
                        <div class="form-control-plaintext">@(string.IsNullOrEmpty(Model.EndDatePersian) ? "-" : Model.EndDatePersian)</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">مبلغ قرارداد</label>
                        <div class="form-control-plaintext">@Model.ContractValue.ToString("N0") تومان</div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">تاریخ ایجاد</label>
                        <div class="form-control-plaintext">@ConvertDateTime.ConvertMiladiToShamsi(Model.CreateDate, "yyyy/MM/dd")</div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">ایجاد کننده</label>
                        <div class="form-control-plaintext">@Model.CreatorFullName</div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="mb-4">
                        <label class="form-label">آخرین بروزرسانی</label>
                        <div class="form-control-plaintext">
                            @if (Model.LastUpdateDate.HasValue)
                            {
                                <span>@ConvertDateTime.ConvertMiladiToShamsi(Model.LastUpdateDate.Value, "yyyy/MM/dd") توسط @Model.LastUpdaterFullName</span>
                            }
                            else
                            {
                                <span>-</span>
                            }
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label class="form-label">توضیحات</label>
                <div class="form-control-plaintext">@(string.IsNullOrEmpty(Model.Description) ? "-" : Model.Description)</div>
            </div>
        </div>
    </div>
    <!-- END Contract Information -->
    <!-- Tasks -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-tasks text-muted me-1"></i> تسک‌های مرتبط
            </h3>
            <div class="block-options">
                <a href="@Url.Action("AddTask", "Task", new { contractId = Model.Id })" class="btn btn-sm btn-alt-primary">
                    <i class="fa fa-plus me-1"></i> افزودن تسک
                </a>
            </div>
        </div>
        <div class="block-content">
            @if (ViewBag.Tasks != null && ((List<Tasks>)ViewBag.Tasks).Count > 0)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-vcenter">
                        <thead>
                            <tr>
                                <th class="text-center">کد</th>
                                <th class="text-center">عنوان</th>
                                <th class="text-center">اولویت</th>
                                <th class="text-center">وضعیت</th>
                                <th class="text-center">مهلت</th>
                                <th class="text-center" style="width: 100px;">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var task in (List<Tasks>)ViewBag.Tasks)
                            {
                                <tr>
                                    <td class="text-center fw-semibold">
                                        <a href="@Url.Action("Details", "Task", new { id = task.Id })">
                                            @task.TaskCode
                                        </a>
                                    </td>
                                    <td class="text-center">@task.Title</td>
                                    <td class="text-center">
                                        @switch (task.Priority)
                                        {
                                            case 0:
                                                <span class="badge bg-info">عادی</span>
                                                break;
                                            case 1:
                                                <span class="badge bg-warning">مهم</span>
                                                break;
                                            case 2:
                                                <span class="badge bg-danger">فوری</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center">
                                        @switch (task.Status)
                                        {
                                            case 0:
                                                <span class="badge bg-info">ایجاد شده</span>
                                                break;
                                            case 1:
                                                <span class="badge bg-warning">در حال انجام</span>
                                                break;
                                            case 2:
                                                <span class="badge bg-success">تکمیل شده</span>
                                                break;
                                            case 3:
                                                <span class="badge bg-primary">تأیید شده</span>
                                                break;
                                            case 4:
                                                <span class="badge bg-danger">رد شده</span>
                                                break;
                                            case 5:
                                                <span class="badge bg-secondary">در انتظار</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center">
                                        @(task.DueDate.HasValue? ConvertDateTime.ConvertMiladiToShamsi(task.DueDate.Value, "yyyy/MM/dd") : "-")
                                    </td>
                                    <td class="text-center">
                                        <a href="@Url.Action("Details", "Task", new { id = task.Id })" class="btn btn-sm btn-alt-secondary" data-bs-toggle="tooltip" title="مشاهده">
                                            <i class="fa fa-fw fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fa fa-tasks fa-3x text-muted mb-3"></i>
                    <p class="mb-3">هیچ تسکی برای این قرارداد ثبت نشده است.</p>
                    <a href="@Url.Action("AddTask", "Task", new { contractId = Model.Id })" class="btn btn-primary">
                        <i class="fa fa-plus me-1"></i> افزودن تسک
                    </a>
                </div>
            }
        </div>
    </div>
    <!-- END Tasks -->
</div>
<!-- END Page Content -->
<!-- Modal Container for dynamic content -->
<div class="modal fade" id="modal-contract" tabindex="-1" role="dialog" aria-labelledby="modal-contract" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <!-- Dynamic content will be loaded here -->
            <div class="modal-body">
                <div class="text-center">
                    <i class="fa fa-3x fa-spinner fa-spin text-primary my-3"></i>
                    <h3 class="mt-2 mb-3">در حال بارگذاری...</h3>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        // Function to open modal and load content
        function openModal(url) {
            $('#modal-contract .modal-content').html('<div class="modal-body text-center"><i class="fa fa-3x fa-spinner fa-spin text-primary my-3"></i><h3 class="mt-2 mb-3">در حال بارگذاری...</h3></div>');
            $('#modal-contract').modal('show');

            // Load content via AJAX
            $.get(url, function(data) {
                $('#modal-contract .modal-content').html(data);
            });
        }

        // Initialize tooltips
        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    </script>
}