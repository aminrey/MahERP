@model StakeholderViewModel
@{
    ViewData["Title"] = $"جزئیات - {Model.DisplayName}";
}

<!-- Hero -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo10.jpg');">
    <div class="bg-primary-dark-op">
        <div class="content content-full text-center py-6">
            <h1 class="h2 text-white mb-2">@Model.DisplayName</h1>
            <h2 class="h4 fw-normal text-white-75 mb-0">
                @Model.PersonTypeText
                @if (!string.IsNullOrEmpty(Model.CompanyName))
                {
                    <span class="mx-2">|</span>
                    <span>@Model.CompanyName</span>
                }
            </h2>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- دکمه‌های عملیاتی - ردیف اول -->
    <div class="row items-push">
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("EditStakeholder", "Stakeholder", new { id = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-pencil-alt text-primary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">ویرایش</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("AddContract", "Contract", new { stakeholderId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-file-contract text-success"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن قرارداد</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("AddContact", "Stakeholder", new { stakeholderId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-user-plus text-info"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن شخص مرتبط</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("ActiveOrDeactiveStakeholder", "Stakeholder", new { id = Model.Id, returnUrl = "Details" })"
               data-toggle="modal-ajax">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-@(Model.IsActive ? "ban text-danger" : "check text-success")"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        @(Model.IsActive ? "غیرفعال کردن" : "فعال کردن")
                    </p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("DeleteStakeholder", "Stakeholder", new { id = Model.Id, returnUrl = "Details" })"
               data-toggle="modal-ajax">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-trash-alt text-danger"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">حذف</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="@Url.Action("Index", "Stakeholder")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-arrow-left text-secondary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">بازگشت</p>
                </div>
            </a>
        </div>
    </div>
    <!-- END Quick Actions -->
    <!-- دکمه‌های بخش‌های جزئیات - ردیف دوم -->
    <div class="block block-rounded">
        <ul class="nav nav-tabs nav-tabs-block justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-info" data-bs-toggle="tab"
                        data-bs-target="#info-panel" type="button" role="tab">
                    <i class="fa fa-info-circle me-1"></i> اطلاعات پایه
                </button>
            </li>

            @if (Model.PersonType == 1)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-chart" data-bs-toggle="tab"
                            data-bs-target="#chart-panel" type="button" role="tab">
                        <i class="fa fa-sitemap me-1"></i> چارت سازمانی
                    </button>
                </li>
            }

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-contacts" data-bs-toggle="tab"
                        data-bs-target="#contacts-panel" type="button" role="tab">
                    <i class="fa fa-users me-1"></i> کارکنان و افراد مرتبط
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-contracts" data-bs-toggle="tab"
                        data-bs-target="#contracts-panel" type="button" role="tab">
                    <i class="fa fa-file-contract me-1"></i> قراردادها
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-stats" data-bs-toggle="tab"
                        data-bs-target="#stats-panel" type="button" role="tab">
                    <i class="fa fa-chart-line me-1"></i> آمار و فعالیت‌ها
                </button>
            </li>
        </ul>

        <div class="block-content tab-content">
            <!-- بخش اطلاعات پایه -->
            <div class="tab-pane active" id="info-panel" role="tabpanel">
                @await Html.PartialAsync("_BasicInfo", Model)
            </div>

            <!-- بخش چارت سازمانی -->
            @if (Model.PersonType == 1)
            {
                <div class="tab-pane" id="chart-panel" role="tabpanel"> 
                    @await Html.PartialAsync("_OrganizationChartContent", Model.Id)
                </div>
            }

            <!-- بخش کارکنان -->
            <div class="tab-pane" id="contacts-panel" role="tabpanel">
                <div id="contacts-content">
                    @{
                        var contacts = ViewBag.Contacts as List<StakeholderContact> ?? new List<StakeholderContact>();
                    }
                    @await Html.PartialAsync("_ContactsList", contacts)
                </div>
            </div>

            <!-- بخش قراردادها -->
            <div class="tab-pane" id="contracts-panel" role="tabpanel">
                <div id="contracts-content">
                    @{
                        var contracts = ViewBag.Contracts as List<Contract> ?? new List<Contract>();
                    }
                    @await Html.PartialAsync("_ContractsList", contracts)
                </div>
            </div>

            <!-- بخش آمار -->
            <div class="tab-pane" id="stats-panel" role="tabpanel">
                <div id="stats-content">
                    @await Html.PartialAsync("_StatsAndActivities", Model)
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END Page Content -->


@section Scripts {
    <script>
        $(document).ready(function() {
            // بارگذاری lazy برای چارت سازمانی
            $('#tab-chart').one('shown.bs.tab', function() {
                $.ajax({
                    url: '@Url.Action("OrganizationChart", "Stakeholder", new { stakeholderId = Model.Id })',
                    method: 'GET',
                    success: function(data) {
                        var $html = $(data);
                        var $chartContainer = $html.find('#org-chart-container');

                        if ($chartContainer.length > 0) {
                            var chartContent = $chartContainer.html();
                            $('#org-chart-container').html(chartContent);
                        } else {
                            var blockContent = $html.find('.block-content').first().html();
                            $('#org-chart-container').html(blockContent);
                        }
                    },
                    error: function() {
                        $('#org-chart-container').html(
                            '<div class="alert alert-danger text-center">' +
                            '<i class="fa fa-exclamation-triangle me-2"></i>خطا در بارگذاری چارت سازمانی' +
                            '</div>'
                        );
                    }
                });
            });

            // فعال‌سازی tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();

            // اسکرول هوشمند برای موبایل
            if ($(window).width() < 768) {
                $('#org-chart-container').css('overflow-x', 'auto');
            }
        });
    </script>
}