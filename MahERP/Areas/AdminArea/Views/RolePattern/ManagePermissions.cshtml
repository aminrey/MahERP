@model RolePatternPermissionViewModel
@{
    ViewData["Title"] = "مدیریت دسترسی‌ها";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">مدیریت دسترسی‌ها</h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-area="AdminArea" asp-controller="Dashboard" asp-action="Index">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-action="Index">الگوهای نقش</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-action="Details" asp-route-id="@Model.RolePatternId">@Model.PatternName</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">مدیریت دسترسی‌ها</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content">
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-key text-muted me-1"></i> مدیریت دسترسی‌های الگوی نقش: @Model.PatternName
            </h3>
            <div class="block-options">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-success" onclick="selectAllPermissions()">
                        <i class="fa fa-check-square me-1"></i>انتخاب همه
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deselectAllPermissions()">
                        <i class="fa fa-square me-1"></i>لغو انتخاب همه
                    </button>
                </div>
            </div>
        </div>
        <div class="block-content block-content-full">
            <form asp-action="UpdatePermissions" method="post">
                <input asp-for="RolePatternId" type="hidden" />
                <input asp-for="PatternName" type="hidden" />

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <i class="fa fa-info-circle me-1"></i>
                            <strong>سیستم دسترسی:</strong>
                            <br>• **همه بخش‌ها** قابل کنترل دسترسی هستند
                            <br>• **دسترسی مشاهده** برای هر بخش قابل تنظیم است
                            <br>• هر بخش می‌تواند به صورت مستقل فعال یا غیرفعال شود
                        </div>
                    </div>
                </div>

                @{
                    var controllerActions = new List<ControllerInfo>
                                {
                                new ControllerInfo
                                {
                                Name = "TaskInitialSettings",
                                DisplayName = "تعاریف اولیه تسک‌ینگ",
                                Actions = new ActionInfo[]
                                {
                                new ActionInfo { Name = "General", DisplayName = "شامل دسته‌بندی تسک و اتصال به شعب" }
                                }
                                },
                                new ControllerInfo
                                {
                                Name = "Dashboard",
                                DisplayName = "📊 داشبورد و گزارشات",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به داشبورد و گزارشات" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Tasks",
                                DisplayName = "📋 عملیات تسک‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به عملیات تسک‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Branch",
                                DisplayName = "🏢 مدیریت شعب",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به مدیریت شعب" } }
                                },
                                new ControllerInfo
                                {
                                Name = "BranchUser",
                                DisplayName = "👥 کاربران شعب",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به کاربران شعب" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Team",
                                DisplayName = "👥 مدیریت تیم‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به مدیریت تیم‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "UserManager",
                                DisplayName = "👤 مدیریت کاربران",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به مدیریت کاربران" } }
                                },
                                new ControllerInfo
                                {
                                Name = "RolePattern",
                                DisplayName = "🔑 مدیریت نقش‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به مدیریت نقش‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "UserPermission",
                                DisplayName = "🔐 دسترسی کاربران",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به تنظیم دسترسی کاربران" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Stakeholder",
                                DisplayName = "🤝 طرف حساب‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به طرف حساب‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Contract",
                                DisplayName = "📄 قراردادها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به قراردادها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "CRM",
                                DisplayName = "📊 مدیریت CRM",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به مدیریت CRM" } }
                                },
                                new ControllerInfo
                                {
                                Name = "UserActivityLog",
                                DisplayName = "📊 لاگ فعالیت‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به لاگ فعالیت‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Notification",
                                DisplayName = "🔔 نوتیفیکیشن‌ها",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به نوتیفیکیشن‌ها" } }
                                },
                                new ControllerInfo
                                {
                                Name = "Settings",
                                DisplayName = "⚙️ تنظیمات سیستم",
                                Actions = new ActionInfo[] { new ActionInfo { Name = "General", DisplayName = "دسترسی به تنظیمات سیستم" } }
                                }
                                };

                    Model.Controllers = controllerActions;
                }

                <!-- جدول دسترسی‌ها -->
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-vcenter table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width: 500px;">
                                    <strong>بخش‌های سیستم</strong>
                                    <br><small class="text-muted">دسترسی‌ها و توضیحات</small>
                                </th>
                                <th class="text-center" style="width: 200px;">
                                    <i class="fa fa-eye text-info me-1"></i><strong>دسترسی</strong>
                                    <br><small class="text-muted">فعال/غیرفعال</small>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Controllers.Count; i++)
                            {
                                var controller = Model.Controllers[i];
                                var action = controller.Actions[0];
                                var existingPermission = Model.CurrentPermissions.FirstOrDefault(p =>
                                p.ControllerName == controller.Name && p.ActionName == action.Name);
                                var permissionIndex = Model.Permissions.Count;

                                // Add to Permissions list
                                Model.Permissions.Add(new RolePatternDetailsViewModel
                                {
                                    ControllerName = controller.Name,
                                    ActionName = action.Name,
                                    ControllerDisplayName = controller.DisplayName, // ✅ اضافه شده
                                    ActionDisplayName = action.DisplayName,         // ✅ اضافه شده
                                    CanRead = existingPermission?.CanRead ?? false,
                                    CanCreate = false, // غیرفعال برای همه
                                    CanEdit = false,   // غیرفعال برای همه
                                    CanDelete = false, // غیرفعال برای همه
                                    CanApprove = false, // غیرفعال برای همه
                                    DataAccessLevel = 0, // حذف شده
                                    IsActive = true
                                });
                                <tr class="table-light-blue">
                                    <td class="fw-semibold">
                                        <div class="d-flex align-items-center">
                                            <i class="fa fa-shield-alt text-primary me-3 fs-5"></i>
                                            <div>
                                                <h6 class="mb-1">@controller.DisplayName</h6>
                                                <small class="text-muted">
                                                    <span class="badge bg-primary">
                                                        <i class="fa fa-lock me-1"></i>قابل کنترل
                                                    </span>
                                                    <br>@action.DisplayName
                                                </small>
                                            </div>
                                        </div>
                                        <input asp-for="Permissions[permissionIndex].ControllerName" type="hidden" value="@controller.Name" />
                                        <input asp-for="Permissions[permissionIndex].ActionName" type="hidden" value="@action.Name" />
                                        <input asp-for="Permissions[permissionIndex].ControllerDisplayName" type="hidden" value="@controller.DisplayName" />
                                        <input asp-for="Permissions[permissionIndex].ActionDisplayName" type="hidden" value="@action.DisplayName" />
                                        <input asp-for="Permissions[permissionIndex].IsActive" type="hidden" value="true" />
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check form-switch d-flex justify-content-center">
                                            <input asp-for="Permissions[permissionIndex].CanRead" class="form-check-input permission-checkbox" type="checkbox" style="transform: scale(1.5);" />
                                        </div>
                                        <small class="text-muted mt-1 d-block">
                                            <span class="text-primary">دسترسی کلی</span>
                                        </small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-primary border-start border-primary border-4">
                            <div class="d-flex align-items-center">
                                <i class="fa fa-shield-alt fs-4 text-primary me-3"></i>
                                <div>
                                    <h5 class="mb-2">🔐 سیستم دسترسی ساده:</h5>
                                    <ul class="mb-0">
                                        <li><strong>همه بخش‌ها قابل کنترل:</strong> هر بخش می‌تواند فعال یا غیرفعال شود</li>
                                        <li><strong>دسترسی یکپارچه:</strong> فقط کنترل کلی روی هر بخش</li>
                                        <li><strong>تعاریف اولیه تسک‌ینگ:</strong> شامل دسته‌بندی تسک‌ها و اتصال به شعب</li>
                                        <li><strong>ساده و کارآمد:</strong> حداقل پیچیدگی، حداکثر انعطاف</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="block-content bg-body-light">
                    <div class="row">
                        <div class="col-6">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fa fa-check opacity-50 me-1"></i> ذخیره دسترسی‌ها
                            </button>
                        </div>
                        <div class="col-6 text-end">
                            <a asp-action="Details" asp-route-id="@Model.RolePatternId" class="btn btn-alt-secondary btn-lg">
                                <i class="fa fa-arrow-right opacity-50 me-1"></i> بازگشت
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- END Page Content -->
@section Scripts {
    <script>
        function selectAllPermissions() {
            $('.permission-checkbox').prop('checked', true);
        }

        function deselectAllPermissions() {
            $('.permission-checkbox').prop('checked', false);
        }

        $(document).ready(function() {
            $('[title]').tooltip();
        });
    </script>

    <style>
        .table th, .table td {
            vertical-align: middle;
            padding: 1rem 0.75rem;
        }

        .form-check-input {
            border-width: 2px;
        }

        .table-responsive {
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        }

        /* رنگ‌بندی یکپارچه برای همه ردیف‌ها */
        .table-light-blue {
            background-color: rgba(13, 110, 253, 0.08) !important;
            border-left: 4px solid #0d6efd;
        }

        .table tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.15) !important;
            transform: scale(1.005);
            transition: all 0.2s ease;
        }

        /* هدر جدول */
        .table-dark th {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: none;
            color: white;
            font-weight: 600;
        }

        /* سوییچ بهبود یافته */
        .form-switch .form-check-input {
            width: 2.5rem;
            height: 1.25rem;
        }

            .form-switch .form-check-input:checked {
                background-color: #198754;
                border-color: #198754;
                box-shadow: 0 0 8px rgba(25, 135, 84, 0.4);
            }

        /* badge ها */
        .badge {
            font-size: 0.75rem;
            padding: 0.4em 0.7em;
            font-weight: 500;
        }

        /* آیکون‌ها */
        .fs-4 {
            font-size: 1.5rem !important;
        }

        .fs-5 {
            font-size: 1.25rem !important;
        }

        /* انیمیشن دکمه‌ها */
        .btn {
            transition: all 0.2s ease;
        }

            .btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            }

        /* responsive */
        @@media (max-width: 768px) {
            .table th, .table td

        {
            padding: 0.75rem 0.5rem;
            font-size: 0.85rem;
        }

        }
    </style>
}