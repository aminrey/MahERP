@model TaskViewModel
@{
    ViewData["Title"] = "افزودن تسک جدید";
}
<style>
    .select2-invalid .select2-selection {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }

    .select2-validation .select2-selection {
        border: 1px solid #ced4da;
    }

    .select2-validation.select2-invalid .select2-selection {
        border-color: #dc3545;
    }

    /* استایل‌های جدید برای لیست کارها */
    .js-task {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6 !important;
    }

        .js-task:hover {
            border-color: #007bff !important;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }

        .js-task .js-task-content {
            color: #495057;
            line-height: 1.4;
        }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animated.fadeIn {
        animation: fadeIn 0.3s ease-in-out;
    }

    /* ⭐⭐⭐ استایل‌های جدید برای بخش‌بندی */
    .task-section {
        border: 2px dashed #e3e7ed;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
        background: #f9fafb;
        transition: all 0.3s ease;
    }

    .task-section:hover {
        border-color: #4c9aff;
        background: #f0f7ff;
        box-shadow: 0 2px 8px rgba(76, 154, 255, 0.1);
    }

    .task-section-title {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #e3e7ed;
    }

    .task-section-title i {
        font-size: 20px;
        margin-left: 10px;
        color: #4c9aff;
    }

    .task-section-title h5 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
    }

    .task-section-required {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .task-section-required:hover {
        background: #fff8dc;
        border-color: #ff9800;
    }

    /* بهبود user assignment cards */
    .user-assignment-row {
        transition: all 0.2s ease;
        border: 1px solid #e3e7ed;
    }

    .user-assignment-row:hover {
        border-color: #4c9aff;
        box-shadow: 0 2px 6px rgba(76, 154, 255, 0.15);
    }
</style>

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">افزودن تسک جدید</h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">مدیریت</li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Tasks")">تسک‌ها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">افزودن جدید</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<!-- Page Content -->
<div class="content content-full content-boxed">
    <form method="POST" action="@Url.Action("CreateNewTask", "Tasks")" enctype="multipart/form-data" id="createTaskForm">
        @Html.AntiForgeryToken()
        
        <!-- Navigation Tabs -->
        <div class="block block-rounded">
            <ul class="nav nav-tabs nav-tabs-block" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="main-info-tab" data-bs-toggle="tab" data-bs-target="#main-info" type="button" role="tab">
                        <i class="fa fa-info-circle me-1"></i>
                        اطلاعات اصلی
                        <span class="badge bg-danger ms-1 d-none" id="main-info-error">!</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="project-info-tab" data-bs-toggle="tab" data-bs-target="#project-info" type="button" role="tab">
                        <i class="fa fa-folder-open me-1"></i>
                       جزئیات بیشتر تسک
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="timeframe-tab" data-bs-toggle="tab" data-bs-target="#timeframe" type="button" role="tab">
                        <i class="fa fa-clock me-1"></i>
                        بازه زمانی
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="operations-tab" data-bs-toggle="tab" data-bs-target="#operations" type="button" role="tab">
                        <i class="fa fa-tasks me-1"></i>
                        فهرست کارها
                        <span class="badge bg-primary ms-1" id="operations-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#reminders" type="button" role="tab">
                        <i class="fa fa-bell me-1"></i>
                        یادآوری‌ها
                        <span class="badge bg-success ms-1" id="reminders-count">1</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="viewers-tab" data-bs-toggle="tab" data-bs-target="#viewers" type="button" role="tab">
                        <i class="fa fa-eye me-1"></i>
                        ناظرین
                        <span class="badge bg-info ms-1" id="viewers-count">0</span>
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content">
            <!-- Tab 1: اطلاعات اصلی -->
            <div class="tab-pane active" id="main-info" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">اطلاعات اصلی تسک</h3>
                        <div class="block-options">
                            <small class="text-muted">اطلاعات ضروری و الزامی</small>
                        </div>
                    </div>
                    <div class="block-content">
                        <div class="row justify-content-center">
                            <div class="col-md-12 col-lg-10">
                                
                                <!-- نمایش خطاهای عمومی -->
                                @if (!ViewData.ModelState.IsValid)
                                {
                                    <div class="alert alert-danger alert-dismissible" role="alert">
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        <h4 class="alert-heading">
                                            <i class="fa fa-exclamation-triangle me-2"></i>
                                            خطا در اعتبارسنجی اطلاعات
                                        </h4>
                                        <p class="mb-0">لطفاً خطاهای زیر را اصلاح کنید:</p>
                                        <hr>
                                        <ul class="mb-0">
                                            @foreach (var modelError in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                            {
                                                <li>@modelError.ErrorMessage</li>
                                            }
                                        </ul>
                                    </div>
                                }

                                <!-- نمایش پیام‌های موفقیت -->
                                @if (TempData["SuccessMessage"] != null)
                                {
                                    <div class="alert alert-success alert-dismissible" role="alert">
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        <i class="fa fa-check-circle me-2"></i>
                                        @TempData["SuccessMessage"]
                                    </div>
                                }

                                <!-- نمایش پیام‌های خطای عمومی -->
                                @if (TempData["ErrorMessage"] != null)
                                {
                                    <div class="alert alert-danger alert-dismissible" role="alert">
                                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                        <i class="fa fa-times-circle me-2"></i>
                                        @TempData["ErrorMessage"]
                                    </div>
                                }

                                <!-- ⭐⭐⭐ بخش 1: کد و نوع تسک -->
                                <div class="task-section task-section-required">
                                    <div class="task-section-title">
                                        <i class="fa fa-barcode"></i>
                                        <h5>کد و نوع تسک</h5>
                                        <span class="badge bg-danger ms-2">الزامی</span>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label" for="TaskCode">
                                                    کد تسک <span class="text-danger">*</span>
                                                    @if (Model.TaskCodeSettings?.AllowManualInput == true)
                                                    {
                                                        <small class="text-muted ms-2">
                                                            (پیشوند سیستمی: @Model.TaskCodeSettings.SystemPrefix-)
                                                        </small>
                                                    }
                                                </label>

                                                <!-- نمایش کد اتوماتیک -->
                                                <div id="automaticCodeDiv" style="@(Model.IsManualTaskCode ? "display: none;" : "")">
                                                    <input asp-for="TaskCode" class="form-control bg-light" readonly
                                                           placeholder="کد تسک به صورت خودکار تولید می‌شود"
                                                           id="automaticTaskCode">
                                                    <div class="invalid-feedback">
                                                        <span asp-validation-for="TaskCode"></span>
                                                    </div>
                                                    <small class="form-text text-success">
                                                        <i class="fa fa-robot me-1"></i>
                                                        @if (!string.IsNullOrEmpty(Model.TaskCode))
                                                        {
                                                            <span>کد تسک به صورت خودکار تولید شده: <strong>@Model.TaskCode</strong></span>
                                                        }
                                                        else
                                                        {
                                                            <span>کد تسک به صورت خودکار تولید می‌شود</span>
                                                        }
                                                    </small>
                                                </div>

                                                <!-- ورودی کد دستی -->
                                                @if (Model.TaskCodeSettings?.AllowManualInput == true)
                                                {
                                                    <div id="manualCodeDiv" style="@(Model.IsManualTaskCode ? "" : "display: none;")">
                                                        <input asp-for="ManualTaskCode" class="form-control @(ViewData.ModelState["ManualTaskCode"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                                               placeholder="کد تسک دلخواه خود را وارد کنید"
                                                               id="manualTaskCode" maxlength="50">
                                                        <div class="invalid-feedback">
                                                            <span asp-validation-for="ManualTaskCode"></span>
                                                        </div>
                                                        <small class="form-text text-warning">
                                                            <i class="fa fa-exclamation-triangle me-1"></i>
                                                            نمی‌توانید از پیشوند '@Model.TaskCodeSettings.SystemPrefix-' استفاده کنید
                                                        </small>
                                                        <div id="taskCodeMessages"></div>
                                                    </div>

                                                    <div class="form-check mt-2">
                                                        <input asp-for="IsManualTaskCode" class="form-check-input"
                                                               id="toggleManualCode" onchange="toggleTaskCodeInput()">
                                                        <label class="form-check-label" for="toggleManualCode">
                                                            <i class="fa fa-edit me-1"></i>
                                                            ورود دستی کد تسک
                                                        </label>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                        <div class="col-sm-6">
                                            <div class="mb-3">
                                                <label class="form-label">نوع تسک <span class="text-danger">*</span></label>
                                                <div class="d-flex gap-3 flex-wrap">
                                                    <div class="form-check form-check-inline">
                                                        <input asp-for="TaskType" class="form-check-input @(ViewData.ModelState["TaskType"]?.Errors.Count > 0 ? "is-invalid" : "")" id="tasktype-normal" type="radio" value="0" checked />
                                                        <label class="form-check-label" for="tasktype-normal">
                                                            <i class="fa fa-tasks me-2 text-muted"></i> عادی
                                                        </label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input asp-for="TaskType" class="form-check-input @(ViewData.ModelState["TaskType"]?.Errors.Count > 0 ? "is-invalid" : "")" id="tasktype-important" type="radio" value="1" />
                                                        <label class="form-check-label" for="tasktype-important">
                                                            <i class="fa fa-exclamation-circle me-2 text-warning"></i> مهم
                                                        </label>
                                                    </div>
                                                    <div class="form-check form-check-inline">
                                                        <input asp-for="TaskType" class="form-check-input @(ViewData.ModelState["TaskType"]?.Errors.Count > 0 ? "is-invalid" : "")" id="tasktype-urgent" type="radio" value="2" />
                                                        <label class="form-check-label" for="tasktype-urgent">
                                                            <i class="fa fa-fire me-2 text-danger"></i> اضطراری
                                                        </label>
                                                    </div>
                                                </div>
                                                @if (ViewData.ModelState["TaskType"]?.Errors.Count > 0)
                                                {
                                                    <div class="invalid-feedback d-block">
                                                        <span asp-validation-for="TaskType"></span>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ⭐⭐⭐ بخش 2: عنوان و توضیحات -->
                                <div class="task-section task-section-required">
                                    <div class="task-section-title">
                                        <i class="fa fa-align-left"></i>
                                        <h5>عنوان و توضیحات</h5>
                                        <span class="badge bg-danger ms-2">الزامی</span>
                                    </div>
                                    
                                    <!-- عنوان تسک -->
                                    <div class="mb-3">
                                        <label class="form-label" for="Title">عنوان تسک <span class="text-danger">*</span></label>
                                        <input asp-for="Title" 
                                               class="form-control @(ViewData.ModelState["Title"]?.Errors.Count > 0 ? "is-invalid" : "")" 
                                               placeholder="عنوان تسک را وارد کنید" 
                                               id="Title"
                                               name="Title"
                                               maxlength="200">
                                        @if (ViewData.ModelState["Title"]?.Errors.Count > 0)
                                        {
                                            <div class="invalid-feedback">
                                                <span asp-validation-for="Title"></span>
                                            </div>
                                        }
                                    </div>

                                    <!-- توضیحات تسک -->
                                    <div class="mb-0">
                                        <label asp-for="Description" class="form-label">توضیحات تسک</label>
                                        <textarea asp-for="Description" class="form-control @(ViewData.ModelState["Description"]?.Errors.Count > 0 ? "is-invalid" : "")" rows="4" placeholder="شرح کاملی از تسک و نحوه انجام آن ارائه دهید..."></textarea>
                                        @if (ViewData.ModelState["Description"]?.Errors.Count > 0)
                                        {
                                            <div class="invalid-feedback">
                                                <span asp-validation-for="Description"></span>
                                            </div>
                                        }
                                        <small class="form-text text-muted">
                                            <i class="fa fa-lightbulb me-1"></i>
                                            توضیحات دقیق‌تر به انجام‌دهندگان کمک می‌کند تا تسک را بهتر درک کنند
                                        </small>
                                    </div>
                                </div>

                                <!-- ⭐⭐⭐ بخش 3: انتخاب شعبه (فقط اگر بیش از یک شعبه باشد) -->
                                @if (Model.branchListInitial != null && Model.branchListInitial.Count() > 1)
                                {
                                    <div class="task-section task-section-required">
                                        <div class="task-section-title">
                                            <i class="fa fa-building"></i>
                                            <h5>شعبه</h5>
                                            <span class="badge bg-danger ms-2">الزامی</span>
                                        </div>
                                        
                                        <div class="mb-0">
                                            <label class="form-label" for="BranchIdSelected">انتخاب شعبه <span class="text-danger">*</span></label>
                                            <select class="js-select2 form-select branch @(ViewData.ModelState["BranchIdSelected"]?.Errors.Count > 0 ? "is-invalid" : "")"
                                                    asp-items="@(new SelectList(Model.branchListInitial, "Id", "Name", Model.BranchIdSelected))"
                                                    id="BranchIdSelected"
                                                    name="BranchIdSelected"
                                                    asp-for="BranchIdSelected"
                                                    data-placeholder="شعبه را انتخاب کنید"
                                                    data-url="@Url.Action("BranchTriggerSelect", "Tasks")"
                                                    data-toggle="multiplepartialview"
                                                    data-target-divs="UsersDiv,TeamsDiv,StakeholdersDiv,TaskCategoriesDiv"
                                                    data-param-name="branchId"
                                                    style="width: 100%;" required>
                                                <option value="">انتخاب شعبه</option>
                                            </select>
                                            <div class="invalid-feedback">
                                                <span asp-validation-for="BranchIdSelected"></span>
                                            </div>
                                            <small class="form-text text-muted">
                                                <i class="fa fa-info-circle me-1"></i>
                                                انتخاب شعبه باعث بروزرسانی کاربران و تیم‌ها می‌شود
                                            </small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <!-- ⭐ Hidden input برای شعبه یکتا -->
                                    <input type="hidden" asp-for="BranchIdSelected" id="BranchIdSelected" value="@(Model.branchListInitial?.FirstOrDefault()?.Id ?? 0)" />
                                }

                                <!-- ⭐⭐⭐ بخش 4: کاربران منتصب (جابجا شده - حالا قبل از طرف حساب) -->
                                <div class="task-section task-section-required">
                                    <div class="task-section-title">
                                        <i class="fa fa-users"></i>
                                        <h5>کاربران منتصب</h5>
                                        <span class="badge bg-danger ms-2">الزامی</span>
                                    </div>
                                    
                                    <div class="alert alert-info mb-3">
                                        <i class="fa fa-info-circle me-1"></i>
                                        برای هر کاربر باید تیم مربوطه را مشخص کنید (در صورتی که کاربر در چند تیم عضو باشد)
                                    </div>

                                    <div id="user-assignments-container">
                                        <!-- ردیف‌های تخصیص کاربر-تیم به صورت دینامیک اضافه می‌شوند -->
                                    </div>
                                    
                                    <!-- دکمه اضافه کردن کاربر جدید -->
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="add-user-assignment">
                                        <i class="fa fa-plus me-1"></i> اضافه کردن کاربر
                                    </button>
                                    
                                    <!-- Hidden inputs برای ارسال داده‌ها -->
                                    <input type="hidden" id="AssignmentsSelectedTaskUserArraysString" name="AssignmentsSelectedTaskUserArraysString" />
                                    <input type="hidden" id="UserTeamAssignmentsJson" asp-for="UserTeamAssignmentsJson" />
                                    
                                    @if (ViewData.ModelState["AssignmentsSelectedTaskUserArraysString"]?.Errors.Count > 0)
                                    {
                                        <div class="invalid-feedback d-block">
                                            <span asp-validation-for="AssignmentsSelectedTaskUserArraysString"></span>
                                        </div>
                                    }
                                    
                                    <small class="form-text text-muted">
                                        <i class="fa fa-users me-1"></i>
                                        کاربرانی که این تسک به آن‌ها اختصاص داده می‌شود و تیم مربوطه
                                    </small>
                                </div>

                                <!-- ⭐⭐⭐ بخش 5: طرف حساب (جابجا شده - حالا بعد از کاربران) -->
                                <div class="task-section">
                                    <div class="task-section-title">
                                        <i class="fa fa-handshake"></i>
                                        <h5>طرف حساب</h5>
                                        <span class="badge bg-secondary ms-2">اختیاری</span>
                                    </div>

                                    <!-- ⭐ Tab Navigation برای انتخاب نوع -->
                                    <ul class="nav nav-pills mb-3" id="stakeholderTypeTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="organization-tab"
                                                    data-bs-toggle="pill" data-bs-target="#organization-panel"
                                                    type="button" role="tab">
                                                <i class="fa fa-building me-1"></i>
                                                شرکت/سازمان
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="contact-tab"
                                                    data-bs-toggle="pill" data-bs-target="#contact-panel"
                                                    type="button" role="tab">
                                                <i class="fa fa-user me-1"></i>
                                                فرد
                                            </button>
                                        </li>
                                    </ul>

                                    <div class="tab-content">
                                        <!-- Panel 1: انتخاب Organization -->
                                        <div class="tab-pane fade show active" id="organization-panel" role="tabpanel">
                                            <div id="OrganizationSelectionDiv">
                                                <select asp-for="SelectedOrganizationId"
                                                        class="js-select2 form-select"
                                                        id="SelectedOrganizationId"
                                                        name="SelectedOrganizationId"
                                                        data-placeholder="انتخاب شرکت/سازمان"
                                                        data-url="@Url.Action("OrganizationTriggerSelect", "Tasks")"
                                                        data-toggle="partialview"
                                                        data-target-div="OrganizationContactsDiv"
                                                        data-param-name="organizationId"
                                                        style="width: 100%;">
                                                    <option value="">انتخاب شرکت/سازمان</option>
                                                    @if (Model.OrganizationsInitial != null && Model.OrganizationsInitial.Any())
                                                    {
                                                        @foreach (var org in Model.OrganizationsInitial)
                                                        {
                                                            <option value="@org.Id">
                                                                @org.DisplayName
                                                                @if (!string.IsNullOrEmpty(org.RegistrationNumber))
                                                                {
                                                                    <text> (ثبت: @org.RegistrationNumber)</text>
                                                                }
                                                            </option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                            <small class="form-text text-muted mt-1">
                                                <i class="fa fa-building me-1"></i>
                                                شرکت‌ها و سازمان‌هایی که در شعبه انتخاب شده تعریف شده‌اند
                                            </small>

                                            <!-- بخش نمایش افراد مرتبط با Organization -->
                                            <div id="OrganizationContactsDiv" class="mt-3" style="display: none;">
                                                <!-- محتوا از AJAX بارگذاری می‌شود -->
                                            </div>
                                        </div>

                                        <!-- Panel 2: انتخاب Contact -->
                                        <div class="tab-pane fade" id="contact-panel" role="tabpanel">
                                            <div id="ContactSelectionDiv">
                                                <select asp-for="SelectedContactId"
                                                        class="js-select2 form-select"
                                                        id="SelectedContactId"
                                                        name="SelectedContactId"
                                                        data-placeholder="انتخاب فرد"
                                                        style="width: 100%;">
                                                    <option value="">انتخاب فرد</option>
                                                    @if (Model.ContactsInitial != null && Model.ContactsInitial.Any())
                                                    {
                                                        @foreach (var contact in Model.ContactsInitial)
                                                        {
                                                            <option value="@contact.Id">@contact.FullName (@contact.NationalCode)</option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                            <small class="form-text text-muted mt-1">
                                                <i class="fa fa-user me-1"></i>
                                                افرادی که در شعبه انتخاب شده تعریف شده‌اند
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- ⭐⭐⭐ بخش 6: فایل‌های پیوست -->
                                <div class="task-section">
                                    <div class="task-section-title">
                                        <i class="fa fa-paperclip"></i>
                                        <h5>فایل‌های پیوست</h5>
                                        <span class="badge bg-secondary ms-2">اختیاری</span>
                                    </div>
                                    
                                    <div class="mb-0">
                                        <label class="form-label" for="Attachments">فایل‌های پیوست</label>
                                        <input type="file" name="Attachments" multiple class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip,.rar">
                                        <small class="form-text text-muted">
                                            <i class="fa fa-info-circle me-1"></i>
                                            فایل‌های مرتبط، اسناد، تصاویر یا مدارک مورد نیاز را ضمیمه کنید
                                        </small>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: جزئیات بیشتر در تسک -->
            <div class="tab-pane" id="project-info" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">جزئیات بیشتر در تسک</h3>
                        <div class="block-options">
                            <small class="text-muted">اطلاعات اختیاری برای دسته‌بندی بهتر</small>
                        </div>
                    </div>
                    <div class="block-content">
                        <div class="row justify-content-center">
                            <div class="col-md-12 col-lg-10">
                                
                                <!-- راهنمای استفاده -->
                                <div class="alert alert-info mb-4">
                                    <h6><i class="fa fa-info-circle me-1"></i> درباره این بخش:</h6>
                                    <p class="mb-2">این بخش برای دسته‌بندی و سازماندهی بهتر تسک‌ها طراحی شده و اختیاری است.</p>
                                    <ul class="mb-0">
                                        <li><strong>دسته‌بندی:</strong> برای گروه‌بندی تسک‌ها بر اساس موضوع</li>
                                    </ul>
                                </div>

                                <!-- دسته‌بندی تسک -->
                                <div class="task-section">
                                    <div class="task-section-title">
                                        <i class="fa fa-tags"></i>
                                        <h5>دسته‌بندی تسک</h5>
                                    </div>
                                    
                                    <div class="mb-0">
                                        <label class="form-label" for="TaskCategoryIdSelected">دسته‌بندی تسک</label>
                                        <div id="TaskCategoriesDiv">
                                            <select asp-for="TaskCategoryIdSelected"
                                                    id="TaskCategoryIdSelected"
                                                    name="TaskCategoryIdSelected"
                                                    class="js-select2 form-select"
                                                    data-placeholder="ابتدا شعبه را انتخاب کنید"
                                                    style="width: 100%;"
                                                    disabled>
                                                <option value="">انتخاب دسته‌بندی</option>
                                            </select>
                                        </div>
                                        <small class="form-text text-muted">
                                            <i class="fa fa-tags me-1"></i>
                                            دسته‌بندی کمک می‌کند تسک‌ها بر اساس موضوع گروه‌بندی شوند
                                        </small>
                                    </div>
                                </div>

                                <!-- پیغام راهنما -->
                                <div class="alert alert-warning" id="project-branch-warning" style="display: none;">
                                    <h6><i class="fa fa-exclamation-triangle me-1"></i> توجه:</h6>
                                    <p class="mb-0">
                                        برای استفاده از این بخش، ابتدا باید در تب "اطلاعات اصلی" شعبه را انتخاب کنید.
                                        <br>
                                        <a href="#" onclick="$('#main-info-tab').click(); return false;" class="text-decoration-underline">
                                            برگشت به اطلاعات اصلی
                                        </a>
                                    </p>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: بازه زمانی -->
            <div class="tab-pane" id="timeframe" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">بازه زمانی تسک</h3>
                        <div class="block-options">
                            <small class="text-muted">تعیین زمان‌بندی پیشنهادی توسط سازنده تسک</small>
                        </div>
                    </div>
                    <div class="block-content">
                        <div class="row justify-content-center">
                            <div class="col-md-10">
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="task-section">
                                            <div class="task-section-title">
                                                <i class="fa fa-play"></i>
                                                <h5>تاریخ شروع</h5>
                                            </div>
                                            <input asp-for="SuggestedStartDatePersian" class="form-control js-flatpickr" 
                                                   placeholder="انتخاب تاریخ و ساعت شروع">
                                            <span asp-validation-for="SuggestedStartDatePersian" class="text-danger"></span>
                                            <small class="form-text text-muted">
                                                <i class="fa fa-play me-1"></i>
                                                تاریخ پیشنهادی برای شروع انجام تسک
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="task-section">
                                            <div class="task-section-title">
                                                <i class="fa fa-flag-checkered"></i>
                                                <h5>مهلت انجام</h5>
                                            </div>
                                            <input asp-for="DueDatePersian" class="form-control js-flatpickr" 
                                                   placeholder="انتخاب تاریخ و ساعت مهلت">
                                            <span asp-validation-for="DueDatePersian" class="text-danger"></span>
                                            <small class="form-text text-muted">
                                                <i class="fa fa-flag-checkered me-1"></i>
                                                آخرین مهلت برای تکمیل تسک
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <div class="task-section">
                                    <div class="task-section-title">
                                        <i class="fa fa-clock"></i>
                                        <h5>تخمین زمان و تنظیمات</h5>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">مدت زمان تخمینی</label>
                                                <div class="input-group">
                                                    <input asp-for="EstimatedHours" type="number" step="0.5" min="0" 
                                                           class="form-control" placeholder="0">
                                                    <span class="input-group-text">ساعت</span>
                                                </div>
                                                <span asp-validation-for="EstimatedHours" class="text-danger"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mt-4 pt-2">
                                                <input asp-for="IsHardDeadline" type="checkbox" class="form-check-input">
                                                <label asp-for="IsHardDeadline" class="form-check-label">
                                                    <strong>مهلت سخت</strong>
                                                    <small class="d-block text-muted">
                                                        مهلت قطعی و غیرقابل تغییر توسط انجام‌دهنده
                                                    </small>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-0">
                                        <label class="form-label">یادداشت زمان‌بندی</label>
                                        <textarea asp-for="TimeNote" class="form-control" rows="3" 
                                                  placeholder="توضیحات اضافی درباره زمان‌بندی، اولویت‌ها یا ملاحظات خاص..."></textarea>
                                        <span asp-validation-for="TimeNote" class="text-danger"></span>
                                    </div>
                                </div>

                                <!-- پیش‌نمایش زمان‌بندی -->
                                <div class="alert alert-info" id="timePreview" style="display: none;">
                                    <h6><i class="fa fa-info-circle me-1"></i> خلاصه زمان‌بندی:</h6>
                                    <div id="timePreviewContent"></div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: فهرست کارها -->
            <div class="tab-pane" id="operations" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">فهرست کارها</h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-success" id="addOperationBtn">
                                <i class="fa fa-plus me-1"></i> اضافه کردن کار
                            </button>
                        </div>
                    </div>
                    <div class="block-content">
                        <div class="js-tasks" id="taskOperationsList">
                            
                            <!-- راهنمای استفاده -->
                            <div class="alert alert-info" id="operationsGuide">
                                <h6><i class="fa fa-lightbulb me-1"></i> راهنمای استفاده:</h6>
                                <ul class="mb-0">
                                    <li>برای هر تسک می‌توانید فهرستی از کارهای جزئی تعریف کنید</li>
                                    <li>انجام‌دهندگان می‌توانند هر کار را جداگانه تیک بزنند</li>
                                    <li>کارهای ضروری با علامت قرمز مشخص می‌شوند</li>
                                </ul>
                            </div>

                            <div class="mb-4">
                                <div class="input-group input-group-lg">
                                    <input class="form-control form-control-lg fs-base border-2"
                                           id="js-task-input"
                                           name="js-task-input"
                                           placeholder="یک کار جدید اضافه کنید و Enter را فشار دهید..."
                                           type="text"
                                           autocomplete="off" />
                                    <button class="btn btn-primary btn-lg" type="button" id="addTaskBtn">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- لیست کارها -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="content-heading pb-0 mb-0 border-0">
                                    فهرست کارها
                                </h6>
                                <span class="js-task-badge badge rounded-pill bg-primary" id="operationsBadge">0</span>
                            </div>
                            
                            <div class="js-task-list" id="operationsList">
                                <!-- کارها به صورت دینامیک اضافه می‌شوند -->
                            </div>

                            <!-- پیام خالی بودن لیست -->
                            <div class="text-center py-4 text-muted" id="emptyOperationsList">
                                <i class="fa fa-tasks fa-2x mb-2"></i>
                                <p class="mb-0">هنوز هیچ کاری اضافه نشده است</p>
                                <small>برای اضافه کردن اولین کار، از فرم بالا استفاده کنید</small>
                            </div>

                            <!-- Hidden input برای ذخیره operations -->
                            <input type="hidden" asp-for="TaskOperationsJson" id="taskOperationsData" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5: یادآوری‌ها -->
            <div class="tab-pane" id="reminders" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">تنظیمات یادآوری</h3>
                        <div class="block-options">
                            <button type="button" class="btn btn-sm btn-warning"
                                    data-toggle="modal-ajax"
                                    href="@Url.Action("AddCustomReminderModal", "Tasks")">
                                <i class="fa fa-bell-o me-1"></i> یادآوری سفارشی
                            </button>
                        </div>
                    </div>
                    <div class="block-content">
                        <div id="remindersList">
                            
                            <!-- یادآوری پیش‌فرض -->
                            <div class="card border-success mb-3">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <i class="fa fa-bell text-success me-2"></i>
                                            <strong>یادآوری پیش‌فرض سیستم</strong>
                                        </div>
                                        <div class="form-check">
                                            <input asp-for="EnableDefaultReminder" class="form-check-input" type="checkbox" id="defaultReminder" checked>
                                            <label class="form-check-label" for="defaultReminder">فعال</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="card-text">
                                        <i class="fa fa-info-circle text-info me-1"></i>
                                        ۳ روز قبل از پایان مهلت، یادآوری برای تمام اعضای تیم ارسال می‌شود
                                    </p>
                                    <small class="text-muted">
                                        زمان ارسال: ۹:۰۰ صبح | کانال: سیستم
                                    </small>
                                </div>
                            </div>

                            <!-- لیست یادآوری‌های سفارشی -->
                            <div id="customRemindersList">
                                <!-- یادآوری‌های سفارشی به صورت دینامیک اضافه می‌شوند -->
                            </div>

                            <!-- راهنمای یادآوری‌ها -->
                            <div class="alert alert-warning">
                                <h6><i class="fa fa-lightbulb me-1"></i> نکات مهم:</h6>
                                <ul class="mb-0">
                                    <li><strong>یادآوری تکراری:</strong> هر چند روز یک بار یادآوری ارسال می‌شود</li>
                                    <li><strong>یادآوری قبل از مهلت:</strong> چند روز قبل از پایان مهلت یادآوری ارسال می‌شود</li>
                                    <li><strong>یادآوری یکباره:</strong> در تاریخ و ساعت مشخص یادآوری ارسال می‌شود</li>
                                </ul>
                            </div>

                            <!-- Hidden input برای ذخیره reminders -->
                            <input type="hidden" asp-for="TaskRemindersJson" id="taskRemindersData" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 6: ناظرین -->
            <div class="tab-pane" id="viewers" role="tabpanel">
                <div class="block block-rounded">
                    <div class="block-header block-header-default">
                        <h3 class="block-title">ناظرین تسک</h3>
                        <div class="block-options">
                            <small class="text-muted">افرادی که می‌توانند این تسک را مشاهده کنند</small>
                        </div>
                    </div>
                    <div class="block-content">
                        <div id="viewersList">
                            <!-- محتوای ناظرین -->
                            <div id="viewersContent" style="display: none;">
                                <!-- محتوا به صورت دینامیک بارگذاری می‌شود -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- فیلد مخفی برای IsActive -->
        <input type="hidden" asp-for="IsActive" value="true" />

        <!-- دکمه‌های عملیات -->
        <div class="block block-rounded">
            <div class="block-content block-content-full block-content-sm bg-body-light">
                <div class="row">
                    <div class="col-sm-6">
                        <button type="button" class="btn btn-alt-secondary" onclick="window.history.back();">
                            <i class="fa fa-arrow-right me-1"></i> انصراف
                        </button>
                    </div>
                    <div class="col-sm-6 text-end">
                        <button type="button" class="btn btn-alt-primary me-2" id="previewTaskBtn">
                            <i class="fa fa-eye me-1"></i> پیش‌نمایش
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitTaskBtn">
                            <i class="fa fa-check me-1"></i> ذخیره تسک
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </form>
</div>

@section Scripts {
    <script>
        Dashmix.helpersOnLoad(['js-flatpickr', 'jq-datepicker', 'jq-maxlength', 'jq-select2', 'jq-rangeslider', 'jq-masked-inputs', 'jq-pw-strength']);
    </script>

    <script>
        // متغیرهای کمکی
        let operationsCounter = 0;
        let operationsArray = [];
        let remindersCounter = 0;
        let remindersList = [];
        
        // متغیرهای سراسری برای مدیریت User-Team Assignments
        let userAssignments = [];
        let availableUsers = [];
        let availableTeams = [];
        let assignmentCounter = 0;

        $(document).ready(function() {
            console.log('Document ready - شروع بارگذاری فرم');
            initializeForm();
            setupEventHandlers();
            initializeTasksManagement();
            initializeUserAssignments();
            autoSelectSingleBranch();
        });

        function initializeForm() {
            console.log('شروع راه‌اندازی فرم');

            // راه‌اندازی Select2
            $('.js-select2').select2({
                width: '100%',
                allowClear: true,
                dropdownAutoWidth: true,
                containerCssClass: 'select2-validation',
                escapeMarkup: function(markup) {
                    return markup;
                }
            });

            // راه‌اندازی تقویم شمسی
            $('.js-flatpickr').each(function() {
                try {
                    new mds.MdsPersianDateTimePicker(this, {
                        targetTextSelector: this,
                        enableTimePicker: true,
                        textFormat: 'yyyy/MM/dd HH:mm',
                        targetDateFormat: 'yyyy-MM-dd HH:mm:ss'
                    });
                } catch (e) {
                    console.warn('خطا در راه‌اندازی تقویم:', e);
                }
            });

            $('#createTaskForm').attr('novalidate', 'novalidate');
            console.log('راه‌اندازی فرم کامل شد');
        }

        function initializeTasksManagement() {
            console.log('راه‌اندازی سیستم مدیریت کارها');
            updateOperationsDisplay();
            updateOperationsCount();
        }

        // راه‌اندازی سیستم User-Team Assignments
        function initializeUserAssignments() {
            $('#add-user-assignment').on('click', function() {
                if (availableUsers.length === 0) {
                    alert('ابتدا شعبه را انتخاب کنید');
                    return;
                }
                addUserAssignmentRow();
            });
            
            // هنگام تغییر شعبه، لیست کاربران و تیم‌ها را بروزرسانی کن
            $('#BranchIdSelected').on('change', function() {
                const branchId = $(this).val();
                if (branchId) {
                    loadBranchUsersAndTeams(branchId);
                }
            });
        }

        // انتخاب خودکار شعبه
        function autoSelectSingleBranch() {
            const branchSelect = $('#BranchIdSelected');
            const options = branchSelect.find('option[value!=""]');
            
            // ⭐ اگر فقط یک شعبه باشد، خودکار انتخاب شود
            if (options.length === 1) {
                const branchId = options.first().val();
                branchSelect.val(branchId);
                loadBranchUsersAndTeams(branchId);
                
                if (typeof toastr !== 'undefined') {
                    toastr.info('شعبه به صورت خودکار انتخاب شد', '', {timeOut: 2000});
                }
            }
            // ⭐ اگر hidden input باشد (یک شعبه)، مقدار آن را بارگذاری کن
            else if (branchSelect.is('[type="hidden"]')) {
                const branchId = branchSelect.val();
                if (branchId && branchId !== '0') {
                    loadBranchUsersAndTeams(branchId);
                }
            }
        }

        // بارگذاری کاربران و تیم‌های شعبه
        function loadBranchUsersAndTeams(branchId) {
            console.log('🔄 Loading users and teams for branch:', branchId);
            
            $.ajax({
                url: '@Url.Action("BranchTriggerSelect", "Tasks")',
                type: 'POST',
                data: {
                    branchId: branchId,
                    __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    console.log('✅ Branch data loaded:', response);
                    
                    if (response.status === 'update-view' && response.viewList) {
                        // استخراج کاربران
                        const usersHtml = response.viewList.find(v => v.elementId === 'UsersDiv')?.view?.result;
                        if (usersHtml) {
                            const tempDiv = $('<div>').html(usersHtml);
                            availableUsers = [];
                            tempDiv.find('option[value!=""]').each(function() {
                                availableUsers.push({
                                    id: $(this).val(),
                                    name: $(this).text()
                                });
                            });
                            console.log('👥 Available users:', availableUsers.length);
                        }
                        
                        // استخراج تیم‌ها
                        const teamsHtml = response.viewList.find(v => v.elementId === 'TeamsDiv')?.view?.result;
                        if (teamsHtml) {
                            const tempDiv = $('<div>').html(teamsHtml);
                            availableTeams = [];
                            tempDiv.find('option[value!=""]').each(function() {
                                availableTeams.push({
                                    id: $(this).val(),
                                    name: $(this).text()
                                });
                            });
                            console.log('👔 Available teams:', availableTeams.length);
                        }
                        
                        // بروزرسانی تخصیص‌های موجود
                        refreshUserAssignmentSelects();
                    }
                }
            });
        }
                // ادامه تابع addUserAssignmentRow
        function addUserAssignmentRow(userId = '', teamId = '') {
            assignmentCounter++;
            const rowId = `assignment-row-${assignmentCounter}`;
            const teamContainerId = `team-select-container-${assignmentCounter}`;

            const userOptions = availableUsers.map(u =>
                `<option value="${u.id}" ${u.id === userId ? 'selected' : ''}>${u.name}</option>`
            ).join('');

            const rowHtml = `
                <div class="card mb-2 user-assignment-row" id="${rowId}" data-row-id="${assignmentCounter}">
                    <div class="card-body p-3">
                        <div class="row g-2">
                            <div class="col-md-5">
                                <label class="form-label small mb-1">کاربر: <span class="text-danger">*</span></label>
                                <select class="form-select form-select-sm user-select js-select2"
                                        data-row-id="${assignmentCounter}"
                                        data-container-id="${teamContainerId}"
                                        required>
                                    <option value="">انتخاب کاربر...</option>
                                    ${userOptions}
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label small mb-1">تیم: <span class="text-danger">*</span></label>
                                <div id="${teamContainerId}">
                                    <select class="form-select form-select-sm team-select js-select2"
                                            data-row-id="${assignmentCounter}"
                                            disabled>
                                        <option value="">ابتدا کاربر را انتخاب کنید</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex justify-content-center align-items-center">
                                <button type="button"
                                        class="btn btn-sm btn-danger w-100 remove-assignment"
                                        data-row-id="${assignmentCounter}">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('#user-assignments-container').append(rowHtml);

            const $row = $(`#${rowId}`);
            const $userSelect = $row.find('.user-select');

            // راه‌اندازی Select2
            $userSelect.select2({
                width: '100%',
                dropdownParent: $row,
                placeholder: 'انتخاب کاربر...'
            });

            // رویداد change کاربر
            $userSelect.on('change', function() {
                const selectedUserId = $(this).val();
                const teamContainerId = $(this).data('container-id');
                const branchId = $('#BranchIdSelected').val();

                if (!selectedUserId || !branchId) {
                    $(`#${teamContainerId}`).html(`
                        <select class="form-select form-select-sm team-select" disabled>
                            <option value="">ابتدا کاربر و شعبه را انتخاب کنید</option>
                        </select>
                    `);
                    updateUserAssignmentsData();
                    return;
                }

                // نمایش loading
                $(`#${teamContainerId}`).html(`
                    <div class="text-center p-2">
                        <i class="fa fa-spinner fa-spin"></i> در حال بارگذاری...
                    </div>
                `);

                // AJAX
                $.ajax({
                    url: '@Url.Action("GetUserTeams", "Tasks")',
                    type: 'POST',
                    data: {
                        userId: selectedUserId,
                        branchId: branchId,
                        __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.status === 'update-view' && response.viewList) {
                            // بروزرسانی HTML
                            response.viewList.forEach(function(item) {
                                $(`#${teamContainerId}`).html(item.view.result);

                                // راه‌اندازی Select2 برای تیم
                                const $teamSelect = $(`#${teamContainerId} .team-select`);
                                $teamSelect.select2({
                                    width: '100%',
                                    dropdownParent: $row,
                                    placeholder: 'انتخاب تیم...'
                                });

                                // رویداد change برای تیم
                                $teamSelect.on('change', updateUserAssignmentsData);

                                // ⭐ مدیریت انتخاب خودکار
                                if (response.hasNoTeam === true) {
                                    // اگر تیمی ندارد، گزینه "بدون تیم" (value=0) خودکار انتخاب می‌شود
                                    $teamSelect.val('0').trigger('change');

                                    if (typeof toastr !== 'undefined') {
                                        toastr.warning('این کاربر در هیچ تیمی عضو نیست - تسک به صورت فردی انجام می‌شود', '', {timeOut: 3000});
                                    }
                                } else {
                                    // انتخاب خودکار اگر فقط یک تیم باشد
                                    const options = $teamSelect.find('option[value!=""][value!="0"]');
                                    if (options.length === 1) {
                                        $teamSelect.val(options.first().val()).trigger('change');

                                        if (typeof toastr !== 'undefined') {
                                            toastr.info(`تیم "${options.first().text()}" خودکار انتخاب شد`, '', {timeOut: 2000});
                                        }
                                    }
                                }
                            });

                            updateUserAssignmentsData();
                        } else {
                            throw new Error(response.message || 'خطا در بارگذاری');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Error:', error);
                        $(`#${teamContainerId}`).html(`
                            <select class="form-select form-select-sm team-select">
                                <option value="0">بدون تیم (خطا در بارگذاری)</option>
                            </select>
                        `);

                        // راه‌اندازی Select2 حتی در حالت خطا
                        $(`#${teamContainerId} .team-select`).select2({
                            width: '100%',
                            dropdownParent: $row
                        }).val('0').trigger('change');

                        if (typeof toastr !== 'undefined') {
                            toastr.error('خطا در بارگذاری تیم‌ها - گزینه "بدون تیم" انتخاب شد');
                        }

                        updateUserAssignmentsData();
                    }
                });
            });

            // رویداد حذف
            $row.find('.remove-assignment').on('click', function() {
                removeUserAssignmentRow($(this).data('row-id'));
            });

            // trigger اولیه
            if (userId) {
                $userSelect.val(userId).trigger('change');
            }

            updateUserAssignmentsData();
        }

        // حذف ردیف تخصیص
        function removeUserAssignmentRow(rowId) {
            $(`#assignment-row-${rowId}`).remove();
            updateUserAssignmentsData();
        }

        // بروزرسانی سلکت‌های موجود
        function refreshUserAssignmentSelects() {
            $('.user-assignment-row').each(function() {
                const rowId = $(this).data('row-id');
                const currentUserId = $(this).find('.user-select').val();
                const currentTeamId = $(this).find('.team-select').val();

                // بروزرسانی options
                const userOptions = availableUsers.map(u =>
                    `<option value="${u.id}" ${u.id === currentUserId ? 'selected' : ''}>${u.name}</option>`
                ).join('');

                const teamOptions = availableTeams.map(t =>
                    `<option value="${t.id}" ${t.id === currentTeamId ? 'selected' : ''}>${t.name}</option>`
                ).join('');

                $(this).find('.user-select').html('<option value="">انتخاب کاربر...</option>' + userOptions);
                $(this).find('.team-select').html('<option value="">انتخاب تیم...</option>' + teamOptions);
            });
        }

        // ⭐⭐⭐ اصلاح تابع updateUserAssignmentsData
        function updateUserAssignmentsData() {
            const assignments = [];
            const userTeamMap = {};

            $('.user-assignment-row').each(function() {
                let userId = $(this).find('.user-select').val();
                const teamId = $(this).find('.team-select').val();

                // ⭐⭐⭐ پاکسازی کامل userId
                if (userId) {
                    // تبدیل به string خالص
                    userId = String(userId);

                    // حذف تمام کاراکترهای اضافی
                    userId = userId
                        .replace(/[\[\]\/\s"'`]/g, '') // حذف [, ], /, space, ", ', `
                        .trim();

                    console.log('🔍 Cleaned userId:', userId, 'Length:', userId.length);

                    // ⭐ بررسی معتبر بودن GUID
                    const guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (!guidRegex.test(userId)) {
                        console.warn('⚠️ Invalid GUID format:', userId);
                        return; // رد کردن این کاربر
                    }
                }

                if (userId && teamId !== null && teamId !== undefined) {
                    // ⭐ اضافه کردن به صورت string خالص (نه آرایه)
                    if (!assignments.includes(userId)) {
                        assignments.push(userId);
                    }
                    userTeamMap[userId] = teamId === "" ? 0 : parseInt(teamId);
                }
            });

            // ⭐⭐⭐ تبدیل به JSON بدون nested arrays
            const assignmentsJson = JSON.stringify(assignments);
            const userTeamMapJson = JSON.stringify(userTeamMap);

            console.log('📤 Assignments JSON:', assignmentsJson);
            console.log('📤 UserTeamMap JSON:', userTeamMapJson);

            // بررسی نهایی: آیا JSON معتبر است؟
            if (assignmentsJson.includes('[[')) {
                console.error('❌ NESTED ARRAY DETECTED! Fixing...');
                // اصلاح فوری
                const fixed = JSON.parse(assignmentsJson).flat();
                $('#AssignmentsSelectedTaskUserArraysString').val(JSON.stringify(fixed));
            } else {
                $('#AssignmentsSelectedTaskUserArraysString').val(assignmentsJson);
            }

            $('#UserTeamAssignmentsJson').val(userTeamMapJson);
        }

        function setupEventHandlers() {
            console.log('شروع تنظیم event handlers');

            // مدیریت Enter key
            $('#js-task-input').off('keypress keydown keyup').on('keypress', function(e) {
                if (e.which === 13 || e.keyCode === 13) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    addNewTask();
                    return false;
                }
            });

            $('#addTaskBtn, #addOperationBtn').off('click').on('click', function(e) {
                e.preventDefault();
                addNewTask();
                return false;
            });

            $('#Title').on('blur input', function() {
                validateMainInfo();
                if ($(this).val().trim()) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                }
            });

            $('#BranchIdSelected').on('change select2:select select2:unselect', function() {
                validateMainInfo();
                updateBranchDependentSelects();
                if ($(this).val()) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                }
            });

            $('#SuggestedStartDatePersian, #DueDatePersian, #EstimatedHours').on('change', updateTimePreview);

            $('#createTaskForm').on('submit', function(e) {
                e.preventDefault();
                if (!validateFormBeforeSubmit()) {
                    return false;
                }
                updateAllHiddenInputs();
                this.submit();
            });

            $('.nav-link').on('click', function() {
                const targetTab = $(this).data('bs-target');
                if (targetTab === '#viewers') {
                    updateViewersList();
                }
                if (targetTab === '#project-info') {
                    checkProjectTabRequirements();
                }
            });

            $(document).on('change', '#StakeholderId, #TaskCategoryIdSelected', function() {
                updateProjectStats();
            });

            $(document).on('change', '.reminder-type, .reminder-title, .reminder-time, #defaultReminder', function() {
                updateRemindersData();
                updateRemindersCount();
            });

            $('#manualTaskCode').on('input', function() {
                validateManualTaskCode();
            });

            $('#manualTaskCode').on('blur', function() {
                checkTaskCodeUniqueness();
            });

            console.log('تنظیم event handlers کامل شد');
        }

        // بقیه توابع کمکی...
        function addNewTask() {
            const taskInput = $('#js-task-input');
            const taskText = taskInput.val().trim();

            if (!taskText) {
                taskInput.focus();
                return false;
            }

            operationsCounter++;
            const taskId = operationsCounter;

            const taskHtml = `
                <div class="js-task border rounded p-3 mb-2 bg-light animated fadeIn" data-task-id="${taskId}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="js-task-content fw-medium">${taskText}</div>
                        <button class="btn btn-sm btn-outline-danger" type="button" onclick="removeTask(${taskId})" title="حذف کار">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            $('#operationsList').append(taskHtml);
            taskInput.val('').focus();

            updateOperationsDisplay();
            updateOperationsCount();
            extractOperationsData();

            return false;
        }

        function removeTask(taskId) {
            if (confirm('آیا از حذف این کار اطمینان دارید؟')) {
                $(`[data-task-id="${taskId}"]`).remove();
                updateOperationsDisplay();
                updateOperationsCount();
                extractOperationsData();
            }
        }

        function extractOperationsData() {
            const currentOperations = [];

            $('#operationsList .js-task').each(function(index) {
                const title = $(this).find('.js-task-content').text().trim();
                if (title) {
                    currentOperations.push({
                        Title: title,
                        OperationOrder: index + 1,
                        IsCompleted: false,
                        IsStarred: false,
                        EstimatedHours: null
                    });
                }
            });

            $('#taskOperationsData').val(JSON.stringify(currentOperations));
        }

        function updateOperationsDisplay() {
            const tasksCount = $('#operationsList .js-task').length;
            $('#emptyOperationsList').toggle(tasksCount === 0);
            $('#operationsList').toggle(tasksCount > 0);
        }

        function updateOperationsCount() {
            const tasksCount = $('#operationsList .js-task').length;
            $('#operations-count, #operationsBadge').text(tasksCount);
        }

        function updateRemindersCount() {
            let count = $('#defaultReminder').is(':checked') ? 1 : 0;
            count += $('#customRemindersList .card').length;
            $('#reminders-count').text(count);
        }

        function toggleTaskCodeInput() {
            const isManual = $('#toggleManualCode').is(':checked');
            $('#automaticCodeDiv').toggle(!isManual);
            $('#manualCodeDiv').toggle(isManual);
            if (isManual) $('#manualTaskCode').focus();
        }

        function validateMainInfo() {
            let hasErrors = false;

            const title = $('#Title').val().trim();
            $('#Title').toggleClass('is-invalid', !title).toggleClass('is-valid', !!title);
            hasErrors = hasErrors || !title;

            const branchId = $('#BranchIdSelected').val();
            $('#BranchIdSelected').toggleClass('is-invalid', !branchId).toggleClass('is-valid', !!branchId);
            $('#BranchIdSelected').next('.select2-container').toggleClass('select2-invalid', !branchId);
            hasErrors = hasErrors || !branchId;

            $('#main-info-error').toggleClass('d-none', !hasErrors);
            return !hasErrors;
        }

        function validateFormBeforeSubmit() {
            let isValid = true;
            const errors = [];

            $('.is-invalid').removeClass('is-invalid');
            $('.select2-invalid').removeClass('select2-invalid');

            // بررسی عنوان
            const title = $('#Title').val().trim();
            if (!title) {
                isValid = false;
                errors.push('عنوان تسک الزامی است');
                $('#Title').addClass('is-invalid');
                $('#main-info-tab').tab('show');
            }

            // بررسی شعبه
            const branchId = $('#BranchIdSelected').val();
            if (!branchId) {
                isValid = false;
                errors.push('انتخاب شعبه الزامی است');
                $('#BranchIdSelected').addClass('is-invalid').next('.select2-container').addClass('select2-invalid');
                $('#main-info-tab').tab('show');
            }

            // بررسی تخصیص کاربران
            const assignedUsers = JSON.parse($('#AssignmentsSelectedTaskUserArraysString').val() || '[]');
            if (assignedUsers.length === 0) {
                isValid = false;
                errors.push('لطفاً حداقل یک کاربر را برای انجام تسک انتخاب کنید');
                $('#main-info-tab').tab('show');
            }

            // بررسی تکمیل بودن تیم برای هر کاربر
            let hasIncompleteAssignment = false;
            $('.user-assignment-row').each(function() {
                const userId = $(this).find('.user-select').val();
                const teamId = $(this).find('.team-select').val();

                if (userId && !teamId) {
                    isValid = false;
                    hasIncompleteAssignment = true;
                    $(this).find('.team-select').addClass('is-invalid');
                }
            });

            if (hasIncompleteAssignment) {
                errors.push('لطفاً برای تمام کاربران منتصب، تیم مربوطه را انتخاب کنید');
            }

            // بررسی کد دستی
            const isManualCode = $('#toggleManualCode').is(':checked');
            if (isManualCode) {
                const manualCode = $('#manualTaskCode').val().trim();
                if (!manualCode) {
                    isValid = false;
                    errors.push('لطفاً کد تسک را وارد کنید');
                    $('#manualTaskCode').addClass('is-invalid');
                } else if ($('#manualTaskCode').hasClass('is-invalid')) {
                    isValid = false;
                    errors.push('کد تسک وارد شده تکراری یا نامعتبر است');
                }
            }

            if (!isValid && errors.length > 0) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'خطا در اعتبارسنجی',
                        html: '<div class="text-start"><ul class="mb-0">' +
                              errors.map(e => `<li>${e}</li>`).join('') +
                              '</ul></div>',
                        icon: 'error',
                        confirmButtonText: 'متوجه شدم'
                    });
                } else {
                    alert('لطفاً خطاهای زیر را رفع کنید:\n\n' + errors.join('\n'));
                }
            }

            return isValid;
        }

        function updateBranchDependentSelects() {
            const branchId = $('#BranchIdSelected').val();
            $('#StakeholderId, #TaskCategoryIdSelected').prop('disabled', !branchId);
        }

        function validateManualTaskCode() {
            const manualCode = $('#manualTaskCode').val().trim();
            const systemPrefix = '@(Model.TaskCodeSettings?.SystemPrefix ?? "TSK")';

            if (!manualCode) {
                $('#manualTaskCode').removeClass('is-valid is-invalid');
                return true;
            }

            const isValid = !manualCode.startsWith(systemPrefix + '-');
            $('#manualTaskCode').toggleClass('is-invalid', !isValid).toggleClass('is-valid', isValid);
            return isValid;
        }

        function checkTaskCodeUniqueness() {
            const taskCode = $('#manualTaskCode').val().trim();
            if (!taskCode || !validateManualTaskCode()) return;

            $.ajax({
                url: '@Url.Action("CheckTaskCodeUniqueness", "Tasks")',
                type: 'POST',
                data: {
                    taskCode: taskCode,
                    __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success && response.isUnique) {
                        $('#manualTaskCode').addClass('is-valid').removeClass('is-invalid');
                        $('#taskCodeMessages').html('<small class="text-success"><i class="fa fa-check me-1"></i>کد تسک معتبر و منحصر به فرد است</small>');
                    } else {
                        $('#manualTaskCode').addClass('is-invalid').removeClass('is-valid');
                        $('#taskCodeMessages').html('<small class="text-danger"><i class="fa fa-times me-1"></i>این کد تسک قبلاً استفاده شده است</small>');
                    }
                }
            });
        }

        function updateTimePreview() {
            const startDate = $('#SuggestedStartDatePersian').val();
            const dueDate = $('#DueDatePersian').val();
            const estimatedHours = $('#EstimatedHours').val();

            if (!startDate && !dueDate && !estimatedHours) {
                $('#timePreview').hide();
                return;
            }

            let previewHtml = '<div class="row">';
            if (startDate) previewHtml += `<div class="col-sm-4"><strong>شروع:</strong> ${startDate}</div>`;
            if (dueDate) previewHtml += `<div class="col-sm-4"><strong>مهلت:</strong> ${dueDate}</div>`;
            if (estimatedHours) previewHtml += `<div class="col-sm-4"><strong>مدت تخمینی:</strong> ${estimatedHours} ساعت</div>`;
            previewHtml += '</div>';

            $('#timePreviewContent').html(previewHtml);
            $('#timePreview').show();
        }

        function checkProjectTabRequirements() {
            const branchId = $('#BranchIdSelected').val();
            $('#project-branch-warning').toggle(!branchId);
        }

        function updateAllHiddenInputs() {
            updateRemindersData();
            extractOperationsData();
            updateUserAssignmentsData();
        }

        function updateRemindersData() {
            remindersList = [];
            if ($('#defaultReminder').is(':checked')) {
                remindersList.push({
                    Title: 'یادآوری پیش‌فرض سیستم',
                    ReminderType: 2,
                    DaysBeforeDeadline: 3,
                    NotificationTime: '09:00:00'
                });
            }

            $('#customRemindersList .reminder-data').each(function() {
                const data = $(this).data();
                const reminderObj = {
                    Title: data.title,
                    Description: data.description,
                    ReminderType: parseInt(data.type),
                    NotificationTime: data.time
                };

                if (data.interval) {
                    reminderObj.IntervalDays = parseInt(data.interval);
                }
                if (data.daysBefore) {
                    reminderObj.DaysBeforeDeadline = parseInt(data.daysBefore);
                }
                if (data.startDate) {
                    reminderObj.StartDatePersian = data.startDate;
                }

                remindersList.push(reminderObj);
            });

            const jsonData = JSON.stringify(remindersList);
            $('#taskRemindersData').val(jsonData);
        }

        function removeReminder(reminderId) {
            if (confirm('آیا از حذف این یادآوری اطمینان دارید؟')) {
                $(`[data-reminder-id="${reminderId}"]`).remove();
                updateRemindersCount();
                updateRemindersData();
            }
        }

        function updateViewersList() {
            const selectedUsers = $('#AssignmentsSelectedTaskUserArraysString').val() || [];
            const selectedTeams = $('#AssignmentsSelectedTeamIds').val() || [];

            if (selectedUsers.length === 0 && selectedTeams.length === 0) {
                $('#viewersWaiting').show();
                $('#viewersContent').hide();
                $('#viewers-count').text('0');
                return;
            }

            let viewersCount = selectedUsers.length;
            selectedTeams.forEach(function(teamId) {
                viewersCount += 5;
            });

            $('#viewers-count').text(viewersCount);
            $('#viewersWaiting').hide();
            $('#viewersContent').show().html(`
                <div class="alert alert-success">
                    <i class="fa fa-users me-2"></i>
                    <strong>تعداد ناظرین تقریبی:</strong> ${viewersCount} نفر
                    <ul class="mt-2 mb-0">
                        <li>کاربران منتصب مستقیم: ${selectedUsers.length} نفر</li>
                        <li>اعضای تیم‌های انتخاب شده: ${selectedTeams.length} تیم</li>
                    </ul>
                </div>
            `);
        }
    </script>

    <script>
        $(document).ready(function() {
            // ⭐ مدیریت تغییر شعبه: بروزرسانی Contacts و Organizations
            $('#BranchIdSelected').on('change', function() {
                const branchId = $(this).val();

                if (!branchId) {
                    $('#SelectedContactId, #SelectedOrganizationId')
                        .prop('disabled', true)
                        .empty()
                        .append('<option value="">ابتدا شعبه را انتخاب کنید</option>');
                    $('#OrganizationContactsDiv').hide();
                    return;
                }

                // ⭐ نمایش loading
                $('#ContactSelectionDiv').html('<div class="text-center py-2"><i class="fa fa-spinner fa-spin"></i> در حال بارگذاری...</div>');
                $('#OrganizationSelectionDiv').html('<div class="text-center py-2"><i class="fa fa-spinner fa-spin"></i> در حال بارگذاری...</div>');

                $.ajax({
                    url: '@Url.Action("BranchTriggerSelectForStakeholders", "Tasks")',
                    type: 'POST',
                    data: {
                        branchId: branchId,
                        __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success && response.viewList) {
                            // ⭐ بروزرسانی Contact dropdown
                            const contactView = response.viewList.find(v => v.elementId === 'ContactSelectionDiv');
                            if (contactView && contactView.view && contactView.view.result) {
                                $('#ContactSelectionDiv').html(contactView.view.result);
                                $('#SelectedContactId').select2({
                                    width: '100%',
                                    placeholder: 'انتخاب فرد',
                                    allowClear: true
                                });
                            }

                            // ⭐ بروزرسانی Organization dropdown
                            const orgView = response.viewList.find(v => v.elementId === 'OrganizationSelectionDiv');
                            if (orgView && orgView.view && orgView.view.result) {
                                $('#OrganizationSelectionDiv').html(orgView.view.result);
                                $('#SelectedOrganizationId').select2({
                                    width: '100%',
                                    placeholder: 'انتخاب شرکت/سازمان',
                                    allowClear: true
                                });
                            }

                            // پاک کردن بخش افراد سازمان
                            $('#OrganizationContactsDiv').hide().empty();

                            if (typeof toastr !== 'undefined') {
                                toastr.success('لیست افراد و سازمان‌ها بروز شد', '', {timeOut: 2000});
                            }
                        }
                    },
                    error: function() {
                        $('#ContactSelectionDiv').html('<select class="form-select" disabled><option>خطا در بارگذاری</option></select>');
                        $('#OrganizationSelectionDiv').html('<select class="form-select" disabled><option>خطا در بارگذاری</option></select>');

                        if (typeof toastr !== 'undefined') {
                            toastr.error('خطا در بارگذاری اطلاعات');
                        }
                    }
                });
            });

            // ⭐⭐⭐ مدیریت تغییر Organization: نمایش افراد مرتبط
            $(document).on('change', '#SelectedOrganizationId', function() {
                const organizationId = $(this).val();

                if (!organizationId) {
                    $('#OrganizationContactsDiv').hide().empty();
                    return;
                }

                $('#OrganizationContactsDiv').html('<div class="text-center py-3"><i class="fa fa-spinner fa-spin"></i> در حال بارگذاری افراد...</div>').show();

                $.ajax({
                    url: '@Url.Action("OrganizationTriggerSelect", "Tasks")',
                    type: 'POST',
                    data: {
                        organizationId: organizationId,
                        __RequestVerificationToken: $('[name="__RequestVerificationToken"]').val()
                    },
                    success: function(html) {
                        $('#OrganizationContactsDiv').html(html);

                        // بروزرسانی Select2 برای dropdown جدید
                        $('#OrganizationRelatedContactId').select2({
                            width: '100%',
                            placeholder: 'انتخاب فرد',
                            allowClear: true
                        });
                    },
                    error: function() {
                        $('#OrganizationContactsDiv').html('<div class="alert alert-danger">خطا در بارگذاری افراد</div>');
                    }
                });
            });

            // ⭐ مدیریت تغییر Tab: پاک کردن انتخاب‌های قبلی
            $('button[data-bs-toggle="pill"]').on('shown.bs.tab', function(e) {
                const target = $(e.target).attr('data-bs-target');

                if (target === '#contact-panel') {
                    // پاک کردن Organization و افراد آن
                    $('#SelectedOrganizationId').val('').trigger('change');
                    $('#OrganizationContactsDiv').hide().empty();
                } else if (target === '#organization-panel') {
                    // پاک کردن Contact
                    $('#SelectedContactId').val('').trigger('change');
                }
            });
        });
    </script>
}