@model TaskViewModel
@{
    ViewData["Title"] = "افزودن تسک جدید";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">افزودن تسک جدید</h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">مدیریت</li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Tasks")">تسک‌ها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">افزودن جدید</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- New Task Form -->
    <form method="POST" action="@Url.Action("CreateNewTask", "Tasks")" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="block block-rounded">
            <div class="block-header block-header-default">
                <h3 class="block-title">اطلاعات تسک</h3>
                <div class="block-options">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fa fa-check me-1"></i> ذخیره
                    </button>
                </div>
            </div>
            <div class="block-content">
                <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-8">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="TaskCode">کد تسک <span class="text-danger">*</span></label>
                                    <input asp-for="TaskCode" class="form-control" readonly placeholder="کد تسک به صورت خودکار تولید می‌شود">
@*                                     <span asp-validation-for="TaskCode" class="text-danger"></span>
 *@                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="TaskType">نوع تسک</label>
                                    <select asp-for="TaskType" class="js-select2 form-select" data-placeholder="انتخاب کنید">
                                        <option value="">انتخاب کنید</option>
                                        <option value="0">عادی</option>
                                        <option value="1">مهم</option>
                                        <option value="2">اضطراری</option>
                                    </select>
                                    <span asp-validation-for="TaskType" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                      
                        <div class="mb-4">
                            <label class="form-label" for="Title">عنوان تسک <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control" placeholder="عنوان تسک را وارد کنید">
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">توضیحات</label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="توضیحات تسک را وارد کنید"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="TaskCategoryIdSelected">دسته‌بندی</label>
                                    <select asp-for="TaskCategoryIdSelected" asp-items="@(new SelectList(Model.TaskCategoryInitial, "Id", "Title"))" id="TaskCategoryIdSelected" name="TaskCategoryIdSelected" class="js-select2 form-select" data-placeholder="انتخاب کنید" style="width: 100%;">
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                    <span asp-validation-for="TaskCategoryIdSelected" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="AssignmentsSelectedTaskUserArraysString">کاربر های منتصب</label>
                                    <div id="UsersDiv">
                                        <select class="js-select2 form-select" asp-items="@(new SelectList(Model.UsersInitial, "Id", "FullNamesString"))" 
                                                id="AssignmentsSelectedTaskUserArraysString" 
                                                data-placeholder="بسیاری را انتخاب کنید" 
                                                multiple="multiple" 
                                                name="AssignmentsSelectedTaskUserArraysString" 
                                                style="width: 100%;">
                                        </select>
                                    </div>
                                    <span asp-validation-for="UsersInitial" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="BranchIdSelected">انتخاب شعبه‌</label>
                                    <select class="js-select2 form-select branch" asp-items="@(new SelectList(Model.branchListInitial, "Id", "Name"))" 
                                            id="BranchIdSelected" 
                                            data-placeholder="شعبه را انتخاب کنید" 
                                            name="BranchIdSelected" 
                                            data-url="@Url.Action("BranchTriggerSelect","Tasks")" 
                                            data-toggle="multiplepartialview"
                                            data-target-divs="UsersDiv,StakeholdersDiv"
                                            data-param-name="branchId"
                                            style="width: 100%;">
                                        <option value="">انتخاب کنید</option>
                                    </select>
                                    <span asp-validation-for="branchListInitial" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="StakeholderId">طرف حساب</label>
                                    <div id="StakeholdersDiv">
                                        <select asp-for="StakeholderId" asp-items="ViewBag.Stakeholders" class="js-select2 form-select" data-placeholder="انتخاب کنید" style="width: 100%;">
                                            <option value="">انتخاب کنید</option>
                                        </select>
                                    </div>
                                    <span asp-validation-for="StakeholderId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="DueDatePersian">مهلت انجام</label>
                                    <input asp-for="DueDatePersian" class="form-control js-flatpickr" placeholder="انتخاب تاریخ مهلت انجام">
                                    <span asp-validation-for="DueDatePersian" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="Attachments">فایل‌های پیوست</label>
                                    <input type="file" name="Attachments" multiple class="form-control">
                                    <span asp-validation-for="Attachments" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-check">
                                <input asp-for="IsActive" class="form-check-input">
                                <span class="form-check-label">وضعیت فعال</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="block-content block-content-full block-content-sm bg-body-light text-end">
                <button type="button" class="btn btn-alt-secondary" onclick="window.history.back();">
                    <i class="fa fa-arrow-right me-1"></i> انصراف
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-check me-1"></i> ذخیره
                </button>
            </div>
        </div>
    </form>
    <!-- END New Task Form -->
</div>
<!-- END Page Content -->
@section scripts {
   
    <script>Dashmix.helpersOnLoad(['js-flatpickr', 'jq-datepicker', 'jq-maxlength', 'jq-select2', 'jq-rangeslider', 'jq-masked-inputs', 'jq-pw-strength']);</script>

    <script>
        $(document).ready(function() {
            // Initialize flatpickr for Persian date picker
            $('.js-flatpickr').each(function() {
                new mds.MdsPersianDateTimePicker(this, {
                    targetTextSelector: this,
                    enableTimePicker: true,
                    textFormat: 'yyyy/MM/dd HH:mm',
                    targetDateFormat: 'yyyy-MM-dd HH:mm:ss',
                });
            });

            // کانفیگ سفارشی برای CreateNewTask
            if (typeof DynamicSelect2Manager !== 'undefined') {
                // اضافه کردن کانفیگ سفارشی برای AssignmentsSelectedTaskUserArraysString
                DynamicSelect2Manager.addSelectConfig('UsersDiv', {
                    id: 'AssignmentsSelectedTaskUserArraysString',
                    name: 'AssignmentsSelectedTaskUserArraysString',
                    multiple: true
                });
                
                // اضافه کردن کانفیگ سفارشی برای StakeholdersDiv
                DynamicSelect2Manager.addSelectConfig('StakeholdersDiv', {
                    id: 'StakeholderId',
                    name: 'StakeholderId',
                    multiple: false
                });
                
                console.log('CreateNewTask specific configs added to DynamicSelect2Manager');
            }
        });
    </script>
}