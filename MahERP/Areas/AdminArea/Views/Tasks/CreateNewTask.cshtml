@model TaskViewModel
@{
    ViewData["Title"] = "افزودن تسک جدید";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">افزودن تسک جدید</h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">مدیریت</li>
                    <li class="breadcrumb-item">
                        <a href="@Url.Action("Index", "Tasks")">تسک‌ها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">افزودن جدید</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- فرم ایجاد تسک جدید -->
    <form method="POST" action="@Url.Action("CreateNewTask", "Tasks")" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="block block-rounded">
            <div class="block-header block-header-default">
                <h3 class="block-title">اطلاعات تسک</h3>
                <div class="block-options">
                    <button type="submit" class="btn btn-sm btn-primary">
                        <i class="fa fa-check me-1"></i> ذخیره
                    </button>
                </div>
            </div>
            <div class="block-content">
                <div class="row justify-content-center">
                    <div class="col-md-10 col-lg-8">
                        <!-- نمایش خطاها -->
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                        <!-- ردیف اول: کد تسک و نوع تسک -->
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="TaskCode">کد تسک <span class="text-danger">*</span></label>
                                    <input asp-for="TaskCode" class="form-control" readonly placeholder="کد تسک به صورت خودکار تولید می‌شود">
                                    <!-- کد تسک به صورت خودکار تولید می‌شود -->
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="TaskType">نوع تسک</label>
                                    <select asp-for="TaskType" class="js-select2 form-select" data-placeholder="انتخاب کنید">
                                        <option value="">انتخاب کنید</option>
                                        <option value="0">عادی</option>
                                        <option value="1">مهم</option>
                                        <option value="2">اضطراری</option>
                                    </select>
                                    <span asp-validation-for="TaskType" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- عنوان تسک -->
                        <div class="mb-4">
                            <label class="form-label" for="Title">عنوان تسک <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control" placeholder="عنوان تسک را وارد کنید">
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <!-- توضیحات تسک -->
                        <div class="mb-4">
                            <label asp-for="Description" class="form-label">توضیحات</label>
                            <textarea asp-for="Description" class="form-control" rows="4" placeholder="توضیحات تسک را وارد کنید"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <!-- انتخاب شعبه - مرحله اول cascade -->
                        <div class="mb-4">
                            <label class="form-label" for="BranchIdSelected">انتخاب شعبه <span class="text-danger">*</span></label>
                            <select class="js-select2 form-select branch" 
                                    asp-items="@(new SelectList(Model.branchListInitial, "Id", "Name"))" 
                                    id="BranchIdSelected" 
                                    data-placeholder="شعبه را انتخاب کنید" 
                                    name="BranchIdSelected" 
                                    data-url="@Url.Action("BranchTriggerSelect","Tasks")" 
                                    data-toggle="multiplepartialview"
                                    data-target-divs="UsersDiv,StakeholdersDiv,TaskCategoriesDiv"
                                    data-param-name="branchId"
                                    style="width: 100%;">
                                <option value="">ابتدا شعبه را انتخاب کنید</option>
                            </select>
                            <span asp-validation-for="branchListInitial" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                انتخاب شعبه باعث بروزرسانی کاربران، طرف حساب‌ها و دسته‌بندی‌ها می‌شود
                            </small>
                        </div>

                        <!-- کاربران منتصب - مرحله دوم cascade -->
                        <div class="mb-4">
                            <label class="form-label" for="AssignmentsSelectedTaskUserArraysString">کاربران منتصب</label>
                            <div id="UsersDiv">
                                <select class="js-select2 form-select" 
                                        id="AssignmentsSelectedTaskUserArraysString" 
                                        data-placeholder="ابتدا شعبه را انتخاب کنید" 
                                        multiple="multiple" 
                                        name="AssignmentsSelectedTaskUserArraysString" 
                                        style="width: 100%;"
                                        disabled>
                                    <option value="">ابتدا شعبه را انتخاب کنید</option>
                                </select>
                            </div>
                            <span asp-validation-for="UsersInitial" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-users me-1"></i>
                                کاربرانی که این تسک به آن‌ها اختصاص داده می‌شود
                            </small>
                        </div>

                        <!-- طرف حساب - مرحله سوم cascade -->
                        <div class="mb-4">
                            <label class="form-label" for="StakeholderId">طرف حساب</label>
                            <div id="StakeholdersDiv">
                                <select asp-for="StakeholderId" 
                                        class="js-select2 form-select" 
                                        id="StakeholderId"
                                        name="StakeholderId"
                                        data-placeholder="ابتدا شعبه را انتخاب کنید" 
                                        style="width: 100%;"
                                        disabled>
                                    <option value="">ابتدا شعبه را انتخاب کنید</option>
                                </select>
                            </div>
                            <span asp-validation-for="StakeholderId" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-handshake me-1"></i>
                                طرف حساب مرتبط با این تسک - انتخاب طرف حساب باعث بروزرسانی دسته‌بندی‌ها می‌شود
                            </small>
                        </div>

                        <!-- دسته‌بندی تسک - مرحله چهارم cascade -->
                        <div class="mb-4">
                            <label class="form-label" for="TaskCategoryIdSelected">دسته‌بندی تسک</label>
                            <div id="TaskCategoriesDiv">
                                <select asp-for="TaskCategoryIdSelected" 
                                        id="TaskCategoryIdSelected" 
                                        name="TaskCategoryIdSelected" 
                                        class="js-select2 form-select" 
                                        data-placeholder="ابتدا شعبه و طرف حساب را انتخاب کنید" 
                                        style="width: 100%;"
                                        disabled>
                                    <option value="">ابتدا شعبه و طرف حساب را انتخاب کنید</option>
                                </select>
                            </div>
                            <span asp-validation-for="TaskCategoryIdSelected" class="text-danger"></span>
                            <small class="form-text text-muted">
                                <i class="fa fa-tags me-1"></i>
                                دسته‌بندی بر اساس شعبه و طرف حساب انتخاب شده نمایش داده می‌شود
                            </small>
                        </div>

                        <!-- ردیف: مهلت انجام و فایل‌های پیوست -->
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="DueDatePersian">مهلت انجام</label>
                                    <input asp-for="DueDatePersian" class="form-control js-flatpickr" placeholder="انتخاب تاریخ مهلت انجام">
                                    <span asp-validation-for="DueDatePersian" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="fa fa-calendar me-1"></i>
                                        تاریخ و زمان مهلت انجام تسک
                                    </small>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="mb-4">
                                    <label class="form-label" for="Attachments">فایل‌های پیوست</label>
                                    <input type="file" name="Attachments" multiple class="form-control">
                                    <span asp-validation-for="Attachments" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="fa fa-paperclip me-1"></i>
                                        فایل‌های مرتبط با تسک را ضمیمه کنید
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- وضعیت فعال -->
                        <div class="mb-4">
                            <label class="form-check">
                                <input asp-for="IsActive" class="form-check-input" checked>
                                <span class="form-check-label">وضعیت فعال</span>
                            </label>
                            <small class="form-text text-muted">
                                <i class="fa fa-toggle-on me-1"></i>
                                تسک در حالت فعال ایجاد می‌شود
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- دکمه‌های عملیات -->
            <div class="block-content block-content-full block-content-sm bg-body-light text-end">
                <button type="button" class="btn btn-alt-secondary" onclick="window.history.back();">
                    <i class="fa fa-arrow-right me-1"></i> انصراف
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fa fa-check me-1"></i> ذخیره تسک
                </button>
            </div>
        </div>
    </form>
    <!-- END فرم ایجاد تسک جدید -->
</div>
<!-- END Page Content -->

@section scripts {
    <!-- اسکریپت‌های مورد نیاز قالب -->
    <script>Dashmix.helpersOnLoad(['js-flatpickr', 'jq-datepicker', 'jq-maxlength', 'jq-select2', 'jq-rangeslider', 'jq-masked-inputs', 'jq-pw-strength']);</script>

    <script>
        $(document).ready(function() {
            // راه‌اندازی تقویم شمسی برای انتخاب تاریخ مهلت
            $('.js-flatpickr').each(function() {
                new mds.MdsPersianDateTimePicker(this, {
                    targetTextSelector: this,
                    enableTimePicker: true,
                    textFormat: 'yyyy/MM/dd HH:mm',
                    targetDateFormat: 'yyyy-MM-dd HH:mm:ss',
                });
            });

            // کانفیگ سفارشی برای مدیریت Select2 های پویا
            if (typeof DynamicSelect2Manager !== 'undefined') {
                // تنظیمات برای کاربران
                DynamicSelect2Manager.addSelectConfig('UsersDiv', {
                    id: 'AssignmentsSelectedTaskUserArraysString',
                    name: 'AssignmentsSelectedTaskUserArraysString',
                    multiple: true,
                    placeholder: 'کاربران را انتخاب کنید'
                });
                
                // تنظیمات برای طرف حساب‌ها
                DynamicSelect2Manager.addSelectConfig('StakeholdersDiv', {
                    id: 'StakeholderId',
                    name: 'StakeholderId',
                    multiple: false,
                    placeholder: 'طرف حساب را انتخاب کنید'
                });
                
                // تنظیمات برای دسته‌بندی‌ها
                DynamicSelect2Manager.addSelectConfig('TaskCategoriesDiv', {
                    id: 'TaskCategoryIdSelected',
                    name: 'TaskCategoryIdSelected',
                    multiple: false,
                    placeholder: 'دسته‌بندی را انتخاب کنید'
                });
                
                console.log('کانفیگ‌های CreateNewTask به DynamicSelect2Manager اضافه شد');
            }

            // تابع کمکی برای راه‌اندازی مجدد Select2 طرف حساب
            function reinitializeStakeholderSelect() {
                setTimeout(function() {
                    if ($('#StakeholderId').length > 0) {
                        $('#StakeholderId').select2({
                            placeholder: 'طرف حساب را انتخاب کنید',
                            allowClear: true,
                            width: '100%'
                        });
                        console.log('Select2 طرف حساب مجدداً راه‌اندازی شد');
                    }
                }, 500);
            }

            // تابع فراخوانی AJAX برای بروزرسانی دسته‌بندی‌ها
            function loadTaskCategoriesByStakeholder(branchId, stakeholderId) {
                var token = $('input[name="__RequestVerificationToken"]').val();
                
                console.log('شروع بارگذاری دسته‌بندی‌ها برای طرف حساب:', stakeholderId, 'در شعبه:', branchId);
                
                $.ajax({
                    url: '@Url.Action("StakeholderTriggerSelectTaskCategories", "Tasks")',
                    type: 'POST',
                    data: {
                        branchId: branchId,
                        stakeholderId: stakeholderId,
                        __RequestVerificationToken: token
                    },
                    beforeSend: function() {
                        $('#TaskCategoryIdSelected').prop('disabled', true);
                        $('#TaskCategoryIdSelected').attr('data-placeholder', 'در حال بارگذاری...');
                        console.log('درخواست AJAX ارسال شد');
                    },
                    success: function(response) {
                        console.log('پاسخ AJAX دریافت شد:', response);
                        
                        if (response.status === 'update-view' && response.viewList) {
                            // بروزرسانی div دسته‌بندی‌ها
                            response.viewList.forEach(function(item) {
                                if (item.elementId === 'TaskCategoriesDiv') {
                                    $('#' + item.elementId).html(item.view.result);
                                    
                                    // راه‌اندازی مجدد Select2 برای element جدید
                                    $('#TaskCategoryIdSelected').select2({
                                        placeholder: 'دسته‌بندی را انتخاب کنید',
                                        allowClear: true,
                                        width: '100%'
                                    });
                                    
                                    $('#TaskCategoryIdSelected').prop('disabled', false);
                                    console.log('دسته‌بندی‌ها با موفقیت بروزرسانی شد');
                                }
                            });
                        } else {
                            console.error('ساختار پاسخ نامعتبر:', response);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('خطا در بارگذاری دسته‌بندی‌ها:', error);
                        console.error('جزئیات خطا:', xhr.responseText);
                        $('#TaskCategoryIdSelected').prop('disabled', true);
                        $('#TaskCategoryIdSelected').attr('data-placeholder', 'خطا در بارگذاری دسته‌بندی‌ها');
                    }
                });
            }

            // رویداد تغییر شعبه - بروزرسانی همه فیلدهای وابسته
            $(document).on('change', '#BranchIdSelected', function() {
                var branchId = $(this).val();
                console.log('رویداد تغییر شعبه فراخوانی شد، شعبه انتخاب شده:', branchId);
                
                if (branchId) {
                    // فعال کردن فیلدهای وابسته
                    $('#AssignmentsSelectedTaskUserArraysString, #StakeholderId').prop('disabled', false);
                    
                    // غیرفعال کردن دسته‌بندی تا طرف حساب انتخاب شود
                    $('#TaskCategoryIdSelected').prop('disabled', true);
                    
                    // بروزرسانی placeholder ها
                    $('#AssignmentsSelectedTaskUserArraysString').attr('data-placeholder', 'کاربران را انتخاب کنید');
                    $('#StakeholderId').attr('data-placeholder', 'طرف حساب را انتخاب کنید');
                    $('#TaskCategoryIdSelected').attr('data-placeholder', 'ابتدا طرف حساب را انتخاب کنید');
                    
                    // راه‌اندازی مجدد Select2 طرف حساب پس از بروزرسانی cascade اول
                    reinitializeStakeholderSelect();
                    
                    console.log('شعبه انتخاب شد:', branchId);
                } else {
                    // غیرفعال کردن فیلدهای وابسته
                    $('#AssignmentsSelectedTaskUserArraysString, #StakeholderId, #TaskCategoryIdSelected').prop('disabled', true);
                    
                    // بازنشانی placeholder ها
                    $('#AssignmentsSelectedTaskUserArraysString').attr('data-placeholder', 'ابتدا شعبه را انتخاب کنید');
                    $('#StakeholderId').attr('data-placeholder', 'ابتدا شعبه را انتخاب کنید');
                    $('#TaskCategoryIdSelected').attr('data-placeholder', 'ابتدا شعبه و طرف حساب را انتخاب کنید');
                    
                    console.log('شعبه پاک شد');
                }
            });

            // رویداد تغییر طرف حساب - بروزرسانی دسته‌بندی‌ها (CASCADE دوم) - با event delegation
            $(document).on('change', '#StakeholderId', function() {
                var stakeholderId = $(this).val();
                var branchId = $('#BranchIdSelected').val();
                
                console.log('رویداد تغییر طرف حساب فراخوانی شد');
                console.log('طرف حساب انتخاب شده:', stakeholderId);
                console.log('شعبه جاری:', branchId);
                
                if (stakeholderId && branchId) {
                    // فعال کردن انتخاب دسته‌بندی
                    $('#TaskCategoryIdSelected').prop('disabled', false);
                    $('#TaskCategoryIdSelected').attr('data-placeholder', 'در حال بارگذاری...');
                    
                    // فراخوانی تابع AJAX
                    loadTaskCategoriesByStakeholder(branchId, stakeholderId);
                    
                    console.log('طرف حساب انتخاب شد و درخواست AJAX ارسال شد');
                } else {
                    // غیرفعال کردن انتخاب دسته‌بندی
                    $('#TaskCategoryIdSelected').prop('disabled', true);
                    $('#TaskCategoryIdSelected').attr('data-placeholder', 'ابتدا طرف حساب را انتخاب کنید');
                    
                    // پاک کردن محتوای دسته‌بندی‌ها
                    $('#TaskCategoriesDiv').html(`
                        <select class="js-select2 form-select" 
                                asp-for="TaskCategoryIdSelected" 
                                id="TaskCategoryIdSelected" 
                                name="TaskCategoryIdSelected"
                                data-placeholder="ابتدا طرف حساب را انتخاب کنید" 
                                style="width: 100%;"
                                disabled>
                            <option value="">ابتدا طرف حساب را انتخاب کنید</option>
                        </select>
                    `);
                    
                    console.log('طرف حساب پاک شد - دسته‌بندی‌ها ریست شد');
                }
            });

            // اضافه کردن event listener برای Select2 events نیز
            $(document).on('select2:select', '#StakeholderId', function(e) {
                console.log('Select2 event triggered for stakeholder');
                $(this).trigger('change');
            });

            // بررسی اولیه وضعیت فیلدها
            var initialBranchId = $('#BranchIdSelected').val();
            if (!initialBranchId) {
                $('#AssignmentsSelectedTaskUserArraysString, #StakeholderId, #TaskCategoryIdSelected').prop('disabled', true);
            }

            console.log('فرم CreateNewTask آماده شد - ترتیب cascade: شعبه -> کاربران/طرف حساب -> دسته‌بندی');
            console.log('Event delegation برای طرف حساب تنظیم شد');
        });
    </script>
}