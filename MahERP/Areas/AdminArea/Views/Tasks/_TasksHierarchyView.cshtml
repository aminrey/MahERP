@model TaskIndexViewModel

<div class="hierarchy-tasks">
    @if (Model.GroupedTasks != null)
    {
        <!-- تسک‌های شخصی -->
        @if (Model.GroupedTasks.MyTasks.Any())
        {
            <div class="mb-4">
                <h5 class="text-primary">
                    <i class="fa fa-user me-2"></i>
                    تسک‌های من (@Model.GroupedTasks.MyTasks.Count)
                </h5>
                @await Html.PartialAsync("_TasksTable", Model.GroupedTasks.MyTasks)
            </div>
        }

        <!-- تسک‌های اعضای تیم -->
        @if (Model.GroupedTasks.TeamMemberTasks.Any())
        {
            <div class="mb-4">
                <h5 class="text-info">
                    <i class="fa fa-users me-2"></i>
                    اعضای تیم من
                </h5>
                @foreach (var teamMember in Model.GroupedTasks.TeamMemberTasks)
                {
                    @if (teamMember.Value.Any())
                    {
                        <div class="ms-3 mb-3">
                            <h6 class="text-muted">
                                <i class="fa fa-user-circle me-1"></i>
                                @teamMember.Key (@teamMember.Value.Count تسک)
                            </h6>
                            @await Html.PartialAsync("_TasksTable", teamMember.Value)
                        </div>
                    }
                }
            </div>
        }

        <!-- تسک‌های تیم‌های زیرمجموعه -->
        @if (Model.GroupedTasks.SubTeamTasks.Any())
        {
            <div class="mb-4">
                <h5 class="text-success">
                    <i class="fa fa-sitemap me-2"></i>
                    تیم‌های زیرمجموعه
                </h5>
                @foreach (var subTeam in Model.GroupedTasks.SubTeamTasks)
                {
                    @if (subTeam.Value.Any())
                    {
                        <div class="ms-3 mb-3">
                            <h6 class="text-muted">
                                <i class="fa fa-users me-1"></i>
                                تیم @subTeam.Key (@subTeam.Value.Count تسک)
                            </h6>
                            @await Html.PartialAsync("_TasksTable", subTeam.Value)
                        </div>
                    }
                }
            </div>
        }
    }
    else
    {
        <!-- نمایش پیام در صورت عدم وجود داده گروه‌بندی شده -->
        <div class="alert alert-info">
            <i class="fa fa-info-circle me-2"></i>
            اطلاعات سلسله‌مراتبی تسک‌ها در حال بارگذاری است...
        </div>
    }

    <!-- نمایش آمار اگر موجود باشد -->
    @if (Model.Statistics != null)
    {
        <div class="mt-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h4>@Model.Statistics.TotalTasks</h4>
                            <p>مجموع تسک‌ها</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h4>@Model.Statistics.CompletedTasks</h4>
                            <p>تکمیل شده</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h4>@Model.Statistics.InProgressTasks</h4>
                            <p>در حال انجام</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h4>@Model.Statistics.OverdueTasks</h4>
                            <p>عقب افتاده</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- نمایش فیلترهای فعال -->
    @if (Model.Filters != null && ViewBag.HasActiveFilters == true)
    {
        <div class="mt-3">
            <div class="alert alert-secondary">
                <i class="fa fa-filter me-2"></i>
                <span class="fw-bold">فیلترهای فعال:</span>

                @if (!string.IsNullOrEmpty(Model.Filters.SearchTerm))
                {
                    <span class="badge bg-info me-1">جستجو: @Model.Filters.SearchTerm</span>
                }

                @if (Model.Filters.BranchId.HasValue)
                {
                    <span class="badge bg-secondary me-1">شعبه انتخاب شده</span>
                }

                @if (Model.Filters.TeamId.HasValue)
                {
                    <span class="badge bg-success me-1">تیم انتخاب شده</span>
                }

                @if (!string.IsNullOrEmpty(Model.Filters.UserId))
                {
                    <span class="badge bg-warning me-1">کاربر انتخاب شده</span>
                }
            </div>
        </div>
    }
</div>

@* JavaScript برای بهبود تعامل *@
<script>
    $(document).ready(function() {
        // اضافه کردن انیمیشن برای کارت‌های آمار
        $('.card').hover(function() {
            $(this).addClass('shadow-lg').css('transform', 'scale(1.05)');
        }, function() {
            $(this).removeClass('shadow-lg').css('transform', 'scale(1)');
        });

        // نمایش تعداد تسک‌ها در tooltip
        $('[data-toggle="tooltip"]').tooltip();

        // اضافه کردن قابلیت collapse برای بخش‌های مختلف
        $('.hierarchy-tasks h5, .hierarchy-tasks h6').css('cursor', 'pointer').click(function() {
            $(this).next().slideToggle();
        });
    });
</script>

<style>
    .hierarchy-tasks .card {
        transition: all 0.3s ease;
    }

    .hierarchy-tasks .ms-3 {
        border-left: 3px solid #e9ecef;
        padding-left: 1rem;
    }

    .hierarchy-tasks h6.text-muted:hover {
        color: #495057 !important;
    }
</style>