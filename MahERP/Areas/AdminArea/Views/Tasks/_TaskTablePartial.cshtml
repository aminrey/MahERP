@model dynamic
@{
    var tasks = Model.Tasks as List<TaskViewModel>;
    var currentUserId = Model.CurrentUserId as string;
    var personName = Model.PersonName as string;
    var isCompleted = (bool)Model.IsCompleted;
}

<div class="table-responsive">
    <table class="table table-hover table-vcenter mb-0">
        <thead class="@(isCompleted ? "table-success" : "table-light")">
            <tr>
                <th style="width: 50px;"></th>
                <th>کد</th>
                <th>عنوان</th>
                <th class="text-center d-none d-md-table-cell">دسته‌بندی</th>
                <th class="text-center d-none d-lg-table-cell">طرف حساب</th>
                <th class="text-center">وضعیت</th>
                <th class="text-center d-none d-lg-table-cell">سازنده</th> @* ⭐ اصلاح شده *@
                <th class="text-center d-none d-sm-table-cell">@(isCompleted ? "تاریخ تکمیل" : "مهلت")</th>
                <th class="text-center" style="width: 120px;">عملیات</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var task in tasks.OrderByDescending(t => t.CreateDate))
            {
                var currentUserAssignment = task.AssignmentsTaskUser?.FirstOrDefault(a => a.AssignedUserId == currentUserId && a.AssignedUserName == personName);
                var isTaskAssignedToCurrentUser = currentUserAssignment != null;
                var isInMyDay = task.IsInMyDay;
                var isFocused = task.IsFocused ?? false;

                var rowClass = task.IsOverdue && !isCompleted ? "table-warning" : "";
                if (isFocused && !isCompleted)
                {
                    rowClass += " task-focused-row";
                }
                else if (isCompleted)
                {
                    rowClass = "table-success-subtle";
                }

                <tr class="@rowClass">
                    <td class="text-center">
                        @if (!isCompleted)
                        {
                            @if (isFocused)
                            {
                                <i class="fa fa-bullseye text-warning fa-lg"
                                   title="متمرکز روی این تسک"
                                   data-bs-toggle="tooltip"
                                   style="animation: focusPulse 2s infinite;"></i>
                            }
                            else if (task.Priority == 2)
                            {
                                <i class="fa fa-exclamation-triangle text-danger"
                                   title="فوری" data-bs-toggle="tooltip"></i>
                            }
                            else if (task.Important)
                            {
                                <i class="fa fa-star text-warning"
                                   title="مهم" data-bs-toggle="tooltip"></i>
                            }
                            else
                            {
                                <i class="fa fa-circle text-muted" style="font-size: 0.5rem;"></i>
                            }
                        }
                        else
                        {
                            <i class="fa fa-check-circle text-success" title="تکمیل شده" data-bs-toggle="tooltip"></i>
                        }
                    </td>
                    <td>
                        <small class="text-muted">@task.TaskCode</small>
                        @if (isFocused && !isCompleted)
                        {
                            <br />
                            <span class="badge bg-warning text-dark mt-1" style="font-size: 0.7rem;">
                                <i class="fa fa-star me-1"></i>متمرکز
                            </span>
                        }
                    </td>
                    <td>
                        <a asp-action="Details" asp-route-id="@task.Id"
                           class="fw-bold text-decoration-none @(isFocused && !isCompleted ? "text-warning" : "")">
                            @if (isFocused && !isCompleted)
                            {
                                <i class="fa fa-bullseye me-1"></i>
                            }
                            @task.Title
                        </a>
                        @if (!string.IsNullOrEmpty(task.Description))
                        {
                            <br />
                            <small class="text-muted">
                                @(task.Description.Length > 50 ? task.Description.Substring(0, 50) + "..." : task.Description)
                            </small>
                        }
                    </td>
                    <td class="text-center d-none d-md-table-cell">
                        @if (!string.IsNullOrEmpty(task.CategoryTitle))
                        {
                            <span class="badge bg-info">@task.CategoryTitle</span>
                        }
                    </td>
                    <td class="text-center d-none d-lg-table-cell">
                        @if (task.SelectedContactId.HasValue)
                        {
                            <span class="badge bg-primary" title="فرد: @task.ContactFullName">
                                <i class="fa fa-user me-1"></i>
                                @(task.ContactFullName?.Length > 15 ? task.ContactFullName.Substring(0, 15) + "..." : task.ContactFullName)
                            </span>
                            @if (task.SelectedOrganizationId.HasValue)
                            {
                                <br />
                                <small class="text-muted" title="سازمان: @task.OrganizationName">
                                    <i class="fa fa-building"></i> @(task.OrganizationName?.Length > 15 ? task.OrganizationName.Substring(0, 15) + "..." : task.OrganizationName)
                                </small>
                            }
                        }
                        else if (task.SelectedOrganizationId.HasValue)
                        {
                            <span class="badge bg-info" title="سازمان: @task.OrganizationName">
                                <i class="fa fa-building me-1"></i>
                                @(task.OrganizationName?.Length > 15 ? task.OrganizationName.Substring(0, 15) + "..." : task.OrganizationName)
                            </span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td class="text-center">
                        @{
                            var statusClass = task.Status switch
                            {
                                0 => "bg-secondary",
                                1 => "bg-warning",
                                2 => "bg-success",
                                3 => "bg-info",
                                4 => "bg-danger",
                                _ => "bg-dark"
                            };

                            var statusText = task.Status switch
                            {
                                0 => "ایجاد",
                                1 => "انجام",
                                2 => "تکمیل",
                                3 => "تأیید",
                                4 => "رد",
                                _ => "؟"
                            };
                        }
                        <span class="badge @statusClass">@statusText</span>
                    </td>
                    <td class="text-center d-none d-lg-table-cell">
                        @* ⭐⭐⭐ نمایش نام سازنده به صورت Badge *@
                        @if (!string.IsNullOrEmpty(task.CreatorName))
                        {
                            <span class="badge bg-primary-light text-primary" title="سازنده تسک">
                                <i class="fa fa-user-tie me-1"></i>
                                @task.CreatorName
                            </span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td class="text-center d-none d-sm-table-cell">
                        @if (isCompleted && task.CompletionDate.HasValue)
                        {
                            <small class="text-success">
                                <i class="fa fa-calendar-check me-1"></i>
                                @ConvertDateTime.ConvertMiladiToShamsi(task.CompletionDate, "yyyy/MM/dd")
                            </small>
                        }
                        else if (task.DueDate.HasValue)
                        {
                            var isOverdue = task.DueDate.Value < DateTime.Now && !task.CompletionDate.HasValue;
                            <small class="@(isOverdue ? "text-danger fw-bold" : "text-muted")">
                                @ConvertDateTime.ConvertMiladiToShamsi(task.DueDate, "yyyy/MM/dd")
                            </small>
                        }
                        else
                        {
                            <small class="text-muted">-</small>
                        }
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <a asp-action="Details" asp-route-id="@task.Id"
                               class="btn btn-alt-secondary"
                               title="جزئیات" data-bs-toggle="tooltip">
                                <i class="fa fa-eye"></i>
                            </a>

                            @if (isTaskAssignedToCurrentUser && !isCompleted)
                            {
                                @if (isInMyDay)
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-success"
                                            title="در روز من قرار دارد"
                                            data-bs-toggle="tooltip">
                                        <i class="fa fa-check-circle"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary btn-add-to-myday"
                                            data-toggle="modal-ajax"
                                            href="@Url.Action("AddToMyDayModal", "Tasks", new { taskId = task.Id })"
                                            title="افزودن به روز من"
                                            data-bs-toggle="tooltip">
                                        <i class="fa fa-calendar-day"></i>
                                    </button>
                                }

                                @if (isFocused)
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-warning"
                                            onclick="removeTaskFocus(@task.Id)"
                                            title="حذف از تمرکز"
                                            data-bs-toggle="tooltip">
                                        <i class="fa fa-star"></i>
                                    </button>
                                }
                                else
                                {
                                    <button type="button"
                                            class="btn btn-sm btn-outline-secondary"
                                            onclick="setTaskFocus(@task.Id)"
                                            title="تنظیم به عنوان تمرکز"
                                            data-bs-toggle="tooltip">
                                        <i class="fa fa-bullseye"></i>
                                    </button>
                                }
                            }

                            @if (!isCompleted)
                            {
                                <a href="#"
                                   onclick="showComingSoonNotification(event, 'ویرایش تسک')"
                                   class="btn btn-sm btn-warning">
                                    <i class="fa fa-pencil-alt"></i>
                                </a>
                            }
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    /* ⭐ استایل Badge سازنده */
    .bg-primary-light {
        background-color: rgba(70, 127, 207, 0.1) !important;
    }

    .table-success-subtle {
        background-color: rgba(70, 195, 123, 0.05) !important;
    }
</style>