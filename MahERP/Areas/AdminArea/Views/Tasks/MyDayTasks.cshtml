@model MyDayTasksViewModel
@{
    ViewData["Title"] = "تسک‌های من - همه روزها";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-calendar-day text-primary me-2"></i>
                تسک‌های من - همه روزها
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="نشانگر مسیر">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-action="Index">تسک‌ها</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">روز من</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->
<!-- Page Content -->
<div class="content">
    <!-- آمار کلی -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-chart-pie text-primary me-1"></i>
                        آمار کلی تسک‌های من
                    </h3>
                    <div class="block-options">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshTasks()">
                            <i class="fa fa-refresh"></i> بروزرسانی
                        </button>
                    </div>
                </div>
                <div class="block-content">
                    <div class="row text-center">
                        <div class="col-lg-3 col-md-6">
                            <div class="py-3">
                                <div class="fs-1 fw-bold text-primary">@Model.Stats.TotalPlannedTasks</div>
                                <div class="fw-semibold text-muted text-uppercase">کل تسک‌ها</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="py-3">
                                <div class="fs-1 fw-bold text-success">@Model.Stats.WorkedTasks</div>
                                <div class="fw-semibold text-muted text-uppercase">کار شده</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="py-3">
                                <div class="fs-1 fw-bold text-info">@Model.Stats.CompletedTasks</div>
                                <div class="fw-semibold text-muted text-uppercase">تکمیل شده</div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="py-3">
                                <div class="fs-1 fw-bold text-warning">@Model.Stats.TotalWorkTimeFormatted</div>
                                <div class="fw-semibold text-muted text-uppercase">زمان کل</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- تسک‌ها گروه‌بندی شده بر اساس تاریخ -->
    @if (Model.TasksByDate.Any())
    {
        @foreach (var dateGroup in Model.TasksByDate.OrderByDescending(x => x.Key))
        {
            var isToday = dateGroup.Value.Any(t => t.IsToday);
            var hasOverdue = dateGroup.Value.Any(t => t.IsOverdue);
            var plannedTasks = dateGroup.Value.Where(t => !t.IsWorkedOn).ToList();
            var workedTasks = dateGroup.Value.Where(t => t.IsWorkedOn).ToList();

            <div class="row mb-4">
                <div class="col-12">
                    <div class="block block-rounded @(isToday ? "block-themed" : "") @(hasOverdue ? "border-danger" : "")">
                        <div class="block-header @(isToday ? "bg-primary text-white" : "block-header-default")">
                            <h3 class="block-title">
                                <i class="fa @(isToday ? "fa-calendar-day" : "fa-calendar") me-1"></i>
                                @dateGroup.Key
                                @if (isToday)
                                {
                                    <span class="badge bg-light text-primary ms-2">امروز</span>
                                }
                                @if (hasOverdue)
                                {
                                    <span class="badge bg-danger ms-2">عقب افتاده</span>
                                }
                            </h3>
                            <div class="block-options">
                                <span class="badge @(isToday ? "bg-light text-primary" : "bg-secondary")">
                                    @dateGroup.Value.Count تسک
                                </span>
                            </div>
                        </div>

                        <div class="block-content p-0">
                            <div class="row no-gutters">
                                <!-- تسک‌های برنامه‌ریزی شده -->
                                <div class="col-lg-6">
                                    <div class="p-3 border-end">
                                        <h6 class="text-muted mb-3">
                                            <i class="fa fa-clock text-primary me-1"></i>
                                            برنامه‌ریزی شده
                                            <span class="badge bg-primary ms-1">@plannedTasks.Count</span>
                                        </h6>

                                        @if (plannedTasks.Any())
                                        {
                                            <div class="list-group list-group-flush">
                                                @foreach (var task in plannedTasks.OrderBy(x => x.TaskPriority).ThenBy(x => x.CreatedDate))
                                                {
                                                    <div class="list-group-item list-group-item-action @(task.IsOverdue ? "border-danger" : "")">
                                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <div class="d-flex align-items-center mb-1">
                                                                    @if (task.TaskPriority == 2)
                                                                    {
                                                                        <i class="fa fa-exclamation-triangle text-danger me-2" title="فوری"></i>
                                                                    }
                                                                    else if (task.IsImportant)
                                                                    {
                                                                        <i class="fa fa-star text-warning me-2" title="مهم"></i>
                                                                    }
                                                                    else
                                                                    {
                                                                        <i class="fa fa-circle text-muted me-2"></i>
                                                                    }

                                                                    <h6 class="mb-0">
                                                                        <a asp-action="Details" asp-route-id="@task.TaskId" class="text-decoration-none">
                                                                            @task.TaskTitle
                                                                        </a>
                                                                    </h6>

                                                                    <span class="badge bg-secondary ms-2">@task.TaskCode</span>
                                                                </div>

                                                                @if (!string.IsNullOrEmpty(task.CategoryTitle))
                                                                {
                                                                    <small class="text-muted">
                                                                        <i class="fa fa-tag me-1"></i>@task.CategoryTitle
                                                                    </small>
                                                                }

                                                                @if (!string.IsNullOrEmpty(task.PlanNote))
                                                                {
                                                                    <div class="mt-2">
                                                                        <small class="text-info">
                                                                            <i class="fa fa-sticky-note me-1"></i>
                                                                            @task.PlanNote
                                                                        </small>
                                                                    </div>
                                                                }

                                                                <div class="progress progress-sm mt-2">
                                                                    <div class="progress-bar bg-primary" role="progressbar"
                                                                         style="width: @task.ProgressPercentage%"
                                                                         aria-valuenow="@task.ProgressPercentage"
                                                                         aria-valuemin="0" aria-valuemax="100">
                                                                        @if (task.ProgressPercentage > 15)
                                                                        {
                                                                            <span class="small">@task.ProgressPercentage%</span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <div class="ms-3">
                                                                <div class="btn-group-vertical btn-group-sm" role="group">
                                                                    <button type="button" class="btn btn-success"
                                                                            onclick="logWork(@task.TaskId)" title="ثبت کار انجام شده">
                                                                        <i class="fa fa-play"></i>
                                                                    </button>
                                                                    <button type="button" class="btn btn-outline-danger"
                                                                            onclick="removeFromMyDay(@task.TaskId, '@task.PlannedDatePersian')" title="حذف از روز من">
                                                                        <i class="fa fa-times"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-3">
                                                <i class="fa fa-clock fa-2x text-muted mb-2"></i>
                                                <div class="text-muted">هیچ تسک برنامه‌ریزی نشده‌ای ندارید</div>
                                            </div>
                                        }
                                    </div>
                                </div>

                                <!-- تسک‌های انجام شده -->
                                <div class="col-lg-6">
                                    <div class="p-3">
                                        <h6 class="text-muted mb-3">
                                            <i class="fa fa-check-circle text-success me-1"></i>
                                            کار شده
                                            <span class="badge bg-success ms-1">@workedTasks.Count</span>
                                        </h6>

                                        @if (workedTasks.Any())
                                        {
                                            <div class="list-group list-group-flush">
                                                @foreach (var task in workedTasks.OrderByDescending(x => x.WorkStartDate))
                                                {
                                                    <div class="list-group-item">
                                                        <div class="d-flex w-100 justify-content-between align-items-start">
                                                            <div class="flex-grow-1">
                                                                <div class="d-flex align-items-center mb-1">
                                                                    <i class="fa fa-check-circle text-success me-2"></i>

                                                                    <h6 class="mb-0">
                                                                        <a asp-action="Details" asp-route-id="@task.TaskId" class="text-decoration-none">
                                                                            @task.TaskTitle
                                                                        </a>
                                                                    </h6>

                                                                    <span class="badge bg-secondary ms-2">@task.TaskCode</span>

                                                                    @if (task.WorkDurationMinutes.HasValue)
                                                                    {
                                                                        <span class="badge bg-info ms-1">
                                                                            @(task.WorkDurationMinutes.Value > 60 ?
                                                                                                                                    $"{task.WorkDurationMinutes.Value / 60}:{task.WorkDurationMinutes.Value % 60:D2}" :
                                                                                                                                    $"{task.WorkDurationMinutes.Value}د")
                                                    </span>
                                                                                                        }
                                                                </div>

                                                                @if (!string.IsNullOrEmpty(task.WorkNote))
                                                                {
                                                                    <div class="mt-2">
                                                                        <small class="text-success">
                                                                            <i class="fa fa-comment me-1"></i>
                                                                            @(task.WorkNote.Length > 100 ? task.WorkNote.Substring(0, 100) + "..." : task.WorkNote)
                                                                        </small>
                                                                    </div>
                                                                }

                                                                @if (task.WorkStartDate.HasValue)
                                                                {
                                                                    <div class="mt-1">
                                                                        <small class="text-muted">
                                                                            <i class="fa fa-clock me-1"></i>
                                                                            @task.WorkStartDate.Value.ToString("HH:mm")
                                                                        </small>
                                                                    </div>
                                                                }
                                                            </div>

                                                            <div class="ms-3">
                                                                <button type="button" class="btn btn-sm btn-outline-primary"
                                                                        onclick="logWork(@task.TaskId)" title="بروزرسانی کار">
                                                                    <i class="fa fa-edit"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-3">
                                                <i class="fa fa-clock fa-2x text-muted mb-2"></i>
                                                <div class="text-muted">هنوز کاری انجام نشده</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <!-- صفحه خالی -->
        <div class="row">
            <div class="col-12">
                <div class="block block-rounded">
                    <div class="block-content text-center py-5">
                        <div class="mb-3">
                            <i class="fa fa-calendar-plus fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted">هیچ تسکی در برنامه روزانه شما نیست</h4>
                        <p class="text-muted">
                            از طریق لیست تسک‌ها، تسک‌های مورد نظر را به روزهای مختلف اضافه کنید.
                        </p>
                        <a asp-action="Index" class="btn btn-primary">
                            <i class="fa fa-plus me-1"></i> مشاهده لیست تسک‌ها
                        </a>
                    </div>
                </div>
            </div>
        </div>
    }
</div>
<!-- END Page Content -->
@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-refresh every 5 minutes
            setInterval(function() {
                refreshTasks();
            }, 300000);
        });

        function refreshTasks() {
            location.reload();
        }

        function logWork(taskId) {
            var url = '@Url.Action("LogWorkModal")' + '?taskId=' + taskId;

            // Use existing modal system from main.js
            createAndShowModal(url);
        }

        function removeFromMyDay(taskId, plannedDate) {
            if (confirm('آیا مطمئن هستید که می‌خواهید این تسک را از روز خود حذف کنید؟')) {
                $.post('@Url.Action("RemoveFromMyDay")', {
                    taskId: taskId,
                    date: plannedDate,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                }).done(function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        if (typeof Swal !== 'undefined') {
                            Swal.fire('خطا', response.message || 'خطا در حذف تسک', 'error');
                        } else {
                            alert('خطا: ' + (response.message || 'خطا در حذف تسک'));
                        }
                    }
                }).fail(function() {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire('خطا', 'خطا در ارتباط با سرور', 'error');
                    } else {
                        alert('خطا در ارتباط با سرور');
                    }
                });
            }
        }
    </script>
}

@section Styles {
    <style>
        .list-group-item-action:hover {
            background-color: rgba(0,123,255,.05);
        }

        .progress-sm {
            height: 8px;
        }

        .btn-group-vertical .btn {
            margin-bottom: 2px;
        }

            .btn-group-vertical .btn:last-child {
                margin-bottom: 0;
            }

        .border-danger {
            border-color: #dc3545 !important;
        }

        .block-themed .block-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .no-gutters .col-lg-6:first-child {
            border-left: 1px solid #e9ecef;
        }

        @@media (max-width: 991.98px) {
            .no-gutters .col-lg-6:first-child

        {
            border-left: none;
            border-bottom: 1px solid #e9ecef;
        }

        }
    </style>
}