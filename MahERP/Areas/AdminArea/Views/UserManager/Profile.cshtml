@model MahERP.DataModelLayer.ViewModels.UserViewModels.UserViewModelFull
@{
    ViewData["Title"] = "پروفایل من";
}

<style>
    .required::after {
        content: " *";
        color: red;
        font-weight: bold;
    }
</style>

<!-- Hero Section -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo18@2x.jpg');">
    <div class="bg-black-50">
        <div class="content content-full content-top">
            <div class="py-4 text-center">
                <!-- Profile Image with Edit Button -->
                <div class="position-relative d-inline-block mb-3">
                    <img alt="تصویر پروفایل"
                         class="img-avatar img-avatar96 img-avatar-thumb"
                         id="profileImage"
                         src="@(!string.IsNullOrEmpty(Model.ProfileImagePath) ? Model.ProfileImagePath : "/assets/media/avatars/avatar0.jpg")"
                         style="border: 4px solid rgba(255,255,255,0.3); cursor: pointer;"
                         onclick="document.getElementById('profileImageInput').click();" />

                    <!-- Edit Icon -->
                    <button type="button"
                            class="btn btn-sm btn-primary position-absolute bottom-0 end-0 rounded-circle"
                            style="width: 32px; height: 32px; transform: translate(25%, 25%);"
                            onclick="document.getElementById('profileImageInput').click();"
                            title="تغییر تصویر پروفایل">
                        <i class="fa fa-camera fa-sm"></i>
                    </button>

                    <!-- Hidden File Input -->
                    <input type="file"
                           id="profileImageInput"
                           name="profileImage"
                           accept="image/*"
                           style="display: none;"
                           onchange="uploadProfileImage(this)" />
                </div>

                <!-- User Name and Position -->
                <h1 class="h2 fw-bold my-2 text-white">@Model.FirstName @Model.LastName</h1>
                <h2 class="h4 fw-normal text-white-75 mb-1">
                    @(!string.IsNullOrEmpty(Model.PositionName) ? Model.PositionName : "کاربر سیستم")
                </h2>
                @if (!string.IsNullOrEmpty(Model.CompanyName))
                {
                    <h3 class="h5 fw-normal text-white-50 mb-0">@Model.CompanyName</h3>
                }
            </div>
        </div>
    </div>
</div>

<!-- Profile Content -->
<div class="content">
    <div class="row">
        <!-- Profile Information Form -->
        <div class="col-lg-8">
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-user me-1 text-primary"></i>
                        اطلاعات شخصی
                    </h3>
                </div>
                <div class="block-content">
                    <form asp-action="UpdateProfile" asp-controller="UserManager" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="UserName" />
                        <input type="hidden" asp-for="RegisterDate" />
                        <input type="hidden" asp-for="IsActive" />
                        <input type="hidden" asp-for="ProfileImagePath" />

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label required" asp-for="FirstName">نام</label>
                                    <input type="text" class="form-control" asp-for="FirstName" placeholder="نام خود را وارد کنید" />
                                    <span asp-validation-for="FirstName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label required" asp-for="LastName">نام خانوادگی</label>
                                    <input type="text" class="form-control" asp-for="LastName" placeholder="نام خانوادگی خود را وارد کنید" />
                                    <span asp-validation-for="LastName" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="Email">ایمیل</label>
                                    <input @(string.IsNullOrEmpty(Model.Email) ? "" : "readonly") type="email" class="form-control" value="@Model.Email" name="Email" placeholder="ایمیل خود را وارد کنید" />
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label required" asp-for="PhoneNumber">شماره تلفن</label>
                                    <input @(string.IsNullOrEmpty(Model.PhoneNumber) ? "" : "readonly") type="text" class="form-control" value="@Model.PhoneNumber" name="PhoneNumber" placeholder="شماره تلفن خود را وارد کنید" />
                                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="CompanyName">نام شرکت</label>
                                    <input type="text" class="form-control" asp-for="CompanyName" placeholder="نام شرکت خود را وارد کنید" />
                                    <span asp-validation-for="CompanyName" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="PositionName">سمت شغلی</label>
                                    <input @(string.IsNullOrEmpty(Model.PositionName) ? "" : "readonly") type="text" class="form-control" value="@Model.PositionName" name="PositionName" placeholder="سمت شغلی خود را وارد کنید" />
                                    <span asp-validation-for="PositionName" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="City">شهر</label>
                                    <input type="text" class="form-control" asp-for="City" placeholder="شهر خود را وارد کنید" />
                                    <span asp-validation-for="City" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="Province">استان</label>
                                    <input type="text" class="form-control" asp-for="Province" placeholder="استان خود را وارد کنید" />
                                    <span asp-validation-for="Province" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="MelliCode">کد ملی</label>
                                    <input @(string.IsNullOrEmpty(Model.MelliCode) ? "" : "readonly") type="text" class="form-control" value="@Model.MelliCode" name="MelliCode" placeholder="کد ملی خود را وارد کنید" />
                                    <span asp-validation-for="MelliCode" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label class="form-label" asp-for="Gender">جنسیت</label>
                                    <select class="form-select" asp-for="Gender">
                                        <option value="1">مرد</option>
                                        <option value="2">زن</option>
                                    </select>
                                    <span asp-validation-for="Gender" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" asp-for="Address">آدرس</label>
                            <textarea @(string.IsNullOrEmpty(Model.Address) ? "" : "readonly") class="form-control"  name="Address" rows="3" placeholder="آدرس کامل خود را وارد کنید"> @Model.Address</textarea>
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-save me-1"></i>
                                ذخیره تغییرات
                            </button>
                            <a href="@Url.Action("Profile")" class="btn btn-alt-secondary">
                                <i class="fa fa-undo me-1"></i>
                                انصراف
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Account Stats -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-chart-bar me-1 text-info"></i>
                        آمار حساب کاربری
                    </h3>
                </div>
                <div class="block-content">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="py-3">
                                <div class="fs-3 fw-semibold text-primary mb-1">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                <div class="fs-sm text-muted">تاریخ عضویت</div>
                                <div class="fw-semibold">@Model.RegisterDate.ToString("yyyy/MM/dd")</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="py-3">
                                <div class="fs-3 fw-semibold text-success mb-1">
                                    <i class="fa fa-check-circle"></i>
                                </div>
                                <div class="fs-sm text-muted">وضعیت حساب</div>
                                <div class="fw-semibold">@(Model.IsActive ? "فعال" : "غیرفعال")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change Password -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-lock me-1 text-warning"></i>
                        تغییر رمز عبور
                    </h3>
                </div>
                <div class="block-content">
                    <form asp-action="ChangePassword" asp-controller="UserManager" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label">رمز عبور فعلی</label>
                            <input type="password" class="form-control" name="CurrentPassword" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">رمز عبور جدید</label>
                            <input type="password" class="form-control" name="NewPassword" minlength="6" required />
                        </div>

                        <div class="mb-4">
                            <label class="form-label">تکرار رمز عبور جدید</label>
                            <input type="password" class="form-control" name="ConfirmPassword" minlength="6" required />
                        </div>

                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fa fa-key me-1"></i>
                            تغییر رمز عبور
                        </button>
                    </form>
                </div>
            </div>

            <!-- Account Info -->
            <div class="block block-rounded">
                <div class="block-header block-header-default">
                    <h3 class="block-title">
                        <i class="fa fa-info-circle me-1 text-secondary"></i>
                        اطلاعات حساب
                    </h3>
                </div>
                <div class="block-content">
                    <table class="table table-borderless table-sm">
                        <tr>
                            <td class="fw-semibold">نام کاربری:</td>
                            <td>@Model.UserName</td>
                        </tr>
                        <tr>
                            <td class="fw-semibold">شناسه کاربری:</td>
                            <td class="font-monospace fs-sm">@Model.Id</td>
                        </tr>
                        <tr>
                            <td class="fw-semibold">وضعیت:</td>
                            <td>
                                @if (Model.IsActive)
                                {
                                    <span class="badge bg-success">فعال</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">غیرفعال</span>
                                }
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Change Password Form Submission (فقط فرم تغییر رمز عبور همچنان AJAX باشد)
            $('#changePasswordForm').on('submit', function(e) {
                e.preventDefault();

                var newPassword = $('input[name="NewPassword"]').val();
                var confirmPassword = $('input[name="ConfirmPassword"]').val();

                if (newPassword !== confirmPassword) {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: 'رمز عبور جدید و تکرار آن باید یکسان باشند',
                        confirmButtonText: 'تأیید'
                    });
                    return;
                }

                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("ChangePassword", "UserManager", new { area = "AdminArea" })',
                    type: 'POST',
                    data: formData,
                    beforeSend: function() {
                        $('#changePasswordForm button[type="submit"]').prop('disabled', true).html('<i class="fa fa-spinner fa-spin me-1"></i>در حال تغییر...');
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'موفقیت',
                                text: response.message,
                                confirmButtonText: 'تأیید'
                            }).then(() => {
                                $('#changePasswordForm')[0].reset();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'خطا',
                                text: response.message,
                                confirmButtonText: 'تأیید'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: 'خطا در ارتباط با سرور',
                            confirmButtonText: 'تأیید'
                        });
                    },
                    complete: function() {
                        $('#changePasswordForm button[type="submit"]').prop('disabled', false).html('<i class="fa fa-key me-1"></i>تغییر رمز عبور');
                    }
                });
            });
        });

         // Profile Image Upload
        function uploadProfileImage(input) {
            if (input.files && input.files[0]) {
                var file = input.files[0];

                // Validate file type
                var allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: 'فرمت تصویر مجاز نیست. فرمت‌های مجاز: JPG, PNG, GIF',
                        confirmButtonText: 'تأیید'
                    });
                    return;
                }

                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    Swal.fire({
                        icon: 'error',
                        title: 'خطا',
                        text: 'حجم تصویر نباید بیشتر از 5 مگابایت باشد',
                        confirmButtonText: 'تأیید'
                    });
                    return;
                }

                var formData = new FormData();
                formData.append('profileImage', file);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                console.log('شروع آپلود تصویر...'); // برای دیباگ

                $.ajax({
                    url: '@Url.Action("UploadProfileImage", "UserManager", new { area = "AdminArea" })',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function() {
                        // Show loading overlay on image
                        $('#profileImage').after('<div class="position-absolute top-50 start-50 translate-middle" id="imageLoader"><i class="fa fa-spinner fa-spin fa-2x text-primary"></i></div>');
                        console.log('در حال ارسال درخواست...');
                    },
                    success: function(response) {
                        console.log('پاسخ سرور:', response); // برای دیباگ
                        
                        if (response && response.status === 'success') {
                            // به‌روزرسانی تصویر پروفایل
                            $('#profileImage').attr('src', response.imagePath + '?v=' + new Date().getTime());
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'موفقیت',
                                text: response.message,
                                confirmButtonText: 'تأیید'
                            });
                        } else {
                            console.error('خطا در پاسخ:', response);
                            Swal.fire({
                                icon: 'error',
                                title: 'خطا',
                                text: response ? response.message : 'خطا در آپلود تصویر',
                                confirmButtonText: 'تأیید'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('خطا در AJAX:', {xhr: xhr, status: status, error: error});
                        Swal.fire({
                            icon: 'error',
                            title: 'خطا',
                            text: 'خطا در ارتباط با سرور: ' + error,
                            confirmButtonText: 'تأیید'
                        });
                    },
                    complete: function() {
                        $('#imageLoader').remove();
                        // Clear file input
                        $('#profileImageInput').val('');
                        console.log('درخواست تکمیل شد');
                    }
                });
            }
        }
    </script>
}

<style>
    .required::after {
        content: " *";
        color: red;
        font-weight: bold;
    }

    .img-avatar-thumb {
        object-fit: cover;
        transition: all 0.3s ease;
    }

        .img-avatar-thumb:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

    .bg-image {
        background-attachment: fixed;
        background-position: center;
        background-size: cover;
    }

    .position-relative .btn {
        transition: all 0.3s ease;
    }

        .position-relative .btn:hover {
            transform: translate(25%, 25%) scale(1.1);
        }

    .block {
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

        .block:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

    .form-control:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    /* استایل برای فیلدهای readonly */
    .form-control[readonly] {
        background-color: #f8f9fa;
        opacity: 0.8;
    }
</style>