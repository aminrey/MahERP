@model BranchDetailsViewModel
@{
    ViewData["Title"] = $"جزئیات شعبه - {Model.Name}";
}

<!-- Hero -->
<div class="bg-image" style="background-image: url('/assets/media/photos/photo12.jpg');">
    <div class="bg-primary-dark-op">
        <div class="content content-full text-center py-6">
            <h1 class="h2 text-white mb-2">@Model.Name</h1>
            <h2 class="h4 fw-normal text-white-75 mb-0">
                @(Model.IsMainBranch ? "شعبه اصلی" : "شعبه فرعی")
                @if (Model.ParentBranch != null)
                {
                    <span class="mx-2">|</span>
                    <span>زیرمجموعه: @Model.ParentBranchName</span>
                }
            </h2>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content content-full content-boxed">
    <!-- دکمه‌های عملیاتی - ردیف اول -->
    <div class="row items-push">
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" 
               href="@Url.Action("EditBranch", "Branch", new { id = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-pencil-alt text-primary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">ویرایش</p>
                </div>
            </a>
        </div>
        
        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" 
               href="javascript:void(0)" onclick="openModal('@Url.Action("ToggleActivation", "Branch", new { id = Model.Id })')">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-@(Model.IsActive ? "ban text-danger" : "check text-success")"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">
                        @(Model.IsActive ? "غیرفعال کردن" : "فعال کردن")
                    </p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" 
               href="@Url.Action("AddUserToBranch", "Branch", new { branchId = Model.Id })">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-user-plus text-info"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن کاربر</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="javascript:void(0)" onclick="openModal('@Url.Action("AddStakeholderToBranch", "Branch", new { branchId = Model.Id })')">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-user-tie text-success"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن طرف حساب</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0"
               href="javascript:void(0)" onclick="openModal('@Url.Action("AssignTaskCategoryToBranch", "BranchTaskCategory", new { area = "AdminArea", branchId = Model.Id })')">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-plus-circle text-warning"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">افزودن دسته‌بندی</p>
                </div>
            </a>
        </div>

        <div class="col-6 col-md-4 col-xl-2">
            <a class="block block-rounded block-link-shadow text-center h-100 mb-0" 
               href="@Url.Action("Index", "Branch")">
                <div class="block-content py-5">
                    <div class="fs-3 fw-semibold mb-1">
                        <i class="fa fa-arrow-left text-secondary"></i>
                    </div>
                    <p class="fw-semibold fs-sm text-muted text-uppercase mb-0">بازگشت</p>
                </div>
            </a>
        </div>
    </div>
    <!-- END Quick Actions -->

    <!-- دکمه‌های بخش‌های جزئیات - ردیف دوم (Tab Navigation) -->
    <div class="block block-rounded">
        <ul class="nav nav-tabs nav-tabs-block justify-content-center" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-info" data-bs-toggle="tab" 
                        data-bs-target="#info-panel" type="button" role="tab">
                    <i class="fa fa-info-circle me-1"></i> اطلاعات پایه
                </button>
            </li>
            
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-users" data-bs-toggle="tab" 
                        data-bs-target="#users-panel" type="button" role="tab">
                    <i class="fa fa-users me-1"></i> کاربران شعبه
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-stakeholders" data-bs-toggle="tab" 
                        data-bs-target="#stakeholders-panel" type="button" role="tab">
                    <i class="fa fa-user-tie me-1"></i> طرف حساب‌ها
                </button>
            </li>

            @if (Model.ChildBranches != null && Model.ChildBranches.Count > 0)
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tab-children" data-bs-toggle="tab" 
                            data-bs-target="#children-panel" type="button" role="tab">
                        <i class="fa fa-sitemap me-1"></i> شعبه‌های زیرمجموعه
                    </button>
                </li>
            }

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-categories" data-bs-toggle="tab" 
                        data-bs-target="#categories-panel" type="button" role="tab">
                    <i class="fa fa-list-alt me-1"></i> دسته‌بندی تسک‌ها
                </button>
            </li>

            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-stats" data-bs-toggle="tab" 
                        data-bs-target="#stats-panel" type="button" role="tab">
                    <i class="fa fa-chart-bar me-1"></i> آمار و گزارشات
                </button>
            </li>
        </ul>

        <div class="block-content tab-content">
            <!-- بخش اطلاعات پایه -->
            <div class="tab-pane active" id="info-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchBasicInfo", Model)
            </div>

            <!-- بخش کاربران -->
            <div class="tab-pane" id="users-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchUsers", Model)
            </div>

            <!-- بخش طرف حساب‌ها -->
            <div class="tab-pane" id="stakeholders-panel" role="tabpanel">
                @{
                    var branchStakeholders = ViewBag.BranchStakeholders as List<StakeholderBranch> ?? new List<StakeholderBranch>();
                }
                @await Html.PartialAsync("_BranchStakeholders", branchStakeholders)
            </div>

            <!-- بخش شعبه‌های زیرمجموعه -->
            @if (Model.ChildBranches != null && Model.ChildBranches.Count > 0)
            {
                <div class="tab-pane" id="children-panel" role="tabpanel">
                    @await Html.PartialAsync("_BranchChildren", Model.ChildBranches)
                </div>
            }

            <!-- بخش دسته‌بندی تسک‌ها -->
            <div class="tab-pane" id="categories-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchTaskCategories", Model.Id)
            </div>

            <!-- بخش آمار -->
            <div class="tab-pane" id="stats-panel" role="tabpanel">
                @await Html.PartialAsync("_BranchStats", Model)
            </div>
        </div>
    </div>
</div>
<!-- END Page Content -->

<!-- Modal Container -->
<div class="modal fade" id="modal-branch" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
                <h5 class="mt-3">در حال بارگذاری...</h5>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function openModal(url) {
            $('#modal-branch .modal-content').html(`
                <div class="modal-body text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">در حال بارگذاری...</span>
                    </div>
                    <h5 class="mt-3">در حال بارگذاری...</h5>
                </div>
            `);
            
            $('#modal-branch').modal('show');

            $.get(url)
                .done(function(data) {
                    $('#modal-branch .modal-content').html(data);
                })
                .fail(function() {
                    $('#modal-branch .modal-content').html(`
                        <div class="modal-header bg-danger">
                            <h4 class="modal-title text-white">خطا</h4>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <i class="fa fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                            <h5>خطا در بارگذاری محتوا</h5>
                            <p>لطفاً مجدداً تلاش کنید.</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                        </div>
                    `);
                });
        }

        $(document).ready(function() {
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            $('#modal-branch').on('hidden.bs.modal', function () {
                $(this).find('.modal-content').html(`
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">در حال بارگذاری...</span>
                        </div>
                        <h5 class="mt-3">در حال بارگذاری...</h5>
                    </div>
                `);
            });
        });
    </script>
}