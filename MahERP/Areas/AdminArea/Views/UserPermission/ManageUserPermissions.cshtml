@model ManageUserPermissionsViewModel
@{
    ViewData["Title"] = "مدیریت دسترسی‌های کاربر";
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center">
            <h1 class="flex-grow-1 fs-3 fw-semibold my-2 my-sm-3">
                <i class="fa fa-user-lock text-primary me-2"></i>دسترسی‌های: @Model.UserFullName
            </h1>
            <nav class="flex-shrink-0 my-2 my-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a asp-area="AdminArea" asp-controller="Dashboard" asp-action="Index">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a asp-controller="UserManagement" asp-action="Index">کاربران</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">دسترسی‌ها</li>
                </ol>
            </nav>
        </div>
    </div>
</div>

<!-- Page Content -->
<div class="content">
 
    <!-- Permission Management -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                <i class="fa fa-sitemap text-muted me-1"></i>مدیریت دسترسی‌ها
            </h3>
            <div class="block-options">
                <button type="button" class="btn btn-sm btn-success" onclick="selectAll()">
                    <i class="fa fa-check-square me-1"></i>انتخاب همه
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="deselectAll()">
                    <i class="fa fa-square me-1"></i>لغو همه
                </button>
                <button type="button" class="btn btn-sm btn-primary" onclick="expandAll()">
                    <i class="fa fa-expand me-1"></i>باز کردن
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="collapseAll()">
                    <i class="fa fa-compress me-1"></i>بستن
                </button>
            </div>
        </div>
        <div class="block-content">
            <form asp-action="ManageUserPermissions" method="post" id="userPermissionsForm">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="UserId" />
                <input type="hidden" asp-for="UserFullName" />

                <div class="row">
                    <!-- Permission Tree -->
                    <div class="col-lg-6">
                        <div class="alert alert-info mb-4">
                            <i class="fa fa-info-circle me-1"></i>
                            <strong>راهنما:</strong>
                            <ul class="mb-0 mt-2 small">
                                <li>✅ دسترسی‌های انتخاب شده <strong>به صورت مستقیم</strong> به کاربر داده می‌شود</li>
                                <li>✅ دسترسی‌های از طریق <strong>نقش</strong> با آیکون <i class="fa fa-shield-alt text-primary"></i> نشان داده می‌شوند</li>
                                <li>✅ دسترسی‌های <strong>دستی</strong> با آیکون <i class="fa fa-hand-paper text-warning"></i> مشخص هستند</li>
                                <li>⚠️ دسترسی‌های دستی <strong>مستقل از نقش</strong> کاربر هستند</li>
                            </ul>
                        </div>

                        <!-- Permission Tree -->
                        <div id="user-permission-tree" class="permission-tree-container mb-4">
                            @if (Model.PermissionTree != null && Model.PermissionTree.Any())
                            {
                                @await Html.PartialAsync("_PermissionTreePartial", Model.PermissionTree)
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fa fa-exclamation-triangle me-1"></i>
                                    هیچ دسترسی در سیستم تعریف نشده است.
                                </div>
                            }
                        </div>

                        <!-- Selected Count -->
                        <div class="alert alert-success">
                            <i class="fa fa-check-circle me-1"></i>
                            <strong id="selectedCount">0</strong> دسترسی انتخاب شده
                            <span class="ms-2 text-muted small">
                                (<strong id="roleBasedCount">0</strong> از نقش +
                                <strong id="manualCount">0</strong> دستی)
                            </span>
                        </div>

                        <!-- Hidden container for selected IDs -->
                        <div id="selectedIdsContainer"></div>
                    </div>

                    <!-- Permissions Detail -->
                    <div class="col-lg-6">
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">
                                    <i class="fa fa-list me-1"></i>دسترسی‌های فعلی کاربر
                                </h5>
                            </div>
                            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                                @if (Model.UserPermissions.Any())
                                {
                                    <div class="list-group">
                                        @foreach (var perm in Model.UserPermissions.OrderBy(p => p.PermissionName))
                                        {
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>@perm.PermissionName</strong>
                                                    <br>
                                                    <small class="text-muted">@perm.PermissionCode</small>
                                                </div>
                                                <div class="text-end">
                                                    @if (perm.SourceType == "Role")
                                                    {
                                                        <span class="badge bg-primary" title="از نقش: @perm.SourceRoleName">
                                                            <i class="fa fa-shield-alt me-1"></i>@perm.SourceRoleName
                                                        </span>
                                                    }
                                                    else if (perm.SourceType == "Manual")
                                                    {
                                                        <span class="badge bg-warning">
                                                            <i class="fa fa-hand-paper me-1"></i>دستی
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-info">
                                                            <i class="fa fa-layer-group me-1"></i>ترکیبی
                                                        </span>
                                                    }
                                                    <br>
                                                    @if (perm.IsActive)
                                                    {
                                                        <span class="badge bg-success mt-1">فعال</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger mt-1">غیرفعال</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning mb-0">
                                        <i class="fa fa-exclamation-triangle me-1"></i>
                                        هیچ دسترسی فعالی وجود ندارد.
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Statistics -->
                        <div class="row mt-3">
                            <div class="col-6">
                                <div class="card text-center border-primary">
                                    <div class="card-body p-3">
                                        <h3 class="text-primary mb-0">@Model.UserPermissions.Count(p => p.SourceType == "Role")</h3>
                                        <small class="text-muted">از نقش</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card text-center border-warning">
                                    <div class="card-body p-3">
                                        <h3 class="text-warning mb-0">@Model.UserPermissions.Count(p => p.SourceType == "Manual")</h3>
                                        <small class="text-muted">دستی</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fa fa-save me-1"></i>ذخیره دسترسی‌ها
                                </button>
                                <a asp-controller="UserManagement" asp-action="Index" class="btn btn-secondary btn-lg">
                                    <i class="fa fa-times me-1"></i>انصراف
                                </a>
                            </div>
                            <div>
                                <a asp-action="ResetUserPermissions" asp-route-userId="@Model.UserId"
                                   class="btn btn-danger btn-lg"
                                   onclick="return confirm('آیا از بازنشانی تمام دسترسی‌های دستی مطمئن هستید؟')">
                                    <i class="fa fa-undo me-1"></i>بازنشانی دسترسی‌های دستی
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/themes/default/style.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.16/jstree.min.js"></script>

    <script>
        $(function () {
            console.log('=== Initializing User Permission jsTree ===');

            // ✅ Initialize jsTree with checkbox
            $('#user-permission-tree').jstree({
                'core': {
                    'themes': {
                        'responsive': true,
                        'variant': 'large',
                        'stripes': true
                    }
                },
                'checkbox': {
                    'keep_selected_style': false,
                    'three_state': false,
                    'cascade': 'up'
                },
                'plugins': ['checkbox', 'wholerow']
            });

            // ✅ Event: Tree Changed
            $('#user-permission-tree').on("changed.jstree", function (e, data) {
                console.log('✅ Tree changed - Selected nodes:', data.selected);
                updateHiddenInputs();
                updateStatistics();
            });

            // ✅ Event: Tree Ready
            $('#user-permission-tree').on("ready.jstree", function (e, data) {
                console.log('✅ jsTree is ready');

                var selectedIds = @Html.Raw(Json.Serialize(Model.SelectedPermissionIds ?? new List<int>()));
                console.log('Initially selected IDs:', selectedIds);

                if (selectedIds && selectedIds.length > 0) {
                    selectedIds.forEach(function(id) {
                        var nodeId = 'perm-' + id;
                        $('#user-permission-tree').jstree('select_node', nodeId);
                    });
                }

                updateHiddenInputs();
                updateStatistics();
            });

            // ✅ Update hidden inputs
            function updateHiddenInputs() {
                var selectedNodes = $('#user-permission-tree').jstree('get_selected', true);

                var selectedIds = selectedNodes.map(function(node) {
                    return parseInt(node.id.replace('perm-', ''));
                }).filter(function(id) {
                    return !isNaN(id);
                });

                console.log('Updating hidden inputs with IDs:', selectedIds);

                $('#selectedIdsContainer').empty();

                selectedIds.forEach(function(id) {
                    $('<input>').attr({
                        type: 'hidden',
                        name: 'SelectedPermissionIds',
                        value: id
                    }).appendTo('#selectedIdsContainer');
                });
            }

            // ✅ Update statistics
            function updateStatistics() {
                var totalCount = $('#user-permission-tree').jstree('get_selected').length;
                $('#selectedCount').text(totalCount);

                // شمارش دسترسی‌های از نقش و دستی
                var roleBasedCount = @Model.UserPermissions.Count(p => p.SourceType == "Role");
                var manualCount = totalCount - roleBasedCount;

                $('#roleBasedCount').text(roleBasedCount);
                $('#manualCount').text(manualCount > 0 ? manualCount : 0);
            }

            // ✅ Global functions
            window.selectAll = function() {
                $('#user-permission-tree').jstree('select_all');
            };

            window.deselectAll = function() {
                $('#user-permission-tree').jstree('deselect_all');
            };

            window.expandAll = function() {
                $('#user-permission-tree').jstree('open_all');
            };

            window.collapseAll = function() {
                $('#user-permission-tree').jstree('close_all');
            };

            // ✅ Form submission
            $('#userPermissionsForm').on('submit', function(e) {
                var selectedIds = $('#selectedIdsContainer input[name="SelectedPermissionIds"]').map(function() {
                    return $(this).val();
                }).get();

                console.log('=== Form Submitting ===');
                console.log('Selected IDs:', selectedIds);
                console.log('Form data:', $(this).serialize());

                if (selectedIds.length === 0) {
                    if (!confirm('هیچ دسترسی انتخاب نشده است. تمام دسترسی‌های دستی حذف خواهند شد. آیا مطمئن هستید؟')) {
                        e.preventDefault();
                        return false;
                    }
                }

                return true;
            });
        });
    </script>

    <style>
        .permission-tree-container {
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            max-height: 600px;
            overflow-y: auto;
        }

        .jstree-default .jstree-hovered {
            background: #e9ecef !important;
        }

        .jstree-default .jstree-anchor {
            padding: 8px 12px;
            border-radius: 4px;
        }

        .jstree-default .jstree-node {
            margin-right: 0;
        }

        .jstree-default .jstree-icon {
            margin-left: 5px;
        }

        .list-group-item {
            border-right: 4px solid transparent;
        }

            .list-group-item:hover {
                background-color: #f8f9fa;
                border-right-color: #007bff;
            }
    </style>
}