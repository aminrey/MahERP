@model MahERP.DataModelLayer.ViewModels.OrganizationViewModels.TeamMemberViewModel

<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">اضافه کردن عضو به تیم: @Model.TeamTitle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <form asp-action="AddMemberSubmit" method="post">
            @Html.AntiForgeryToken()

            <div class="modal-body">
                <input type="hidden" asp-for="TeamId" />

                <div class="mb-3">
                    <label asp-for="UserId" class="form-label required">انتخاب کاربر</label>
                    <select asp-for="UserId" class="form-select js-select2" asp-items="ViewBag.AvailableUsers" required>
                        <option value="">-- انتخاب کاربر --</option>
                    </select>
                    <span asp-validation-for="UserId" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label asp-for="PositionId" class="form-label">سمت در تیم</label>
                    <select asp-for="PositionId" class="form-select" asp-items="ViewBag.AvailablePositions">
                    </select>
                    <span asp-validation-for="PositionId" class="text-danger"></span>
                    <div class="form-text">
                        <small class="text-info">
                            <i class="fa fa-info-circle me-1"></i>
                            انتخاب سمت تأثیر بر مجوزهای مشاهده تسک خواهد داشت. در صورت عدم انتخاب، عضو بدون سمت رسمی اضافه می‌شود.
                        </small>
                    </div>
                </div>

                <!-- نوع عضویت -->
                <div class="mb-3">
                    <label asp-for="MembershipType" class="form-label">نوع عضویت</label>
                    <select asp-for="MembershipType" class="form-select">
                        <option value="0">عضو عادی</option>
                        <option value="1">ناظر تیم</option>
                    </select>
                    <span asp-validation-for="MembershipType" class="text-danger"></span>
                    <div class="form-text">
                        <small class="text-muted">
                            <i class="fa fa-users me-1"></i>
                            <strong>عضو عادی:</strong> دسترسی معمولی به تیم و تسک‌ها<br>
                            <strong>ناظر تیم:</strong> نظارت و پیگیری تسک افراد زیرمجموعه در تیم<br>
                        </small>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="RoleDescription" class="form-label">شرح نقش در تیم</label>
                    <textarea asp-for="RoleDescription" class="form-control" rows="3" placeholder="توضیحات مسئولیت‌ها و نقش کاربر در تیم (اختیاری)"></textarea>
                    <span asp-validation-for="RoleDescription" class="text-danger"></span>
                    <div class="form-text">
                        <small class="text-muted">این توضیحات به سایر اعضای تیم در مشاهده لیست اعضا نمایش داده خواهد شد</small>
                    </div>
                </div>

                <div class="form-check">
                    <input asp-for="IsActive" class="form-check-input" type="checkbox" checked />
                    <label asp-for="IsActive" class="form-check-label">عضو فعال</label>
                    <div class="form-text">
                        <small class="text-muted">اعضای غیرفعال در لیست‌های اصلی نمایش داده نمی‌شوند</small>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa fa-times me-1"></i> انصراف
                </button>
                <button type="submit" class="btn btn-primary" data-save="modal-ajax-save">
                    <i class="fa fa-plus me-1"></i> اضافه کردن عضو
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function() {
        // فعال‌سازی Select2 برای dropdown کاربران
        $('.js-select2').select2({
            dropdownParent: $('.modal'),
            placeholder: '-- انتخاب کاربر --',
            allowClear: true,
            language: {
                noResults: function() {
                    return "کاربری یافت نشد";
                },
                searching: function() {
                    return "در حال جستجو...";
                }
            }
        });

        // فوکوس روی اولین فیلد هنگام باز شدن مودال
        $('.modal').on('shown.bs.modal', function () {
            $('#UserId').focus();
        });

        // پاک کردن فیلدهای فرم هنگام بسته شدن مودال (در صورت لغو)
        $('.modal').on('hidden.bs.modal', function () {
            $(this).find('form')[0].reset();
            $('.js-select2').val(null).trigger('change');
            // بازگردانی به مقدار پیش‌فرض نوع عضویت
            $('#MembershipType').val('0');
        });

        // هشدار هنگام انتخاب نوع "مدیر تیم"
        $('#MembershipType').on('change', function() {
            var selectedValue = $(this).val();
            if (selectedValue === '2') {
                $('#managerWarning').remove(); // حذف هشدار قبلی
                var warningHtml = `
                    <div class="alert alert-warning alert-dismissible fade show mt-2" role="alert" id="managerWarning">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        <strong>توجه:</strong> انتخاب نوع "مدیر تیم" ممکن است بر دسترسی‌ها و مجوزهای سیستم تأثیر بگذارد.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                $(this).closest('.mb-3').append(warningHtml);
            } else {
                $('#managerWarning').remove();
            }
        });
    });
</script>