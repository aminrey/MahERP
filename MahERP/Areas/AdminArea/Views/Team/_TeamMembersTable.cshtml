@model List<MahERP.DataModelLayer.ViewModels.OrganizationViewModels.TeamMemberViewModel>

@if (Model?.Any() == true)
{
    <div class="table-responsive">
        <table class="table table-striped table-vcenter">
            <thead>
                <tr>
                    <th>نام کاربر</th>
                    <th>سمت</th>
                    <th>نوع عضویت</th>
                    <th>تاریخ شروع</th>
                    <th>وضعیت</th>
                    <th class="text-center">عملیات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var member in Model.OrderBy(m => m.PowerLevel ?? 999).ThenBy(m => m.UserFullName))
                {
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fa fa-user me-2 text-primary"></i>
                                <div>
                                    <strong>@member.UserFullName</strong>
                                    @if (!string.IsNullOrEmpty(member.RoleDescription))
                                    {
                                        <br>
                            
                                        <small class="text-muted">@member.RoleDescription</small>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>
                            @if (!string.IsNullOrEmpty(member.PositionTitle))
                            {
                                <span class="badge bg-primary">@member.PositionTitle</span>
                                @if (member.PowerLevel.HasValue)
                                {
                                    <small class="text-muted d-block">قدرت: @member.PowerLevel</small>
                                }
                            }
                            else if (!string.IsNullOrEmpty(member.Position))
                            {
                                <span class="badge bg-secondary">@member.Position</span>
                            }
                            else
                            {
                                <span class="text-muted">بدون سمت</span>
                            }
                        </td>
                        <td>
                            @{
                                var membershipInfo = member.MembershipType switch
                                {
                                    0 => new { Class = "bg-info", Text = "عضو عادی" },
                                    1 => new { Class = "bg-warning", Text = "عضو ویژه" },
                                    2 => new { Class = "bg-success", Text = "مدیر تیم" },
                                    _ => new { Class = "bg-secondary", Text = "نامشخص" }
                                };
                            }
                            <span class="badge @membershipInfo.Class">@membershipInfo.Text</span>
                        </td>
                        <td>
                            @if (member.StartDate != default)
                            {
                                @ConvertDateTime.ConvertMiladiToShamsi(member.StartDate, "yyyy/MM/dd")
                            }
                            else
                            {
                                <span class="text-muted">نامشخص</span>
                            }
                        </td>
                        <td>
                            <span class="badge bg-@(member.IsActive ? "success" : "danger")">
                                @(member.IsActive ? "فعال" : "غیرفعال")
                            </span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary"
                                        data-toggle="modal-ajax"
                                        href="@Url.Action("EditMemberModal", new { id = member.Id })"
                                        title="ویرایش عضو">
                                    <i class="fa fa-edit"></i>
                                </button>

                                @if (!member.PositionId.HasValue)
                                {
                                    <button type="button" class="btn btn-outline-info"
                                            data-toggle="modal-ajax"
                                            href="@Url.Action("AssignPositionModal", new { memberId = member.Id })"
                                            title="تخصیص سمت">
                                        <i class="fa fa-briefcase"></i>
                                    </button>
                                }

                                <button type="button" class="btn btn-outline-danger"
                                        onclick="removeMember(@member.Id, '@member.UserFullName')"
                                        title="حذف از تیم">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="text-center py-4">
        <i class="fa fa-users fa-2x text-muted mb-2"></i>
        <p class="text-muted">هیچ عضوی در این تیم وجود ندارد</p>
        <button type="button" class="btn btn-primary"
                data-toggle="modal-ajax"
                href="@Url.Action("AddMemberModal", new { teamId = ViewBag.TeamId })">
            <i class="fa fa-plus me-1"></i> اضافه کردن اولین عضو
        </button>
    </div>
}

<script>
    function removeMember(memberId, memberName) {
        if (confirm(`آیا از حذف "${memberName}" از تیم اطمینان دارید؟`)) {
            $.post('@Url.Action("RemoveMember", "Team")', {
                memberId: memberId,
                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
            }, function(result) {
                if (result.success) {
                    // بروزرسانی صفحه یا جدول
                    location.reload();
                } else {
                    alert('خطا: ' + result.message);
                }
            }).fail(function() {
                alert('خطا در ارتباط با سرور');
            });
        }
    }
</script>