@model List<ContactGroupMember>
@{
    ViewData["Title"] = $"مدیریت اعضای گروه: {ViewBag.GroupTitle}";
    var groupId = ViewBag.GroupId;
    var groupTitle = ViewBag.GroupTitle;
}

<!-- Hero -->
<div class="bg-body-light">
    <div class="content content-full">
        <div class="d-flex flex-column flex-sm-row justify-content-sm-between align-items-sm-center py-2">
            <div class="flex-grow-1">
                <h1 class="h3 fw-bold mb-1">
                    <i class="fa fa-users me-2 text-primary"></i>
                    مدیریت اعضا
                </h1>
                <h2 class="fs-base lh-base fw-medium text-muted mb-0">
                    گروه: @groupTitle
                </h2>
            </div>
            <nav class="flex-shrink-0 mt-3 mt-sm-0 ms-sm-3" aria-label="breadcrumb">
                <ol class="breadcrumb breadcrumb-alt">
                    <li class="breadcrumb-item">
                        <a class="link-fx" href="@Url.Action("Index", "Home")">داشبورد</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a class="link-fx" href="@Url.Action("Index", "ContactGroups")">گروه‌ها</a>
                    </li>
                    <li class="breadcrumb-item" aria-current="page">اعضا</li>
                </ol>
            </nav>
        </div>
    </div>
</div>
<!-- END Hero -->

<!-- Page Content -->
<div class="content">
    <!-- دکمه‌ها -->
    <div class="block block-rounded mb-4">
        <div class="block-content block-content-full">
            <button type="button" class="btn btn-primary" 
                    data-toggle="modal-ajax"
                    href="@Url.Action("AddMemberModal", new { groupId })">
                <i class="fa fa-plus me-1"></i>
                افزودن عضو جدید
            </button>
            <a href="@Url.Action("Edit", new { id = groupId })" class="btn btn-warning">
                <i class="fa fa-pencil-alt me-1"></i>
                ویرایش گروه
            </a>
            <a href="@Url.Action("Index")" class="btn btn-secondary">
                <i class="fa fa-arrow-left me-1"></i>
                بازگشت
            </a>
        </div>
    </div>

    <!-- لیست اعضا -->
    <div class="block block-rounded">
        <div class="block-header block-header-default">
            <h3 class="block-title">
                اعضای گروه
                <span class="badge bg-primary ms-2">@Model.Count نفر</span>
            </h3>
        </div>
        <div class="block-content">
            @if (Model != null && Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-vcenter">
                        <thead>
                            <tr>
                                <th>نام فرد</th>
                                <th>شماره تماس</th>
                                <th>ایمیل</th>
                                <th>تاریخ افزودن</th>
                                <th>افزودن شده توسط</th>
                                <th>یادداشت</th>
                                <th class="text-center">عملیات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var member in Model)
                            {
                                <tr>
                                    <td>
                                        <a href="@Url.Action("Details", "Contacts", new { id = member.ContactId })" 
                                           target="_blank">
                                            @member.Contact?.FullName
                                        </a>
                                    </td>
                                    <td>@(member.Contact?.DefaultPhone?.FormattedNumber ?? "-")</td>
                                    <td>@(member.Contact?.PrimaryEmail ?? "-")</td>
                                    <td>@member.AddedDatePersian</td>
                                    <td>
                                        <small class="text-muted">
                                            @if (member.AddedByUser != null)
                                            {
                                                @($"{member.AddedByUser.FirstName} {member.AddedByUser.LastName}")
                                            }
                                            else
                                            {
                                                <text>-</text>
                                            }
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">@(member.Notes ?? "-")</small>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" 
                                                class="btn btn-sm btn-danger" 
                                                onclick="removeMember(@groupId, @member.ContactId, '@member.Contact?.FullName')"
                                                title="حذف از گروه">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fa fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">هیچ عضوی در این گروه وجود ندارد</p>
                    <button type="button" class="btn btn-primary" 
                            data-toggle="modal-ajax"
                            href="@Url.Action("AddMemberModal", new { groupId })">
                        <i class="fa fa-plus me-1"></i>
                        افزودن اولین عضو
                    </button>
                </div>
            }
        </div>
    </div>
</div>
<!-- END Page Content -->

<!-- Modal Container -->
<div class="modal fade" id="modal-group" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">در حال بارگذاری...</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function removeMember(groupId, contactId, contactName) {
            if (confirm(`آیا از حذف "${contactName}" از این گروه اطمینان دارید؟`)) {
                $.ajax({
                    url: '@Url.Action("RemoveMember")',
                    type: 'POST',
                    data: {
                        groupId: groupId,
                        contactId: contactId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert('خطا: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('خطا در ارتباط با سرور');
                    }
                });
            }
        }
    </script>
}

@Html.AntiForgeryToken()