using MahERP.CommonLayer.Interface;
using MahERP.CommonLayer.Repository;
using System;
using System.Threading.Tasks;

namespace MahERP.Tests
{
    /// <summary>
    /// ????????? ??????? ?? ????? ???????? ????? ??????
    /// </summary>
    public class TelegramButtonsExamples
    {
        private readonly ITelegramBotSendNotification _telegramService;
        private const string BOT_TOKEN = "YOUR_BOT_TOKEN";
        private const long TEST_CHAT_ID = 123456789;
        private const string BASE_URL = "https://yourdomain.com";

        public TelegramButtonsExamples(ITelegramBotSendNotification telegramService)
        {
            _telegramService = telegramService;
        }

        #region ? Example 1: ????? ??? ????

        public async Task SendTaskAssignedNotification(string taskId, string taskTitle, string assigneeName)
        {
            var message = $"?? <b>??? ???? ?????? ????</b>\n\n" +
                         $"?? <b>??:</b> {assigneeName}\n" +
                         $"?? <b>?????:</b> {taskTitle}\n" +
                         $"?? <b>??:</b> {taskId}\n\n" +
                         $"????? ?? ???? ??? ????? ????.";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                TaskId = taskId,
                EventType = 1, // TaskAssigned
                TaskTitle = taskTitle
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???
            // ?? ??? ?????
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 2: ????? ?????? ??????? ????? ????

        public async Task SendDailyTaskDigest(string userName, int pendingTasksCount)
        {
            var message = $"?? <b>??? ???? {userName}!</b>\n\n" +
                         $"?? ??? <b>{pendingTasksCount} ???</b> ?? ??? ????? ?????:\n\n" +
                         $"?? ??????? ?? ??? ????? ???:\n\n" +
                         $"1?? ????? ??????? ????? A\n" +
                         $"   ?? ????: 1402/10/15 | ?? ??????: ????\n" +
                         $"   ?? ??????: 30%\n\n" +
                         $"2?? ????? ????? ??????\n" +
                         $"   ?? ????: 1402/10/18 | ?? ??????: ????\n" +
                         $"   ?? ??????: 65%\n\n" +
                         $"?? ??? ???? ????? ?????!";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                EventType = 13, // DailyTaskDigest
                HasPendingTasksList = true
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???? ??????
            // ?? ??????? ?????
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 3: ??????? ?????? ???

        public async Task SendDeadlineReminder(string taskId, string taskTitle, int hoursRemaining)
        {
            var urgencyEmoji = hoursRemaining <= 2 ? "??" : "?";
            var urgencyText = hoursRemaining <= 2 ? "????" : "???????";

            var message = $"{urgencyEmoji} <b>{urgencyText} - ?????? ???</b>\n\n" +
                         $"?? <b>?????:</b> {taskTitle}\n" +
                         $"? <b>???? ?????????:</b> {hoursRemaining} ????\n\n" +
                         $"????? ?? ?? ?????? ??? ?? ????? ????.";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                TaskId = taskId,
                EventType = 3, // TaskDeadlineReminder
                TaskTitle = taskTitle
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???
            // ? ????? ??
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 4: ????? ????? ????

        public async Task SendNewCommentNotification(string taskId, string taskTitle, string commenterName, string commentText)
        {
            // ????? ???? ??? ?????
            var shortComment = commentText.Length > 100 
                ? commentText.Substring(0, 100) + "..." 
                : commentText;

            var message = $"?? <b>????? ???? ?? ???</b>\n\n" +
                         $"?? <b>???:</b> {taskTitle}\n" +
                         $"?? <b>?? ???:</b> {commenterName}\n\n" +
                         $"?? <i>{shortComment}</i>";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                TaskId = taskId,
                EventType = 4, // TaskCommentAdded
                TaskTitle = taskTitle
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???
            // ?? ??? ?????
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 5: ????? ????? ????? ???

        public async Task SendTaskStatusChangedNotification(string taskId, string taskTitle, string oldStatus, string newStatus)
        {
            var statusEmoji = newStatus switch
            {
                "????? ???" => "?",
                "?? ??? ?????" => "??",
                "????? ???" => "??",
                "??? ???" => "?",
                _ => "??"
            };

            var message = $"{statusEmoji} <b>????? ????? ???</b>\n\n" +
                         $"?? <b>?????:</b> {taskTitle}\n" +
                         $"?? <b>????? ????:</b> {oldStatus}\n" +
                         $"?? <b>????? ????:</b> {newStatus}";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                TaskId = taskId,
                EventType = 8, // TaskStatusChanged
                TaskTitle = taskTitle
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???
            // ?? ??? ?????
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 6: ????? ???? ?? ?????

        public async Task SendCommentMentionNotification(string taskId, string taskTitle, string mentionerName, string mentionedUser)
        {
            var message = $"?? <b>??? ?? ?????? ???? ????</b>\n\n" +
                         $"?? <b>???:</b> {taskTitle}\n" +
                         $"?? <b>????:</b> {mentionerName}\n\n" +
                         $"????? ????? ?? ?????? ? ???? ????.";

            var context = new NotificationContext
            {
                BaseUrl = BASE_URL,
                TaskId = taskId,
                EventType = 10, // CommentMentioned
                TaskTitle = taskTitle
            };

            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN,
                context
            );

            // ???????? ????? ???:
            // ?? ?????? ???
            // ?? ??? ????????
        }

        #endregion

        #region ? Example 7: ????? ???? Context (???????? ???????)

        public async Task SendSimpleNotification(string message)
        {
            // ??????? ???? Context - ???????? ??????? ????? ???? ??????
            await _telegramService.SendNotificationAsync(
                message,
                TEST_CHAT_ID,
                BOT_TOKEN
            );

            // ???????? ????? ??? (???????):
            // ?? ???? ??????
        }

        #endregion

        #region ?? Test Method: ??? ??? ????????

        public async Task RunAllExamples()
        {
            Console.WriteLine("?? ???? ??? ???????? ????? ??????...\n");

            // ??? 1
            Console.WriteLine("1?? ????? ????? ??? ????...");
            await SendTaskAssignedNotification("TSK-001", "????? ??????? ?????", "??? ?????");
            await Task.Delay(2000);

            // ??? 2
            Console.WriteLine("2?? ????? ????? ??????...");
            await SendDailyTaskDigest("??? ?????", 5);
            await Task.Delay(2000);

            // ??? 3
            Console.WriteLine("3?? ????? ??????? ??????...");
            await SendDeadlineReminder("TSK-002", "????? ????? ??????", 2);
            await Task.Delay(2000);

            // ??? 4
            Console.WriteLine("4?? ????? ????? ?????...");
            await SendNewCommentNotification("TSK-001", "????? ??????? ?????", "??? ?????", "????? ?????? ????? ????");
            await Task.Delay(2000);

            // ??? 5
            Console.WriteLine("5?? ????? ????? ?????...");
            await SendTaskStatusChangedNotification("TSK-003", "????? ???? ??????", "?? ??????", "?? ??? ?????");
            await Task.Delay(2000);

            // ??? 6
            Console.WriteLine("6?? ????? ????...");
            await SendCommentMentionNotification("TSK-004", "????????? ????????", "???? ?????", "??? ?????");
            await Task.Delay(2000);

            // ??? 7
            Console.WriteLine("7?? ????? ????? ????...");
            await SendSimpleNotification("??? ?? ????? ???? ???? Context ???");

            Console.WriteLine("\n? ???? ?????? ?? ?????? ????? ??!");
        }

        #endregion
    }
}
